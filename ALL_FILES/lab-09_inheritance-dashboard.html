<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 9 Dashboard: Inheritance | BIOL-8</title>
<style>
/* ═══════════════════════════════════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f0f2f5; --card: #ffffff; --sidebar: #1a1a2e; --sidebar-hover: #252545;
  --accent: #c41e3a; --accent-light: #e8354f; --blue: #2563eb; --blue-light: #3b82f6;
  --green: #16a34a; --amber: #d97706; --purple: #7c3aed;
  --text: #1a1a1a; --text-muted: #6b7280; --border: #e5e7eb;
  --radius: 10px; --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
}
html { scroll-behavior: smooth; }
body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; }

/* ═══════════════════════════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════════════════════════ */
.layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; background: var(--sidebar); color: #e2e8f0; position: fixed;
  top: 0; left: 0; height: 100vh; overflow-y: auto; z-index: 100;
  display: flex; flex-direction: column;
}
.sidebar-header { padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-header h1 { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
.sidebar-header p { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.sidebar-nav { flex: 1; padding: 12px 0; }
.sidebar-nav a {
  display: flex; align-items: center; gap: 10px; padding: 10px 20px;
  color: #94a3b8; text-decoration: none; font-size: 13px; font-weight: 500;
  transition: all 0.15s; border-left: 3px solid transparent;
}
.sidebar-nav a:hover { background: var(--sidebar-hover); color: #e2e8f0; }
.sidebar-nav a.active { color: #fff; background: var(--sidebar-hover); border-left-color: var(--accent); }
.sidebar-nav .nav-num {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 6px; font-size: 11px; font-weight: 700;
  background: rgba(255,255,255,0.08); flex-shrink: 0;
}
.sidebar-nav a.active .nav-num { background: var(--accent); color: #fff; }
.sidebar-footer { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #64748b; }

.main { margin-left: 260px; flex: 1; padding: 32px; max-width: 1200px; }

/* ═══════════════════════════════════════════════════════════════════════
   CARDS & SECTIONS
   ═══════════════════════════════════════════════════════════════════════ */
.section { margin-bottom: 40px; scroll-margin-top: 24px; }
.section-header {
  display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
}
.section-num {
  display: flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: 10px;
  background: var(--accent); color: #fff; font-weight: 800; font-size: 16px; flex-shrink: 0;
}
.section-title { font-size: 22px; font-weight: 700; }
.section-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

.card {
  background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 24px; margin-bottom: 16px; border: 1px solid var(--border);
}
.card-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.card-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
@media (max-width: 900px) { .card-row, .card-row-3 { grid-template-columns: 1fr; } }

/* ═══════════════════════════════════════════════════════════════════════
   BUTTONS & INPUTS
   ═══════════════════════════════════════════════════════════════════════ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
  border: none; cursor: pointer; transition: all 0.15s; font-family: var(--font);
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn-secondary { background: var(--blue); color: #fff; }
.btn-secondary:hover { background: var(--blue-light); }
.btn-outline { background: transparent; color: var(--text); border: 2px solid var(--border); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }

.slider-group { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
.slider-group label { font-size: 13px; font-weight: 600; min-width: 80px; }
.slider-group input[type=range] { flex: 1; accent-color: var(--accent); }
.slider-val { font-family: var(--mono); font-size: 14px; font-weight: 700; min-width: 50px; text-align: right; }

select.form-select {
  padding: 8px 12px; border-radius: 8px; border: 2px solid var(--border);
  font-family: var(--font); font-size: 13px; font-weight: 600;
  background: #fff; cursor: pointer; transition: border-color 0.15s;
}
select.form-select:focus { outline: none; border-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   STATS & BADGES
   ═══════════════════════════════════════════════════════════════════════ */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 12px 0; }
.stat-box {
  text-align: center; padding: 14px 8px; border-radius: 8px;
  background: #f8fafc; border: 1px solid var(--border);
}
.stat-box .stat-val { font-size: 28px; font-weight: 800; font-family: var(--mono); }
.stat-box .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-accent .stat-val { color: var(--accent); }
.stat-blue .stat-val { color: var(--blue); }
.stat-green .stat-val { color: var(--green); }
.stat-amber .stat-val { color: var(--amber); }
.stat-purple .stat-val { color: var(--purple); }

.badge {
  display: inline-block; padding: 2px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
}
.badge-red { background: #fef2f2; color: var(--accent); }
.badge-blue { background: #eff6ff; color: var(--blue); }
.badge-green { background: #f0fdf4; color: var(--green); }
.badge-amber { background: #fffbeb; color: var(--amber); }
.badge-purple { background: #f5f3ff; color: var(--purple); }

/* ═══════════════════════════════════════════════════════════════════════
   CHART CONTAINERS
   ═══════════════════════════════════════════════════════════════════════ */
.chart-wrap { position: relative; width: 100%; margin: 8px 0; }
.chart-wrap canvas { width: 100% !important; display: block; border-radius: 6px; }

/* ═══════════════════════════════════════════════════════════════════════
   PUNNETT SQUARE
   ═══════════════════════════════════════════════════════════════════════ */
.punnett { display: grid; grid-template-columns: 60px 1fr 1fr; grid-template-rows: 50px 1fr 1fr; gap: 3px; max-width: 300px; margin: 12px auto; }
.punnett .p-cell {
  display: flex; align-items: center; justify-content: center;
  border-radius: 6px; font-weight: 700; font-size: 18px; min-height: 60px;
}
.punnett .p-corner { background: transparent; }
.punnett .p-header { background: #1a1a1a; color: #fff; }
.punnett .p-aa { background: #dbeafe; color: #1e40af; border: 2px solid #93c5fd; }
.punnett .p-Aa { background: #fef3c7; color: #92400e; border: 2px solid #fcd34d; }
.punnett .p-AA { background: #fce7f3; color: #9d174d; border: 2px solid #f9a8d4; }
.punnett .p-highlight { box-shadow: 0 0 0 3px var(--accent), 0 0 12px rgba(196,30,58,0.3); z-index: 1; }

/* ═══════════════════════════════════════════════════════════════════════
   DATA GRID
   ═══════════════════════════════════════════════════════════════════════ */
.data-grid {
  display: grid; gap: 3px; margin: 10px 0; font-family: var(--mono); font-size: 14px;
}
.data-grid .cell {
  display: flex; align-items: center; justify-content: center;
  height: 38px; border-radius: 4px; font-weight: 700; transition: all 0.2s;
}
.data-grid .cell-header { background: #1a1a1a; color: #fff; font-size: 11px; font-weight: 600; }
.data-grid .cell-label { background: #f1f5f9; color: var(--text); font-size: 12px; font-weight: 600; }
.data-grid .cell-empty { background: #fafafa; border: 1px dashed #d1d5db; color: #d1d5db; }
.data-grid .cell-new { animation: cellPop 0.3s ease; }
@keyframes cellPop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

/* ═══════════════════════════════════════════════════════════════════════
   CONVERGENCE LINE
   ═══════════════════════════════════════════════════════════════════════ */
.convergence-info { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin: 10px 0; font-size: 13px; }
.convergence-info .ci-dot { width: 12px; height: 3px; border-radius: 2px; display: inline-block; }

/* ═══════════════════════════════════════════════════════════════════════
   ANALYSIS PANEL
   ═══════════════════════════════════════════════════════════════════════ */
.analysis-result {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--blue); font-size: 14px;
}
.analysis-result .ar-title { font-weight: 700; margin-bottom: 6px; }
.analysis-result code { font-family: var(--mono); background: #e2e8f0; padding: 1px 6px; border-radius: 4px; font-size: 13px; }
.analysis-result.ar-pass { border-left-color: var(--green); }
.analysis-result.ar-fail { border-left-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   HERO BANNER
   ═══════════════════════════════════════════════════════════════════════ */
.hero {
  background: linear-gradient(135deg, #1a1a2e 0%, #2d1b3d 50%, #3b1a2e 100%);
  color: #fff; border-radius: var(--radius); padding: 36px; margin-bottom: 32px;
  position: relative; overflow: hidden;
}
.hero::after {
  content: ''; position: absolute; top: -50%; right: -20%; width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(196,30,58,0.15) 0%, transparent 70%);
  pointer-events: none;
}
.hero h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.hero p { font-size: 15px; color: #cbd5e1; max-width: 600px; line-height: 1.7; }
.hero .bio-tags { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
.hero .bio-tag {
  padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
  background: rgba(255,255,255,0.1); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);
}

/* ═══════════════════════════════════════════════════════════════════════
   TRAIT CHECKLIST
   ═══════════════════════════════════════════════════════════════════════ */
.trait-list { list-style: none; padding: 0; }
.trait-list li {
  display: flex; align-items: center; gap: 10px; padding: 10px 12px;
  border-bottom: 1px solid var(--border); font-size: 14px; transition: background 0.15s;
}
.trait-list li:hover { background: #f8fafc; }
.trait-list li:last-child { border-bottom: none; }
.trait-list input[type=checkbox] { accent-color: var(--accent); width: 18px; height: 18px; cursor: pointer; }
.trait-list .trait-name { font-weight: 600; flex: 1; }
.trait-list .trait-dom { font-size: 12px; color: var(--text-muted); min-width: 100px; text-align: right; }
.trait-list .trait-freq { font-size: 12px; color: var(--blue); font-weight: 600; min-width: 50px; text-align: right; }

/* ═══════════════════════════════════════════════════════════════════════
   PEDIGREE CELLS
   ═══════════════════════════════════════════════════════════════════════ */
.pedigree-controls { display: flex; gap: 12px; flex-wrap: wrap; margin: 10px 0; align-items: center; }
.pedigree-controls label { font-size: 13px; font-weight: 600; }

/* ═══════════════════════════════════════════════════════════════════════
   BLOOD TYPE TABLE
   ═══════════════════════════════════════════════════════════════════════ */
.compat-table { width: 100%; border-collapse: collapse; font-size: 13px; margin: 10px 0; }
.compat-table th, .compat-table td {
  padding: 8px 6px; text-align: center; border: 1px solid var(--border);
}
.compat-table th { background: #1a1a1a; color: #fff; font-weight: 600; font-size: 12px; }
.compat-table .compat-yes { background: #f0fdf4; color: var(--green); font-weight: 700; }
.compat-table .compat-no { background: #fef2f2; color: var(--accent); font-weight: 700; }

/* ═══════════════════════════════════════════════════════════════════════
   COUNSELING SCENARIOS
   ═══════════════════════════════════════════════════════════════════════ */
.scenario-card {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border: 1px solid var(--border); cursor: pointer; transition: all 0.15s;
}
.scenario-card:hover { border-color: var(--accent); box-shadow: var(--shadow); }
.scenario-card .sc-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
.scenario-card .sc-desc { font-size: 13px; color: var(--text-muted); }

/* ═══════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main { margin-left: 0; padding: 16px; }
}
</style>
</head>
<body>
<div class="layout">

<!-- ═══════════════════════════════════════════════════════════════════════
     SIDEBAR
     ═══════════════════════════════════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h1>BIOL-8: Human Biology</h1>
    <p>Lab 9 &mdash; Inheritance</p>
  </div>
  <nav class="sidebar-nav">
    <a href="#hero" class="active"><span class="nav-num">&bull;</span> Overview</a>
    <a href="#part1"><span class="nav-num">1</span> Punnett Square</a>
    <a href="#part2"><span class="nav-num">2</span> Trait Survey</a>
    <a href="#part3"><span class="nav-num">3</span> Pedigree Analyzer</a>
    <a href="#part4"><span class="nav-num">4</span> Blood Types</a>
    <a href="#part5"><span class="nav-num">5</span> Sex-Linked Traits</a>
    <a href="#part6"><span class="nav-num">6</span> Genetic Counseling</a>
  </nav>
  <div class="sidebar-footer">Interactive Lab Dashboard<br>&copy; 2026 BIOL-8</div>
</aside>

<!-- ═══════════════════════════════════════════════════════════════════════
     MAIN CONTENT
     ═══════════════════════════════════════════════════════════════════════ -->
<div class="main">

<!-- HERO -->
<div class="hero" id="hero">
  <h2>Inheritance</h2>
  <p>Interactive simulations exploring how traits are passed from parents to offspring. Build Punnett squares, analyze pedigrees, investigate blood type inheritance, and explore sex-linked traits and genetic counseling scenarios.</p>
  <div class="bio-tags">
    <span class="bio-tag">Genetics</span>
    <span class="bio-tag">Punnett Squares</span>
    <span class="bio-tag">Pedigrees</span>
  </div>
</div>

<!-- ═══════════════════════════════════════ PART 1: PUNNETT SQUARE BUILDER ═══════════════════════════════════════ -->
<div class="section" id="part1">
  <div class="section-header">
    <div class="section-num">1</div>
    <div><div class="section-title">Punnett Square Builder</div>
    <div class="section-subtitle">Select a trait and parent genotypes to visualize genetic crosses</div></div>
  </div>
  <div class="card">
    <div class="card-title">Cross Setup</div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">TRAIT</div>
        <select class="form-select" id="ps-trait" onchange="psUpdateTrait()">
          <option value="widows_peak">Widow's Peak</option>
          <option value="earlobes">Free Earlobes</option>
          <option value="tongue">Tongue Rolling</option>
          <option value="cleft_chin">Cleft Chin</option>
          <option value="dimples">Dimples</option>
          <option value="freckles">Freckles</option>
          <option value="hitchhiker">Hitchhiker's Thumb</option>
          <option value="ptc">PTC Tasting</option>
        </select>
      </div>
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">PARENT 1</div>
        <select class="form-select" id="ps-p1" onchange="psUpdateSquare()">
          <option value="HH">Homozygous Dominant (AA)</option>
          <option value="Hh" selected>Heterozygous (Aa)</option>
          <option value="hh">Homozygous Recessive (aa)</option>
        </select>
      </div>
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">PARENT 2</div>
        <select class="form-select" id="ps-p2" onchange="psUpdateSquare()">
          <option value="HH">Homozygous Dominant (AA)</option>
          <option value="Hh" selected>Heterozygous (Aa)</option>
          <option value="hh">Homozygous Recessive (aa)</option>
        </select>
      </div>
    </div>
    <div id="ps-trait-info" style="font-size:13px;color:var(--text-muted);margin-bottom:12px;"></div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Punnett Square</div>
      <div class="chart-wrap"><canvas id="ps-canvas" height="260"></canvas></div>
      <div id="ps-ratios" style="text-align:center;margin-top:8px;"></div>
    </div>
    <div class="card">
      <div class="card-title">Offspring Simulator</div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="psSimulate(10)">Simulate 10</button>
        <button class="btn btn-secondary" onclick="psSimulate(50)">Simulate 50</button>
        <button class="btn btn-secondary" onclick="psSimulate(100)">Simulate 100</button>
        <button class="btn btn-outline" onclick="psReset()">Reset</button>
      </div>
      <div class="stat-grid">
        <div class="stat-box stat-accent"><div class="stat-val" id="ps-dom-count">0</div><div class="stat-label">Dominant</div></div>
        <div class="stat-box stat-blue"><div class="stat-val" id="ps-rec-count">0</div><div class="stat-label">Recessive</div></div>
        <div class="stat-box stat-green"><div class="stat-val" id="ps-total">0</div><div class="stat-label">Total</div></div>
        <div class="stat-box stat-amber"><div class="stat-val" id="ps-ratio-obs">-</div><div class="stat-label">Obs. Ratio</div></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Observed vs. Expected Frequencies</div>
    <div class="chart-wrap"><canvas id="ps-bar-chart" height="260"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════════════════════ PART 2: HUMAN TRAIT SURVEY ═══════════════════════════════════════ -->
<div class="section" id="part2">
  <div class="section-header">
    <div class="section-num">2</div>
    <div><div class="section-title">Human Trait Survey</div>
    <div class="section-subtitle">Check your phenotype for common human genetic traits</div></div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Your Phenotype Checklist</div>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Check each trait if you exhibit the <strong>dominant</strong> phenotype.</p>
      <ul class="trait-list" id="trait-checklist"></ul>
    </div>
    <div class="card">
      <div class="card-title">Your Genotype Predictions</div>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Based on your phenotype, here are possible genotypes.</p>
      <div id="trait-genotypes"></div>
      <div class="stat-grid" style="margin-top:16px;">
        <div class="stat-box stat-accent"><div class="stat-val" id="trait-dom-count">0</div><div class="stat-label">Dominant</div></div>
        <div class="stat-box stat-blue"><div class="stat-val" id="trait-rec-count">0</div><div class="stat-label">Recessive</div></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Class Data Aggregation Simulator</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Simulate a class of students and compare population frequencies with your traits.</p>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="traitSimClass(30)">Simulate 30 Students</button>
      <button class="btn btn-secondary" onclick="traitSimClass(100)">Simulate 100</button>
      <button class="btn btn-outline" onclick="traitResetClass()">Reset</button>
    </div>
    <div class="chart-wrap"><canvas id="trait-pop-chart" height="280"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════════════════════ PART 3: PEDIGREE ANALYZER ═══════════════════════════════════════ -->
<div class="section" id="part3">
  <div class="section-header">
    <div class="section-num">3</div>
    <div><div class="section-title">Pedigree Analyzer</div>
    <div class="section-subtitle">Analyze family trees to determine inheritance patterns</div></div>
  </div>
  <div class="card">
    <div class="card-title">Interactive Pedigree</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Click on individuals to toggle their affected status. The analyzer will determine the most likely inheritance pattern.</p>
    <div class="pedigree-controls">
      <label>Practice Pedigree:</label>
      <select class="form-select" id="ped-preset" onchange="pedLoadPreset()">
        <option value="custom">Custom (click to edit)</option>
        <option value="ad">Autosomal Dominant</option>
        <option value="ar">Autosomal Recessive</option>
        <option value="xlr">X-Linked Recessive</option>
        <option value="xld">X-Linked Dominant</option>
      </select>
      <button class="btn btn-sm btn-outline" onclick="pedClearAll()">Clear All</button>
      <button class="btn btn-sm btn-secondary" id="ped-reveal-btn" onclick="pedRevealAnswer()" style="display:none;">Reveal Answer</button>
    </div>
    <div class="chart-wrap"><canvas id="ped-canvas" height="340"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Inheritance Pattern Analysis</div>
    <div id="ped-analysis">
      <p style="font-size:13px;color:var(--text-muted);">Click individuals in the pedigree above, then the analyzer will determine the most likely inheritance pattern.</p>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════ PART 4: BLOOD TYPE INHERITANCE ═══════════════════════════════════════ -->
<div class="section" id="part4">
  <div class="section-header">
    <div class="section-num">4</div>
    <div><div class="section-title">Blood Type Inheritance</div>
    <div class="section-subtitle">Explore ABO blood groups with codominance and multiple alleles</div></div>
  </div>
  <div class="card">
    <div class="card-title">ABO Cross Setup</div>
    <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center;">
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">PARENT 1 GENOTYPE</div>
        <select class="form-select" id="bt-p1" onchange="btUpdateCross()">
          <option value="IAIA">I^A I^A (Type A)</option>
          <option value="IAi">I^A i (Type A)</option>
          <option value="IBIB">I^B I^B (Type B)</option>
          <option value="IBi">I^B i (Type B)</option>
          <option value="IAIB" selected>I^A I^B (Type AB)</option>
          <option value="ii">ii (Type O)</option>
        </select>
      </div>
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">PARENT 2 GENOTYPE</div>
        <select class="form-select" id="bt-p2" onchange="btUpdateCross()">
          <option value="IAIA">I^A I^A (Type A)</option>
          <option value="IAi">I^A i (Type A)</option>
          <option value="IBIB">I^B I^B (Type B)</option>
          <option value="IBi" selected>I^B i (Type B)</option>
          <option value="IAIB">I^A I^B (Type AB)</option>
          <option value="ii">ii (Type O)</option>
        </select>
      </div>
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">Rh FACTOR</div>
        <label style="font-size:13px;cursor:pointer;"><input type="checkbox" id="bt-rh" onchange="btUpdateCross()" checked style="accent-color:var(--accent);"> Include Rh (+/-)</label>
      </div>
    </div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">ABO Punnett Square</div>
      <div class="chart-wrap"><canvas id="bt-canvas" height="260"></canvas></div>
      <div id="bt-ratios" style="text-align:center;margin-top:8px;"></div>
    </div>
    <div class="card">
      <div class="card-title">Offspring Blood Types</div>
      <div class="stat-grid" id="bt-stats"></div>
      <div id="bt-paternity" style="margin-top:12px;"></div>
    </div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Transfusion Compatibility</div>
      <table class="compat-table">
        <thead>
          <tr><th>Recipient \ Donor</th><th>O-</th><th>O+</th><th>A-</th><th>A+</th><th>B-</th><th>B+</th><th>AB-</th><th>AB+</th></tr>
        </thead>
        <tbody id="compat-tbody"></tbody>
      </table>
    </div>
    <div class="card">
      <div class="card-title">US Blood Type Frequencies</div>
      <div class="chart-wrap"><canvas id="bt-pop-chart" height="260"></canvas></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════ PART 5: SEX-LINKED TRAITS ═══════════════════════════════════════ -->
<div class="section" id="part5">
  <div class="section-header">
    <div class="section-num">5</div>
    <div><div class="section-title">Sex-Linked Trait Simulator</div>
    <div class="section-subtitle">Explore X-linked recessive traits like color blindness and hemophilia</div></div>
  </div>
  <div class="card">
    <div class="card-title">X-Linked Cross Setup</div>
    <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center;">
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">TRAIT</div>
        <select class="form-select" id="xl-trait" onchange="xlUpdateCross()">
          <option value="colorblind">Color Blindness</option>
          <option value="hemophilia">Hemophilia</option>
        </select>
      </div>
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">MOTHER GENOTYPE</div>
        <select class="form-select" id="xl-mother" onchange="xlUpdateCross()">
          <option value="XAXA">X^A X^A (Normal)</option>
          <option value="XAXa" selected>X^A X^a (Carrier)</option>
          <option value="XaXa">X^a X^a (Affected)</option>
        </select>
      </div>
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">FATHER GENOTYPE</div>
        <select class="form-select" id="xl-father" onchange="xlUpdateCross()">
          <option value="XAY" selected>X^A Y (Normal)</option>
          <option value="XaY">X^a Y (Affected)</option>
        </select>
      </div>
    </div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Sex-Linked Punnett Square</div>
      <div class="chart-wrap"><canvas id="xl-canvas" height="260"></canvas></div>
      <div id="xl-ratios" style="text-align:center;margin-top:8px;"></div>
    </div>
    <div class="card">
      <div class="card-title">Offspring Outcomes</div>
      <div class="stat-grid" id="xl-stats"></div>
      <div id="xl-explanation" style="margin-top:12px;"></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Why Sons Are More Affected &mdash; Probability Calculator</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">If the mother is a carrier (X^A X^a) and father is normal (X^A Y):</p>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val">50%</div><div class="stat-label">Sons Affected</div></div>
      <div class="stat-box stat-blue"><div class="stat-val">0%</div><div class="stat-label">Daughters Affected</div></div>
      <div class="stat-box stat-amber"><div class="stat-val">50%</div><div class="stat-label">Daughters Carriers</div></div>
      <div class="stat-box stat-green"><div class="stat-val">50%</div><div class="stat-label">Sons Normal</div></div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="xlSimulate(100)">Simulate 100 Offspring</button>
      <button class="btn btn-outline" onclick="xlResetSim()">Reset</button>
    </div>
    <div class="chart-wrap"><canvas id="xl-sim-chart" height="260"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Royal Hemophilia Pedigree</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Queen Victoria was a carrier for hemophilia. Trace the trait through three generations of European royalty.</p>
    <div class="chart-wrap"><canvas id="xl-royal-chart" height="300"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════════════════════ PART 6: GENETIC COUNSELING ═══════════════════════════════════════ -->
<div class="section" id="part6">
  <div class="section-header">
    <div class="section-num">6</div>
    <div><div class="section-title">Genetic Counseling Scenarios</div>
    <div class="section-subtitle">Calculate risk and probability for genetic conditions</div></div>
  </div>
  <div class="card">
    <div class="card-title">Select a Scenario</div>
    <div id="gc-scenarios"></div>
  </div>
  <div class="card" id="gc-workspace" style="display:none;">
    <div class="card-title" id="gc-title">Scenario Details</div>
    <div id="gc-description" style="font-size:14px;margin-bottom:16px;"></div>
    <div class="card-row">
      <div>
        <div class="card-title" style="font-size:14px;">Punnett Square</div>
        <div class="chart-wrap"><canvas id="gc-canvas" height="260"></canvas></div>
      </div>
      <div>
        <div class="card-title" style="font-size:14px;">Risk Assessment</div>
        <div id="gc-risk"></div>
        <div class="stat-grid" id="gc-stats" style="margin-top:12px;"></div>
      </div>
    </div>
    <div id="gc-population" style="margin-top:16px;"></div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /layout -->

<!-- ═══════════════════════════════════════════════════════════════════════
     JAVASCRIPT ENGINE
     ═══════════════════════════════════════════════════════════════════════ -->
<script>
// ── Utility ──────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

// ── Chart helper ─────────────────────────────────────────────────────────
function getCtx(id) {
  const c = $(id); const dpr = window.devicePixelRatio || 1;
  const w = c.offsetWidth || c.width || 300;
  const h = c.offsetHeight || c.height || 150;
  c.width = w * dpr; c.height = h * dpr;
  const ctx = c.getContext('2d'); ctx.scale(dpr, dpr);
  ctx.W = w; ctx.H = h;
  return ctx;
}

function drawBarChart(ctx, opts = {}) {
  const { labels, values, expected, colors, maxVal, yLabel } = opts;
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const n = values.length, barW = plotW / n * 0.6, gap = plotW / n * 0.4;

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const mv = maxVal || Math.max(...values, ...(expected||[0])) * 1.2 || 10;
  // grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui';
    ctx.textAlign = 'right'; ctx.fillText((mv * i/4).toFixed(mv > 10 ? 0 : 2), pad.left - 6, y + 4);
  }

  values.forEach((v, i) => {
    const x = pad.left + (plotW / n) * i + gap/2;
    const h = (v / mv) * plotH;
    ctx.fillStyle = colors ? colors[i] : '#c41e3a';
    ctx.beginPath();
    const r = 4;
    ctx.moveTo(x, pad.top + plotH);
    ctx.lineTo(x, pad.top + plotH - h + r);
    ctx.quadraticCurveTo(x, pad.top + plotH - h, x + r, pad.top + plotH - h);
    ctx.lineTo(x + barW - r, pad.top + plotH - h);
    ctx.quadraticCurveTo(x + barW, pad.top + plotH - h, x + barW, pad.top + plotH - h + r);
    ctx.lineTo(x + barW, pad.top + plotH);
    ctx.closePath(); ctx.fill();
    // label
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(labels[i], x + barW/2, H - pad.bottom + 16);
    // value on top
    if (v > 0) {
      ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 12px system-ui';
      ctx.fillText(v.toFixed(v % 1 ? 2 : 0), x + barW/2, pad.top + plotH - h - 6);
    }
  });

  // expected line
  if (expected) {
    expected.forEach((ev, i) => {
      const x = pad.left + (plotW / n) * i + gap/2;
      const y = pad.top + plotH - (ev / mv) * plotH;
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.setLineDash([4,3]);
      ctx.beginPath(); ctx.moveTo(x - 4, y); ctx.lineTo(x + barW + 4, y); ctx.stroke();
      ctx.setLineDash([]);
    });
  }
}

function drawLineChart(ctx, series, opts = {}) {
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 30, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const { yMin = 0, yMax = 1, refLine, xLabel } = opts;
  const yRange = yMax - yMin;
  // grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((yMin + yRange * i/4).toFixed(2), pad.left - 6, y + 4);
  }
  // ref line
  if (refLine !== undefined) {
    const ry = pad.top + plotH * (1 - (refLine - yMin) / yRange);
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(pad.left, ry); ctx.lineTo(W - pad.right, ry); ctx.stroke();
    ctx.setLineDash([]);
  }

  series.forEach(s => {
    if (!s.data.length) return;
    const xMax = opts.xMax || s.data.length;
    ctx.strokeStyle = s.color; ctx.lineWidth = s.width || 2;
    ctx.beginPath();
    s.data.forEach((v, i) => {
      const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
      const y = pad.top + plotH * (1 - (v - yMin) / yRange);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    if (s.width !== 0) ctx.stroke();
    // dots
    if (s.dots && s.data.length < 80) {
      s.data.forEach((v, i) => {
        const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
        const y = pad.top + plotH * (1 - (v - yMin) / yRange);
        ctx.fillStyle = s.color; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
      });
    }
  });
}

// ══════════════════════════════════════════════════════════════════════════
// TRAIT DATA
// ══════════════════════════════════════════════════════════════════════════
const TRAITS = {
  widows_peak: { name: "Widow's Peak", dom: "Widow's peak", rec: "Straight hairline", letter: 'W', freq: 0.35 },
  earlobes: { name: "Free Earlobes", dom: "Free earlobes", rec: "Attached earlobes", letter: 'E', freq: 0.64 },
  tongue: { name: "Tongue Rolling", dom: "Can roll tongue", rec: "Cannot roll tongue", letter: 'R', freq: 0.70 },
  cleft_chin: { name: "Cleft Chin", dom: "Cleft chin", rec: "Smooth chin", letter: 'C', freq: 0.20 },
  dimples: { name: "Dimples", dom: "Dimples present", rec: "No dimples", letter: 'D', freq: 0.25 },
  freckles: { name: "Freckles", dom: "Freckles present", rec: "No freckles", letter: 'F', freq: 0.40 },
  hitchhiker: { name: "Hitchhiker's Thumb", dom: "Straight thumb", rec: "Hitchhiker's thumb", letter: 'H', freq: 0.75 },
  ptc: { name: "PTC Tasting", dom: "Can taste PTC", rec: "Cannot taste PTC", letter: 'T', freq: 0.70 },
  hand: { name: "Hand Clasping", dom: "Left thumb on top", rec: "Right thumb on top", letter: 'L', freq: 0.55 },
  hair_curl: { name: "Hair Texture", dom: "Curly/Wavy hair", rec: "Straight hair", letter: 'S', freq: 0.45 },
  bent_pinky: { name: "Bent Little Finger", dom: "Bent pinky", rec: "Straight pinky", letter: 'B', freq: 0.25 },
  mid_digit: { name: "Mid-Digital Hair", dom: "Hair present", rec: "No hair", letter: 'M', freq: 0.60 }
};

// ══════════════════════════════════════════════════════════════════════════
// PART 1: PUNNETT SQUARE BUILDER
// ══════════════════════════════════════════════════════════════════════════
let psData = { offspring: { dom: 0, het: 0, rec: 0 } };

function psGetAlleles(val) {
  if (val === 'HH') return ['D','D'];
  if (val === 'Hh') return ['D','d'];
  return ['d','d'];
}

function psUpdateTrait() {
  const t = TRAITS[$('ps-trait').value];
  $('ps-trait-info').innerHTML = `<strong>${t.name}:</strong> Dominant = ${t.dom} | Recessive = ${t.rec} | Allele letter: <strong>${t.letter}</strong> | Population frequency (dominant phenotype): ${(t.freq*100).toFixed(0)}%`;
  psUpdateSquare();
}

function psUpdateSquare() {
  psDrawPunnett();
}

function psDrawPunnett() {
  const ctx = getCtx('ps-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);

  const trait = TRAITS[$('ps-trait').value];
  const L = trait.letter;
  const p1 = psGetAlleles($('ps-p1').value);
  const p2 = psGetAlleles($('ps-p2').value);

  const p1Labels = p1.map(a => a === 'D' ? L : L.toLowerCase());
  const p2Labels = p2.map(a => a === 'D' ? L : L.toLowerCase());

  // Grid layout
  const gridSize = Math.min(W, H) - 40;
  const cellSize = gridSize / 3;
  const ox = (W - gridSize) / 2;
  const oy = 10;

  // Header cells - Parent 2 alleles
  for (let c = 0; c < 2; c++) {
    const x = ox + cellSize + c * cellSize;
    const y = oy;
    ctx.fillStyle = '#1a1a1a';
    roundRect(ctx, x + 2, y + 2, cellSize - 4, cellSize - 4, 6);
    ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 20px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(p2Labels[c], x + cellSize / 2, y + cellSize / 2 + 7);
  }

  // Row headers - Parent 1 alleles
  for (let r = 0; r < 2; r++) {
    const x = ox;
    const y = oy + cellSize + r * cellSize;
    ctx.fillStyle = '#1a1a1a';
    roundRect(ctx, x + 2, y + 2, cellSize - 4, cellSize - 4, 6);
    ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 20px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(p1Labels[r], x + cellSize / 2, y + cellSize / 2 + 7);
  }

  // Offspring cells
  const outcomes = [];
  for (let r = 0; r < 2; r++) {
    for (let c = 0; c < 2; c++) {
      const a1 = p1[r], a2 = p2[c];
      const geno = [a1, a2].sort((x,y) => (x==='D'?0:1) - (y==='D'?0:1));
      const genoLabel = geno.map(a => a === 'D' ? L : L.toLowerCase()).join('');
      const type = geno[0] === 'D' && geno[1] === 'D' ? 'AA' : geno[0] === 'D' ? 'Aa' : 'aa';
      outcomes.push({ type, label: genoLabel });

      const x = ox + cellSize + c * cellSize;
      const y = oy + cellSize + r * cellSize;

      const colors = { AA: { bg: '#fce7f3', border: '#f9a8d4', text: '#9d174d' },
                       Aa: { bg: '#fef3c7', border: '#fcd34d', text: '#92400e' },
                       aa: { bg: '#dbeafe', border: '#93c5fd', text: '#1e40af' } };
      const clr = colors[type];

      ctx.fillStyle = clr.bg;
      roundRect(ctx, x + 2, y + 2, cellSize - 4, cellSize - 4, 6);
      ctx.fill();
      ctx.strokeStyle = clr.border; ctx.lineWidth = 2;
      roundRect(ctx, x + 2, y + 2, cellSize - 4, cellSize - 4, 6);
      ctx.stroke();

      ctx.fillStyle = clr.text; ctx.font = 'bold 20px system-ui'; ctx.textAlign = 'center';
      ctx.fillText(genoLabel, x + cellSize / 2, y + cellSize / 2 + 7);
    }
  }

  // Corner cell - x mark
  ctx.fillStyle = '#f8fafc';
  roundRect(ctx, ox + 2, oy + 2, cellSize - 4, cellSize - 4, 6);
  ctx.fill();
  ctx.fillStyle = '#9ca3af'; ctx.font = 'bold 16px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('\u2715', ox + cellSize / 2, oy + cellSize / 2 + 6);

  // Labels
  ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui';
  ctx.save(); ctx.translate(ox - 8, oy + cellSize + cellSize); ctx.rotate(-Math.PI/2);
  ctx.fillText('Parent 1', 0, 0); ctx.restore();
  ctx.fillText('Parent 2', ox + cellSize + cellSize / 2 + cellSize / 2, oy - 2);

  // Compute ratios
  const counts = { AA: 0, Aa: 0, aa: 0 };
  outcomes.forEach(o => counts[o.type]++);
  let ratioHtml = '';
  if (counts.AA > 0) ratioHtml += `<span class="badge badge-red">${counts.AA}/4 ${L}${L}</span> `;
  if (counts.Aa > 0) ratioHtml += `<span class="badge badge-amber">${counts.Aa}/4 ${L}${L.toLowerCase()}</span> `;
  if (counts.aa > 0) ratioHtml += `<span class="badge badge-blue">${counts.aa}/4 ${L.toLowerCase()}${L.toLowerCase()}</span> `;

  const domCount = counts.AA + counts.Aa;
  const recCount = counts.aa;
  ratioHtml += `<br><span style="font-size:12px;color:var(--text-muted);margin-top:4px;display:inline-block;">Phenotypic ratio: ${domCount} dominant : ${recCount} recessive</span>`;
  $('ps-ratios').innerHTML = ratioHtml;

  // Store expected ratios
  psData.expected = { dom: domCount / 4, rec: recCount / 4 };
}

function psSimulate(n) {
  const trait = TRAITS[$('ps-trait').value];
  const p1 = psGetAlleles($('ps-p1').value);
  const p2 = psGetAlleles($('ps-p2').value);

  for (let i = 0; i < n; i++) {
    const a1 = p1[Math.random() < 0.5 ? 0 : 1];
    const a2 = p2[Math.random() < 0.5 ? 0 : 1];
    if (a1 === 'D' || a2 === 'D') {
      psData.offspring.dom++;
    } else {
      psData.offspring.rec++;
    }
  }
  psUpdateStats();
}

function psReset() {
  psData.offspring = { dom: 0, het: 0, rec: 0 };
  psUpdateStats();
}

function psUpdateStats() {
  const total = psData.offspring.dom + psData.offspring.rec;
  $('ps-dom-count').textContent = psData.offspring.dom;
  $('ps-rec-count').textContent = psData.offspring.rec;
  $('ps-total').textContent = total;
  if (total > 0) {
    const r = psData.offspring.dom / psData.offspring.rec;
    $('ps-ratio-obs').textContent = isFinite(r) ? r.toFixed(2) + ':1' : 'All dom';
  } else {
    $('ps-ratio-obs').textContent = '-';
  }
  psDrawBarChart();
}

function psDrawBarChart() {
  const ctx = getCtx('ps-bar-chart');
  const total = psData.offspring.dom + psData.offspring.rec;
  if (!total) { ctx.clearRect(0, 0, ctx.W, ctx.H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, ctx.W, ctx.H); return; }

  const expDom = total * (psData.expected ? psData.expected.dom : 0.75);
  const expRec = total * (psData.expected ? psData.expected.rec : 0.25);

  drawBarChart(ctx, {
    labels: ['Dominant', 'Recessive'],
    values: [psData.offspring.dom, psData.offspring.rec],
    expected: [expDom, expRec],
    colors: ['#c41e3a', '#2563eb'],
    maxVal: Math.max(psData.offspring.dom, psData.offspring.rec, expDom) * 1.3
  });
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

// ══════════════════════════════════════════════════════════════════════════
// PART 2: HUMAN TRAIT SURVEY
// ══════════════════════════════════════════════════════════════════════════
let classData = null;

function buildTraitChecklist() {
  const list = $('trait-checklist');
  list.innerHTML = '';
  Object.entries(TRAITS).forEach(([key, t]) => {
    const li = document.createElement('li');
    li.innerHTML = `<input type="checkbox" id="chk-${key}" onchange="traitUpdateGenotypes()">
      <span class="trait-name">${t.name}</span>
      <span class="trait-dom">${t.dom}</span>
      <span class="trait-freq">${(t.freq * 100).toFixed(0)}%</span>`;
    list.appendChild(li);
  });
  traitUpdateGenotypes();
}

function traitUpdateGenotypes() {
  const container = $('trait-genotypes');
  let html = '';
  let domC = 0, recC = 0;

  Object.entries(TRAITS).forEach(([key, t]) => {
    const checked = document.getElementById('chk-' + key)?.checked;
    const L = t.letter;
    if (checked) {
      domC++;
      html += `<div class="analysis-result ar-pass" style="padding:10px;margin:4px 0;">
        <strong>${t.name}:</strong> Dominant phenotype &mdash; Genotype could be <code>${L}${L}</code> or <code>${L}${L.toLowerCase()}</code>
      </div>`;
    } else {
      recC++;
      html += `<div class="analysis-result" style="padding:10px;margin:4px 0;border-left-color:var(--amber);">
        <strong>${t.name}:</strong> Recessive phenotype &mdash; Genotype must be <code>${L.toLowerCase()}${L.toLowerCase()}</code>
      </div>`;
    }
  });

  container.innerHTML = html;
  $('trait-dom-count').textContent = domC;
  $('trait-rec-count').textContent = recC;
}

function traitSimClass(n) {
  classData = {};
  Object.entries(TRAITS).forEach(([key, t]) => {
    let domCount = 0;
    for (let i = 0; i < n; i++) {
      if (Math.random() < t.freq) domCount++;
    }
    classData[key] = { dom: domCount, rec: n - domCount, total: n };
  });
  drawTraitPopChart();
}

function traitResetClass() {
  classData = null;
  drawTraitPopChart();
}

function drawTraitPopChart() {
  const ctx = getCtx('trait-pop-chart');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  if (!classData) {
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Simulate a class to see population frequency data', W / 2, H / 2);
    return;
  }

  const keys = Object.keys(TRAITS);
  const labels = keys.map(k => TRAITS[k].name.split(' ')[0]);
  const simValues = keys.map(k => classData[k].dom / classData[k].total * 100);
  const expValues = keys.map(k => TRAITS[k].freq * 100);

  const pad = { top: 30, right: 20, bottom: 60, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const n = labels.length;
  const groupW = plotW / n;
  const barW = groupW * 0.35;

  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i / 4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((i * 25) + '%', pad.left - 6, y + 4);
  }

  labels.forEach((label, i) => {
    const cx = pad.left + groupW * i + groupW / 2;
    // Expected bar
    const eh = (expValues[i] / 100) * plotH;
    ctx.fillStyle = '#2563eb';
    ctx.fillRect(cx - barW - 1, pad.top + plotH - eh, barW, eh);
    // Simulated bar
    const sh = (simValues[i] / 100) * plotH;
    ctx.fillStyle = '#c41e3a';
    ctx.fillRect(cx + 1, pad.top + plotH - sh, barW, sh);
    // Label
    ctx.fillStyle = '#374151'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
    ctx.save(); ctx.translate(cx, H - pad.bottom + 12); ctx.rotate(-Math.PI / 6);
    ctx.fillText(label, 0, 0); ctx.restore();
  });

  // Legend
  ctx.fillStyle = '#2563eb'; ctx.fillRect(pad.left, 8, 12, 12);
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Expected Frequency', pad.left + 18, 18);
  ctx.fillStyle = '#c41e3a'; ctx.fillRect(pad.left + 150, 8, 12, 12);
  ctx.fillText('Simulated Class', pad.left + 168, 18);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 3: PEDIGREE ANALYZER
// ══════════════════════════════════════════════════════════════════════════
const PED_MEMBERS = [
  // Gen 1 (grandparents): indices 0-3
  { id: 0, gen: 0, sex: 'M', x: 0.25, y: 0.08, affected: false },
  { id: 1, gen: 0, sex: 'F', x: 0.38, y: 0.08, affected: false },
  { id: 2, gen: 0, sex: 'M', x: 0.62, y: 0.08, affected: false },
  { id: 3, gen: 0, sex: 'F', x: 0.75, y: 0.08, affected: false },
  // Gen 2 (parents): indices 4-7
  { id: 4, gen: 1, sex: 'M', x: 0.18, y: 0.40, affected: false },
  { id: 5, gen: 1, sex: 'F', x: 0.32, y: 0.40, affected: false },
  { id: 6, gen: 1, sex: 'M', x: 0.55, y: 0.40, affected: false },
  { id: 7, gen: 1, sex: 'F', x: 0.72, y: 0.40, affected: false },
  // Gen 3 (children): indices 8-13
  { id: 8, gen: 2, sex: 'M', x: 0.10, y: 0.75, affected: false },
  { id: 9, gen: 2, sex: 'F', x: 0.22, y: 0.75, affected: false },
  { id: 10, gen: 2, sex: 'M', x: 0.34, y: 0.75, affected: false },
  { id: 11, gen: 2, sex: 'F', x: 0.52, y: 0.75, affected: false },
  { id: 12, gen: 2, sex: 'M', x: 0.65, y: 0.75, affected: false },
  { id: 13, gen: 2, sex: 'F', x: 0.78, y: 0.75, affected: false },
];
// Couples: [male, female] pairs
const PED_COUPLES = [[0,1],[2,3],[4,5],[6,7]];
// Parent->child: [couple-index, child-index]
const PED_CHILDREN = [[0,[4,5]],[1,[6,7]],[2,[8,9,10]],[3,[11,12,13]]];

let pedPresetAnswer = '';

function pedDrawPedigree() {
  const ctx = getCtx('ped-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const R = 18;

  // Draw couple lines
  PED_COUPLES.forEach(([mi, fi]) => {
    const m = PED_MEMBERS[mi], f = PED_MEMBERS[fi];
    ctx.strokeStyle = '#374151'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(m.x * W + R, m.y * H + R); ctx.lineTo(f.x * W - R, f.y * H + R); ctx.stroke();
  });

  // Draw descent lines
  PED_CHILDREN.forEach(([ci, children]) => {
    const couple = PED_COUPLES[ci];
    const m = PED_MEMBERS[couple[0]], f = PED_MEMBERS[couple[1]];
    const midX = (m.x + f.x) / 2 * W;
    const parentY = m.y * H + R + R;
    const childY = PED_MEMBERS[children[0]].y * H - R + R;
    const midY = (parentY + childY) / 2;

    ctx.strokeStyle = '#374151'; ctx.lineWidth = 2;
    // Vertical from couple line down
    ctx.beginPath(); ctx.moveTo(midX, m.y * H + R); ctx.lineTo(midX, midY); ctx.stroke();

    // Horizontal line connecting children
    if (children.length > 1) {
      const leftX = PED_MEMBERS[children[0]].x * W;
      const rightX = PED_MEMBERS[children[children.length-1]].x * W;
      ctx.beginPath(); ctx.moveTo(leftX, midY); ctx.lineTo(rightX, midY); ctx.stroke();
    }

    // Vertical to each child
    children.forEach(childIdx => {
      const child = PED_MEMBERS[childIdx];
      ctx.beginPath(); ctx.moveTo(child.x * W, midY); ctx.lineTo(child.x * W, child.y * H - R + R); ctx.stroke();
    });
  });

  // Draw individuals
  PED_MEMBERS.forEach(p => {
    const cx = p.x * W, cy = p.y * H + R;

    if (p.sex === 'M') {
      // Square for males
      ctx.fillStyle = p.affected ? '#1a1a1a' : '#fff';
      ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 2.5;
      ctx.fillRect(cx - R, cy - R, R * 2, R * 2);
      ctx.strokeRect(cx - R, cy - R, R * 2, R * 2);
    } else {
      // Circle for females
      ctx.fillStyle = p.affected ? '#1a1a1a' : '#fff';
      ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 2.5;
      ctx.beginPath(); ctx.arc(cx, cy, R, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
    }

    // ID label
    ctx.fillStyle = p.affected ? '#fff' : '#9ca3af'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(p.id + 1, cx, cy + 4);
  });

  // Generation labels
  ctx.fillStyle = '#9ca3af'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('I', 8, PED_MEMBERS[0].y * H + R + 4);
  ctx.fillText('II', 8, PED_MEMBERS[4].y * H + R + 4);
  ctx.fillText('III', 8, PED_MEMBERS[8].y * H + R + 4);

  // Legend
  const ly = H - 30;
  ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 2; ctx.fillStyle = '#fff';
  ctx.fillRect(W - 200, ly, 16, 16); ctx.strokeRect(W - 200, ly, 16, 16);
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Unaffected Male', W - 180, ly + 12);
  ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(W - 100, ly + 8, 8, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
  ctx.fillStyle = '#374151'; ctx.fillText('Female', W - 88, ly + 12);

  ctx.fillStyle = '#1a1a1a';
  ctx.fillRect(W - 200, ly + 20, 16, 16); ctx.strokeRect(W - 200, ly + 20, 16, 16);
  ctx.fillStyle = '#374151'; ctx.fillText('Affected', W - 180, ly + 32);

  pedAnalyze();
}

function pedHandleClick(e) {
  const canvas = $('ped-canvas');
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / (window.devicePixelRatio || 1) / rect.width;
  const scaleY = canvas.height / (window.devicePixelRatio || 1) / rect.height;
  const mx = (e.clientX - rect.left) * scaleX;
  const my = (e.clientY - rect.top) * scaleY;
  const R = 18;

  const W = canvas.width / (window.devicePixelRatio || 1);
  const H = canvas.height / (window.devicePixelRatio || 1);

  PED_MEMBERS.forEach(p => {
    const cx = p.x * W, cy = p.y * H + R;
    const dx = mx - cx, dy = my - cy;
    if (Math.sqrt(dx*dx + dy*dy) < R + 5) {
      p.affected = !p.affected;
      $('ped-preset').value = 'custom';
      pedPresetAnswer = '';
      $('ped-reveal-btn').style.display = 'none';
      pedDrawPedigree();
    }
  });
}

function pedClearAll() {
  PED_MEMBERS.forEach(p => p.affected = false);
  $('ped-preset').value = 'custom';
  pedPresetAnswer = '';
  $('ped-reveal-btn').style.display = 'none';
  pedDrawPedigree();
}

function pedLoadPreset() {
  const v = $('ped-preset').value;
  PED_MEMBERS.forEach(p => p.affected = false);

  if (v === 'ad') {
    // Autosomal Dominant: affected appear in every generation
    [0, 5, 7, 8, 11, 13].forEach(i => PED_MEMBERS[i].affected = true);
    pedPresetAnswer = 'Autosomal Dominant';
  } else if (v === 'ar') {
    // Autosomal Recessive: carriers skip generations, affected only when both parents carry
    [9, 12].forEach(i => PED_MEMBERS[i].affected = true);
    pedPresetAnswer = 'Autosomal Recessive';
  } else if (v === 'xlr') {
    // X-linked Recessive: mostly males affected, carrier mothers
    [8, 10, 12].forEach(i => PED_MEMBERS[i].affected = true);
    pedPresetAnswer = 'X-Linked Recessive';
  } else if (v === 'xld') {
    // X-linked Dominant: affected females more common, all daughters of affected fathers
    [1, 5, 7, 9, 11, 13].forEach(i => PED_MEMBERS[i].affected = true);
    pedPresetAnswer = 'X-Linked Dominant';
  } else {
    pedPresetAnswer = '';
  }

  $('ped-reveal-btn').style.display = v !== 'custom' ? 'inline-flex' : 'none';
  pedDrawPedigree();
}

function pedRevealAnswer() {
  if (pedPresetAnswer) {
    $('ped-analysis').innerHTML = `<div class="analysis-result ar-pass">
      <div class="ar-title">Answer Revealed</div>
      <p>This pedigree demonstrates <strong>${pedPresetAnswer}</strong> inheritance.</p>
    </div>`;
  }
}

function pedAnalyze() {
  const affected = PED_MEMBERS.filter(p => p.affected);
  if (affected.length === 0) {
    $('ped-analysis').innerHTML = '<p style="font-size:13px;color:var(--text-muted);">Click individuals in the pedigree to toggle affected status, then view the analysis.</p>';
    return;
  }

  const affectedMales = affected.filter(p => p.sex === 'M').length;
  const affectedFemales = affected.filter(p => p.sex === 'F').length;
  const totalMales = PED_MEMBERS.filter(p => p.sex === 'M').length;
  const totalFemales = PED_MEMBERS.filter(p => p.sex === 'F').length;

  // Check generation patterns
  const gen0Affected = affected.filter(p => p.gen === 0).length;
  const gen1Affected = affected.filter(p => p.gen === 1).length;
  const gen2Affected = affected.filter(p => p.gen === 2).length;
  const skipsGen = (gen0Affected > 0 && gen1Affected === 0 && gen2Affected > 0) ||
                   (gen0Affected === 0 && gen1Affected > 0 && gen2Affected === 0);

  let scores = {
    'Autosomal Dominant': 0,
    'Autosomal Recessive': 0,
    'X-Linked Recessive': 0,
    'X-Linked Dominant': 0
  };

  // If every generation has affected -> dominant
  if (gen0Affected > 0 && gen1Affected > 0 && gen2Affected > 0) scores['Autosomal Dominant'] += 3;
  if (gen0Affected > 0 && gen2Affected > 0) scores['Autosomal Dominant'] += 1;

  // Skip generations -> recessive
  if (skipsGen) { scores['Autosomal Recessive'] += 3; scores['X-Linked Recessive'] += 2; }

  // More males affected -> X-linked recessive
  if (affectedMales > affectedFemales * 1.5) { scores['X-Linked Recessive'] += 3; }
  if (affectedMales > 0 && affectedFemales === 0) { scores['X-Linked Recessive'] += 4; }

  // More females affected -> X-linked dominant
  if (affectedFemales > affectedMales * 1.5) scores['X-Linked Dominant'] += 2;

  // Equal distribution -> autosomal
  if (Math.abs(affectedMales / totalMales - affectedFemales / totalFemales) < 0.2) {
    scores['Autosomal Dominant'] += 1;
    scores['Autosomal Recessive'] += 1;
  }

  // Affected in many -> dominant
  if (affected.length > PED_MEMBERS.length * 0.4) scores['Autosomal Dominant'] += 2;
  if (affected.length < PED_MEMBERS.length * 0.25) scores['Autosomal Recessive'] += 2;

  const best = Object.entries(scores).sort((a, b) => b[1] - a[1])[0];

  let html = `<div class="analysis-result">
    <div class="ar-title">Pattern Analysis</div>
    <p><strong>Affected:</strong> ${affectedMales} males, ${affectedFemales} females (${affected.length} total out of ${PED_MEMBERS.length})</p>
    <p><strong>Generations affected:</strong> ${[gen0Affected > 0 ? 'I' : '', gen1Affected > 0 ? 'II' : '', gen2Affected > 0 ? 'III' : ''].filter(Boolean).join(', ') || 'None'}</p>
    <p style="margin-top:8px;"><strong>Most likely pattern:</strong> <code>${best[0]}</code></p>
  </div>`;

  // Score breakdown
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">';
  Object.entries(scores).sort((a,b) => b[1] - a[1]).forEach(([name, score]) => {
    const maxScore = Math.max(...Object.values(scores)) || 1;
    const pct = (score / maxScore * 100).toFixed(0);
    html += `<div style="background:#f8fafc;padding:8px;border-radius:6px;border:1px solid var(--border);">
      <div style="font-size:12px;font-weight:600;">${name}</div>
      <div style="height:6px;background:#e5e7eb;border-radius:3px;margin-top:4px;">
        <div style="height:100%;background:${score === best[1] ? 'var(--accent)' : 'var(--blue)'};border-radius:3px;width:${pct}%;"></div>
      </div>
    </div>`;
  });
  html += '</div>';

  $('ped-analysis').innerHTML = html;
}

// ══════════════════════════════════════════════════════════════════════════
// PART 4: BLOOD TYPE INHERITANCE
// ══════════════════════════════════════════════════════════════════════════
const BT_ALLELES = {
  IAIA: ['IA','IA'], IAi: ['IA','i'], IBIB: ['IB','IB'], IBi: ['IB','i'], IAIB: ['IA','IB'], ii: ['i','i']
};
const BT_PHENOTYPE = {
  'IA,IA': 'A', 'IA,i': 'A', 'i,IA': 'A',
  'IB,IB': 'B', 'IB,i': 'B', 'i,IB': 'B',
  'IA,IB': 'AB', 'IB,IA': 'AB',
  'i,i': 'O'
};
const BT_COLORS = { A: '#c41e3a', B: '#2563eb', AB: '#7c3aed', O: '#16a34a' };
const BT_POP_FREQ = { 'O+': 37.4, 'A+': 35.7, 'B+': 8.5, 'AB+': 3.4, 'O-': 6.6, 'A-': 6.3, 'B-': 1.5, 'AB-': 0.6 };

function btUpdateCross() {
  const p1 = BT_ALLELES[$('bt-p1').value];
  const p2 = BT_ALLELES[$('bt-p2').value];

  // Draw Punnett square
  const ctx = getCtx('bt-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const gridSize = Math.min(W, H) - 40;
  const cellSize = gridSize / 3;
  const ox = (W - gridSize) / 2;
  const oy = 10;

  const formatAllele = a => a === 'IA' ? 'I^A' : a === 'IB' ? 'I^B' : 'i';

  // Header - Parent 2
  for (let c = 0; c < 2; c++) {
    const x = ox + cellSize + c * cellSize;
    ctx.fillStyle = '#1a1a1a';
    roundRect(ctx, x + 2, oy + 2, cellSize - 4, cellSize - 4, 6);
    ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 16px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(formatAllele(p2[c]), x + cellSize / 2, oy + cellSize / 2 + 6);
  }

  // Row headers - Parent 1
  for (let r = 0; r < 2; r++) {
    const y = oy + cellSize + r * cellSize;
    ctx.fillStyle = '#1a1a1a';
    roundRect(ctx, ox + 2, y + 2, cellSize - 4, cellSize - 4, 6);
    ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 16px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(formatAllele(p1[r]), ox + cellSize / 2, y + cellSize / 2 + 6);
  }

  // Corner
  ctx.fillStyle = '#f8fafc';
  roundRect(ctx, ox + 2, oy + 2, cellSize - 4, cellSize - 4, 6);
  ctx.fill();

  // Offspring cells
  const outcomes = {};
  for (let r = 0; r < 2; r++) {
    for (let c = 0; c < 2; c++) {
      const a1 = p1[r], a2 = p2[c];
      const key = [a1, a2].sort().join(',');
      const pheno = BT_PHENOTYPE[a1 + ',' + a2] || BT_PHENOTYPE[a2 + ',' + a1] || '?';
      outcomes[pheno] = (outcomes[pheno] || 0) + 1;

      const x = ox + cellSize + c * cellSize;
      const y = oy + cellSize + r * cellSize;
      const clr = BT_COLORS[pheno] || '#374151';

      ctx.fillStyle = clr + '22';
      roundRect(ctx, x + 2, y + 2, cellSize - 4, cellSize - 4, 6);
      ctx.fill();
      ctx.strokeStyle = clr; ctx.lineWidth = 2;
      roundRect(ctx, x + 2, y + 2, cellSize - 4, cellSize - 4, 6);
      ctx.stroke();

      ctx.fillStyle = clr; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
      const genoLabel = formatAllele(a1) + ' ' + formatAllele(a2);
      ctx.fillText(genoLabel, x + cellSize / 2, y + cellSize / 2);
      ctx.font = 'bold 16px system-ui';
      ctx.fillText('Type ' + pheno, x + cellSize / 2, y + cellSize / 2 + 18);
    }
  }

  // Ratios
  let ratioHtml = '';
  Object.entries(outcomes).forEach(([pheno, count]) => {
    const badgeClass = pheno === 'A' ? 'badge-red' : pheno === 'B' ? 'badge-blue' : pheno === 'AB' ? 'badge-purple' : 'badge-green';
    ratioHtml += `<span class="badge ${badgeClass}">${count}/4 Type ${pheno}</span> `;
  });
  $('bt-ratios').innerHTML = ratioHtml;

  // Stats
  let statsHtml = '';
  ['A', 'B', 'AB', 'O'].forEach(type => {
    const count = outcomes[type] || 0;
    const pct = (count / 4 * 100).toFixed(0);
    const colorClass = type === 'A' ? 'stat-accent' : type === 'B' ? 'stat-blue' : type === 'AB' ? 'stat-purple' : 'stat-green';
    statsHtml += `<div class="stat-box ${colorClass}"><div class="stat-val">${pct}%</div><div class="stat-label">Type ${type}</div></div>`;
  });
  $('bt-stats').innerHTML = statsHtml;

  // Paternity exclusion
  const p1Pheno = btGetPhenotype($('bt-p1').value);
  const p2Pheno = btGetPhenotype($('bt-p2').value);
  const possibleTypes = Object.keys(outcomes);
  const impossibleTypes = ['A','B','AB','O'].filter(t => !possibleTypes.includes(t));

  let patHtml = '<div class="analysis-result" style="border-left-color:var(--purple);">';
  patHtml += `<div class="ar-title">Paternity Exclusion</div>`;
  patHtml += `<p>Parents: Type ${p1Pheno} x Type ${p2Pheno}</p>`;
  patHtml += `<p>Possible offspring: <strong>${possibleTypes.join(', ')}</strong></p>`;
  if (impossibleTypes.length) {
    patHtml += `<p>Impossible offspring: <strong>${impossibleTypes.join(', ')}</strong> &mdash; could exclude paternity if child has these types.</p>`;
  } else {
    patHtml += `<p>All blood types are possible &mdash; cannot exclude paternity by blood type alone.</p>`;
  }
  patHtml += '</div>';
  $('bt-paternity').innerHTML = patHtml;
}

function btGetPhenotype(geno) {
  const a = BT_ALLELES[geno];
  return BT_PHENOTYPE[a[0] + ',' + a[1]] || BT_PHENOTYPE[a[1] + ',' + a[0]] || '?';
}

function buildCompatTable() {
  const types = ['O-','O+','A-','A+','B-','B+','AB-','AB+'];
  const antigens = {
    'O-': [], 'O+': ['D'], 'A-': ['A'], 'A+': ['A','D'], 'B-': ['B'], 'B+': ['B','D'], 'AB-': ['A','B'], 'AB+': ['A','B','D']
  };
  const antibodies = {
    'O-': ['A','B','D'], 'O+': ['A','B'], 'A-': ['B','D'], 'A+': ['B'], 'B-': ['A','D'], 'B+': ['A'], 'AB-': ['D'], 'AB+': []
  };

  const tbody = $('compat-tbody');
  tbody.innerHTML = '';
  types.forEach(recip => {
    let row = `<tr><th>${recip}</th>`;
    types.forEach(donor => {
      const donorAg = antigens[donor];
      const recipAb = antibodies[recip];
      const compatible = !donorAg.some(ag => recipAb.includes(ag));
      row += `<td class="${compatible ? 'compat-yes' : 'compat-no'}">${compatible ? '\u2713' : '\u2717'}</td>`;
    });
    row += '</tr>';
    tbody.innerHTML += row;
  });
}

function drawBtPopChart() {
  const ctx = getCtx('bt-pop-chart');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const types = Object.keys(BT_POP_FREQ);
  const values = Object.values(BT_POP_FREQ);
  const total = values.reduce((s, v) => s + v, 0);

  // Draw as pie chart
  const cx = W / 2, cy = H / 2 - 10;
  const R = Math.min(W, H) / 2 - 40;
  let startAngle = -Math.PI / 2;

  const pieColors = ['#16a34a','#22c55e','#c41e3a','#ef4444','#2563eb','#3b82f6','#7c3aed','#8b5cf6'];

  types.forEach((type, i) => {
    const sliceAngle = (values[i] / total) * Math.PI * 2;
    ctx.fillStyle = pieColors[i];
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, R, startAngle, startAngle + sliceAngle);
    ctx.closePath();
    ctx.fill();

    // Label
    const midAngle = startAngle + sliceAngle / 2;
    const labelR = R * 0.7;
    const lx = cx + Math.cos(midAngle) * labelR;
    const ly = cy + Math.sin(midAngle) * labelR;
    ctx.fillStyle = '#fff'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    if (values[i] > 3) {
      ctx.fillText(type, lx, ly - 2);
      ctx.font = '10px system-ui';
      ctx.fillText(values[i] + '%', lx, ly + 10);
    }

    startAngle += sliceAngle;
  });

  // Title
  ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('US Population Blood Type Distribution', W / 2, H - 8);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 5: SEX-LINKED TRAITS
// ══════════════════════════════════════════════════════════════════════════
let xlSimData = { sons_affected: 0, sons_normal: 0, daughters_affected: 0, daughters_carrier: 0, daughters_normal: 0 };

function xlGetAlleles(val) {
  if (val === 'XAXA') return ['XA','XA'];
  if (val === 'XAXa') return ['XA','Xa'];
  if (val === 'XaXa') return ['Xa','Xa'];
  if (val === 'XAY') return ['XA','Y'];
  return ['Xa','Y'];
}

function xlUpdateCross() {
  const mother = xlGetAlleles($('xl-mother').value);
  const father = xlGetAlleles($('xl-father').value);
  const trait = $('xl-trait').value;
  const traitName = trait === 'colorblind' ? 'Color Blindness' : 'Hemophilia';

  const ctx = getCtx('xl-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const gridSize = Math.min(W, H) - 40;
  const cellSize = gridSize / 3;
  const ox = (W - gridSize) / 2;
  const oy = 10;

  const formatXL = a => a === 'XA' ? 'X^A' : a === 'Xa' ? 'X^a' : 'Y';

  // Header - Father alleles
  for (let c = 0; c < 2; c++) {
    const x = ox + cellSize + c * cellSize;
    ctx.fillStyle = '#1a1a1a';
    roundRect(ctx, x + 2, oy + 2, cellSize - 4, cellSize - 4, 6);
    ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 16px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(formatXL(father[c]), x + cellSize / 2, oy + cellSize / 2 + 6);
  }

  // Row headers - Mother alleles
  for (let r = 0; r < 2; r++) {
    const y = oy + cellSize + r * cellSize;
    ctx.fillStyle = '#1a1a1a';
    roundRect(ctx, ox + 2, y + 2, cellSize - 4, cellSize - 4, 6);
    ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 16px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(formatXL(mother[r]), ox + cellSize / 2, y + cellSize / 2 + 6);
  }

  // Corner
  ctx.fillStyle = '#f8fafc';
  roundRect(ctx, ox + 2, oy + 2, cellSize - 4, cellSize - 4, 6);
  ctx.fill();

  // Offspring
  const outcomes = [];
  for (let r = 0; r < 2; r++) {
    for (let c = 0; c < 2; c++) {
      const a1 = mother[r], a2 = father[c];
      const isMale = a2 === 'Y';
      let status, bgColor, borderColor, textColor;

      if (isMale) {
        // Son: only has mother's X
        const affected = a1 === 'Xa';
        status = affected ? 'Affected Son' : 'Normal Son';
        bgColor = affected ? '#fef2f2' : '#f0fdf4';
        borderColor = affected ? '#fca5a5' : '#86efac';
        textColor = affected ? '#991b1b' : '#166534';
      } else {
        // Daughter
        const hasTwo_a = (a1 === 'Xa' && a2 === 'Xa');
        const carrier = (a1 === 'Xa' && a2 !== 'Xa') || (a2 === 'Xa' && a1 !== 'Xa');
        if (hasTwo_a) {
          status = 'Affected Daughter';
          bgColor = '#fef2f2'; borderColor = '#fca5a5'; textColor = '#991b1b';
        } else if (carrier) {
          status = 'Carrier Daughter';
          bgColor = '#fef3c7'; borderColor = '#fcd34d'; textColor = '#92400e';
        } else {
          status = 'Normal Daughter';
          bgColor = '#f0fdf4'; borderColor = '#86efac'; textColor = '#166534';
        }
      }

      outcomes.push(status);

      const x = ox + cellSize + c * cellSize;
      const y = oy + cellSize + r * cellSize;

      ctx.fillStyle = bgColor;
      roundRect(ctx, x + 2, y + 2, cellSize - 4, cellSize - 4, 6);
      ctx.fill();
      ctx.strokeStyle = borderColor; ctx.lineWidth = 2;
      roundRect(ctx, x + 2, y + 2, cellSize - 4, cellSize - 4, 6);
      ctx.stroke();

      ctx.fillStyle = textColor; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
      const genoLabel = formatXL(a1) + ' ' + formatXL(a2);
      ctx.fillText(genoLabel, x + cellSize / 2, y + cellSize / 2 - 4);
      ctx.font = '11px system-ui';
      ctx.fillText(status, x + cellSize / 2, y + cellSize / 2 + 14);
    }
  }

  // Labels
  ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText('Father', ox + cellSize * 2, oy - 2);
  ctx.save(); ctx.translate(ox - 8, oy + cellSize + cellSize); ctx.rotate(-Math.PI/2);
  ctx.fillText('Mother', 0, 0); ctx.restore();

  // Ratios
  const counts = {};
  outcomes.forEach(o => counts[o] = (counts[o] || 0) + 1);
  let ratioHtml = '';
  Object.entries(counts).forEach(([status, count]) => {
    const badge = status.includes('Affected') ? 'badge-red' : status.includes('Carrier') ? 'badge-amber' : 'badge-green';
    ratioHtml += `<span class="badge ${badge}">${count}/4 ${status}</span> `;
  });
  $('xl-ratios').innerHTML = ratioHtml;

  // Stats
  let statsHtml = '';
  Object.entries(counts).forEach(([status, count]) => {
    const pct = (count / 4 * 100).toFixed(0);
    const colorClass = status.includes('Affected') ? 'stat-accent' : status.includes('Carrier') ? 'stat-amber' : 'stat-green';
    statsHtml += `<div class="stat-box ${colorClass}"><div class="stat-val">${pct}%</div><div class="stat-label">${status}</div></div>`;
  });
  $('xl-stats').innerHTML = statsHtml;

  // Explanation
  const motherGeno = $('xl-mother').value;
  const fatherGeno = $('xl-father').value;
  let expHtml = '<div class="analysis-result" style="border-left-color:var(--purple);">';
  expHtml += `<div class="ar-title">Why Males Are More Affected</div>`;
  expHtml += `<p>Males have only <strong>one X chromosome</strong> (XY). A single recessive allele on their X will express the trait since there is no second X to mask it.</p>`;
  expHtml += `<p>Females have <strong>two X chromosomes</strong> (XX). They need two copies of the recessive allele to be affected. With one copy, they are unaffected <strong>carriers</strong>.</p>`;
  expHtml += '</div>';
  $('xl-explanation').innerHTML = expHtml;
}

function xlSimulate(n) {
  xlSimData = { sons_affected: 0, sons_normal: 0, daughters_affected: 0, daughters_carrier: 0, daughters_normal: 0 };
  const mother = xlGetAlleles($('xl-mother').value);
  const father = xlGetAlleles($('xl-father').value);

  for (let i = 0; i < n; i++) {
    const mAllele = mother[Math.random() < 0.5 ? 0 : 1];
    const fAllele = father[Math.random() < 0.5 ? 0 : 1];

    if (fAllele === 'Y') {
      // Son
      if (mAllele === 'Xa') xlSimData.sons_affected++;
      else xlSimData.sons_normal++;
    } else {
      // Daughter
      if (mAllele === 'Xa' && fAllele === 'Xa') xlSimData.daughters_affected++;
      else if (mAllele === 'Xa' || fAllele === 'Xa') xlSimData.daughters_carrier++;
      else xlSimData.daughters_normal++;
    }
  }
  drawXlSimChart();
}

function xlResetSim() {
  xlSimData = { sons_affected: 0, sons_normal: 0, daughters_affected: 0, daughters_carrier: 0, daughters_normal: 0 };
  drawXlSimChart();
}

function drawXlSimChart() {
  const ctx = getCtx('xl-sim-chart');
  const d = xlSimData;
  const total = d.sons_affected + d.sons_normal + d.daughters_affected + d.daughters_carrier + d.daughters_normal;

  if (!total) {
    ctx.clearRect(0, 0, ctx.W, ctx.H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, ctx.W, ctx.H);
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Simulate offspring to see results', ctx.W / 2, ctx.H / 2);
    return;
  }

  drawBarChart(ctx, {
    labels: ['Sons\nAffected', 'Sons\nNormal', 'Daughters\nAffected', 'Daughters\nCarrier', 'Daughters\nNormal'],
    values: [d.sons_affected, d.sons_normal, d.daughters_affected, d.daughters_carrier, d.daughters_normal],
    colors: ['#c41e3a', '#16a34a', '#c41e3a', '#d97706', '#16a34a'],
    maxVal: Math.max(d.sons_affected, d.sons_normal, d.daughters_affected, d.daughters_carrier, d.daughters_normal) * 1.3
  });
}

function drawRoyalPedigree() {
  const ctx = getCtx('xl-royal-chart');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const R = 14;

  // Royal family members
  const royals = [
    // Gen 1
    { name: 'Albert', sex: 'M', x: 0.35, y: 0.06, affected: false, carrier: false },
    { name: 'Victoria', sex: 'F', x: 0.50, y: 0.06, affected: false, carrier: true },
    // Gen 2
    { name: 'Edward VII', sex: 'M', x: 0.08, y: 0.35, affected: false, carrier: false },
    { name: 'Alice', sex: 'F', x: 0.24, y: 0.35, affected: false, carrier: true },
    { name: 'Leopold', sex: 'M', x: 0.42, y: 0.35, affected: true, carrier: false },
    { name: 'Beatrice', sex: 'F', x: 0.58, y: 0.35, affected: false, carrier: true },
    { name: 'Other children', sex: 'F', x: 0.80, y: 0.35, affected: false, carrier: false },
    // Gen 3
    { name: 'Alexandra', sex: 'F', x: 0.10, y: 0.68, affected: false, carrier: true },
    { name: 'Frederick', sex: 'M', x: 0.24, y: 0.68, affected: true, carrier: false },
    { name: 'Irene', sex: 'F', x: 0.38, y: 0.68, affected: false, carrier: true },
    { name: 'Alfonso', sex: 'M', x: 0.54, y: 0.68, affected: true, carrier: false },
    { name: 'Victoria E.', sex: 'F', x: 0.70, y: 0.68, affected: false, carrier: true },
    { name: 'Leopold', sex: 'M', x: 0.86, y: 0.68, affected: true, carrier: false },
  ];

  // Draw connections
  ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 1.5;
  // Victoria-Albert couple
  ctx.beginPath(); ctx.moveTo(0.35*W + R, 0.06*H + R); ctx.lineTo(0.50*W - R, 0.06*H + R); ctx.stroke();
  // Down to gen 2
  const midX1 = 0.425 * W;
  ctx.beginPath(); ctx.moveTo(midX1, 0.06*H + R); ctx.lineTo(midX1, 0.22*H); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0.08*W, 0.22*H); ctx.lineTo(0.80*W, 0.22*H); ctx.stroke();
  [0.08, 0.24, 0.42, 0.58, 0.80].forEach(x => {
    ctx.beginPath(); ctx.moveTo(x*W, 0.22*H); ctx.lineTo(x*W, 0.35*H - R + R); ctx.stroke();
  });

  // Alice's children
  ctx.beginPath(); ctx.moveTo(0.24*W, 0.35*H + R + R); ctx.lineTo(0.24*W, 0.52*H); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0.10*W, 0.52*H); ctx.lineTo(0.38*W, 0.52*H); ctx.stroke();
  [0.10, 0.24, 0.38].forEach(x => {
    ctx.beginPath(); ctx.moveTo(x*W, 0.52*H); ctx.lineTo(x*W, 0.68*H - R + R); ctx.stroke();
  });

  // Beatrice's children
  ctx.beginPath(); ctx.moveTo(0.58*W, 0.35*H + R + R); ctx.lineTo(0.58*W, 0.52*H); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0.54*W, 0.52*H); ctx.lineTo(0.86*W, 0.52*H); ctx.stroke();
  [0.54, 0.70, 0.86].forEach(x => {
    ctx.beginPath(); ctx.moveTo(x*W, 0.52*H); ctx.lineTo(x*W, 0.68*H - R + R); ctx.stroke();
  });

  // Draw individuals
  royals.forEach(p => {
    const cx = p.x * W, cy = p.y * H + R;

    if (p.sex === 'M') {
      ctx.fillStyle = p.affected ? '#1a1a1a' : '#fff';
      ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 2;
      ctx.fillRect(cx - R, cy - R, R * 2, R * 2);
      ctx.strokeRect(cx - R, cy - R, R * 2, R * 2);
    } else {
      ctx.fillStyle = p.affected ? '#1a1a1a' : '#fff';
      ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(cx, cy, R, 0, Math.PI * 2); ctx.fill(); ctx.stroke();

      // Carrier dot
      if (p.carrier) {
        ctx.fillStyle = '#1a1a1a';
        ctx.beginPath(); ctx.arc(cx, cy, R * 0.4, 0, Math.PI * 2); ctx.fill();
      }
    }

    // Name
    ctx.fillStyle = '#374151'; ctx.font = '9px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(p.name, cx, cy + R + 12);
  });

  // Legend
  ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillStyle = '#1a1a1a'; ctx.fillRect(10, H - 22, 12, 12); ctx.strokeRect(10, H - 22, 12, 12);
  ctx.fillStyle = '#374151'; ctx.fillText('Affected (hemophilia)', 28, H - 12);

  ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(170, H - 16, 6, 0, Math.PI * 2); ctx.fill();
  ctx.strokeStyle = '#1a1a1a'; ctx.stroke();
  ctx.fillStyle = '#1a1a1a'; ctx.beginPath(); ctx.arc(170, H - 16, 3, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#374151'; ctx.fillText('Carrier female', 182, H - 12);

  // Generation labels
  ctx.fillStyle = '#9ca3af'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('I', 4, 0.06*H + R + 4);
  ctx.fillText('II', 4, 0.35*H + R + 4);
  ctx.fillText('III', 4, 0.68*H + R + 4);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 6: GENETIC COUNSELING
// ══════════════════════════════════════════════════════════════════════════
const GC_SCENARIOS = [
  {
    id: 'cf',
    title: 'Cystic Fibrosis Risk',
    desc: 'Both partners are known carriers (heterozygous) for cystic fibrosis, an autosomal recessive condition.',
    inheritance: 'Autosomal Recessive',
    gene: 'CFTR',
    p1: ['C','c'], p2: ['C','c'],
    carrierFreq: '1 in 25 (Caucasian population)',
    diseaseFreq: '1 in 2,500 births',
    risk: { affected: 25, carrier: 50, unaffected: 25 }
  },
  {
    id: 'scd',
    title: 'Sickle Cell Disease',
    desc: 'Both partners carry the sickle cell trait (HbAS). What is the risk their child will have sickle cell disease?',
    inheritance: 'Autosomal Recessive (Codominant)',
    gene: 'HBB',
    p1: ['A','S'], p2: ['A','S'],
    carrierFreq: '1 in 12 (African American population)',
    diseaseFreq: '1 in 365 (African American births)',
    risk: { affected: 25, carrier: 50, unaffected: 25 }
  },
  {
    id: 'hd',
    title: "Huntington's Disease",
    desc: 'One partner has a parent diagnosed with Huntington\'s disease (autosomal dominant). They want to know the risk for their children.',
    inheritance: 'Autosomal Dominant',
    gene: 'HTT',
    p1: ['H','h'], p2: ['h','h'],
    carrierFreq: 'N/A (dominant)',
    diseaseFreq: '3-7 per 100,000',
    risk: { affected: 50, carrier: 0, unaffected: 50 }
  },
  {
    id: 'tsd',
    title: 'Tay-Sachs Disease',
    desc: 'Both partners are Ashkenazi Jewish and have been identified as carriers for Tay-Sachs disease.',
    inheritance: 'Autosomal Recessive',
    gene: 'HEXA',
    p1: ['T','t'], p2: ['T','t'],
    carrierFreq: '1 in 30 (Ashkenazi Jewish)',
    diseaseFreq: '1 in 3,600 (Ashkenazi Jewish)',
    risk: { affected: 25, carrier: 50, unaffected: 25 }
  },
  {
    id: 'pku',
    title: 'Phenylketonuria (PKU)',
    desc: 'A couple with no family history learns through newborn screening that they are both PKU carriers.',
    inheritance: 'Autosomal Recessive',
    gene: 'PAH',
    p1: ['P','p'], p2: ['P','p'],
    carrierFreq: '1 in 50',
    diseaseFreq: '1 in 10,000',
    risk: { affected: 25, carrier: 50, unaffected: 25 }
  }
];

function buildGCScenarios() {
  const container = $('gc-scenarios');
  container.innerHTML = '';
  GC_SCENARIOS.forEach(sc => {
    const div = document.createElement('div');
    div.className = 'scenario-card';
    div.innerHTML = `<div class="sc-title">${sc.title}</div><div class="sc-desc">${sc.desc}</div>`;
    div.onclick = () => loadGCScenario(sc.id);
    container.appendChild(div);
  });
}

function loadGCScenario(id) {
  const sc = GC_SCENARIOS.find(s => s.id === id);
  if (!sc) return;

  $('gc-workspace').style.display = 'block';
  $('gc-title').textContent = sc.title;
  $('gc-description').innerHTML = `<p>${sc.desc}</p>
    <p style="margin-top:8px;font-size:13px;"><strong>Inheritance:</strong> ${sc.inheritance} | <strong>Gene:</strong> ${sc.gene}</p>`;

  // Draw Punnett square
  const ctx = getCtx('gc-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const gridSize = Math.min(W, H) - 40;
  const cellSize = gridSize / 3;
  const ox = (W - gridSize) / 2;
  const oy = 10;

  // Headers
  for (let c = 0; c < 2; c++) {
    const x = ox + cellSize + c * cellSize;
    ctx.fillStyle = '#1a1a1a';
    roundRect(ctx, x + 2, oy + 2, cellSize - 4, cellSize - 4, 6);
    ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 20px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(sc.p2[c], x + cellSize / 2, oy + cellSize / 2 + 7);
  }
  for (let r = 0; r < 2; r++) {
    const y = oy + cellSize + r * cellSize;
    ctx.fillStyle = '#1a1a1a';
    roundRect(ctx, ox + 2, y + 2, cellSize - 4, cellSize - 4, 6);
    ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 20px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(sc.p1[r], ox + cellSize / 2, y + cellSize / 2 + 7);
  }
  ctx.fillStyle = '#f8fafc';
  roundRect(ctx, ox + 2, oy + 2, cellSize - 4, cellSize - 4, 6);
  ctx.fill();

  // Offspring
  for (let r = 0; r < 2; r++) {
    for (let c = 0; c < 2; c++) {
      const a1 = sc.p1[r], a2 = sc.p2[c];
      const isUpper1 = a1 === a1.toUpperCase();
      const isUpper2 = a2 === a2.toUpperCase();
      const genoParts = [a1, a2].sort((x, y) => (x === x.toUpperCase() ? 0 : 1) - (y === y.toUpperCase() ? 0 : 1));
      const genoLabel = genoParts.join('');

      let type, bg, border, text;
      if (isUpper1 && isUpper2) {
        type = 'Homozygous'; bg = '#fce7f3'; border = '#f9a8d4'; text = '#9d174d';
      } else if (isUpper1 || isUpper2) {
        type = 'Carrier'; bg = '#fef3c7'; border = '#fcd34d'; text = '#92400e';
      } else {
        type = 'Affected'; bg = '#fef2f2'; border = '#fca5a5'; text = '#991b1b';
      }

      // For dominant diseases (Huntington's), flip logic
      if (sc.inheritance === 'Autosomal Dominant') {
        if (isUpper1 || isUpper2) {
          // H present = affected for Huntington's
          if (a1 === 'H' || a2 === 'H') {
            type = 'Affected'; bg = '#fef2f2'; border = '#fca5a5'; text = '#991b1b';
          }
        }
        if (!isUpper1 && !isUpper2) {
          type = 'Unaffected'; bg = '#f0fdf4'; border = '#86efac'; text = '#166534';
        }
        if ((a1 === 'H' && a2 === 'H') || (a1 === 'h' && a2 === 'h')) {
          // HH or hh
          if (a1 === 'H') {
            type = 'Affected (HH)'; bg = '#fef2f2'; border = '#fca5a5'; text = '#991b1b';
          } else {
            type = 'Unaffected'; bg = '#f0fdf4'; border = '#86efac'; text = '#166534';
          }
        }
      }

      const x = ox + cellSize + c * cellSize;
      const y = oy + cellSize + r * cellSize;

      ctx.fillStyle = bg;
      roundRect(ctx, x + 2, y + 2, cellSize - 4, cellSize - 4, 6);
      ctx.fill();
      ctx.strokeStyle = border; ctx.lineWidth = 2;
      roundRect(ctx, x + 2, y + 2, cellSize - 4, cellSize - 4, 6);
      ctx.stroke();

      ctx.fillStyle = text; ctx.font = 'bold 18px system-ui'; ctx.textAlign = 'center';
      ctx.fillText(genoLabel, x + cellSize / 2, y + cellSize / 2);
      ctx.font = '11px system-ui';
      ctx.fillText(type, x + cellSize / 2, y + cellSize / 2 + 18);
    }
  }

  // Risk assessment
  let riskHtml = `<div class="analysis-result ${sc.risk.affected >= 50 ? 'ar-fail' : 'ar-pass'}">
    <div class="ar-title">Risk Assessment for Each Pregnancy</div>
    <p><strong>${sc.risk.affected}%</strong> chance of having an affected child</p>`;
  if (sc.risk.carrier > 0) {
    riskHtml += `<p><strong>${sc.risk.carrier}%</strong> chance of having a carrier child</p>`;
  }
  riskHtml += `<p><strong>${sc.risk.unaffected}%</strong> chance of having an unaffected child</p>
    <p style="margin-top:6px;font-size:12px;color:var(--text-muted);">Note: Each pregnancy is an independent event. These probabilities apply to <em>each</em> child separately.</p>
  </div>`;
  $('gc-risk').innerHTML = riskHtml;

  // Stats
  let statsHtml = '';
  statsHtml += `<div class="stat-box stat-accent"><div class="stat-val">${sc.risk.affected}%</div><div class="stat-label">Affected</div></div>`;
  if (sc.risk.carrier > 0) {
    statsHtml += `<div class="stat-box stat-amber"><div class="stat-val">${sc.risk.carrier}%</div><div class="stat-label">Carrier</div></div>`;
  }
  statsHtml += `<div class="stat-box stat-green"><div class="stat-val">${sc.risk.unaffected}%</div><div class="stat-label">Unaffected</div></div>`;
  $('gc-stats').innerHTML = statsHtml;

  // Population data
  let popHtml = `<div class="analysis-result" style="border-left-color:var(--purple);">
    <div class="ar-title">Population Data</div>
    <p><strong>Carrier frequency:</strong> ${sc.carrierFreq}</p>
    <p><strong>Disease frequency:</strong> ${sc.diseaseFreq}</p>
  </div>`;
  $('gc-population').innerHTML = popHtml;

  // Scroll to workspace
  $('gc-workspace').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ══════════════════════════════════════════════════════════════════════════
// SIDEBAR SCROLL HIGHLIGHT
// ══════════════════════════════════════════════════════════════════════════
function updateSidebar() {
  const sections = document.querySelectorAll('.section, .hero');
  const links = document.querySelectorAll('.sidebar-nav a');
  let current = '';
  sections.forEach(s => {
    if (window.scrollY >= s.offsetTop - 100) current = s.id;
  });
  links.forEach(a => {
    a.classList.toggle('active', a.getAttribute('href') === '#' + current);
  });
}
window.addEventListener('scroll', updateSidebar);

// ══════════════════════════════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════════════════════════════
window.addEventListener('DOMContentLoaded', () => {
  // Part 1
  psUpdateTrait();
  psDrawPunnett();

  // Part 2
  buildTraitChecklist();
  drawTraitPopChart();

  // Part 3
  pedDrawPedigree();
  $('ped-canvas').addEventListener('click', pedHandleClick);

  // Part 4
  btUpdateCross();
  buildCompatTable();
  drawBtPopChart();

  // Part 5
  xlUpdateCross();
  drawXlSimChart();
  drawRoyalPedigree();

  // Part 6
  buildGCScenarios();
});

window.addEventListener('resize', () => {
  psDrawPunnett(); psDrawBarChart();
  drawTraitPopChart();
  pedDrawPedigree();
  btUpdateCross(); drawBtPopChart();
  xlUpdateCross(); drawXlSimChart(); drawRoyalPedigree();
});
</script>
</body>
</html>
