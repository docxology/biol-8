<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 15 Dashboard: Respiratory System | BIOL-8</title>
<style>
/* ═══════════════════════════════════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f0f2f5; --card: #ffffff; --sidebar: #1a1a2e; --sidebar-hover: #252545;
  --accent: #c41e3a; --accent-light: #e8354f; --blue: #2563eb; --blue-light: #3b82f6;
  --green: #16a34a; --amber: #d97706; --purple: #7c3aed;
  --text: #1a1a1a; --text-muted: #6b7280; --border: #e5e7eb;
  --radius: 10px; --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
}
html { scroll-behavior: smooth; }
body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; }

/* ═══════════════════════════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════════════════════════ */
.layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; background: var(--sidebar); color: #e2e8f0; position: fixed;
  top: 0; left: 0; height: 100vh; overflow-y: auto; z-index: 100;
  display: flex; flex-direction: column;
}
.sidebar-header { padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-header h1 { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
.sidebar-header p { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.sidebar-nav { flex: 1; padding: 12px 0; }
.sidebar-nav a {
  display: flex; align-items: center; gap: 10px; padding: 10px 20px;
  color: #94a3b8; text-decoration: none; font-size: 13px; font-weight: 500;
  transition: all 0.15s; border-left: 3px solid transparent;
}
.sidebar-nav a:hover { background: var(--sidebar-hover); color: #e2e8f0; }
.sidebar-nav a.active { color: #fff; background: var(--sidebar-hover); border-left-color: var(--accent); }
.sidebar-nav .nav-num {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 6px; font-size: 11px; font-weight: 700;
  background: rgba(255,255,255,0.08); flex-shrink: 0;
}
.sidebar-nav a.active .nav-num { background: var(--accent); color: #fff; }
.sidebar-footer { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #64748b; }

.main { margin-left: 260px; flex: 1; padding: 32px; max-width: 1200px; }

/* ═══════════════════════════════════════════════════════════════════════
   CARDS & SECTIONS
   ═══════════════════════════════════════════════════════════════════════ */
.section { margin-bottom: 40px; scroll-margin-top: 24px; }
.section-header {
  display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
}
.section-num {
  display: flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: 10px;
  background: var(--accent); color: #fff; font-weight: 800; font-size: 16px; flex-shrink: 0;
}
.section-title { font-size: 22px; font-weight: 700; }
.section-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

.card {
  background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 24px; margin-bottom: 16px; border: 1px solid var(--border);
}
.card-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.card-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
@media (max-width: 900px) { .card-row, .card-row-3 { grid-template-columns: 1fr; } }

/* ═══════════════════════════════════════════════════════════════════════
   BUTTONS & INPUTS
   ═══════════════════════════════════════════════════════════════════════ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
  border: none; cursor: pointer; transition: all 0.15s; font-family: var(--font);
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn-secondary { background: var(--blue); color: #fff; }
.btn-secondary:hover { background: var(--blue-light); }
.btn-outline { background: transparent; color: var(--text); border: 2px solid var(--border); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }

.slider-group { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
.slider-group label { font-size: 13px; font-weight: 600; min-width: 80px; }
.slider-group input[type=range] { flex: 1; accent-color: var(--accent); }
.slider-val { font-family: var(--mono); font-size: 14px; font-weight: 700; min-width: 50px; text-align: right; }

/* ═══════════════════════════════════════════════════════════════════════
   STATS & BADGES
   ═══════════════════════════════════════════════════════════════════════ */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 12px 0; }
.stat-box {
  text-align: center; padding: 14px 8px; border-radius: 8px;
  background: #f8fafc; border: 1px solid var(--border);
}
.stat-box .stat-val { font-size: 28px; font-weight: 800; font-family: var(--mono); }
.stat-box .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-accent .stat-val { color: var(--accent); }
.stat-blue .stat-val { color: var(--blue); }
.stat-green .stat-val { color: var(--green); }
.stat-amber .stat-val { color: var(--amber); }
.stat-purple .stat-val { color: var(--purple); }

.badge {
  display: inline-block; padding: 2px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
}
.badge-red { background: #fef2f2; color: var(--accent); }
.badge-blue { background: #eff6ff; color: var(--blue); }
.badge-green { background: #f0fdf4; color: var(--green); }

/* ═══════════════════════════════════════════════════════════════════════
   CHART CONTAINERS
   ═══════════════════════════════════════════════════════════════════════ */
.chart-wrap { position: relative; width: 100%; margin: 8px 0; }
.chart-wrap canvas { width: 100% !important; display: block; border-radius: 6px; }

/* ═══════════════════════════════════════════════════════════════════════
   ANALYSIS PANEL
   ═══════════════════════════════════════════════════════════════════════ */
.analysis-result {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--blue); font-size: 14px;
}
.analysis-result .ar-title { font-weight: 700; margin-bottom: 6px; }
.analysis-result code { font-family: var(--mono); background: #e2e8f0; padding: 1px 6px; border-radius: 4px; font-size: 13px; }
.analysis-result.ar-pass { border-left-color: var(--green); }
.analysis-result.ar-fail { border-left-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   HERO BANNER
   ═══════════════════════════════════════════════════════════════════════ */
.hero {
  background: linear-gradient(135deg, #1a1a2e 0%, #2d1b3d 50%, #3b1a2e 100%);
  color: #fff; border-radius: var(--radius); padding: 36px; margin-bottom: 32px;
  position: relative; overflow: hidden;
}
.hero::after {
  content: ''; position: absolute; top: -50%; right: -20%; width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(196,30,58,0.15) 0%, transparent 70%);
  pointer-events: none;
}
.hero h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.hero p { font-size: 15px; color: #cbd5e1; max-width: 600px; line-height: 1.7; }
.hero .bio-tags { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
.hero .bio-tag {
  padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
  background: rgba(255,255,255,0.1); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);
}

/* ═══════════════════════════════════════════════════════════════════════
   CONVERGENCE LINE
   ═══════════════════════════════════════════════════════════════════════ */
.convergence-info { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin: 10px 0; font-size: 13px; }
.convergence-info .ci-dot { width: 12px; height: 3px; border-radius: 2px; display: inline-block; }

/* ═══════════════════════════════════════════════════════════════════════
   RESPIRATORY-SPECIFIC: CONDITION CARDS
   ═══════════════════════════════════════════════════════════════════════ */
.condition-tabs { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 16px; }
.condition-tab {
  padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600;
  border: 2px solid var(--border); background: #fff; cursor: pointer; transition: all 0.15s;
}
.condition-tab:hover { border-color: var(--accent); color: var(--accent); }
.condition-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main { margin-left: 0; padding: 16px; }
}
</style>
</head>
<body>
<div class="layout">

<!-- ═══════════════════════════════════════════════════════════════════════
     SIDEBAR
     ═══════════════════════════════════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h1>BIOL-8: Human Biology</h1>
    <p>Lab 15 &mdash; Respiratory System</p>
  </div>
  <nav class="sidebar-nav">
    <a href="#hero" class="active"><span class="nav-num">&bull;</span> Overview</a>
    <a href="#part1"><span class="nav-num">1</span> Anatomy Explorer</a>
    <a href="#part2"><span class="nav-num">2</span> Breathing Mechanics</a>
    <a href="#part3"><span class="nav-num">3</span> Lung Volumes</a>
    <a href="#part4"><span class="nav-num">4</span> Gas Exchange</a>
    <a href="#part5"><span class="nav-num">5</span> Breathing Rate</a>
    <a href="#part6"><span class="nav-num">6</span> Respiratory Health</a>
  </nav>
  <div class="sidebar-footer">Interactive Lab Dashboard<br>&copy; 2026 BIOL-8</div>
</aside>

<!-- ═══════════════════════════════════════════════════════════════════════
     MAIN CONTENT
     ═══════════════════════════════════════════════════════════════════════ -->
<div class="main">

<!-- HERO -->
<div class="hero" id="hero">
  <h2>Respiratory System</h2>
  <p>Explore lung anatomy, breathing mechanics, gas exchange, and respiratory physiology through interactive simulations. Measure lung volumes, investigate breathing rate factors, and understand respiratory health conditions.</p>
  <div class="bio-tags">
    <span class="bio-tag">Lungs</span>
    <span class="bio-tag">Gas Exchange</span>
    <span class="bio-tag">Breathing</span>
  </div>
</div>

<!-- ═══════════════════════════════ PART 1: ANATOMY EXPLORER ═══════════════════════════════ -->
<div class="section" id="part1">
  <div class="section-header">
    <div class="section-num">1</div>
    <div><div class="section-title">Respiratory Anatomy Explorer</div>
    <div class="section-subtitle">Click structures to learn about their function and clinical relevance</div></div>
  </div>
  <div class="card">
    <div class="card-title">Respiratory Tract &mdash; Click any structure</div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="anatomyZoom('gross')">Gross Anatomy</button>
      <button class="btn btn-secondary" onclick="anatomyZoom('alveolar')">Alveolar Level</button>
      <button class="btn btn-outline" onclick="anatomyReset()">Reset</button>
    </div>
    <div class="chart-wrap"><canvas id="anatomy-canvas" height="500"></canvas></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val">70 m&sup2;</div><div class="stat-label">Gas Exchange Area</div></div>
      <div class="stat-box stat-blue"><div class="stat-val">~300M</div><div class="stat-label">Alveoli Count</div></div>
      <div class="stat-box stat-green"><div class="stat-val">0.5 &mu;m</div><div class="stat-label">Membrane Thickness</div></div>
      <div class="stat-box stat-amber"><div class="stat-val">2,400 km</div><div class="stat-label">Total Airway Length</div></div>
    </div>
  </div>
  <div class="card" id="anatomy-info-card">
    <div class="card-title" id="anatomy-info-title">Select a Structure</div>
    <p id="anatomy-info-function" style="font-size:14px;margin-bottom:8px;">Click on any structure in the diagram above to learn about its function.</p>
    <div id="anatomy-info-clinical" class="analysis-result" style="display:none;">
      <div class="ar-title">Clinical Note</div>
      <p id="anatomy-info-clinical-text"></p>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════ PART 2: BREATHING MECHANICS ═══════════════════════════════ -->
<div class="section" id="part2">
  <div class="section-header">
    <div class="section-num">2</div>
    <div><div class="section-title">Breathing Mechanics Model</div>
    <div class="section-subtitle">Visualize Boyle's Law in action: pressure, volume, and airflow</div></div>
  </div>
  <div class="card">
    <div class="card-title">Bell Jar Model &mdash; Diaphragm and Lung Simulation</div>
    <div class="btn-group">
      <button class="btn btn-primary" id="breathe-btn" onclick="toggleBreathing()">Start Breathing</button>
      <button class="btn btn-secondary" onclick="toggleBreathMode()">Toggle: Quiet / Forced</button>
      <button class="btn btn-outline" onclick="breathReset()">Reset</button>
    </div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:8px;" id="breath-mode-label">Mode: <strong>Quiet Breathing</strong></p>
    <div class="chart-wrap"><canvas id="belljar-canvas" height="420"></canvas></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="bj-pressure">760</div><div class="stat-label">Intrapulmonary (mmHg)</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="bj-volume">2.5</div><div class="stat-label">Lung Volume (L)</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="bj-phase">Rest</div><div class="stat-label">Phase</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="bj-flow">0</div><div class="stat-label">Airflow (L/s)</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Pressure &amp; Volume Over Time</div>
    <div class="convergence-info">
      <span><span class="ci-dot" style="background:var(--accent);"></span> Intrapulmonary Pressure</span>
      <span><span class="ci-dot" style="background:var(--blue);"></span> Lung Volume</span>
      <span><span class="ci-dot" style="background:#9ca3af;"></span> Atmospheric (760 mmHg)</span>
    </div>
    <div class="chart-wrap"><canvas id="pv-chart" height="240"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════════════ PART 3: LUNG VOLUMES ═══════════════════════════════ -->
<div class="section" id="part3">
  <div class="section-header">
    <div class="section-num">3</div>
    <div><div class="section-title">Lung Volumes &amp; Capacities</div>
    <div class="section-subtitle">Interactive spirometry trace with personal estimation</div></div>
  </div>
  <div class="card">
    <div class="card-title">Spirometry Trace</div>
    <div class="chart-wrap"><canvas id="spirometry-canvas" height="360"></canvas></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="sp-tv">500</div><div class="stat-label">TV (mL)</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="sp-irv">3100</div><div class="stat-label">IRV (mL)</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="sp-erv">1200</div><div class="stat-label">ERV (mL)</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="sp-rv">1200</div><div class="stat-label">RV (mL)</div></div>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-purple"><div class="stat-val" id="sp-vc">4800</div><div class="stat-label">VC (mL)</div></div>
      <div class="stat-box stat-accent"><div class="stat-val" id="sp-tlc">6000</div><div class="stat-label">TLC (mL)</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="sp-frc">2400</div><div class="stat-label">FRC (mL)</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="sp-ic">3600</div><div class="stat-label">IC (mL)</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Estimate Your Lung Volumes</div>
    <div class="slider-group">
      <label>Height (cm)</label>
      <input type="range" id="sp-height" min="140" max="210" value="170" oninput="updatePersonal()">
      <span class="slider-val" id="sp-height-val">170</span>
    </div>
    <div class="slider-group">
      <label>Age (years)</label>
      <input type="range" id="sp-age" min="15" max="80" value="25" oninput="updatePersonal()">
      <span class="slider-val" id="sp-age-val">25</span>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="setPersonalSex('M')">Male</button>
      <button class="btn btn-secondary" onclick="setPersonalSex('F')">Female</button>
    </div>
    <p style="font-size:13px;color:var(--text-muted);" id="personal-result">Adjust parameters and select sex to estimate your vital capacity.</p>
  </div>
  <div class="card">
    <div class="card-title">Comparison &mdash; Male vs Female, Athlete vs Sedentary</div>
    <div class="chart-wrap"><canvas id="comparison-chart" height="280"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════════════ PART 4: GAS EXCHANGE ═══════════════════════════════ -->
<div class="section" id="part4">
  <div class="section-header">
    <div class="section-num">4</div>
    <div><div class="section-title">Gas Exchange at the Alveoli</div>
    <div class="section-subtitle">Diffusion, partial pressures, and the O2-hemoglobin dissociation curve</div></div>
  </div>
  <div class="card">
    <div class="card-title">Alveolar-Capillary Gas Exchange</div>
    <div class="btn-group">
      <button class="btn btn-primary" id="gas-anim-btn" onclick="toggleGasAnim()">Start Animation</button>
      <button class="btn btn-outline" onclick="gasReset()">Reset</button>
    </div>
    <div class="chart-wrap"><canvas id="gas-exchange-canvas" height="400"></canvas></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val">104</div><div class="stat-label">Alveolar PO2 (mmHg)</div></div>
      <div class="stat-box stat-blue"><div class="stat-val">40</div><div class="stat-label">Venous PO2 (mmHg)</div></div>
      <div class="stat-box stat-green"><div class="stat-val">40</div><div class="stat-label">Alveolar PCO2 (mmHg)</div></div>
      <div class="stat-box stat-amber"><div class="stat-val">45</div><div class="stat-label">Venous PCO2 (mmHg)</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">O2-Hemoglobin Dissociation Curve (Bohr Effect)</div>
    <div class="slider-group">
      <label>pH</label>
      <input type="range" id="oxy-ph" min="700" max="760" value="740" oninput="updateOxyCurve()">
      <span class="slider-val" id="oxy-ph-val">7.40</span>
    </div>
    <div class="slider-group">
      <label>Temp (&deg;C)</label>
      <input type="range" id="oxy-temp" min="33" max="43" value="37" oninput="updateOxyCurve()">
      <span class="slider-val" id="oxy-temp-val">37</span>
    </div>
    <div class="slider-group">
      <label>2,3-BPG</label>
      <input type="range" id="oxy-bpg" min="0" max="100" value="50" oninput="updateOxyCurve()">
      <span class="slider-val" id="oxy-bpg-val">Normal</span>
    </div>
    <div class="chart-wrap"><canvas id="oxy-curve-canvas" height="320"></canvas></div>
    <div id="bohr-explanation" class="analysis-result ar-pass">
      <div class="ar-title">Bohr Effect</div>
      <p>At normal physiological conditions (pH 7.40, 37&deg;C), hemoglobin has standard O2 affinity. Decreasing pH, increasing temperature, or increasing 2,3-BPG shifts the curve right, promoting O2 unloading at tissues.</p>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════ PART 5: BREATHING RATE ═══════════════════════════════ -->
<div class="section" id="part5">
  <div class="section-header">
    <div class="section-num">5</div>
    <div><div class="section-title">Breathing Rate Experiment</div>
    <div class="section-subtitle">Measure breathing rate under different physiological conditions</div></div>
  </div>
  <div class="card">
    <div class="card-title">Condition Simulator</div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="setBreathCondition('rest')">Rest</button>
      <button class="btn btn-secondary" onclick="setBreathCondition('exercise')">Light Exercise</button>
      <button class="btn btn-secondary" onclick="setBreathCondition('hold')">Breath Holding</button>
      <button class="btn btn-secondary" onclick="setBreathCondition('hyper')">Hyperventilation</button>
      <button class="btn btn-secondary" onclick="setBreathCondition('co2')">CO2 Rebreathing</button>
      <button class="btn btn-outline" onclick="breathExpReset()">Reset</button>
    </div>
    <div class="chart-wrap"><canvas id="chest-canvas" height="200"></canvas></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="br-rate">12</div><div class="stat-label">Breaths/min</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="br-co2">40</div><div class="stat-label">Blood CO2 (mmHg)</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="br-ph">7.40</div><div class="stat-label">Blood pH</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="br-condition">Rest</div><div class="stat-label">Condition</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Breathing Rate Over Time</div>
    <div class="convergence-info">
      <span><span class="ci-dot" style="background:var(--accent);"></span> Breaths/min</span>
      <span><span class="ci-dot" style="background:var(--blue);"></span> CO2 Level</span>
      <span><span class="ci-dot" style="background:var(--green);"></span> Blood pH</span>
    </div>
    <div class="chart-wrap"><canvas id="br-chart" height="260"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Chemoreceptor Response</div>
    <div id="chemo-explanation" class="analysis-result ar-pass">
      <div class="ar-title">Neural Control of Breathing</div>
      <p>Central chemoreceptors in the medulla detect changes in CSF pH (caused by CO2). Peripheral chemoreceptors (carotid and aortic bodies) detect drops in PO2, rises in PCO2, and drops in pH. Increased CO2 is the primary stimulus for increased ventilation.</p>
    </div>
    <div class="chart-wrap"><canvas id="chemo-canvas" height="220"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════════════ PART 6: RESPIRATORY HEALTH ═══════════════════════════════ -->
<div class="section" id="part6">
  <div class="section-header">
    <div class="section-num">6</div>
    <div><div class="section-title">Respiratory Health Dashboard</div>
    <div class="section-subtitle">Common respiratory conditions and smoking cessation timeline</div></div>
  </div>
  <div class="card">
    <div class="card-title">Respiratory Conditions</div>
    <div class="condition-tabs" id="condition-tabs">
      <div class="condition-tab active" onclick="selectCondition('asthma')">Asthma</div>
      <div class="condition-tab" onclick="selectCondition('copd')">COPD/Emphysema</div>
      <div class="condition-tab" onclick="selectCondition('pneumonia')">Pneumonia</div>
      <div class="condition-tab" onclick="selectCondition('covid')">COVID-19</div>
    </div>
    <div class="card-row">
      <div>
        <div class="chart-wrap"><canvas id="condition-canvas" height="300"></canvas></div>
      </div>
      <div>
        <h4 id="cond-title" style="font-size:16px;font-weight:700;margin-bottom:8px;">Asthma</h4>
        <p id="cond-desc" style="font-size:14px;margin-bottom:12px;"></p>
        <div id="cond-treatment" class="analysis-result ar-pass">
          <div class="ar-title">Treatment</div>
          <p id="cond-treatment-text"></p>
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Spirometry Pattern &mdash; Normal vs Disease</div>
    <div class="chart-wrap"><canvas id="spiro-disease-canvas" height="260"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Smoking Cessation Timeline</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Health improvements after quitting smoking, from hours to years.</p>
    <div class="chart-wrap"><canvas id="smoking-canvas" height="320"></canvas></div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /layout -->

<!-- ═══════════════════════════════════════════════════════════════════════
     JAVASCRIPT ENGINE
     ═══════════════════════════════════════════════════════════════════════ -->
<script>
// -- Utility ----------------------------------------------------------------
const $ = id => document.getElementById(id);
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
const lerp = (a, b, t) => a + (b - a) * t;

// -- Chart helper -----------------------------------------------------------
function getCtx(id) {
  const c = $(id); const dpr = window.devicePixelRatio || 1;
  const w = c.offsetWidth || c.width || 300;
  const h = c.offsetHeight || c.height || 150;
  c.width = w * dpr; c.height = h * dpr;
  const ctx = c.getContext('2d'); ctx.scale(dpr, dpr);
  ctx.W = w; ctx.H = h;
  return ctx;
}

function drawBarChart(ctx, opts = {}) {
  const { labels, values, expected, colors, maxVal, yLabel } = opts;
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const n = values.length, barW = plotW / n * 0.6, gap = plotW / n * 0.4;

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const mv = maxVal || Math.max(...values, ...(expected||[0])) * 1.2 || 10;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui';
    ctx.textAlign = 'right'; ctx.fillText((mv * i/4).toFixed(mv > 10 ? 0 : 2), pad.left - 6, y + 4);
  }

  values.forEach((v, i) => {
    const x = pad.left + (plotW / n) * i + gap/2;
    const h = (v / mv) * plotH;
    ctx.fillStyle = colors ? colors[i] : '#c41e3a';
    ctx.beginPath();
    const r = 4;
    ctx.moveTo(x, pad.top + plotH);
    ctx.lineTo(x, pad.top + plotH - h + r);
    ctx.quadraticCurveTo(x, pad.top + plotH - h, x + r, pad.top + plotH - h);
    ctx.lineTo(x + barW - r, pad.top + plotH - h);
    ctx.quadraticCurveTo(x + barW, pad.top + plotH - h, x + barW, pad.top + plotH - h + r);
    ctx.lineTo(x + barW, pad.top + plotH);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(labels[i], x + barW/2, H - pad.bottom + 16);
    if (v > 0) {
      ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 12px system-ui';
      ctx.fillText(v.toFixed(v % 1 ? 2 : 0), x + barW/2, pad.top + plotH - h - 6);
    }
  });

  if (expected) {
    expected.forEach((ev, i) => {
      const x = pad.left + (plotW / n) * i + gap/2;
      const y = pad.top + plotH - (ev / mv) * plotH;
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.setLineDash([4,3]);
      ctx.beginPath(); ctx.moveTo(x - 4, y); ctx.lineTo(x + barW + 4, y); ctx.stroke();
      ctx.setLineDash([]);
    });
  }
}

function drawLineChart(ctx, series, opts = {}) {
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 30, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const { yMin = 0, yMax = 1, refLine, xLabel } = opts;
  const yRange = yMax - yMin;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((yMin + yRange * i/4).toFixed(2), pad.left - 6, y + 4);
  }
  if (refLine !== undefined) {
    const ry = pad.top + plotH * (1 - (refLine - yMin) / yRange);
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(pad.left, ry); ctx.lineTo(W - pad.right, ry); ctx.stroke();
    ctx.setLineDash([]);
  }

  series.forEach(s => {
    if (!s.data.length) return;
    const xMax = opts.xMax || s.data.length;
    ctx.strokeStyle = s.color; ctx.lineWidth = s.width || 2;
    ctx.beginPath();
    s.data.forEach((v, i) => {
      const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
      const y = pad.top + plotH * (1 - (v - yMin) / yRange);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    if (s.width !== 0) ctx.stroke();
    if (s.dots && s.data.length < 80) {
      s.data.forEach((v, i) => {
        const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
        const y = pad.top + plotH * (1 - (v - yMin) / yRange);
        ctx.fillStyle = s.color; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
      });
    }
  });
}


// ══════════════════════════════════════════════════════════════════════════
// PART 1: RESPIRATORY ANATOMY EXPLORER
// ══════════════════════════════════════════════════════════════════════════
let anatomyView = 'gross';
const structures = {
  gross: [
    { id: 'nasal', label: 'Nasal Cavity', x: 0.50, y: 0.08, w: 0.12, h: 0.06,
      fn: 'Warms, humidifies, and filters inspired air. Lined with mucous membranes and ciliated epithelium. Olfactory receptors in upper region detect smell.',
      clinical: 'Nasal polyps can obstruct airflow. Deviated septum affects ~80% of people to some degree.' },
    { id: 'pharynx', label: 'Pharynx', x: 0.50, y: 0.16, w: 0.10, h: 0.06,
      fn: 'Shared passageway for air and food. Divided into nasopharynx, oropharynx, and laryngopharynx. Contains tonsils for immune defense.',
      clinical: 'Obstructive sleep apnea occurs when pharyngeal muscles relax excessively during sleep, collapsing the airway.' },
    { id: 'larynx', label: 'Larynx', x: 0.50, y: 0.24, w: 0.08, h: 0.06,
      fn: 'Voice box containing vocal cords. Epiglottis closes during swallowing to prevent aspiration. Thyroid cartilage forms the Adam\'s apple.',
      clinical: 'Laryngitis (vocal cord inflammation) causes hoarseness. Laryngeal cancer is strongly linked to smoking.' },
    { id: 'trachea', label: 'Trachea', x: 0.50, y: 0.34, w: 0.06, h: 0.10,
      fn: 'Windpipe reinforced by 16-20 C-shaped cartilage rings. Lined with ciliated pseudostratified columnar epithelium (mucociliary escalator). About 12 cm long.',
      clinical: 'Tracheostomy may be performed in emergency airway obstruction. Tracheal stenosis can result from prolonged intubation.' },
    { id: 'bronchi', label: 'Primary Bronchi', x: 0.50, y: 0.46, w: 0.18, h: 0.06,
      fn: 'Right and left main bronchi branch from trachea at the carina. Right bronchus is wider, shorter, and more vertical (foreign objects more likely to lodge here).',
      clinical: 'Bronchitis involves inflammation of bronchial mucosa. Lung cancer often arises near the primary bronchi.' },
    { id: 'bronchioles', label: 'Bronchioles', x: 0.38, y: 0.56, w: 0.10, h: 0.06,
      fn: 'Small airways (<1mm diameter) lacking cartilage. Smooth muscle walls control airway diameter. Terminal bronchioles lead to respiratory bronchioles.',
      clinical: 'Asthma primarily affects bronchioles: smooth muscle spasm (bronchospasm) + inflammation + excess mucus narrows the lumen.' },
    { id: 'alveoli', label: 'Alveoli', x: 0.38, y: 0.66, w: 0.10, h: 0.08,
      fn: 'Tiny air sacs (~0.2mm diameter) where gas exchange occurs. Type I cells for gas exchange, Type II cells produce surfactant. Surrounded by dense capillary network.',
      clinical: 'Emphysema destroys alveolar walls, reducing surface area. Pulmonary edema fills alveoli with fluid, impairing gas exchange.' },
    { id: 'diaphragm', label: 'Diaphragm', x: 0.50, y: 0.82, w: 0.30, h: 0.06,
      fn: 'Primary muscle of inspiration. Dome-shaped skeletal muscle. Contracts and flattens during inhalation, increasing thoracic volume. Innervated by phrenic nerve (C3-C5).',
      clinical: 'Phrenic nerve damage (C3-C5 spinal injuries) can paralyze the diaphragm. Hiccups are involuntary diaphragm spasms.' },
    { id: 'rlung', label: 'Right Lung (3 lobes)', x: 0.35, y: 0.58, w: 0.14, h: 0.20,
      fn: 'Three lobes (superior, middle, inferior) separated by horizontal and oblique fissures. Slightly larger than left lung. Contains ~1.5L of air at rest.',
      clinical: 'Right middle lobe syndrome: recurrent atelectasis or pneumonia due to compression of the middle lobe bronchus.' },
    { id: 'llung', label: 'Left Lung (2 lobes)', x: 0.65, y: 0.58, w: 0.14, h: 0.20,
      fn: 'Two lobes (superior, inferior) separated by oblique fissure. Has cardiac notch to accommodate the heart. Lingula is homologous to right middle lobe.',
      clinical: 'Pneumothorax (collapsed lung) can occur spontaneously in tall, thin individuals. Tension pneumothorax is a medical emergency.' }
  ],
  alveolar: [
    { id: 'alv-sac', label: 'Alveolar Sac', x: 0.50, y: 0.30, w: 0.30, h: 0.25,
      fn: 'Cluster of alveoli at the end of an alveolar duct. Each sac contains multiple alveoli, maximizing surface area for gas exchange.',
      clinical: 'In emphysema, alveolar walls break down, creating large air spaces (bullae) with drastically reduced surface area.' },
    { id: 'type1', label: 'Type I Pneumocytes', x: 0.35, y: 0.58, w: 0.14, h: 0.06,
      fn: 'Squamous epithelial cells covering ~95% of alveolar surface. Extremely thin (0.1-0.5 um) to allow rapid gas diffusion. Form the air-blood barrier.',
      clinical: 'Type I cells are highly susceptible to damage from toxins, infections, and oxygen free radicals. Cannot regenerate themselves.' },
    { id: 'type2', label: 'Type II Pneumocytes', x: 0.65, y: 0.58, w: 0.14, h: 0.06,
      fn: 'Cuboidal cells producing pulmonary surfactant (dipalmitoylphosphatidylcholine). Reduce surface tension, preventing alveolar collapse. Can regenerate Type I cells.',
      clinical: 'Premature infants may lack surfactant, causing Infant Respiratory Distress Syndrome (IRDS). Treated with exogenous surfactant.' },
    { id: 'capillary', label: 'Pulmonary Capillary', x: 0.50, y: 0.70, w: 0.24, h: 0.06,
      fn: 'Dense capillary network surrounds each alveolus. Red blood cells pass single-file, maximizing gas exchange time (~0.75 seconds). Extremely thin endothelium.',
      clinical: 'Pulmonary embolism blocks capillary blood flow. Pulmonary hypertension increases resistance in pulmonary capillary bed.' },
    { id: 'macrophage', label: 'Alveolar Macrophages', x: 0.50, y: 0.82, w: 0.16, h: 0.06,
      fn: 'Dust cells that patrol alveolar surfaces. Phagocytize bacteria, dust, and debris. Critical innate immune defense in the lungs.',
      clinical: 'Overwhelmed in pneumoconiosis (occupite dust diseases like silicosis, asbestosis). Smoking impairs macrophage function.' },
    { id: 'membrane', label: 'Respiratory Membrane', x: 0.50, y: 0.14, w: 0.20, h: 0.06,
      fn: 'The air-blood barrier: alveolar epithelium + fused basement membranes + capillary endothelium. Total thickness ~0.5 um. Gases diffuse according to Fick\'s law.',
      clinical: 'Pulmonary fibrosis thickens this membrane, impairing diffusion. Pulmonary edema adds fluid, increasing diffusion distance.' }
  ]
};

function drawAnatomy() {
  const ctx = getCtx('anatomy-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);

  // Background
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  if (anatomyView === 'gross') {
    drawGrossAnatomy(ctx, W, H);
  } else {
    drawAlveolarView(ctx, W, H);
  }

  // Draw clickable structure zones
  const structs = structures[anatomyView];
  structs.forEach(s => {
    const x = s.x * W - (s.w * W)/2;
    const y = s.y * H - (s.h * H)/2;
    const w = s.w * W;
    const h = s.h * H;

    // Subtle hover zone
    ctx.strokeStyle = 'rgba(196,30,58,0.3)'; ctx.lineWidth = 1.5;
    ctx.setLineDash([4, 4]);
    ctx.strokeRect(x, y, w, h);
    ctx.setLineDash([]);

    // Label
    ctx.fillStyle = '#1a1a2e'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(s.label, s.x * W, s.y * H - (s.h * H)/2 - 4);
  });
}

function drawGrossAnatomy(ctx, W, H) {
  const cx = W * 0.50;

  // Head outline
  ctx.fillStyle = '#fde8e8'; ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.ellipse(cx, H*0.07, 40, 25, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.fillStyle = '#1a1a2e'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Nasal Cavity', cx, H*0.07+4);

  // Pharynx
  ctx.fillStyle = '#fce4ec'; ctx.strokeStyle = '#e57373'; ctx.lineWidth = 1.5;
  ctx.fillRect(cx-15, H*0.12, 30, H*0.08);
  ctx.strokeRect(cx-15, H*0.12, 30, H*0.08);

  // Larynx
  ctx.fillStyle = '#e3f2fd'; ctx.strokeStyle = '#42a5f5'; ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(cx-18, H*0.22); ctx.lineTo(cx+18, H*0.22);
  ctx.lineTo(cx+12, H*0.28); ctx.lineTo(cx-12, H*0.28);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // Trachea with rings
  ctx.fillStyle = '#e8f5e9'; ctx.strokeStyle = '#66bb6a'; ctx.lineWidth = 2;
  ctx.fillRect(cx-12, H*0.29, 24, H*0.14);
  ctx.strokeRect(cx-12, H*0.29, 24, H*0.14);
  for (let i = 0; i < 7; i++) {
    const ry = H*0.30 + i * H*0.02;
    ctx.beginPath(); ctx.moveTo(cx-12, ry); ctx.lineTo(cx+12, ry); ctx.stroke();
  }

  // Bronchi - branching
  ctx.strokeStyle = '#66bb6a'; ctx.lineWidth = 3;
  ctx.beginPath(); ctx.moveTo(cx, H*0.43); ctx.lineTo(cx-60, H*0.50); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx, H*0.43); ctx.lineTo(cx+60, H*0.50); ctx.stroke();

  // Secondary bronchi
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(cx-60, H*0.50); ctx.lineTo(cx-80, H*0.56); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx-60, H*0.50); ctx.lineTo(cx-50, H*0.56); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx+60, H*0.50); ctx.lineTo(cx+80, H*0.56); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx+60, H*0.50); ctx.lineTo(cx+50, H*0.56); ctx.stroke();

  // Lungs
  ctx.fillStyle = 'rgba(233,213,255,0.5)'; ctx.strokeStyle = '#7c3aed'; ctx.lineWidth = 2;
  // Right lung
  ctx.beginPath();
  ctx.moveTo(cx-20, H*0.45);
  ctx.quadraticCurveTo(cx-120, H*0.50, cx-110, H*0.72);
  ctx.quadraticCurveTo(cx-100, H*0.78, cx-20, H*0.76);
  ctx.closePath(); ctx.fill(); ctx.stroke();
  // Left lung
  ctx.beginPath();
  ctx.moveTo(cx+20, H*0.45);
  ctx.quadraticCurveTo(cx+120, H*0.50, cx+110, H*0.72);
  ctx.quadraticCurveTo(cx+100, H*0.78, cx+20, H*0.76);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // Lobe divisions - right (3 lobes)
  ctx.strokeStyle = '#9575cd'; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(cx-20, H*0.55); ctx.lineTo(cx-100, H*0.58); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx-20, H*0.63); ctx.lineTo(cx-105, H*0.66); ctx.stroke();
  // Left (2 lobes)
  ctx.beginPath(); ctx.moveTo(cx+20, H*0.60); ctx.lineTo(cx+105, H*0.63); ctx.stroke();
  ctx.setLineDash([]);

  // Cardiac notch
  ctx.strokeStyle = '#ef5350'; ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.arc(cx+25, H*0.65, 15, -0.5, 1.5); ctx.stroke();

  // Diaphragm
  ctx.fillStyle = 'rgba(255,183,77,0.3)'; ctx.strokeStyle = '#ff9800'; ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(cx-130, H*0.82);
  ctx.quadraticCurveTo(cx, H*0.75, cx+130, H*0.82);
  ctx.lineTo(cx+130, H*0.86);
  ctx.quadraticCurveTo(cx, H*0.79, cx-130, H*0.86);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // Bronchiole indicator
  ctx.fillStyle = 'rgba(76,175,80,0.2)'; ctx.strokeStyle = '#4caf50'; ctx.lineWidth = 1;
  for (let i = 0; i < 4; i++) {
    const bx = cx - 75 + i*20, by = H*0.58 + (i%2)*8;
    ctx.beginPath(); ctx.arc(bx, by, 5, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  }

  // Alveoli clusters indicator
  ctx.fillStyle = 'rgba(233,30,99,0.15)'; ctx.strokeStyle = '#e91e63'; ctx.lineWidth = 1;
  for (let i = 0; i < 6; i++) {
    const ax = cx - 85 + i*15, ay = H*0.66 + (i%3)*6;
    ctx.beginPath(); ctx.arc(ax, ay, 4, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  }
}

function drawAlveolarView(ctx, W, H) {
  const cx = W/2, cy = H*0.4;

  // Title
  ctx.fillStyle = '#1a1a2e'; ctx.font = 'bold 16px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Alveolar Level View', cx, 30);

  // Respiratory membrane label at top
  ctx.fillStyle = '#e3f2fd'; ctx.strokeStyle = '#2196f3'; ctx.lineWidth = 2;
  ctx.fillRect(cx-80, H*0.10, 160, H*0.05);
  ctx.strokeRect(cx-80, H*0.10, 160, H*0.05);
  ctx.fillStyle = '#1a1a2e'; ctx.font = '11px system-ui';
  ctx.fillText('Respiratory Membrane (~0.5 um)', cx, H*0.13);

  // Alveolar sac - cluster of circles
  ctx.fillStyle = 'rgba(244,143,177,0.2)'; ctx.strokeStyle = '#e91e63'; ctx.lineWidth = 2;
  const alvPositions = [
    [cx-40, cy-20, 35], [cx+40, cy-20, 35],
    [cx, cy+20, 38], [cx-60, cy+25, 30], [cx+60, cy+25, 30]
  ];
  alvPositions.forEach(([x, y, r]) => {
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    // Air space label
    ctx.fillStyle = '#f8bbd0'; ctx.font = '9px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Air', x, y+3);
    ctx.fillStyle = 'rgba(244,143,177,0.2)';
  });

  // Type I cells on alveolar wall
  ctx.fillStyle = '#bbdefb'; ctx.strokeStyle = '#1565c0';
  const t1Pos = [[cx-55, cy+55], [cx-30, cy+58], [cx+10, cy+60], [cx+40, cy+57]];
  t1Pos.forEach(([x, y]) => {
    ctx.beginPath(); ctx.ellipse(x, y, 12, 4, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  });

  // Type II cells
  ctx.fillStyle = '#c8e6c9'; ctx.strokeStyle = '#2e7d32'; ctx.lineWidth = 2;
  const t2Pos = [[cx+65, cy+55], [cx-70, cy+50]];
  t2Pos.forEach(([x, y]) => {
    ctx.beginPath(); ctx.arc(x, y, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    // Surfactant dots
    ctx.fillStyle = '#a5d6a7';
    for (let i = 0; i < 3; i++) {
      ctx.beginPath(); ctx.arc(x + rand(-5,5), y + rand(10,18), 2, 0, Math.PI*2); ctx.fill();
    }
    ctx.fillStyle = '#c8e6c9';
  });

  // Capillary network
  ctx.strokeStyle = '#f44336'; ctx.lineWidth = 3;
  ctx.fillStyle = 'rgba(244,67,54,0.15)';
  ctx.beginPath();
  ctx.moveTo(cx-100, H*0.68);
  ctx.bezierCurveTo(cx-60, H*0.65, cx-20, H*0.72, cx, H*0.68);
  ctx.bezierCurveTo(cx+20, H*0.64, cx+60, H*0.71, cx+100, H*0.68);
  ctx.lineTo(cx+100, H*0.74);
  ctx.bezierCurveTo(cx+60, H*0.77, cx+20, H*0.70, cx, H*0.74);
  ctx.bezierCurveTo(cx-20, H*0.78, cx-60, H*0.71, cx-100, H*0.74);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // RBCs in capillary
  ctx.fillStyle = '#d32f2f';
  for (let i = 0; i < 5; i++) {
    const rx = cx - 70 + i * 35;
    const ry = H*0.71 + Math.sin(i*1.5)*4;
    ctx.beginPath(); ctx.ellipse(rx, ry, 7, 4, 0, 0, Math.PI*2); ctx.fill();
  }

  // Macrophages
  ctx.fillStyle = '#fff9c4'; ctx.strokeStyle = '#f9a825'; ctx.lineWidth = 2;
  const macPos = [[cx-20, H*0.82], [cx+30, H*0.84]];
  macPos.forEach(([x, y]) => {
    ctx.beginPath();
    // Irregular shape for macrophage
    for (let a = 0; a < Math.PI*2; a += 0.3) {
      const r = 10 + Math.sin(a*3)*3;
      const px = x + Math.cos(a)*r, py = y + Math.sin(a)*r;
      a === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
    }
    ctx.closePath(); ctx.fill(); ctx.stroke();
  });

  // O2 / CO2 arrows
  ctx.strokeStyle = '#2196f3'; ctx.lineWidth = 2; ctx.fillStyle = '#2196f3';
  drawArrow(ctx, cx-30, cy+45, cx-30, H*0.66, 'O2');
  ctx.strokeStyle = '#ff9800'; ctx.fillStyle = '#ff9800';
  drawArrow(ctx, cx+30, H*0.66, cx+30, cy+45, 'CO2');
}

function drawArrow(ctx, x1, y1, x2, y2, label) {
  const angle = Math.atan2(y2-y1, x2-x1);
  ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
  // Arrowhead
  ctx.beginPath();
  ctx.moveTo(x2, y2);
  ctx.lineTo(x2 - 8*Math.cos(angle-0.4), y2 - 8*Math.sin(angle-0.4));
  ctx.lineTo(x2 - 8*Math.cos(angle+0.4), y2 - 8*Math.sin(angle+0.4));
  ctx.closePath(); ctx.fill();
  // Label
  const mx = (x1+x2)/2, my = (y1+y2)/2;
  ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
  ctx.fillText(label, mx + 15, my);
}

function anatomyZoom(view) {
  anatomyView = view;
  drawAnatomy();
}

function anatomyReset() {
  anatomyView = 'gross';
  $('anatomy-info-title').textContent = 'Select a Structure';
  $('anatomy-info-function').textContent = 'Click on any structure in the diagram above to learn about its function.';
  $('anatomy-info-clinical').style.display = 'none';
  drawAnatomy();
}

// Click handler for anatomy canvas
$('anatomy-canvas').addEventListener('click', function(e) {
  const rect = this.getBoundingClientRect();
  const mx = (e.clientX - rect.left) / rect.width;
  const my = (e.clientY - rect.top) / rect.height;
  const structs = structures[anatomyView];
  for (const s of structs) {
    if (Math.abs(mx - s.x) < s.w/2 && Math.abs(my - s.y) < s.h/2) {
      $('anatomy-info-title').textContent = s.label;
      $('anatomy-info-function').textContent = s.fn;
      $('anatomy-info-clinical').style.display = 'block';
      $('anatomy-info-clinical-text').textContent = s.clinical;
      break;
    }
  }
});


// ══════════════════════════════════════════════════════════════════════════
// PART 2: BREATHING MECHANICS
// ══════════════════════════════════════════════════════════════════════════
let breathState = {
  running: false, time: 0, phase: 0, // 0-1 cycle
  mode: 'quiet', // 'quiet' or 'forced'
  pressureHistory: [], volumeHistory: [],
  animId: null
};

function toggleBreathing() {
  breathState.running = !breathState.running;
  $('breathe-btn').textContent = breathState.running ? 'Stop' : 'Start Breathing';
  if (breathState.running) animateBreath();
}

function toggleBreathMode() {
  breathState.mode = breathState.mode === 'quiet' ? 'forced' : 'quiet';
  $('breath-mode-label').innerHTML = 'Mode: <strong>' +
    (breathState.mode === 'quiet' ? 'Quiet Breathing' : 'Forced Breathing') + '</strong>';
}

function breathReset() {
  breathState.running = false;
  breathState.time = 0; breathState.phase = 0;
  breathState.pressureHistory = []; breathState.volumeHistory = [];
  $('breathe-btn').textContent = 'Start Breathing';
  $('bj-pressure').textContent = '760';
  $('bj-volume').textContent = '2.5';
  $('bj-phase').textContent = 'Rest';
  $('bj-flow').textContent = '0';
  drawBellJar(0);
  drawPVChart();
}

function animateBreath() {
  if (!breathState.running) return;
  const speed = breathState.mode === 'quiet' ? 0.008 : 0.012;
  breathState.phase = (breathState.phase + speed) % 1;
  breathState.time++;

  // Phase: 0-0.4 = inhalation, 0.4-0.5 = pause, 0.5-0.9 = exhalation, 0.9-1 = pause
  let diaphragmPos, pressure, volume, flow, phaseName;
  const p = breathState.phase;
  const amp = breathState.mode === 'quiet' ? 1 : 1.8;

  if (p < 0.4) {
    // Inhalation
    const t = p / 0.4;
    const ease = Math.sin(t * Math.PI / 2);
    diaphragmPos = ease * amp;
    pressure = 760 - 3 * ease * amp;
    volume = 2.5 + 0.5 * ease * amp;
    flow = 0.5 * Math.cos(t * Math.PI / 2) * amp;
    phaseName = 'Inhale';
  } else if (p < 0.5) {
    diaphragmPos = 1 * amp;
    pressure = 760;
    volume = 2.5 + 0.5 * amp;
    flow = 0;
    phaseName = 'Pause';
  } else if (p < 0.9) {
    // Exhalation
    const t = (p - 0.5) / 0.4;
    const ease = Math.sin(t * Math.PI / 2);
    diaphragmPos = (1 - ease) * amp;
    pressure = 760 + 2 * ease * amp;
    volume = 2.5 + 0.5 * (1 - ease) * amp;
    flow = -0.4 * Math.cos(t * Math.PI / 2) * amp;
    phaseName = 'Exhale';
  } else {
    diaphragmPos = 0;
    pressure = 760;
    volume = 2.5;
    flow = 0;
    phaseName = 'Pause';
  }

  $('bj-pressure').textContent = pressure.toFixed(1);
  $('bj-volume').textContent = volume.toFixed(2);
  $('bj-phase').textContent = phaseName;
  $('bj-flow').textContent = flow.toFixed(2);

  if (breathState.time % 3 === 0) {
    breathState.pressureHistory.push(pressure);
    breathState.volumeHistory.push(volume);
    if (breathState.pressureHistory.length > 200) {
      breathState.pressureHistory.shift();
      breathState.volumeHistory.shift();
    }
    drawPVChart();
  }

  drawBellJar(diaphragmPos);
  breathState.animId = requestAnimationFrame(animateBreath);
}

function drawBellJar(diaphragmPos) {
  const ctx = getCtx('belljar-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const cx = W/2, jarTop = H*0.08, jarBot = H*0.75;
  const jarW = W*0.35;

  // Bell jar (glass container)
  ctx.strokeStyle = '#78909c'; ctx.lineWidth = 3;
  ctx.fillStyle = 'rgba(144,202,249,0.08)';
  ctx.beginPath();
  ctx.moveTo(cx - jarW, jarTop);
  ctx.lineTo(cx - jarW, jarBot);
  ctx.lineTo(cx + jarW, jarBot);
  ctx.lineTo(cx + jarW, jarTop);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // Trachea (tube at top)
  ctx.fillStyle = '#e8f5e9'; ctx.strokeStyle = '#66bb6a'; ctx.lineWidth = 2;
  ctx.fillRect(cx-8, jarTop-20, 16, 60);
  ctx.strokeRect(cx-8, jarTop-20, 16, 60);
  // Opening arrow (air)
  if (diaphragmPos > 0.3) {
    ctx.fillStyle = '#2196f3'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('AIR IN', cx, jarTop - 28);
    ctx.beginPath(); ctx.moveTo(cx, jarTop-22); ctx.lineTo(cx-6, jarTop-30); ctx.lineTo(cx+6, jarTop-30);
    ctx.closePath(); ctx.fill();
  } else if (diaphragmPos < -0.1) {
    ctx.fillStyle = '#ff9800'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('AIR OUT', cx, jarTop - 28);
  }

  // Lungs (balloons)
  const lungInflation = 0.6 + diaphragmPos * 0.25;
  const lw = jarW * lungInflation * 0.7;
  const lh = (jarBot - jarTop) * 0.35 * (0.8 + diaphragmPos * 0.15);

  ctx.fillStyle = 'rgba(244,143,177,0.4)'; ctx.strokeStyle = '#e91e63'; ctx.lineWidth = 2;
  // Left lung
  ctx.beginPath(); ctx.ellipse(cx - jarW*0.3, jarTop + (jarBot-jarTop)*0.35, lw*0.5, lh, 0, 0, Math.PI*2);
  ctx.fill(); ctx.stroke();
  // Right lung
  ctx.beginPath(); ctx.ellipse(cx + jarW*0.3, jarTop + (jarBot-jarTop)*0.35, lw*0.5, lh, 0, 0, Math.PI*2);
  ctx.fill(); ctx.stroke();

  // Bronchi connections
  ctx.strokeStyle = '#66bb6a'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(cx, jarTop+40); ctx.lineTo(cx - jarW*0.3, jarTop + (jarBot-jarTop)*0.25); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx, jarTop+40); ctx.lineTo(cx + jarW*0.3, jarTop + (jarBot-jarTop)*0.25); ctx.stroke();

  // Intercostal muscles on jar walls
  ctx.strokeStyle = '#ef9a9a'; ctx.lineWidth = 1.5;
  for (let i = 0; i < 5; i++) {
    const my = jarTop + 40 + i * 50;
    // Left side
    ctx.beginPath();
    ctx.moveTo(cx - jarW - 10, my);
    ctx.lineTo(cx - jarW + 5, my + 25);
    ctx.stroke();
    // Right side
    ctx.beginPath();
    ctx.moveTo(cx + jarW + 10, my);
    ctx.lineTo(cx + jarW - 5, my + 25);
    ctx.stroke();
  }
  ctx.fillStyle = '#ef9a9a'; ctx.font = '10px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Intercostal', cx + jarW + 14, jarTop + 60);
  ctx.fillText('muscles', cx + jarW + 14, jarTop + 72);

  // Diaphragm (rubber sheet at bottom)
  const dY = jarBot + diaphragmPos * 30;
  ctx.fillStyle = 'rgba(255,183,77,0.5)'; ctx.strokeStyle = '#ff9800'; ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(cx - jarW, jarBot);
  ctx.quadraticCurveTo(cx, dY + 20, cx + jarW, jarBot);
  ctx.lineTo(cx + jarW, jarBot + 15);
  ctx.quadraticCurveTo(cx, dY + 35, cx - jarW, jarBot + 15);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // Labels
  ctx.fillStyle = '#ff9800'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Diaphragm', cx, dY + 50);

  // Pressure gauge
  const gaugeX = W * 0.85, gaugeY = H * 0.30;
  ctx.fillStyle = '#fff'; ctx.strokeStyle = '#374151'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(gaugeX, gaugeY, 35, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  const pressVal = parseFloat($('bj-pressure').textContent);
  const pressAngle = ((pressVal - 757) / 6) * Math.PI - Math.PI/2;
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(gaugeX, gaugeY);
  ctx.lineTo(gaugeX + Math.cos(pressAngle)*25, gaugeY + Math.sin(pressAngle)*25);
  ctx.stroke();
  ctx.fillStyle = '#1a1a2e'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Pressure', gaugeX, gaugeY + 50);
  ctx.fillText(pressVal.toFixed(1) + ' mmHg', gaugeX, gaugeY + 62);

  // Volume gauge
  const vGaugeX = W * 0.85, vGaugeY = H * 0.60;
  const volVal = parseFloat($('bj-volume').textContent);
  const barH = 80, barW2 = 20;
  ctx.fillStyle = '#e8f5e9'; ctx.strokeStyle = '#374151'; ctx.lineWidth = 1;
  ctx.fillRect(vGaugeX - barW2/2, vGaugeY - barH/2, barW2, barH);
  ctx.strokeRect(vGaugeX - barW2/2, vGaugeY - barH/2, barW2, barH);
  const fillH = ((volVal - 1.5) / 3) * barH;
  ctx.fillStyle = '#4caf50';
  ctx.fillRect(vGaugeX - barW2/2, vGaugeY + barH/2 - fillH, barW2, fillH);
  ctx.fillStyle = '#1a1a2e'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Volume', vGaugeX, vGaugeY + barH/2 + 16);
  ctx.fillText(volVal.toFixed(2) + ' L', vGaugeX, vGaugeY + barH/2 + 28);

  // Boyle's Law notation
  ctx.fillStyle = '#7c3aed'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'left';
  ctx.fillText("Boyle's Law: P1V1 = P2V2", 20, H - 20);
}

function drawPVChart() {
  if (!breathState.pressureHistory.length) {
    const ctx = getCtx('pv-chart');
    ctx.clearRect(0, 0, ctx.W, ctx.H);
    ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, ctx.W, ctx.H);
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Start breathing to see pressure and volume traces', ctx.W/2, ctx.H/2);
    return;
  }
  const ctx = getCtx('pv-chart');
  const pNorm = breathState.pressureHistory.map(p => (p - 755) / 10);
  const vNorm = breathState.volumeHistory.map(v => (v - 1.5) / 3);
  drawLineChart(ctx, [
    { data: pNorm, color: '#c41e3a', width: 2 },
    { data: vNorm, color: '#2563eb', width: 2 }
  ], { yMin: 0, yMax: 1, refLine: 0.5 });
}


// ══════════════════════════════════════════════════════════════════════════
// PART 3: LUNG VOLUMES & CAPACITIES
// ══════════════════════════════════════════════════════════════════════════
let spiroState = { sex: 'M' };

function drawSpirometry() {
  const ctx = getCtx('spirometry-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const pad = { top: 30, right: 140, bottom: 40, left: 60 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;

  const tv = parseInt($('sp-tv').textContent);
  const irv = parseInt($('sp-irv').textContent);
  const erv = parseInt($('sp-erv').textContent);
  const rv = parseInt($('sp-rv').textContent);
  const tlc = tv + irv + erv + rv;

  // Y axis: 0 to TLC
  const yScale = plotH / tlc;

  // Grid lines
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 6; i++) {
    const y = pad.top + plotH - (i * tlc / 6) * yScale;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + plotW, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText(Math.round(i * tlc / 6) + '', pad.left - 6, y + 4);
  }
  ctx.fillStyle = '#374151'; ctx.font = '12px system-ui'; ctx.textAlign = 'center';
  ctx.save(); ctx.translate(14, pad.top + plotH/2); ctx.rotate(-Math.PI/2);
  ctx.fillText('Volume (mL)', 0, 0); ctx.restore();

  // Generate spirometry trace
  const baseVol = rv + erv; // FRC level
  const points = [];
  const totalPoints = 200;

  // Normal tidal breathing (cycles 0-80)
  for (let i = 0; i <= 80; i++) {
    const t = (i / 20) * Math.PI * 2;
    const vol = baseVol + (tv/2) + (tv/2) * Math.sin(t - Math.PI/2);
    points.push(vol);
  }
  // Max inspiration (80-100)
  for (let i = 0; i < 20; i++) {
    const t = i / 20;
    const startVol = baseVol + tv;
    const endVol = rv + erv + tv + irv; // TLC
    points.push(lerp(startVol, endVol, Math.sin(t * Math.PI / 2)));
  }
  // Max expiration (100-130)
  for (let i = 0; i < 30; i++) {
    const t = i / 30;
    const startVol = tlc;
    const endVol = rv; // down to RV
    points.push(lerp(startVol, endVol, Math.sin(t * Math.PI / 2)));
  }
  // Recovery breathing (130-200)
  for (let i = 0; i < 70; i++) {
    const t = (i / 20) * Math.PI * 2;
    const vol = baseVol + (tv/2) + (tv/2) * Math.sin(t - Math.PI/2);
    points.push(vol);
  }

  // Draw trace
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2.5;
  ctx.beginPath();
  points.forEach((v, i) => {
    const x = pad.left + (i / (points.length-1)) * plotW;
    const y = pad.top + plotH - v * yScale;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Volume labels on right side
  const rX = pad.left + plotW + 10;

  // TV bracket
  const tvTop = pad.top + plotH - (baseVol + tv) * yScale;
  const tvBot = pad.top + plotH - baseVol * yScale;
  drawBracket(ctx, rX, tvTop, tvBot, 'TV', '#c41e3a');

  // IRV bracket
  const irvTop = pad.top + plotH - tlc * yScale;
  drawBracket(ctx, rX + 40, tvTop, irvTop, 'IRV', '#2563eb');

  // ERV bracket
  const ervBot = pad.top + plotH - rv * yScale;
  drawBracket(ctx, rX + 40, tvBot, ervBot, 'ERV', '#16a34a');

  // RV bracket
  const rvBot = pad.top + plotH;
  drawBracket(ctx, rX + 80, ervBot, rvBot, 'RV', '#d97706');

  // Dashed lines for levels
  ctx.setLineDash([4,4]); ctx.lineWidth = 1;
  ctx.strokeStyle = '#9ca3af';
  // TLC level
  ctx.beginPath(); ctx.moveTo(pad.left, irvTop); ctx.lineTo(pad.left+plotW, irvTop); ctx.stroke();
  // FRC level
  ctx.beginPath(); ctx.moveTo(pad.left, tvBot); ctx.lineTo(pad.left+plotW, tvBot); ctx.stroke();
  // RV level
  ctx.beginPath(); ctx.moveTo(pad.left, ervBot); ctx.lineTo(pad.left+plotW, ervBot); ctx.stroke();
  ctx.setLineDash([]);

  // Level labels
  ctx.fillStyle = '#7c3aed'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('TLC', pad.left + 5, irvTop - 4);
  ctx.fillText('FRC', pad.left + 5, tvBot - 4);
  ctx.fillText('RV', pad.left + 5, ervBot - 4);
}

function drawBracket(ctx, x, y1, y2, label, color) {
  ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.fillStyle = color;
  ctx.beginPath(); ctx.moveTo(x, y1); ctx.lineTo(x+8, y1); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x, y2); ctx.lineTo(x+8, y2); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x+4, y1); ctx.lineTo(x+4, y2); ctx.stroke();
  ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText(label, x+12, (y1+y2)/2 + 4);
}

function updatePersonal() {
  $('sp-height-val').textContent = $('sp-height').value;
  $('sp-age-val').textContent = $('sp-age').value;
}

function setPersonalSex(sex) {
  spiroState.sex = sex;
  const height = parseInt($('sp-height').value);
  const age = parseInt($('sp-age').value);

  // Estimated vital capacity using standard equations (simplified)
  let vc;
  if (sex === 'M') {
    vc = (27.63 - 0.112 * age) * height; // simplified
  } else {
    vc = (21.78 - 0.101 * age) * height;
  }
  vc = Math.round(vc);

  // Estimate components
  const tv = 500;
  const irv = Math.round(vc * 0.65);
  const erv = Math.round(vc * 0.25);
  const rv = Math.round(vc * 0.25);
  const frc = erv + rv;
  const tlc = vc + rv;
  const ic = tv + irv;

  $('sp-tv').textContent = tv;
  $('sp-irv').textContent = irv;
  $('sp-erv').textContent = erv;
  $('sp-rv').textContent = rv;
  $('sp-vc').textContent = vc;
  $('sp-tlc').textContent = tlc;
  $('sp-frc').textContent = frc;
  $('sp-ic').textContent = ic;

  $('personal-result').innerHTML =
    '<strong>Estimated VC (' + sex + '):</strong> ' + vc + ' mL | ' +
    'Height: ' + height + ' cm | Age: ' + age + ' years | TLC: ' + tlc + ' mL';

  drawSpirometry();
  drawComparisonChart();
}

function drawComparisonChart() {
  const ctx = getCtx('comparison-chart');
  drawBarChart(ctx, {
    labels: ['Male Avg', 'Female Avg', 'Male Athlete', 'Female Athlete', 'Sedentary M', 'Sedentary F'],
    values: [4800, 3400, 6200, 4800, 3800, 2800],
    colors: ['#2563eb', '#e91e63', '#1565c0', '#ad1457', '#90caf9', '#f48fb1'],
    maxVal: 7000
  });
}


// ══════════════════════════════════════════════════════════════════════════
// PART 4: GAS EXCHANGE
// ══════════════════════════════════════════════════════════════════════════
let gasState = { running: false, time: 0, particles: [], animId: null };

function toggleGasAnim() {
  gasState.running = !gasState.running;
  $('gas-anim-btn').textContent = gasState.running ? 'Stop' : 'Start Animation';
  if (gasState.running) {
    initGasParticles();
    animateGas();
  }
}

function gasReset() {
  gasState.running = false;
  gasState.time = 0;
  gasState.particles = [];
  $('gas-anim-btn').textContent = 'Start Animation';
  drawGasExchange();
}

function initGasParticles() {
  gasState.particles = [];
  // O2 particles (blue) starting in alveolus
  for (let i = 0; i < 15; i++) {
    gasState.particles.push({
      type: 'O2', x: 0.3 + Math.random()*0.4, y: 0.15 + Math.random()*0.25,
      vx: (Math.random()-0.5)*0.003, vy: (Math.random()-0.5)*0.003,
      crossed: false
    });
  }
  // CO2 particles (orange) starting in capillary
  for (let i = 0; i < 12; i++) {
    gasState.particles.push({
      type: 'CO2', x: 0.3 + Math.random()*0.4, y: 0.65 + Math.random()*0.15,
      vx: (Math.random()-0.5)*0.003, vy: (Math.random()-0.5)*0.003,
      crossed: false
    });
  }
}

function animateGas() {
  if (!gasState.running) return;
  gasState.time++;

  // Move particles with gradient-driven diffusion
  gasState.particles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;

    // Diffusion bias
    if (p.type === 'O2' && !p.crossed && p.y < 0.55) {
      p.vy += 0.0003; // bias toward capillary
    }
    if (p.type === 'CO2' && !p.crossed && p.y > 0.50) {
      p.vy -= 0.0003; // bias toward alveolus
    }

    // Check crossing membrane (~y=0.50)
    if (p.type === 'O2' && p.y > 0.55) p.crossed = true;
    if (p.type === 'CO2' && p.y < 0.45) p.crossed = true;

    // Boundaries
    p.x = clamp(p.x, 0.15, 0.85);
    p.y = clamp(p.y, 0.08, 0.85);

    // Random walk
    p.vx += (Math.random()-0.5)*0.001;
    p.vy += (Math.random()-0.5)*0.001;
    p.vx *= 0.98; p.vy *= 0.98;
  });

  drawGasExchange();
  gasState.animId = requestAnimationFrame(animateGas);
}

function drawGasExchange() {
  const ctx = getCtx('gas-exchange-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Alveolus (top half)
  ctx.fillStyle = 'rgba(244,143,177,0.15)'; ctx.strokeStyle = '#e91e63'; ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.ellipse(W/2, H*0.25, W*0.35, H*0.20, 0, 0, Math.PI*2);
  ctx.fill(); ctx.stroke();
  ctx.fillStyle = '#e91e63'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('ALVEOLUS (Air Space)', W/2, H*0.08);

  // Partial pressures in alveolus
  ctx.font = '12px system-ui'; ctx.fillStyle = '#1565c0';
  ctx.fillText('PO2 = 104 mmHg', W*0.25, H*0.15);
  ctx.fillStyle = '#e65100';
  ctx.fillText('PCO2 = 40 mmHg', W*0.75, H*0.15);

  // Respiratory membrane
  ctx.fillStyle = 'rgba(158,158,158,0.3)'; ctx.strokeStyle = '#757575'; ctx.lineWidth = 1;
  ctx.fillRect(W*0.15, H*0.47, W*0.70, H*0.06);
  ctx.strokeRect(W*0.15, H*0.47, W*0.70, H*0.06);
  ctx.fillStyle = '#757575'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Respiratory Membrane (0.5 um)', W/2, H*0.51);

  // Capillary (bottom half)
  ctx.fillStyle = 'rgba(239,154,154,0.2)'; ctx.strokeStyle = '#d32f2f'; ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(W*0.10, H*0.60);
  ctx.lineTo(W*0.10, H*0.80);
  ctx.quadraticCurveTo(W*0.50, H*0.85, W*0.90, H*0.80);
  ctx.lineTo(W*0.90, H*0.60);
  ctx.quadraticCurveTo(W*0.50, H*0.55, W*0.10, H*0.60);
  ctx.closePath(); ctx.fill(); ctx.stroke();
  ctx.fillStyle = '#d32f2f'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('PULMONARY CAPILLARY (Blood)', W/2, H*0.93);

  // Partial pressures in capillary (venous end)
  ctx.font = '12px system-ui'; ctx.fillStyle = '#1565c0';
  ctx.fillText('PO2 = 40 mmHg', W*0.20, H*0.65);
  ctx.fillStyle = '#e65100';
  ctx.fillText('PCO2 = 45 mmHg', W*0.80, H*0.65);

  // Arrow labels for gradient
  ctx.fillStyle = '#1565c0'; ctx.font = 'bold 12px system-ui';
  ctx.fillText('O2 diffuses DOWN gradient', W*0.25, H*0.43);
  drawArrow2(ctx, W*0.20, H*0.35, W*0.20, H*0.46, '#1565c0');

  ctx.fillStyle = '#e65100';
  ctx.fillText('CO2 diffuses DOWN gradient', W*0.75, H*0.43);
  drawArrow2(ctx, W*0.80, H*0.55, W*0.80, H*0.44, '#e65100');

  // RBCs
  ctx.fillStyle = '#c62828';
  for (let i = 0; i < 6; i++) {
    const rx = W*0.20 + i * W*0.12;
    const ry = H*0.72 + Math.sin(gasState.time*0.02 + i)*5;
    ctx.beginPath(); ctx.ellipse(rx, ry, 10, 5, 0, 0, Math.PI*2); ctx.fill();
    // Hb label on some
    if (i % 2 === 0) {
      ctx.fillStyle = '#ffcdd2'; ctx.font = '7px system-ui'; ctx.textAlign = 'center';
      ctx.fillText('Hb', rx, ry+3);
      ctx.fillStyle = '#c62828';
    }
  }

  // Animated particles
  gasState.particles.forEach(p => {
    const px = p.x * W, py = p.y * H;
    if (p.type === 'O2') {
      ctx.fillStyle = p.crossed ? '#0d47a1' : '#42a5f5';
      ctx.beginPath(); ctx.arc(px, py, 4, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#fff'; ctx.font = 'bold 6px system-ui'; ctx.textAlign = 'center';
      ctx.fillText('O2', px, py+2);
    } else {
      ctx.fillStyle = p.crossed ? '#bf360c' : '#ff9800';
      ctx.beginPath(); ctx.arc(px, py, 4, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#fff'; ctx.font = 'bold 5px system-ui'; ctx.textAlign = 'center';
      ctx.fillText('CO2', px, py+2);
    }
  });

  // Hemoglobin binding note
  ctx.fillStyle = '#7c3aed'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Hb + O2 -> HbO2 (Oxyhemoglobin)', W*0.05, H*0.98);
}

function drawArrow2(ctx, x1, y1, x2, y2, color) {
  ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.fillStyle = color;
  const angle = Math.atan2(y2-y1, x2-x1);
  ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x2, y2);
  ctx.lineTo(x2 - 8*Math.cos(angle-0.4), y2 - 8*Math.sin(angle-0.4));
  ctx.lineTo(x2 - 8*Math.cos(angle+0.4), y2 - 8*Math.sin(angle+0.4));
  ctx.closePath(); ctx.fill();
}

// O2-Hemoglobin Dissociation Curve
function updateOxyCurve() {
  const ph = parseInt($('oxy-ph').value) / 100;
  const temp = parseInt($('oxy-temp').value);
  const bpg = parseInt($('oxy-bpg').value);
  $('oxy-ph-val').textContent = ph.toFixed(2);
  $('oxy-temp-val').textContent = temp;
  $('oxy-bpg-val').textContent = bpg < 30 ? 'Low' : bpg > 70 ? 'High' : 'Normal';
  drawOxyCurve();

  // Update Bohr effect explanation
  let explanation = '';
  if (ph < 7.35) {
    explanation = 'LOW pH (acidosis) shifts the curve RIGHT, promoting O2 release to tissues. This is the Bohr effect: active muscles produce CO2 and H+, which reduces Hb-O2 affinity exactly where O2 is needed most.';
  } else if (ph > 7.45) {
    explanation = 'HIGH pH (alkalosis) shifts the curve LEFT, increasing Hb-O2 affinity. Hemoglobin holds onto O2 more tightly, which can impair O2 delivery to tissues.';
  } else if (temp > 39) {
    explanation = 'ELEVATED temperature shifts the curve RIGHT. During fever or exercise, increased temperature promotes O2 unloading. Metabolically active tissues generate heat and receive more O2.';
  } else if (temp < 35) {
    explanation = 'LOW temperature shifts the curve LEFT. Hemoglobin binds O2 more tightly in cooler conditions. This is relevant during hypothermia or in peripheral vasoconstriction.';
  } else if (bpg > 70) {
    explanation = 'HIGH 2,3-BPG shifts the curve RIGHT. 2,3-BPG is produced by RBCs during hypoxia, anemia, or at high altitude. It binds deoxyhemoglobin and reduces O2 affinity, improving O2 delivery.';
  } else if (bpg < 30) {
    explanation = 'LOW 2,3-BPG shifts the curve LEFT. This occurs in stored blood (blood bank). Transfused RBCs temporarily have reduced O2 delivery capacity until 2,3-BPG levels normalize.';
  } else {
    explanation = 'At normal physiological conditions (pH 7.40, 37 C), hemoglobin has standard O2 affinity. The sigmoidal shape reflects cooperative binding: once one O2 binds, subsequent binding is easier.';
  }
  $('bohr-explanation').querySelector('p').textContent = explanation;
}

function drawOxyCurve() {
  const ctx = getCtx('oxy-curve-canvas');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 30, right: 30, bottom: 50, left: 60 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const ph = parseInt($('oxy-ph').value) / 100;
  const temp = parseInt($('oxy-temp').value);
  const bpg = parseInt($('oxy-bpg').value);

  // Hill equation parameters
  // P50 shifts with pH, temp, BPG
  let p50 = 26.6; // normal P50
  p50 += (7.40 - ph) * 40; // pH effect
  p50 += (temp - 37) * 1.5; // temp effect
  p50 += (bpg - 50) * 0.15; // BPG effect
  p50 = clamp(p50, 15, 45);
  const n = 2.7; // Hill coefficient

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 5; i++) {
    const y = pad.top + plotH * (1 - i/5);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W-pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((i*20) + '%', pad.left - 6, y + 4);
  }
  for (let i = 0; i <= 5; i++) {
    const x = pad.left + plotW * i/5;
    ctx.beginPath(); ctx.moveTo(x, pad.top); ctx.lineTo(x, pad.top+plotH); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText((i*20), x, H - pad.bottom + 16);
  }

  // Axis labels
  ctx.fillStyle = '#374151'; ctx.font = '12px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('PO2 (mmHg)', pad.left + plotW/2, H - 8);
  ctx.save(); ctx.translate(14, pad.top + plotH/2); ctx.rotate(-Math.PI/2);
  ctx.fillText('% Hb Saturation', 0, 0); ctx.restore();

  // Normal curve (reference)
  ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1.5; ctx.setLineDash([4,4]);
  ctx.beginPath();
  for (let po2 = 0; po2 <= 100; po2++) {
    const sat = Math.pow(po2, 2.7) / (Math.pow(26.6, 2.7) + Math.pow(po2, 2.7)) * 100;
    const x = pad.left + (po2/100) * plotW;
    const y = pad.top + plotH * (1 - sat/100);
    po2 === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke(); ctx.setLineDash([]);

  // Current curve
  const isShifted = Math.abs(p50 - 26.6) > 2;
  ctx.strokeStyle = isShifted ? (p50 > 26.6 ? '#c41e3a' : '#2563eb') : '#c41e3a';
  ctx.lineWidth = 3;
  ctx.beginPath();
  for (let po2 = 0; po2 <= 100; po2++) {
    const sat = Math.pow(po2, n) / (Math.pow(p50, n) + Math.pow(po2, n)) * 100;
    const x = pad.left + (po2/100) * plotW;
    const y = pad.top + plotH * (1 - sat/100);
    po2 === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke();

  // P50 marker
  const p50x = pad.left + (p50/100) * plotW;
  const p50y = pad.top + plotH * 0.5;
  ctx.fillStyle = '#c41e3a'; ctx.beginPath(); ctx.arc(p50x, p50y, 5, 0, Math.PI*2); ctx.fill();
  ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('P50 = ' + p50.toFixed(1) + ' mmHg', p50x + 8, p50y - 8);

  // Shift arrow
  if (isShifted) {
    const dir = p50 > 26.6 ? 'RIGHT shift' : 'LEFT shift';
    ctx.fillStyle = p50 > 26.6 ? '#c41e3a' : '#2563eb';
    ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(dir, W/2, pad.top + 16);
  }

  // Legend
  ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1.5; ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(pad.left + plotW - 120, pad.top + 8); ctx.lineTo(pad.left + plotW - 100, pad.top + 8); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#9ca3af'; ctx.fillText('Normal', pad.left + plotW - 96, pad.top + 12);
  ctx.strokeStyle = ctx.fillStyle = isShifted ? (p50 > 26.6 ? '#c41e3a' : '#2563eb') : '#c41e3a';
  ctx.lineWidth = 3;
  ctx.beginPath(); ctx.moveTo(pad.left + plotW - 120, pad.top + 24); ctx.lineTo(pad.left + plotW - 100, pad.top + 24); ctx.stroke();
  ctx.fillText('Current', pad.left + plotW - 96, pad.top + 28);

  // Key tissue PO2 annotations
  ctx.fillStyle = '#16a34a'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
  const tissueX = pad.left + (40/100)*plotW;
  ctx.setLineDash([2,2]); ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(tissueX, pad.top); ctx.lineTo(tissueX, pad.top+plotH); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillText('Tissue PO2', tissueX, pad.top + plotH + 14);

  ctx.fillStyle = '#d32f2f';
  const lungX = pad.left + (100/100)*plotW;
  ctx.setLineDash([2,2]); ctx.strokeStyle = '#d32f2f'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(lungX-2, pad.top); ctx.lineTo(lungX-2, pad.top+plotH); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillText('Lung PO2', lungX - 15, pad.top + plotH + 14);
}


// ══════════════════════════════════════════════════════════════════════════
// PART 5: BREATHING RATE EXPERIMENT
// ══════════════════════════════════════════════════════════════════════════
let brState = {
  condition: 'rest', time: 0, running: false, animId: null,
  rateHistory: [], co2History: [], phHistory: [],
  currentRate: 12, currentCO2: 40, currentPH: 7.40,
  chestPhase: 0
};

const conditionParams = {
  rest:     { rate: 12, co2: 40, ph: 7.40, desc: 'Normal resting breathing. Medullary rhythmicity center sets baseline rate.' },
  exercise: { rate: 24, co2: 46, ph: 7.36, desc: 'Light exercise increases metabolic CO2 production. Chemoreceptors detect rising PCO2 and stimulate increased ventilation.' },
  hold:     { rate: 0,  co2: 55, ph: 7.30, desc: 'Breath holding causes CO2 accumulation. Rising PCO2 and falling pH create an increasingly strong urge to breathe. The breakpoint occurs when chemoreceptor stimulation overrides voluntary control.' },
  hyper:    { rate: 30, co2: 25, ph: 7.55, desc: 'Hyperventilation blows off excess CO2, causing respiratory alkalosis. Low PCO2 reduces respiratory drive, potentially causing apnea after voluntary hyperventilation.' },
  co2:      { rate: 28, co2: 52, ph: 7.32, desc: 'Rebreathing expired air increases inspired CO2. Central chemoreceptors in the medulla detect the resulting drop in CSF pH and strongly stimulate ventilation.' }
};

function setBreathCondition(cond) {
  brState.condition = cond;
  const params = conditionParams[cond];

  // Transition over time
  brState.running = true;
  const targetRate = params.rate;
  const targetCO2 = params.co2;
  const targetPH = params.ph;

  // Record data points
  for (let i = 0; i < 10; i++) {
    const t = i / 10;
    brState.currentRate = lerp(brState.currentRate, targetRate, 0.15);
    brState.currentCO2 = lerp(brState.currentCO2, targetCO2, 0.15);
    brState.currentPH = lerp(brState.currentPH, targetPH, 0.15);
    brState.rateHistory.push(brState.currentRate);
    brState.co2History.push(brState.currentCO2);
    brState.phHistory.push(brState.currentPH);
  }

  if (brState.rateHistory.length > 100) {
    brState.rateHistory = brState.rateHistory.slice(-100);
    brState.co2History = brState.co2History.slice(-100);
    brState.phHistory = brState.phHistory.slice(-100);
  }

  $('br-rate').textContent = Math.round(brState.currentRate);
  $('br-co2').textContent = brState.currentCO2.toFixed(0);
  $('br-ph').textContent = brState.currentPH.toFixed(2);
  $('br-condition').textContent = cond.charAt(0).toUpperCase() + cond.slice(1);

  $('chemo-explanation').querySelector('p').textContent = params.desc;

  drawBRChart();
  drawChemoCanvas();
  animateChest();
}

function breathExpReset() {
  brState = {
    condition: 'rest', time: 0, running: false, animId: null,
    rateHistory: [], co2History: [], phHistory: [],
    currentRate: 12, currentCO2: 40, currentPH: 7.40,
    chestPhase: 0
  };
  $('br-rate').textContent = '12';
  $('br-co2').textContent = '40';
  $('br-ph').textContent = '7.40';
  $('br-condition').textContent = 'Rest';
  drawBRChart();
  drawChestCanvas(0);
  drawChemoCanvas();
}

function animateChest() {
  if (brState.animId) cancelAnimationFrame(brState.animId);
  let frame = 0;
  const rate = brState.currentRate;
  const speed = rate > 0 ? rate / 60 * 0.05 : 0;

  function step() {
    frame++;
    if (rate > 0) {
      brState.chestPhase = (brState.chestPhase + speed) % 1;
    }
    drawChestCanvas(brState.chestPhase);
    if (frame < 180) brState.animId = requestAnimationFrame(step);
  }
  step();
}

function drawChestCanvas(phase) {
  const ctx = getCtx('chest-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const cx = W/2;
  const expansion = Math.sin(phase * Math.PI * 2) * 0.5 + 0.5;

  // Rib cage outline
  const ribW = 80 + expansion * 30;
  const ribH = 60 + expansion * 15;

  ctx.strokeStyle = '#78909c'; ctx.lineWidth = 2;
  ctx.fillStyle = 'rgba(187,222,251,0.2)';
  ctx.beginPath();
  ctx.ellipse(cx, H*0.5, ribW, ribH, 0, 0, Math.PI*2);
  ctx.fill(); ctx.stroke();

  // Lungs inside
  const lungW = 25 + expansion * 15;
  const lungH = 35 + expansion * 12;
  ctx.fillStyle = 'rgba(244,143,177,0.3)'; ctx.strokeStyle = '#e91e63'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.ellipse(cx - 30, H*0.48, lungW, lungH, -0.2, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.beginPath(); ctx.ellipse(cx + 30, H*0.48, lungW, lungH, 0.2, 0, Math.PI*2); ctx.fill(); ctx.stroke();

  // Diaphragm
  const dY = H*0.75 - expansion * 15;
  ctx.fillStyle = 'rgba(255,183,77,0.4)'; ctx.strokeStyle = '#ff9800'; ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(cx - ribW - 10, H*0.78);
  ctx.quadraticCurveTo(cx, dY, cx + ribW + 10, H*0.78);
  ctx.stroke();

  // Phase label
  const rate = Math.round(brState.currentRate);
  const isInhale = phase < 0.25 || phase > 0.75;
  ctx.fillStyle = '#1a1a2e'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  if (rate === 0) {
    ctx.fillText('BREATH HOLDING', cx, H*0.12);
  } else {
    ctx.fillText(isInhale ? 'INHALATION' : 'EXHALATION', cx, H*0.12);
  }
  ctx.font = '12px system-ui'; ctx.fillStyle = '#6b7280';
  ctx.fillText(rate + ' breaths/min', cx, H*0.95);
}

function drawBRChart() {
  if (!brState.rateHistory.length) {
    const ctx = getCtx('br-chart');
    ctx.clearRect(0, 0, ctx.W, ctx.H);
    ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, ctx.W, ctx.H);
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Select a condition to start tracking', ctx.W/2, ctx.H/2);
    return;
  }

  const ctx = getCtx('br-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 30, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // We draw three y-axes worth of data normalized
  const rateNorm = brState.rateHistory.map(r => r / 35);
  const co2Norm = brState.co2History.map(c => (c - 20) / 40);
  const phNorm = brState.phHistory.map(p => (p - 7.2) / 0.5);

  drawLineChart(ctx, [
    { data: rateNorm, color: '#c41e3a', width: 2, dots: false },
    { data: co2Norm, color: '#2563eb', width: 2, dots: false },
    { data: phNorm, color: '#16a34a', width: 2, dots: false }
  ], { yMin: 0, yMax: 1 });
}

function drawChemoCanvas() {
  const ctx = getCtx('chemo-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Chemoreceptor diagram
  const cx = W/2;

  // Brain stem (medulla)
  ctx.fillStyle = '#e8eaf6'; ctx.strokeStyle = '#5c6bc0'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.ellipse(cx, H*0.35, 60, 40, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.fillStyle = '#283593'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Medulla', cx, H*0.33);
  ctx.font = '10px system-ui'; ctx.fillText('Central', cx, H*0.40);
  ctx.fillText('Chemoreceptors', cx, H*0.48);

  // Carotid body
  ctx.fillStyle = '#fce4ec'; ctx.strokeStyle = '#e91e63'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.ellipse(cx - 120, H*0.55, 30, 20, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.fillStyle = '#880e4f'; ctx.font = 'bold 10px system-ui';
  ctx.fillText('Carotid Body', cx - 120, H*0.55);

  // Aortic body
  ctx.fillStyle = '#fff3e0'; ctx.strokeStyle = '#ff9800'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.ellipse(cx + 120, H*0.55, 30, 20, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.fillStyle = '#e65100'; ctx.font = 'bold 10px system-ui';
  ctx.fillText('Aortic Body', cx + 120, H*0.55);

  // Stimulus arrows
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui';
  const co2 = brState.currentCO2;
  const ph = brState.currentPH;
  const stimLevel = clamp((co2 - 35) / 25, 0, 1);

  // Stimulus bar
  ctx.fillStyle = '#e8f5e9';
  ctx.fillRect(cx - 80, H*0.75, 160, 20);
  ctx.fillStyle = stimLevel > 0.5 ? '#c41e3a' : '#16a34a';
  ctx.fillRect(cx - 80, H*0.75, 160 * stimLevel, 20);
  ctx.strokeStyle = '#374151'; ctx.lineWidth = 1;
  ctx.strokeRect(cx - 80, H*0.75, 160, 20);
  ctx.fillStyle = '#1a1a2e'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Ventilatory Drive: ' + (stimLevel * 100).toFixed(0) + '%', cx, H*0.73);

  // Connections
  ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(cx - 90, H*0.55); ctx.lineTo(cx - 60, H*0.42); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx + 90, H*0.55); ctx.lineTo(cx + 60, H*0.42); ctx.stroke();

  // Detects labels
  ctx.fillStyle = '#6b7280'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Detects: CSF pH (via CO2)', cx, H*0.20);
  ctx.fillText('Detects: PO2, PCO2, pH', cx - 120, H*0.70);
  ctx.fillText('Detects: PO2, PCO2, pH', cx + 120, H*0.70);

  // Current values
  ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 12px system-ui';
  ctx.fillText('CO2: ' + co2.toFixed(0) + ' mmHg | pH: ' + ph.toFixed(2), cx, H*0.95);
}


// ══════════════════════════════════════════════════════════════════════════
// PART 6: RESPIRATORY HEALTH DASHBOARD
// ══════════════════════════════════════════════════════════════════════════
let currentCondition = 'asthma';

const conditions = {
  asthma: {
    title: 'Asthma',
    desc: 'Chronic inflammatory disorder of the airways. Characterized by episodic bronchoconstriction, airway inflammation, and excess mucus production. Bronchial smooth muscle spasm narrows the airway lumen, especially during exhalation, causing wheezing, chest tightness, and dyspnea.',
    treatment: 'Rescue inhalers (short-acting beta-agonists like albuterol) for acute attacks. Controller medications include inhaled corticosteroids, long-acting beta-agonists (LABAs), and leukotriene modifiers. Severe cases may require biologic therapy (anti-IgE, anti-IL-5).',
    spiroPat: 'obstructive'
  },
  copd: {
    title: 'COPD / Emphysema',
    desc: 'Chronic obstructive pulmonary disease encompasses emphysema (alveolar wall destruction, air trapping) and chronic bronchitis (excessive mucus, inflamed airways). Usually caused by smoking. Emphysema reduces gas exchange surface area and elasticity, leading to air trapping and hyperinflation.',
    treatment: 'Smoking cessation is the most important intervention. Bronchodilators (anticholinergics, beta-agonists), inhaled corticosteroids, pulmonary rehabilitation. Severe cases: supplemental O2, lung volume reduction surgery, or transplant.',
    spiroPat: 'obstructive'
  },
  pneumonia: {
    title: 'Pneumonia',
    desc: 'Infection of the lung parenchyma caused by bacteria (Streptococcus pneumoniae most common), viruses, or fungi. Alveoli fill with inflammatory exudate (pus, fluid), impairing gas exchange. Consolidation visible on chest X-ray. Symptoms: productive cough, fever, dyspnea, pleuritic chest pain.',
    treatment: 'Bacterial: antibiotics (amoxicillin, azithromycin, fluoroquinolones). Viral: supportive care, antivirals for influenza/COVID. Prevention: pneumococcal and influenza vaccines. Severe cases require hospitalization, supplemental O2, and IV antibiotics.',
    spiroPat: 'restrictive'
  },
  covid: {
    title: 'COVID-19 Respiratory Effects',
    desc: 'SARS-CoV-2 binds ACE2 receptors on Type II pneumocytes. Causes diffuse alveolar damage, inflammatory cytokine storm, and microthrombi in pulmonary vasculature. Can progress to ARDS (Acute Respiratory Distress Syndrome) with bilateral lung infiltrates and severe hypoxemia. Long COVID may cause persistent dyspnea and reduced exercise tolerance.',
    treatment: 'Mild: supportive care, antipyretics. Moderate-severe: dexamethasone (reduces mortality), remdesivir, supplemental O2. Critical: mechanical ventilation, prone positioning, ECMO. Prevention: mRNA and viral vector vaccines. Nirmatrelvir/ritonavir for high-risk patients.',
    spiroPat: 'restrictive'
  }
};

function selectCondition(cond) {
  currentCondition = cond;
  const info = conditions[cond];

  // Update tabs
  document.querySelectorAll('.condition-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');

  $('cond-title').textContent = info.title;
  $('cond-desc').textContent = info.desc;
  $('cond-treatment-text').textContent = info.treatment;

  drawConditionCanvas();
  drawSpiroDisease();
}

function drawConditionCanvas() {
  const ctx = getCtx('condition-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const cx = W/2;

  // Draw side by side: Normal vs Diseased
  ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Normal', cx - W*0.22, 20);
  ctx.fillText('Diseased', cx + W*0.22, 20);

  // Divider line
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(cx, 10); ctx.lineTo(cx, H-10); ctx.stroke();

  if (currentCondition === 'asthma') {
    // Normal bronchiole
    drawBronchiole(ctx, cx - W*0.22, H*0.5, 30, 20, false);
    // Asthmatic bronchiole (constricted)
    drawBronchiole(ctx, cx + W*0.22, H*0.5, 30, 8, true);
    ctx.fillStyle = '#e91e63'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Bronchospasm', cx + W*0.22, H*0.85);
    ctx.fillText('+ Inflammation', cx + W*0.22, H*0.90);
    ctx.fillText('+ Excess Mucus', cx + W*0.22, H*0.95);
  } else if (currentCondition === 'copd') {
    // Normal alveoli
    drawAlveoliCluster(ctx, cx - W*0.22, H*0.5, 5, false);
    // Emphysematous alveoli (destroyed walls)
    drawAlveoliCluster(ctx, cx + W*0.22, H*0.5, 5, true);
    ctx.fillStyle = '#e91e63'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Destroyed Walls', cx + W*0.22, H*0.88);
    ctx.fillText('Air Trapping', cx + W*0.22, H*0.93);
  } else if (currentCondition === 'pneumonia') {
    // Normal alveolus
    drawSingleAlveolus(ctx, cx - W*0.22, H*0.5, 40, false);
    // Fluid-filled alveolus
    drawSingleAlveolus(ctx, cx + W*0.22, H*0.5, 40, true);
    ctx.fillStyle = '#e91e63'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Fluid/Pus Filled', cx + W*0.22, H*0.88);
    ctx.fillText('Impaired Exchange', cx + W*0.22, H*0.93);
  } else if (currentCondition === 'covid') {
    // Normal alveolar wall
    drawCovidAlveolus(ctx, cx - W*0.22, H*0.5, false);
    // Inflamed with microthrombi
    drawCovidAlveolus(ctx, cx + W*0.22, H*0.5, true);
    ctx.fillStyle = '#e91e63'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Cytokine Storm', cx + W*0.22, H*0.85);
    ctx.fillText('Microthrombi', cx + W*0.22, H*0.90);
    ctx.fillText('ARDS', cx + W*0.22, H*0.95);
  }
}

function drawBronchiole(ctx, cx, cy, outerR, innerR, diseased) {
  // Outer wall
  ctx.fillStyle = diseased ? 'rgba(244,143,177,0.5)' : 'rgba(187,222,251,0.3)';
  ctx.strokeStyle = diseased ? '#e91e63' : '#2196f3'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(cx, cy, outerR, 0, Math.PI*2); ctx.fill(); ctx.stroke();

  // Smooth muscle
  if (diseased) {
    ctx.strokeStyle = '#ad1457'; ctx.lineWidth = 3;
    ctx.beginPath(); ctx.arc(cx, cy, outerR - 4, 0, Math.PI*2); ctx.stroke();
  }

  // Lumen
  ctx.fillStyle = diseased ? 'rgba(255,255,255,0.5)' : '#fff';
  ctx.strokeStyle = diseased ? '#e91e63' : '#90caf9'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.arc(cx, cy, innerR, 0, Math.PI*2); ctx.fill(); ctx.stroke();

  // Mucus plugs in diseased
  if (diseased) {
    ctx.fillStyle = 'rgba(255,235,59,0.6)';
    for (let i = 0; i < 4; i++) {
      const a = i * Math.PI/2;
      ctx.beginPath(); ctx.arc(cx + Math.cos(a)*(innerR+3), cy + Math.sin(a)*(innerR+3), 3, 0, Math.PI*2); ctx.fill();
    }
  }

  // Label
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Lumen: ' + (innerR*2) + 'px', cx, cy + outerR + 16);
}

function drawAlveoliCluster(ctx, cx, cy, count, destroyed) {
  const positions = [
    [-20, -15], [20, -15], [0, 15], [-25, 10], [25, 10]
  ];
  positions.forEach(([dx, dy], i) => {
    if (destroyed) {
      // Irregular, merged spaces
      ctx.fillStyle = 'rgba(255,205,210,0.3)';
      ctx.strokeStyle = '#ef5350'; ctx.lineWidth = 1;
      const r = 15 + rand(5, 15);
      ctx.beginPath(); ctx.ellipse(cx+dx, cy+dy, r, r*0.8, i*0.5, 0, Math.PI*2); ctx.fill();
      if (i % 2 === 0) ctx.stroke();
    } else {
      ctx.fillStyle = 'rgba(187,222,251,0.3)';
      ctx.strokeStyle = '#42a5f5'; ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.arc(cx+dx, cy+dy, 14, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    }
  });
}

function drawSingleAlveolus(ctx, cx, cy, r, filled) {
  ctx.fillStyle = filled ? 'rgba(255,235,59,0.4)' : 'rgba(187,222,251,0.2)';
  ctx.strokeStyle = filled ? '#ff9800' : '#42a5f5'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.fill(); ctx.stroke();

  if (filled) {
    // Fluid level
    ctx.fillStyle = 'rgba(255,152,0,0.3)';
    ctx.beginPath();
    ctx.moveTo(cx - r, cy + 5);
    ctx.quadraticCurveTo(cx, cy - 5, cx + r, cy + 5);
    ctx.lineTo(cx + r, cy + r);
    ctx.arc(cx, cy, r, 0.1, Math.PI - 0.1);
    ctx.closePath(); ctx.fill();

    // Bacteria
    ctx.fillStyle = '#4caf50';
    for (let i = 0; i < 5; i++) {
      ctx.beginPath(); ctx.arc(cx + rand(-20,20), cy + rand(5, 25), 3, 0, Math.PI*2); ctx.fill();
    }
  } else {
    // Air
    ctx.fillStyle = '#bbdefb'; ctx.font = '14px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Air', cx, cy + 5);
  }
}

function drawCovidAlveolus(ctx, cx, cy, diseased) {
  // Alveolus
  ctx.fillStyle = diseased ? 'rgba(255,205,210,0.3)' : 'rgba(187,222,251,0.2)';
  ctx.strokeStyle = diseased ? '#d32f2f' : '#42a5f5'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(cx, cy, 35, 0, Math.PI*2); ctx.fill(); ctx.stroke();

  if (diseased) {
    // Inflammatory cells
    ctx.fillStyle = '#ff5722';
    for (let i = 0; i < 8; i++) {
      const a = i * Math.PI/4;
      ctx.beginPath(); ctx.arc(cx + Math.cos(a)*25, cy + Math.sin(a)*25, 4, 0, Math.PI*2); ctx.fill();
    }

    // Cytokine markers
    ctx.fillStyle = '#ff9800'; ctx.font = '8px system-ui'; ctx.textAlign = 'center';
    for (let i = 0; i < 4; i++) {
      const a = i * Math.PI/2 + 0.3;
      ctx.fillText('IL-6', cx + Math.cos(a)*40, cy + Math.sin(a)*40);
    }

    // Microthrombi in capillary
    ctx.fillStyle = '#6a1b9a';
    ctx.beginPath(); ctx.ellipse(cx + 15, cy + 45, 8, 4, 0, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(cx - 10, cy + 48, 6, 3, 0.3, 0, Math.PI*2); ctx.fill();

    // Thickened membrane
    ctx.strokeStyle = '#9e9e9e'; ctx.lineWidth = 4;
    ctx.beginPath(); ctx.arc(cx, cy, 37, 0.5, 2.5); ctx.stroke();
  } else {
    // Type II cells
    ctx.fillStyle = '#81c784';
    ctx.beginPath(); ctx.arc(cx - 20, cy + 25, 5, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx + 15, cy + 28, 5, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#2e7d32'; ctx.font = '7px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('ACE2', cx - 20, cy + 28);
  }
}

function drawSpiroDisease() {
  const ctx = getCtx('spiro-disease-canvas');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 30, right: 30, bottom: 40, left: 60 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 5; i++) {
    const y = pad.top + plotH * (1 - i/5);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W-pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((i) + 'L', pad.left - 6, y + 4);
  }
  ctx.fillStyle = '#374151'; ctx.font = '12px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Time (seconds)', pad.left + plotW/2, H - 8);
  for (let i = 0; i <= 6; i++) {
    const x = pad.left + plotW * i/6;
    ctx.fillText(i, x, H - pad.bottom + 16);
  }

  // Normal FVC curve (forced expiratory)
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2.5;
  ctx.beginPath();
  for (let t = 0; t <= 6; t += 0.05) {
    const vol = 5 * (1 - Math.exp(-t * 2.5)); // Normal: rapid emptying
    const x = pad.left + (t/6) * plotW;
    const y = pad.top + plotH * (1 - vol/5);
    t === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke();

  // Disease curve
  const info = conditions[currentCondition];
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2.5;
  ctx.beginPath();
  if (info.spiroPat === 'obstructive') {
    // Obstructive: slow emptying, air trapping
    for (let t = 0; t <= 6; t += 0.05) {
      const vol = 3.5 * (1 - Math.exp(-t * 0.8));
      const x = pad.left + (t/6) * plotW;
      const y = pad.top + plotH * (1 - vol/5);
      t === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
  } else {
    // Restrictive: reduced total but normal rate
    for (let t = 0; t <= 6; t += 0.05) {
      const vol = 3.0 * (1 - Math.exp(-t * 2.5));
      const x = pad.left + (t/6) * plotW;
      const y = pad.top + plotH * (1 - vol/5);
      t === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
  }
  ctx.stroke();

  // FEV1 marker at t=1
  const fev1x = pad.left + (1/6) * plotW;
  ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(fev1x, pad.top); ctx.lineTo(fev1x, pad.top + plotH); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#9ca3af'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('FEV1', fev1x, pad.top - 4);

  // Legend
  ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 3;
  ctx.beginPath(); ctx.moveTo(pad.left + plotW - 130, pad.top + 8); ctx.lineTo(pad.left + plotW - 110, pad.top + 8); ctx.stroke();
  ctx.fillStyle = '#2563eb'; ctx.fillText('Normal', pad.left + plotW - 106, pad.top + 12);
  ctx.strokeStyle = '#c41e3a';
  ctx.beginPath(); ctx.moveTo(pad.left + plotW - 130, pad.top + 24); ctx.lineTo(pad.left + plotW - 110, pad.top + 24); ctx.stroke();
  ctx.fillStyle = '#c41e3a'; ctx.fillText(info.title, pad.left + plotW - 106, pad.top + 28);

  // Pattern label
  ctx.fillStyle = '#7c3aed'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Pattern: ' + info.spiroPat.charAt(0).toUpperCase() + info.spiroPat.slice(1), pad.left, pad.top - 8);
}

// Smoking cessation timeline
function drawSmokingTimeline() {
  const ctx = getCtx('smoking-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const events = [
    { time: '20 min', pct: 0.03, text: 'Heart rate and blood\npressure drop', color: '#16a34a' },
    { time: '12 hrs', pct: 0.08, text: 'CO level in blood\ndrops to normal', color: '#16a34a' },
    { time: '2 weeks', pct: 0.15, text: 'Circulation & lung\nfunction improve', color: '#2563eb' },
    { time: '1 month', pct: 0.22, text: 'Cilia regrow,\nless coughing', color: '#2563eb' },
    { time: '3 months', pct: 0.30, text: 'Lung function\nincreases 30%', color: '#2563eb' },
    { time: '1 year', pct: 0.45, text: 'Heart disease risk\nhalved', color: '#7c3aed' },
    { time: '5 years', pct: 0.65, text: 'Stroke risk equals\nnon-smoker', color: '#7c3aed' },
    { time: '10 years', pct: 0.82, text: 'Lung cancer risk\nhalved', color: '#d97706' },
    { time: '15 years', pct: 0.95, text: 'Heart disease risk\nequals non-smoker', color: '#16a34a' }
  ];

  const pad = { top: 30, right: 30, bottom: 30, left: 30 };
  const plotW = W - pad.left - pad.right;
  const timelineY = H * 0.45;

  // Timeline line
  ctx.strokeStyle = '#374151'; ctx.lineWidth = 3;
  ctx.beginPath(); ctx.moveTo(pad.left, timelineY); ctx.lineTo(W - pad.right, timelineY); ctx.stroke();

  // Arrow at end
  ctx.fillStyle = '#374151';
  ctx.beginPath();
  ctx.moveTo(W - pad.right, timelineY);
  ctx.lineTo(W - pad.right - 10, timelineY - 6);
  ctx.lineTo(W - pad.right - 10, timelineY + 6);
  ctx.closePath(); ctx.fill();

  events.forEach((ev, i) => {
    const x = pad.left + ev.pct * plotW;
    const isAbove = i % 2 === 0;
    const dotY = timelineY;

    // Dot
    ctx.fillStyle = ev.color; ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(x, dotY, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Connector
    ctx.strokeStyle = ev.color; ctx.lineWidth = 1;
    const textY = isAbove ? dotY - 25 : dotY + 25;
    ctx.beginPath(); ctx.moveTo(x, dotY + (isAbove ? -8 : 8));
    ctx.lineTo(x, textY); ctx.stroke();

    // Time label
    ctx.fillStyle = ev.color; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(ev.time, x, isAbove ? textY - 28 : textY + 12);

    // Description
    ctx.fillStyle = '#374151'; ctx.font = '10px system-ui';
    const lines = ev.text.split('\n');
    lines.forEach((line, li) => {
      ctx.fillText(line, x, isAbove ? textY - 14 + li * 12 : textY + 24 + li * 12);
    });
  });

  // Title
  ctx.fillStyle = '#1a1a2e'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Health Recovery After Quitting Smoking', pad.left, 18);
}


// ══════════════════════════════════════════════════════════════════════════
// SIDEBAR ACTIVE STATE
// ══════════════════════════════════════════════════════════════════════════
const navLinks = document.querySelectorAll('.sidebar-nav a');
const sectionObserver = new IntersectionObserver(entries => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      navLinks.forEach(a => a.classList.remove('active'));
      const id = entry.target.id;
      const link = document.querySelector('.sidebar-nav a[href="#' + id + '"]');
      if (link) link.classList.add('active');
    }
  });
}, { rootMargin: '-20% 0px -80% 0px' });

document.querySelectorAll('.section, .hero').forEach(s => sectionObserver.observe(s));


// ══════════════════════════════════════════════════════════════════════════
// INITIALIZATION
// ══════════════════════════════════════════════════════════════════════════
function init() {
  drawAnatomy();
  drawBellJar(0);
  drawPVChart();
  drawSpirometry();
  drawComparisonChart();
  drawGasExchange();
  drawOxyCurve();
  drawChestCanvas(0);
  drawBRChart();
  drawChemoCanvas();
  drawConditionCanvas();
  drawSpiroDisease();
  drawSmokingTimeline();
}

window.addEventListener('load', init);
window.addEventListener('resize', () => {
  // Redraw all canvases on resize
  drawAnatomy();
  drawBellJar(breathState.running ? 0 : 0);
  drawPVChart();
  drawSpirometry();
  drawComparisonChart();
  drawGasExchange();
  drawOxyCurve();
  drawChestCanvas(brState.chestPhase);
  drawBRChart();
  drawChemoCanvas();
  drawConditionCanvas();
  drawSpiroDisease();
  drawSmokingTimeline();
});
</script>
</body>
</html>
