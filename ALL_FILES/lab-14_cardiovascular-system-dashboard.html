<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 14 Dashboard: Cardiovascular System | BIOL-8</title>
<style>
/* ═══════════════════════════════════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f0f2f5; --card: #ffffff; --sidebar: #1a1a2e; --sidebar-hover: #252545;
  --accent: #c41e3a; --accent-light: #e8354f; --blue: #2563eb; --blue-light: #3b82f6;
  --green: #16a34a; --amber: #d97706; --purple: #7c3aed;
  --text: #1a1a1a; --text-muted: #6b7280; --border: #e5e7eb;
  --radius: 10px; --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
}
html { scroll-behavior: smooth; }
body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; }

/* ═══════════════════════════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════════════════════════ */
.layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; background: var(--sidebar); color: #e2e8f0; position: fixed;
  top: 0; left: 0; height: 100vh; overflow-y: auto; z-index: 100;
  display: flex; flex-direction: column;
}
.sidebar-header { padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-header h1 { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
.sidebar-header p { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.sidebar-nav { flex: 1; padding: 12px 0; }
.sidebar-nav a {
  display: flex; align-items: center; gap: 10px; padding: 10px 20px;
  color: #94a3b8; text-decoration: none; font-size: 13px; font-weight: 500;
  transition: all 0.15s; border-left: 3px solid transparent;
}
.sidebar-nav a:hover { background: var(--sidebar-hover); color: #e2e8f0; }
.sidebar-nav a.active { color: #fff; background: var(--sidebar-hover); border-left-color: var(--accent); }
.sidebar-nav .nav-num {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 6px; font-size: 11px; font-weight: 700;
  background: rgba(255,255,255,0.08); flex-shrink: 0;
}
.sidebar-nav a.active .nav-num { background: var(--accent); color: #fff; }
.sidebar-footer { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #64748b; }

.main { margin-left: 260px; flex: 1; padding: 32px; max-width: 1200px; }

/* ═══════════════════════════════════════════════════════════════════════
   CARDS & SECTIONS
   ═══════════════════════════════════════════════════════════════════════ */
.section { margin-bottom: 40px; scroll-margin-top: 24px; }
.section-header {
  display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
}
.section-num {
  display: flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: 10px;
  background: var(--accent); color: #fff; font-weight: 800; font-size: 16px; flex-shrink: 0;
}
.section-title { font-size: 22px; font-weight: 700; }
.section-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

.card {
  background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 24px; margin-bottom: 16px; border: 1px solid var(--border);
}
.card-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.card-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
@media (max-width: 900px) { .card-row, .card-row-3 { grid-template-columns: 1fr; } }

/* ═══════════════════════════════════════════════════════════════════════
   BUTTONS & INPUTS
   ═══════════════════════════════════════════════════════════════════════ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
  border: none; cursor: pointer; transition: all 0.15s; font-family: var(--font);
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn-secondary { background: var(--blue); color: #fff; }
.btn-secondary:hover { background: var(--blue-light); }
.btn-outline { background: transparent; color: var(--text); border: 2px solid var(--border); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }

.slider-group { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
.slider-group label { font-size: 13px; font-weight: 600; min-width: 80px; }
.slider-group input[type=range] { flex: 1; accent-color: var(--accent); }
.slider-val { font-family: var(--mono); font-size: 14px; font-weight: 700; min-width: 50px; text-align: right; }

input[type=number] {
  width: 80px; padding: 6px 10px; border: 2px solid var(--border); border-radius: 6px;
  font-family: var(--mono); font-size: 14px; font-weight: 600; text-align: center;
}
input[type=number]:focus { outline: none; border-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   STATS & BADGES
   ═══════════════════════════════════════════════════════════════════════ */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 12px 0; }
.stat-box {
  text-align: center; padding: 14px 8px; border-radius: 8px;
  background: #f8fafc; border: 1px solid var(--border);
}
.stat-box .stat-val { font-size: 28px; font-weight: 800; font-family: var(--mono); }
.stat-box .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-accent .stat-val { color: var(--accent); }
.stat-blue .stat-val { color: var(--blue); }
.stat-green .stat-val { color: var(--green); }
.stat-amber .stat-val { color: var(--amber); }
.stat-purple .stat-val { color: var(--purple); }

.badge {
  display: inline-block; padding: 2px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
}
.badge-red { background: #fef2f2; color: var(--accent); }
.badge-blue { background: #eff6ff; color: var(--blue); }
.badge-green { background: #f0fdf4; color: var(--green); }

/* ═══════════════════════════════════════════════════════════════════════
   CHART CONTAINERS
   ═══════════════════════════════════════════════════════════════════════ */
.chart-wrap { position: relative; width: 100%; margin: 8px 0; }
.chart-wrap canvas { width: 100% !important; display: block; border-radius: 6px; }

/* ═══════════════════════════════════════════════════════════════════════
   INFO PANEL (for anatomy explorer)
   ═══════════════════════════════════════════════════════════════════════ */
.info-panel {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--accent); font-size: 14px; min-height: 80px;
}
.info-panel .ip-title { font-weight: 700; margin-bottom: 6px; font-size: 16px; }
.info-panel .ip-type { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600; }
.info-panel .ip-desc { margin-top: 6px; color: #374151; line-height: 1.6; }

/* ═══════════════════════════════════════════════════════════════════════
   ANALYSIS PANEL
   ═══════════════════════════════════════════════════════════════════════ */
.analysis-result {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--blue); font-size: 14px;
}
.analysis-result .ar-title { font-weight: 700; margin-bottom: 6px; }
.analysis-result code { font-family: var(--mono); background: #e2e8f0; padding: 1px 6px; border-radius: 4px; font-size: 13px; }
.analysis-result.ar-pass { border-left-color: var(--green); }
.analysis-result.ar-fail { border-left-color: var(--accent); }
.analysis-result.ar-warn { border-left-color: var(--amber); }

/* ═══════════════════════════════════════════════════════════════════════
   HERO BANNER
   ═══════════════════════════════════════════════════════════════════════ */
.hero {
  background: linear-gradient(135deg, #1a1a2e 0%, #2d1b3d 50%, #3b1a2e 100%);
  color: #fff; border-radius: var(--radius); padding: 36px; margin-bottom: 32px;
  position: relative; overflow: hidden;
}
.hero::after {
  content: ''; position: absolute; top: -50%; right: -20%; width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(196,30,58,0.15) 0%, transparent 70%);
  pointer-events: none;
}
.hero h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.hero p { font-size: 15px; color: #cbd5e1; max-width: 600px; line-height: 1.7; }
.hero .bio-tags { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
.hero .bio-tag {
  padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
  background: rgba(255,255,255,0.1); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);
}

/* ═══════════════════════════════════════════════════════════════════════
   CONVERGENCE LINE
   ═══════════════════════════════════════════════════════════════════════ */
.convergence-info { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin: 10px 0; font-size: 13px; }
.convergence-info .ci-dot { width: 12px; height: 3px; border-radius: 2px; display: inline-block; }

/* ═══════════════════════════════════════════════════════════════════════
   CELL GALLERY GRID
   ═══════════════════════════════════════════════════════════════════════ */
.cell-type-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin: 12px 0; }
.cell-type-btn {
  text-align: center; padding: 12px 6px; border-radius: 8px; cursor: pointer;
  background: #f8fafc; border: 2px solid var(--border); transition: all 0.15s;
  font-size: 12px; font-weight: 600;
}
.cell-type-btn:hover { border-color: var(--accent); }
.cell-type-btn.active { border-color: var(--accent); background: #fef2f2; }
.cell-type-btn .ct-icon { font-size: 24px; margin-bottom: 4px; }

/* ═══════════════════════════════════════════════════════════════════════
   RISK METER
   ═══════════════════════════════════════════════════════════════════════ */
.risk-meter { position: relative; height: 30px; border-radius: 15px; overflow: hidden; margin: 12px 0;
  background: linear-gradient(90deg, #16a34a 0%, #d97706 50%, #dc2626 100%); }
.risk-needle { position: absolute; top: -4px; width: 4px; height: 38px; background: #1a1a1a; border-radius: 2px; transition: left 0.5s; }
.risk-labels { display: flex; justify-content: space-between; font-size: 11px; font-weight: 600; color: var(--text-muted); margin-top: 4px; }

/* ═══════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main { margin-left: 0; padding: 16px; }
}
</style>
</head>
<body>
<div class="layout">

<!-- ═══════════════════════════════════════════════════════════════════════
     SIDEBAR
     ═══════════════════════════════════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h1>BIOL-8: Human Biology</h1>
    <p>Lab 14 &mdash; Cardiovascular System</p>
  </div>
  <nav class="sidebar-nav">
    <a href="#hero" class="active"><span class="nav-num">&bull;</span> Overview</a>
    <a href="#part1"><span class="nav-num">1</span> Heart Anatomy</a>
    <a href="#part2"><span class="nav-num">2</span> Blood Flow</a>
    <a href="#part3"><span class="nav-num">3</span> HR &amp; Blood Pressure</a>
    <a href="#part4"><span class="nav-num">4</span> ECG Reader</a>
    <a href="#part5"><span class="nav-num">5</span> Blood Cells</a>
    <a href="#part6"><span class="nav-num">6</span> CV Health</a>
  </nav>
  <div class="sidebar-footer">Interactive Lab Dashboard<br>&copy; 2026 BIOL-8</div>
</aside>

<!-- ═══════════════════════════════════════════════════════════════════════
     MAIN CONTENT
     ═══════════════════════════════════════════════════════════════════════ -->
<div class="main">

<!-- HERO -->
<div class="hero" id="hero">
  <h2>Cardiovascular System</h2>
  <p>Explore heart anatomy, trace blood flow through pulmonary and systemic circuits, measure heart rate and blood pressure, read ECG waveforms, identify blood cell types, and assess cardiovascular health risk factors.</p>
  <div class="bio-tags">
    <span class="bio-tag">Heart</span>
    <span class="bio-tag">Blood Pressure</span>
    <span class="bio-tag">Circulation</span>
  </div>
</div>

<!-- ═══════════════════════════ PART 1: HEART ANATOMY EXPLORER ═══════════ -->
<div class="section" id="part1">
  <div class="section-header">
    <div class="section-num">1</div>
    <div><div class="section-title">Heart Anatomy Explorer</div>
    <div class="section-subtitle">Click on structures to identify chambers, valves, vessels, and more</div></div>
  </div>
  <div class="card">
    <div class="card-title">Interactive Heart Cross-Section</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Click any labeled structure on the heart diagram to learn about it. Oxygenated blood shown in red, deoxygenated in blue.</p>
    <div class="chart-wrap"><canvas id="heart-canvas" height="520"></canvas></div>
    <div class="info-panel" id="anatomy-info">
      <div class="ip-type">Select a structure</div>
      <div class="ip-title">Heart Anatomy</div>
      <div class="ip-desc">Click on any chamber, valve, vessel, or structure on the heart diagram above to see detailed information about its function and location.</div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════ PART 2: BLOOD FLOW PATHWAY ═══════════════ -->
<div class="section" id="part2">
  <div class="section-header">
    <div class="section-num">2</div>
    <div><div class="section-title">Blood Flow Pathway</div>
    <div class="section-subtitle">Animated blood circulation through pulmonary and systemic circuits</div></div>
  </div>
  <div class="card">
    <div class="card-title">Circulatory System Animation</div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="flowDropCell()">Drop Blood Cell</button>
      <button class="btn btn-secondary" onclick="flowToggleO2()">Toggle O2 Trace</button>
      <button class="btn btn-outline" onclick="flowReset()">Reset</button>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="flow-circuit">--</div><div class="stat-label">Current Circuit</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="flow-location">--</div><div class="stat-label">Location</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="flow-o2">--</div><div class="stat-label">O2 Status</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="flow-timer">0.0s</div><div class="stat-label">Circuit Time</div></div>
    </div>
    <div class="chart-wrap"><canvas id="flow-canvas" height="480"></canvas></div>
    <div class="convergence-info">
      <span><span class="ci-dot" style="background:#dc2626;"></span> Oxygenated (arteries)</span>
      <span><span class="ci-dot" style="background:#2563eb;"></span> Deoxygenated (veins)</span>
      <span><span class="ci-dot" style="background:#7c3aed;"></span> Gas exchange</span>
    </div>
  </div>
</div>

<!-- ═══════════════════════════ PART 3: HR & BP LAB ══════════════════════ -->
<div class="section" id="part3">
  <div class="section-header">
    <div class="section-num">3</div>
    <div><div class="section-title">Heart Rate &amp; Blood Pressure Lab</div>
    <div class="section-subtitle">Measure and simulate cardiovascular responses to different activities</div></div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Resting Heart Rate</div>
      <div class="slider-group">
        <label>Your HR</label>
        <input type="number" id="hr-input" value="72" min="40" max="200" onchange="hrUpdateResting()">
        <span class="slider-val">bpm</span>
      </div>
      <div class="chart-wrap"><canvas id="hr-heart-canvas" height="180"></canvas></div>
      <div class="stat-grid">
        <div class="stat-box stat-accent"><div class="stat-val" id="hr-current">72</div><div class="stat-label">Heart Rate</div></div>
        <div class="stat-box stat-blue"><div class="stat-val" id="hr-co">5.0</div><div class="stat-label">CO (L/min)</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Blood Pressure</div>
      <div class="stat-grid">
        <div class="stat-box stat-accent"><div class="stat-val" id="bp-sys">120</div><div class="stat-label">Systolic</div></div>
        <div class="stat-box stat-blue"><div class="stat-val" id="bp-dia">80</div><div class="stat-label">Diastolic</div></div>
        <div class="stat-box stat-green"><div class="stat-val" id="bp-map">93</div><div class="stat-label">MAP</div></div>
        <div class="stat-box stat-amber"><div class="stat-val" id="bp-status">Normal</div><div class="stat-label">Category</div></div>
      </div>
      <div class="analysis-result ar-pass" id="bp-ref">
        <div class="ar-title">Normal Ranges</div>
        <p><strong>Normal:</strong> &lt;120/80 &nbsp; <strong>Elevated:</strong> 120-129/&lt;80 &nbsp; <strong>Stage 1 HTN:</strong> 130-139/80-89 &nbsp; <strong>Stage 2 HTN:</strong> &ge;140/90</p>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Activity Simulation</div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="hrSimActivity('rest')">Rest</button>
      <button class="btn btn-secondary" onclick="hrSimActivity('walking')">Walking</button>
      <button class="btn btn-secondary" onclick="hrSimActivity('running')">Running</button>
      <button class="btn btn-outline" onclick="hrSimActivity('stress')">Stress</button>
      <button class="btn btn-outline" onclick="hrSimActivity('caffeine')">Caffeine</button>
    </div>
    <div class="chart-wrap"><canvas id="hr-activity-chart" height="260"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Cardiac Output = HR &times; Stroke Volume</div>
    <div class="slider-group">
      <label>Stroke Vol</label>
      <input type="range" id="hr-sv" min="40" max="120" value="70" oninput="hrUpdateCO()">
      <span class="slider-val" id="hr-sv-val">70 mL</span>
    </div>
    <div class="chart-wrap"><canvas id="hr-co-chart" height="220"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════════ PART 4: ECG READER ═══════════════════════ -->
<div class="section" id="part4">
  <div class="section-header">
    <div class="section-num">4</div>
    <div><div class="section-title">ECG (Electrocardiogram) Reader</div>
    <div class="section-subtitle">Visualize electrical activity of the heart and identify waveform components</div></div>
  </div>
  <div class="card">
    <div class="card-title">ECG Waveform</div>
    <div class="slider-group">
      <label>Heart Rate</label>
      <input type="range" id="ecg-hr" min="40" max="180" value="72" oninput="ecgUpdate()">
      <span class="slider-val" id="ecg-hr-val">72 bpm</span>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="ecgSetPattern('normal')">Normal Sinus</button>
      <button class="btn btn-secondary" onclick="ecgSetPattern('tachy')">Tachycardia</button>
      <button class="btn btn-secondary" onclick="ecgSetPattern('brady')">Bradycardia</button>
    </div>
    <div class="chart-wrap"><canvas id="ecg-canvas" height="300"></canvas></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="ecg-rate">72</div><div class="stat-label">Heart Rate</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="ecg-rr">0.83</div><div class="stat-label">R-R Interval (s)</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="ecg-pattern">NSR</div><div class="stat-label">Rhythm</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">ECG Component Reference</div>
    <div class="info-panel" id="ecg-info" style="border-left-color: var(--blue);">
      <div class="ip-title">Waveform Components</div>
      <div class="ip-desc">
        <strong>P Wave:</strong> Atrial depolarization (atria contract)<br>
        <strong>QRS Complex:</strong> Ventricular depolarization (ventricles contract) &mdash; atrial repolarization hidden within<br>
        <strong>T Wave:</strong> Ventricular repolarization (ventricles relax)<br>
        <strong>P-R Interval:</strong> AV node conduction delay (~0.12-0.20s)<br>
        <strong>Q-T Interval:</strong> Total ventricular electrical activity
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════ PART 5: BLOOD CELL GALLERY ══════════════ -->
<div class="section" id="part5">
  <div class="section-header">
    <div class="section-num">5</div>
    <div><div class="section-title">Blood Cell Gallery</div>
    <div class="section-subtitle">Identify red blood cells, white blood cells, and platelets under the microscope</div></div>
  </div>
  <div class="card">
    <div class="card-title">Blood Smear View</div>
    <div class="cell-type-grid" id="cell-type-grid">
      <div class="cell-type-btn active" onclick="bloodSelectType('rbc')">
        <div class="ct-icon" style="color:#dc2626;">&#9679;</div>RBC
      </div>
      <div class="cell-type-btn" onclick="bloodSelectType('neutrophil')">
        <div class="ct-icon" style="color:#7c3aed;">&#9679;</div>Neutrophil
      </div>
      <div class="cell-type-btn" onclick="bloodSelectType('lymphocyte')">
        <div class="ct-icon" style="color:#2563eb;">&#9679;</div>Lymphocyte
      </div>
      <div class="cell-type-btn" onclick="bloodSelectType('monocyte')">
        <div class="ct-icon" style="color:#374151;">&#9679;</div>Monocyte
      </div>
      <div class="cell-type-btn" onclick="bloodSelectType('eosinophil')">
        <div class="ct-icon" style="color:#ea580c;">&#9679;</div>Eosinophil
      </div>
      <div class="cell-type-btn" onclick="bloodSelectType('basophil')">
        <div class="ct-icon" style="color:#1e3a5f;">&#9679;</div>Basophil
      </div>
      <div class="cell-type-btn" onclick="bloodSelectType('platelet')">
        <div class="ct-icon" style="color:#d97706;">&#9679;</div>Platelet
      </div>
    </div>
    <div class="chart-wrap"><canvas id="blood-canvas" height="350"></canvas></div>
    <div class="info-panel" id="blood-info">
      <div class="ip-type">Red Blood Cell</div>
      <div class="ip-title">Erythrocyte (RBC)</div>
      <div class="ip-desc">Biconcave disc shape, ~7-8 um diameter. No nucleus in mature cells. Contains hemoglobin for O2 transport. ~4.5-5.5 million per uL. Lifespan: ~120 days.</div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Differential Count Simulator</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Count 100 white blood cells to determine the differential. Click the cell type as you identify each one.</p>
    <div class="btn-group">
      <button class="btn btn-sm btn-primary" onclick="diffCount('neutrophil')">Neutrophil</button>
      <button class="btn btn-sm btn-secondary" onclick="diffCount('lymphocyte')">Lymphocyte</button>
      <button class="btn btn-sm btn-outline" onclick="diffCount('monocyte')">Monocyte</button>
      <button class="btn btn-sm btn-outline" onclick="diffCount('eosinophil')">Eosinophil</button>
      <button class="btn btn-sm btn-outline" onclick="diffCount('basophil')">Basophil</button>
      <button class="btn btn-sm btn-outline" onclick="diffReset()">Reset</button>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-purple"><div class="stat-val" id="diff-neut">0</div><div class="stat-label">Neutrophils</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="diff-lymph">0</div><div class="stat-label">Lymphocytes</div></div>
      <div class="stat-box"><div class="stat-val" id="diff-mono">0</div><div class="stat-label">Monocytes</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="diff-eos">0</div><div class="stat-label">Eosinophils</div></div>
      <div class="stat-box stat-accent"><div class="stat-val" id="diff-baso">0</div><div class="stat-label">Basophils</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="diff-total">0</div><div class="stat-label">Total / 100</div></div>
    </div>
    <div class="chart-wrap"><canvas id="diff-chart" height="220"></canvas></div>
    <div class="analysis-result" id="cbc-ref">
      <div class="ar-title">CBC Normal Ranges</div>
      <p><strong>RBC:</strong> 4.5-5.5 M/uL &nbsp; <strong>WBC:</strong> 4,500-11,000/uL &nbsp; <strong>Platelets:</strong> 150,000-400,000/uL<br>
      <strong>Differential:</strong> Neutrophils 40-70% | Lymphocytes 20-40% | Monocytes 2-8% | Eosinophils 1-4% | Basophils &lt;1%</p>
    </div>
  </div>
</div>

<!-- ═══════════════════════════ PART 6: CV HEALTH DASHBOARD ═════════════ -->
<div class="section" id="part6">
  <div class="section-header">
    <div class="section-num">6</div>
    <div><div class="section-title">Cardiovascular Health Dashboard</div>
    <div class="section-subtitle">Assess risk factors and simulate lifestyle modifications</div></div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Patient Data Entry</div>
      <div class="slider-group"><label>Age</label><input type="number" id="cv-age" value="45" min="18" max="100" onchange="cvAssess()"><span class="slider-val">yrs</span></div>
      <div class="slider-group"><label>Rest HR</label><input type="number" id="cv-hr" value="78" min="40" max="200" onchange="cvAssess()"><span class="slider-val">bpm</span></div>
      <div class="slider-group"><label>Systolic</label><input type="number" id="cv-sys" value="135" min="80" max="220" onchange="cvAssess()"><span class="slider-val">mmHg</span></div>
      <div class="slider-group"><label>Diastolic</label><input type="number" id="cv-dia" value="88" min="50" max="140" onchange="cvAssess()"><span class="slider-val">mmHg</span></div>
      <div class="slider-group"><label>Total Chol</label><input type="number" id="cv-tc" value="220" min="100" max="400" onchange="cvAssess()"><span class="slider-val">mg/dL</span></div>
      <div class="slider-group"><label>LDL</label><input type="number" id="cv-ldl" value="140" min="40" max="300" onchange="cvAssess()"><span class="slider-val">mg/dL</span></div>
      <div class="slider-group"><label>HDL</label><input type="number" id="cv-hdl" value="42" min="20" max="120" onchange="cvAssess()"><span class="slider-val">mg/dL</span></div>
      <div class="slider-group"><label>BMI</label><input type="number" id="cv-bmi" value="28" min="15" max="50" step="0.1" onchange="cvAssess()"><span class="slider-val">kg/m2</span></div>
    </div>
    <div class="card">
      <div class="card-title">Risk Assessment</div>
      <div class="risk-meter"><div class="risk-needle" id="cv-needle" style="left:40%;"></div></div>
      <div class="risk-labels"><span>Low</span><span>Moderate</span><span>High</span></div>
      <div class="stat-grid">
        <div class="stat-box stat-accent"><div class="stat-val" id="cv-score">--</div><div class="stat-label">Risk Score</div></div>
        <div class="stat-box stat-blue"><div class="stat-val" id="cv-level">--</div><div class="stat-label">Risk Level</div></div>
      </div>
      <div id="cv-factors"></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Artery Cross-Section &mdash; Healthy vs. Atherosclerotic</div>
    <div class="chart-wrap"><canvas id="artery-canvas" height="260"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Risk Factor Modification Simulator</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Toggle lifestyle modifications and watch the risk score change.</p>
    <div class="btn-group">
      <button class="btn btn-sm btn-primary" id="mod-exercise" onclick="cvToggleMod('exercise')">+ Exercise</button>
      <button class="btn btn-sm btn-secondary" id="mod-diet" onclick="cvToggleMod('diet')">+ Healthy Diet</button>
      <button class="btn btn-sm btn-outline" id="mod-smoking" onclick="cvToggleMod('smoking')">+ Quit Smoking</button>
      <button class="btn btn-sm btn-outline" id="mod-weight" onclick="cvToggleMod('weight')">+ Weight Loss</button>
      <button class="btn btn-sm btn-outline" onclick="cvResetMods()">Reset All</button>
    </div>
    <div class="chart-wrap"><canvas id="cv-mod-chart" height="220"></canvas></div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /layout -->

<!-- ═══════════════════════════════════════════════════════════════════════
     JAVASCRIPT ENGINE
     ═══════════════════════════════════════════════════════════════════════ -->
<script>
// ── Utility ──────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

// ── Chart helpers ────────────────────────────────────────────────────────
function getCtx(id) {
  const c = $(id); const dpr = window.devicePixelRatio || 1;
  const w = c.offsetWidth || c.width || 300;
  const h = c.offsetHeight || c.height || 150;
  c.width = w * dpr; c.height = h * dpr;
  const ctx = c.getContext('2d'); ctx.scale(dpr, dpr);
  ctx.W = w; ctx.H = h;
  return ctx;
}

function drawBarChart(ctx, opts = {}) {
  const { labels, values, expected, colors, maxVal, yLabel } = opts;
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const n = values.length, barW = plotW / n * 0.6, gap = plotW / n * 0.4;

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const mv = maxVal || Math.max(...values, ...(expected||[0])) * 1.2 || 10;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui';
    ctx.textAlign = 'right'; ctx.fillText((mv * i/4).toFixed(mv > 10 ? 0 : 2), pad.left - 6, y + 4);
  }

  values.forEach((v, i) => {
    const x = pad.left + (plotW / n) * i + gap/2;
    const h = (v / mv) * plotH;
    ctx.fillStyle = colors ? colors[i] : '#c41e3a';
    ctx.beginPath();
    const r = 4;
    ctx.moveTo(x, pad.top + plotH);
    ctx.lineTo(x, pad.top + plotH - h + r);
    ctx.quadraticCurveTo(x, pad.top + plotH - h, x + r, pad.top + plotH - h);
    ctx.lineTo(x + barW - r, pad.top + plotH - h);
    ctx.quadraticCurveTo(x + barW, pad.top + plotH - h, x + barW, pad.top + plotH - h + r);
    ctx.lineTo(x + barW, pad.top + plotH);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(labels[i], x + barW/2, H - pad.bottom + 16);
    if (v > 0) {
      ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 12px system-ui';
      ctx.fillText(v.toFixed(v % 1 ? 1 : 0), x + barW/2, pad.top + plotH - h - 6);
    }
  });

  if (expected) {
    expected.forEach((ev, i) => {
      const x = pad.left + (plotW / n) * i + gap/2;
      const y = pad.top + plotH - (ev / mv) * plotH;
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.setLineDash([4,3]);
      ctx.beginPath(); ctx.moveTo(x - 4, y); ctx.lineTo(x + barW + 4, y); ctx.stroke();
      ctx.setLineDash([]);
    });
  }
}

function drawLineChart(ctx, series, opts = {}) {
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 30, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const { yMin = 0, yMax = 1, refLine, xLabels } = opts;
  const yRange = yMax - yMin;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((yMin + yRange * i/4).toFixed(yMax > 10 ? 0 : 2), pad.left - 6, y + 4);
  }
  if (refLine !== undefined) {
    const ry = pad.top + plotH * (1 - (refLine - yMin) / yRange);
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(pad.left, ry); ctx.lineTo(W - pad.right, ry); ctx.stroke();
    ctx.setLineDash([]);
  }

  series.forEach(s => {
    if (!s.data.length) return;
    const xMax = opts.xMax || s.data.length;
    ctx.strokeStyle = s.color; ctx.lineWidth = s.width || 2;
    ctx.beginPath();
    s.data.forEach((v, i) => {
      const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
      const y = pad.top + plotH * (1 - (v - yMin) / yRange);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    if (s.width !== 0) ctx.stroke();
    if (s.dots && s.data.length < 80) {
      s.data.forEach((v, i) => {
        const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
        const y = pad.top + plotH * (1 - (v - yMin) / yRange);
        ctx.fillStyle = s.color; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
      });
    }
  });

  if (xLabels) {
    ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
    xLabels.forEach((lbl, i) => {
      const x = pad.left + (i / Math.max(xLabels.length - 1, 1)) * plotW;
      ctx.fillText(lbl, x, H - 4);
    });
  }
}


// ══════════════════════════════════════════════════════════════════════════
// PART 1: HEART ANATOMY EXPLORER
// ══════════════════════════════════════════════════════════════════════════
const heartStructures = [
  { id: 'RA', name: 'Right Atrium', type: 'Chamber', color: '#3b82f6',
    desc: 'Receives deoxygenated blood from the body via the superior and inferior vena cava. Thin-walled upper chamber on the right side. Blood flows through the tricuspid valve into the right ventricle.',
    x: 0.62, y: 0.35, w: 0.14, h: 0.14 },
  { id: 'RV', name: 'Right Ventricle', type: 'Chamber', color: '#2563eb',
    desc: 'Pumps deoxygenated blood to the lungs via the pulmonary arteries. Thinner wall than left ventricle (lower pressure circuit). Separated from left ventricle by the interventricular septum.',
    x: 0.58, y: 0.52, w: 0.16, h: 0.18 },
  { id: 'LA', name: 'Left Atrium', type: 'Chamber', color: '#ef4444',
    desc: 'Receives oxygenated blood from the lungs via the pulmonary veins (4 total). Thin-walled upper chamber on the left side. Blood passes through the bicuspid (mitral) valve into the left ventricle.',
    x: 0.28, y: 0.35, w: 0.14, h: 0.14 },
  { id: 'LV', name: 'Left Ventricle', type: 'Chamber', color: '#dc2626',
    desc: 'Pumps oxygenated blood to the entire body via the aorta. Thickest wall of all chambers (generates highest pressure). The workhorse of the heart.',
    x: 0.28, y: 0.52, w: 0.16, h: 0.18 },
  { id: 'TV', name: 'Tricuspid Valve', type: 'Valve', color: '#8b5cf6',
    desc: 'Three-leaflet (cusp) valve between right atrium and right ventricle. Prevents backflow of blood into the right atrium during ventricular contraction (systole). Attached to papillary muscles via chordae tendineae.',
    x: 0.56, y: 0.46, w: 0.08, h: 0.06 },
  { id: 'MV', name: 'Bicuspid (Mitral) Valve', type: 'Valve', color: '#a855f7',
    desc: 'Two-leaflet valve between left atrium and left ventricle. Also called the mitral valve. Prevents backflow into left atrium during systole. Most commonly affected valve in heart disease.',
    x: 0.38, y: 0.46, w: 0.08, h: 0.06 },
  { id: 'PV', name: 'Pulmonary Valve', type: 'Valve', color: '#6366f1',
    desc: 'Semilunar valve at the base of the pulmonary trunk. Prevents backflow from pulmonary arteries into the right ventricle during diastole. Three crescent-shaped cusps.',
    x: 0.52, y: 0.28, w: 0.08, h: 0.05 },
  { id: 'AV', name: 'Aortic Valve', type: 'Valve', color: '#7c3aed',
    desc: 'Semilunar valve at the base of the aorta. Prevents backflow from aorta into the left ventricle during diastole. Three crescent-shaped cusps. Coronary arteries branch just above this valve.',
    x: 0.40, y: 0.28, w: 0.08, h: 0.05 },
  { id: 'SVC', name: 'Superior Vena Cava', type: 'Great Vessel', color: '#1d4ed8',
    desc: 'Large vein carrying deoxygenated blood from the upper body (head, neck, arms, upper trunk) to the right atrium. Formed by junction of left and right brachiocephalic veins.',
    x: 0.60, y: 0.10, w: 0.10, h: 0.12 },
  { id: 'IVC', name: 'Inferior Vena Cava', type: 'Great Vessel', color: '#1e40af',
    desc: 'Largest vein in the body. Carries deoxygenated blood from the lower body (legs, abdomen, pelvis) to the right atrium. Enters the right atrium from below.',
    x: 0.64, y: 0.72, w: 0.10, h: 0.10 },
  { id: 'AO', name: 'Aorta', type: 'Great Vessel', color: '#b91c1c',
    desc: 'Largest artery in the body. Carries oxygenated blood from the left ventricle to the systemic circulation. Ascending aorta curves into the aortic arch, then descends as the descending aorta.',
    x: 0.36, y: 0.06, w: 0.12, h: 0.14 },
  { id: 'PA', name: 'Pulmonary Arteries', type: 'Great Vessel', color: '#3b82f6',
    desc: 'Carry deoxygenated blood from the right ventricle to the lungs. The ONLY arteries that carry deoxygenated blood. The pulmonary trunk splits into left and right pulmonary arteries.',
    x: 0.50, y: 0.12, w: 0.12, h: 0.10 },
  { id: 'PVN', name: 'Pulmonary Veins', type: 'Great Vessel', color: '#ef4444',
    desc: 'Four veins (2 left, 2 right) that carry oxygenated blood from the lungs to the left atrium. The ONLY veins that carry oxygenated blood. No valves in these veins.',
    x: 0.20, y: 0.25, w: 0.10, h: 0.10 },
  { id: 'SEP', name: 'Interventricular Septum', type: 'Structure', color: '#92400e',
    desc: 'Thick muscular wall that separates the left and right ventricles. Prevents mixing of oxygenated and deoxygenated blood. A septal defect (hole) is a common congenital heart condition.',
    x: 0.44, y: 0.52, w: 0.06, h: 0.18 },
  { id: 'CA', name: 'Coronary Arteries', type: 'Structure', color: '#f59e0b',
    desc: 'Branch from the aorta just above the aortic valve. Supply oxygenated blood to the heart muscle itself. Left coronary artery (LCA) and right coronary artery (RCA). Blockage causes heart attack (MI).',
    x: 0.30, y: 0.22, w: 0.08, h: 0.06 },
];

let selectedStructure = null;

function drawHeart() {
  const ctx = getCtx('heart-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Draw heart outline
  const cx = W * 0.48, cy = H * 0.45;
  const hw = W * 0.38, hh = H * 0.40;

  // Heart shape background
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(cx, cy + hh * 0.95);
  ctx.bezierCurveTo(cx - hw * 1.1, cy + hh * 0.3, cx - hw * 0.9, cy - hh * 0.5, cx, cy - hh * 0.15);
  ctx.bezierCurveTo(cx + hw * 0.9, cy - hh * 0.5, cx + hw * 1.1, cy + hh * 0.3, cx, cy + hh * 0.95);
  ctx.closePath();
  ctx.fillStyle = '#fce4ec';
  ctx.fill();
  ctx.strokeStyle = '#c62828';
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.restore();

  // Draw septum
  ctx.strokeStyle = '#8d6e63';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(cx, cy - hh * 0.15);
  ctx.lineTo(cx, cy + hh * 0.85);
  ctx.stroke();

  // Horizontal septum (atrium/ventricle division)
  ctx.strokeStyle = '#a1887f';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(cx - hw * 0.7, cy + hh * 0.05);
  ctx.lineTo(cx + hw * 0.7, cy + hh * 0.05);
  ctx.stroke();

  // Draw structures
  heartStructures.forEach(s => {
    const sx = W * s.x, sy = H * s.y, sw = W * s.w, sh = H * s.h;
    const isSelected = selectedStructure === s.id;

    // Background fill
    ctx.globalAlpha = isSelected ? 0.5 : 0.2;
    ctx.fillStyle = s.color;
    ctx.beginPath();
    ctx.roundRect(sx, sy, sw, sh, 6);
    ctx.fill();
    ctx.globalAlpha = 1;

    // Border
    ctx.strokeStyle = isSelected ? s.color : 'rgba(0,0,0,0.15)';
    ctx.lineWidth = isSelected ? 3 : 1;
    ctx.beginPath();
    ctx.roundRect(sx, sy, sw, sh, 6);
    ctx.stroke();

    // Label
    ctx.fillStyle = isSelected ? '#fff' : '#1a1a1a';
    ctx.font = `bold ${isSelected ? 13 : 11}px system-ui`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    if (isSelected) {
      ctx.fillStyle = s.color;
      ctx.fillRect(sx, sy, sw, sh);
      ctx.globalAlpha = 0.9;
      ctx.fillStyle = '#fff';
    }
    ctx.fillText(s.id, sx + sw/2, sy + sh/2);
    ctx.globalAlpha = 1;
  });

  // Blood flow direction arrows
  const arrows = [
    { x1: 0.66, y1: 0.22, x2: 0.66, y2: 0.32, color: '#2563eb', label: '' },  // SVC -> RA
    { x1: 0.68, y1: 0.72, x2: 0.68, y2: 0.50, color: '#2563eb', label: '' },  // IVC -> RA
    { x1: 0.64, y1: 0.44, x2: 0.64, y2: 0.54, color: '#2563eb', label: '' },  // RA -> RV
    { x1: 0.58, y1: 0.52, x2: 0.56, y2: 0.28, color: '#2563eb', label: '' },  // RV -> PA
    { x1: 0.24, y1: 0.30, x2: 0.30, y2: 0.38, color: '#dc2626', label: '' },  // PV -> LA
    { x1: 0.36, y1: 0.44, x2: 0.36, y2: 0.54, color: '#dc2626', label: '' },  // LA -> LV
    { x1: 0.34, y1: 0.52, x2: 0.38, y2: 0.20, color: '#dc2626', label: '' },  // LV -> Aorta
  ];

  arrows.forEach(a => {
    const x1 = W * a.x1, y1 = H * a.y1, x2 = W * a.x2, y2 = H * a.y2;
    ctx.strokeStyle = a.color;
    ctx.lineWidth = 2;
    ctx.globalAlpha = 0.6;
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    // Arrowhead
    const angle = Math.atan2(y2 - y1, x2 - x1);
    const headLen = 8;
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - headLen * Math.cos(angle - 0.5), y2 - headLen * Math.sin(angle - 0.5));
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - headLen * Math.cos(angle + 0.5), y2 - headLen * Math.sin(angle + 0.5));
    ctx.stroke();
    ctx.globalAlpha = 1;
  });

  // Legend
  ctx.font = 'bold 11px system-ui';
  ctx.textAlign = 'left';
  ctx.fillStyle = '#dc2626'; ctx.fillRect(10, H - 40, 14, 14);
  ctx.fillStyle = '#374151'; ctx.fillText('Oxygenated', 30, H - 29);
  ctx.fillStyle = '#2563eb'; ctx.fillRect(10, H - 22, 14, 14);
  ctx.fillStyle = '#374151'; ctx.fillText('Deoxygenated', 30, H - 11);
}

$('heart-canvas').addEventListener('click', function(e) {
  const rect = this.getBoundingClientRect();
  const mx = (e.clientX - rect.left) / rect.width;
  const my = (e.clientY - rect.top) / rect.height;

  for (const s of heartStructures) {
    if (mx >= s.x && mx <= s.x + s.w && my >= s.y && my <= s.y + s.h) {
      selectedStructure = s.id;
      $('anatomy-info').innerHTML = `
        <div class="ip-type">${s.type}</div>
        <div class="ip-title">${s.name} (${s.id})</div>
        <div class="ip-desc">${s.desc}</div>
      `;
      drawHeart();
      return;
    }
  }
});


// ══════════════════════════════════════════════════════════════════════════
// PART 2: BLOOD FLOW PATHWAY
// ══════════════════════════════════════════════════════════════════════════
const flowPath = [
  { x: 0.72, y: 0.52, label: 'Body (tissues)', circuit: 'Systemic', o2: 'Delivering O2' },
  { x: 0.80, y: 0.65, label: 'Veins', circuit: 'Systemic', o2: 'Deoxygenated' },
  { x: 0.82, y: 0.78, label: 'Vena Cava', circuit: 'Systemic', o2: 'Deoxygenated' },
  { x: 0.72, y: 0.85, label: 'Right Atrium', circuit: 'Pulmonary', o2: 'Deoxygenated' },
  { x: 0.62, y: 0.80, label: 'Tricuspid Valve', circuit: 'Pulmonary', o2: 'Deoxygenated' },
  { x: 0.58, y: 0.72, label: 'Right Ventricle', circuit: 'Pulmonary', o2: 'Deoxygenated' },
  { x: 0.52, y: 0.58, label: 'Pulmonary Valve', circuit: 'Pulmonary', o2: 'Deoxygenated' },
  { x: 0.45, y: 0.42, label: 'Pulmonary Arteries', circuit: 'Pulmonary', o2: 'Deoxygenated' },
  { x: 0.35, y: 0.28, label: 'Lungs (gas exchange)', circuit: 'Pulmonary', o2: 'Picking up O2' },
  { x: 0.25, y: 0.42, label: 'Pulmonary Veins', circuit: 'Pulmonary', o2: 'Oxygenated' },
  { x: 0.22, y: 0.58, label: 'Left Atrium', circuit: 'Systemic', o2: 'Oxygenated' },
  { x: 0.28, y: 0.65, label: 'Mitral Valve', circuit: 'Systemic', o2: 'Oxygenated' },
  { x: 0.32, y: 0.72, label: 'Left Ventricle', circuit: 'Systemic', o2: 'Oxygenated' },
  { x: 0.38, y: 0.58, label: 'Aortic Valve', circuit: 'Systemic', o2: 'Oxygenated' },
  { x: 0.42, y: 0.40, label: 'Aorta', circuit: 'Systemic', o2: 'Oxygenated' },
  { x: 0.55, y: 0.30, label: 'Arteries', circuit: 'Systemic', o2: 'Oxygenated' },
];

let flowCell = null;
let flowAnimId = null;
let flowShowO2 = false;
let flowStartTime = 0;

function flowDropCell() {
  flowCell = { pos: 0, progress: 0 };
  flowStartTime = Date.now();
  if (!flowAnimId) flowAnimate();
}

function flowToggleO2() { flowShowO2 = !flowShowO2; drawFlow(); }

function flowReset() {
  flowCell = null;
  if (flowAnimId) { cancelAnimationFrame(flowAnimId); flowAnimId = null; }
  $('flow-circuit').textContent = '--';
  $('flow-location').textContent = '--';
  $('flow-o2').textContent = '--';
  $('flow-timer').textContent = '0.0s';
  drawFlow();
}

function flowAnimate() {
  if (!flowCell) return;
  flowCell.progress += 0.008;
  if (flowCell.progress >= 1) {
    flowCell.pos = (flowCell.pos + 1) % flowPath.length;
    flowCell.progress = 0;
    if (flowCell.pos === 0) {
      // Completed full circuit
      flowCell = null;
      $('flow-circuit').textContent = 'Done!';
      $('flow-location').textContent = 'Complete';
      drawFlow();
      flowAnimId = null;
      return;
    }
  }

  const node = flowPath[flowCell.pos];
  $('flow-circuit').textContent = node.circuit;
  $('flow-location').textContent = node.label;
  $('flow-o2').textContent = node.o2;
  $('flow-timer').textContent = ((Date.now() - flowStartTime) / 1000).toFixed(1) + 's';

  drawFlow();
  flowAnimId = requestAnimationFrame(flowAnimate);
}

function drawFlow() {
  const ctx = getCtx('flow-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Draw body outline areas
  // Lungs
  ctx.fillStyle = '#eff6ff';
  ctx.beginPath();
  ctx.ellipse(W * 0.35, H * 0.28, W * 0.12, H * 0.10, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = '#93c5fd'; ctx.lineWidth = 1; ctx.stroke();
  ctx.fillStyle = '#3b82f6'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('LUNGS', W * 0.35, H * 0.28 + 4);

  // Body
  ctx.fillStyle = '#fef2f2';
  ctx.beginPath();
  ctx.ellipse(W * 0.72, H * 0.52, W * 0.12, H * 0.10, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = '#fca5a5'; ctx.lineWidth = 1; ctx.stroke();
  ctx.fillStyle = '#dc2626'; ctx.font = 'bold 13px system-ui';
  ctx.fillText('BODY', W * 0.72, H * 0.52 + 4);

  // Heart center
  ctx.fillStyle = '#fce4ec';
  ctx.beginPath();
  ctx.ellipse(W * 0.50, H * 0.68, W * 0.18, H * 0.16, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = '#e57373'; ctx.lineWidth = 2; ctx.stroke();
  ctx.fillStyle = '#c62828'; ctx.font = 'bold 14px system-ui';
  ctx.fillText('HEART', W * 0.50, H * 0.60);

  // Draw pathway
  for (let i = 0; i < flowPath.length; i++) {
    const n = flowPath[i];
    const next = flowPath[(i + 1) % flowPath.length];
    const x1 = W * n.x, y1 = H * n.y;
    const x2 = W * next.x, y2 = H * next.y;

    // Line color based on oxygenation
    const isOxy = n.o2.includes('Oxygenated') || n.o2.includes('Delivering');
    const isExchange = n.o2.includes('Picking');
    ctx.strokeStyle = isExchange ? '#7c3aed' : (isOxy ? '#dc2626' : '#2563eb');
    ctx.lineWidth = 3;
    ctx.globalAlpha = 0.5;
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();

    // Arrow
    const angle = Math.atan2(y2 - y1, x2 - x1);
    const midX = (x1 + x2) / 2, midY = (y1 + y2) / 2;
    ctx.beginPath();
    ctx.moveTo(midX + 6 * Math.cos(angle), midY + 6 * Math.sin(angle));
    ctx.lineTo(midX - 6 * Math.cos(angle - 0.6), midY - 6 * Math.sin(angle - 0.6));
    ctx.lineTo(midX - 6 * Math.cos(angle + 0.6), midY - 6 * Math.sin(angle + 0.6));
    ctx.closePath();
    ctx.fillStyle = ctx.strokeStyle;
    ctx.fill();
    ctx.globalAlpha = 1;
  }

  // Node labels
  flowPath.forEach((n, i) => {
    const x = W * n.x, y = H * n.y;
    const isOxy = n.o2.includes('Oxygenated') || n.o2.includes('Delivering');
    const isExchange = n.o2.includes('Picking');

    ctx.fillStyle = isExchange ? '#7c3aed' : (isOxy ? '#dc2626' : '#2563eb');
    ctx.beginPath();
    ctx.arc(x, y, 5, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = '#374151';
    ctx.font = '10px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(n.label, x, y - 10);

    // O2 trace
    if (flowShowO2) {
      ctx.font = 'bold 9px system-ui';
      ctx.fillStyle = isExchange ? '#7c3aed' : (isOxy ? '#16a34a' : '#9ca3af');
      ctx.fillText(n.o2, x, y + 16);
    }
  });

  // Draw moving cell
  if (flowCell) {
    const curr = flowPath[flowCell.pos];
    const next = flowPath[(flowCell.pos + 1) % flowPath.length];
    const t = flowCell.progress;
    const cx = W * (curr.x + (next.x - curr.x) * t);
    const cy = H * (curr.y + (next.y - curr.y) * t);

    const isOxy = curr.o2.includes('Oxygenated') || curr.o2.includes('Delivering');

    // Glow
    ctx.fillStyle = isOxy ? 'rgba(220,38,38,0.2)' : 'rgba(37,99,235,0.2)';
    ctx.beginPath(); ctx.arc(cx, cy, 16, 0, Math.PI * 2); ctx.fill();

    // Cell body (biconcave disc shape from side)
    ctx.fillStyle = isOxy ? '#dc2626' : '#60a5fa';
    ctx.beginPath(); ctx.arc(cx, cy, 8, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = isOxy ? '#b91c1c' : '#3b82f6';
    ctx.beginPath(); ctx.ellipse(cx, cy, 4, 2, 0, 0, Math.PI * 2); ctx.fill();
  }
}


// ══════════════════════════════════════════════════════════════════════════
// PART 3: HEART RATE & BLOOD PRESSURE LAB
// ══════════════════════════════════════════════════════════════════════════
let hrData = {
  resting: 72,
  current: 72,
  sv: 70,
  activities: [],
  activityLabels: [],
  beatPhase: 0,
};

const activityProfiles = {
  rest: { hr: [68, 76], sys: [110, 120], dia: [70, 80], label: 'Rest' },
  walking: { hr: [85, 105], sys: [120, 140], dia: [75, 85], label: 'Walking' },
  running: { hr: [140, 180], sys: [140, 190], dia: [60, 80], label: 'Running' },
  stress: { hr: [85, 110], sys: [125, 150], dia: [80, 95], label: 'Stress' },
  caffeine: { hr: [78, 100], sys: [120, 140], dia: [75, 85], label: 'Caffeine' },
};

function hrUpdateResting() {
  hrData.resting = parseInt($('hr-input').value) || 72;
  hrData.current = hrData.resting;
  hrUpdateUI();
}

function hrUpdateCO() {
  hrData.sv = parseInt($('hr-sv').value);
  $('hr-sv-val').textContent = hrData.sv + ' mL';
  hrUpdateUI();
  drawCOChart();
}

function hrSimActivity(activity) {
  const p = activityProfiles[activity];
  const hr = rand(p.hr[0], p.hr[1]);
  const sys = rand(p.sys[0], p.sys[1]);
  const dia = rand(p.dia[0], p.dia[1]);
  hrData.current = hr;
  hrData.activities.push({ hr, sys, dia, label: p.label });
  hrData.activityLabels.push(p.label);

  $('bp-sys').textContent = sys;
  $('bp-dia').textContent = dia;
  $('bp-map').textContent = Math.round(dia + (sys - dia) / 3);

  // BP category
  let cat = 'Normal';
  if (sys >= 140 || dia >= 90) cat = 'Stage 2 HTN';
  else if (sys >= 130 || dia >= 80) cat = 'Stage 1 HTN';
  else if (sys >= 120) cat = 'Elevated';
  $('bp-status').textContent = cat;

  hrUpdateUI();
  drawActivityChart();
  drawCOChart();
}

function hrUpdateUI() {
  $('hr-current').textContent = hrData.current;
  const co = (hrData.current * hrData.sv / 1000).toFixed(1);
  $('hr-co').textContent = co;
  drawHeartBeat();
}

let heartAnimId = null;
function drawHeartBeat() {
  if (heartAnimId) cancelAnimationFrame(heartAnimId);
  const canvas = $('hr-heart-canvas');
  const bpm = hrData.current;
  const msPerBeat = 60000 / bpm;
  let lastBeat = Date.now();

  function animate() {
    const ctx = getCtx('hr-heart-canvas');
    const W = ctx.W, H = ctx.H;
    ctx.clearRect(0, 0, W, H);
    ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

    const now = Date.now();
    const elapsed = (now - lastBeat) % msPerBeat;
    const phase = elapsed / msPerBeat;

    // Pulsing scale: quick systole then slow diastole
    let scale = 1;
    if (phase < 0.15) {
      scale = 1 + 0.15 * Math.sin(phase / 0.15 * Math.PI);
    } else if (phase < 0.3) {
      scale = 1 + 0.15 * Math.sin(((phase - 0.15) / 0.15) * Math.PI) * 0.5;
    }

    const cx = W / 2, cy = H / 2;
    const baseSize = Math.min(W, H) * 0.28;
    const size = baseSize * scale;

    // Heart shape
    ctx.save();
    ctx.translate(cx, cy);
    ctx.scale(size / 80, size / 80);
    ctx.beginPath();
    ctx.moveTo(0, 20);
    ctx.bezierCurveTo(-40, -10, -40, -50, 0, -25);
    ctx.bezierCurveTo(40, -50, 40, -10, 0, 20);
    ctx.closePath();
    ctx.fillStyle = phase < 0.15 ? '#b91c1c' : '#dc2626';
    ctx.fill();
    ctx.strokeStyle = '#991b1b';
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.restore();

    // BPM text
    ctx.fillStyle = '#374151';
    ctx.font = 'bold 16px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(bpm + ' bpm', cx, H - 10);

    heartAnimId = requestAnimationFrame(animate);
  }
  animate();
}

function drawActivityChart() {
  if (!hrData.activities.length) return;
  const ctx = getCtx('hr-activity-chart');
  const labels = hrData.activities.map(a => a.label);
  const hrValues = hrData.activities.map(a => a.hr);
  const sysValues = hrData.activities.map(a => a.sys);
  const diaValues = hrData.activities.map(a => a.dia);

  const W = ctx.W, H = ctx.H;
  const pad = { top: 30, right: 20, bottom: 50, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const allVals = [...hrValues, ...sysValues, ...diaValues];
  const mv = Math.max(...allVals) * 1.2;
  const n = labels.length;
  const groupW = plotW / n;
  const barW = groupW * 0.22;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText(Math.round(mv * i/4), pad.left - 6, y + 4);
  }

  labels.forEach((lbl, i) => {
    const cx = pad.left + groupW * i + groupW / 2;
    // HR bar
    const hrH = (hrValues[i] / mv) * plotH;
    ctx.fillStyle = '#c41e3a';
    ctx.fillRect(cx - barW * 1.5, pad.top + plotH - hrH, barW, hrH);
    // Sys bar
    const sysH = (sysValues[i] / mv) * plotH;
    ctx.fillStyle = '#2563eb';
    ctx.fillRect(cx - barW * 0.5, pad.top + plotH - sysH, barW, sysH);
    // Dia bar
    const diaH = (diaValues[i] / mv) * plotH;
    ctx.fillStyle = '#16a34a';
    ctx.fillRect(cx + barW * 0.5, pad.top + plotH - diaH, barW, diaH);

    ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(lbl, cx, H - pad.bottom + 16);
  });

  // Legend
  ctx.fillStyle = '#c41e3a'; ctx.fillRect(pad.left, 8, 12, 12);
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('HR (bpm)', pad.left + 16, 18);
  ctx.fillStyle = '#2563eb'; ctx.fillRect(pad.left + 90, 8, 12, 12);
  ctx.fillStyle = '#374151'; ctx.fillText('Systolic', pad.left + 106, 18);
  ctx.fillStyle = '#16a34a'; ctx.fillRect(pad.left + 170, 8, 12, 12);
  ctx.fillStyle = '#374151'; ctx.fillText('Diastolic', pad.left + 186, 18);
}

function drawCOChart() {
  const ctx = getCtx('hr-co-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 30, right: 20, bottom: 40, left: 60 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Plot CO = HR x SV for range of HR values
  const sv = hrData.sv;
  const hrs = [];
  const cos = [];
  for (let hr = 40; hr <= 200; hr += 5) {
    hrs.push(hr);
    cos.push(hr * sv / 1000);
  }
  const maxCO = Math.max(...cos) * 1.1;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((maxCO * i/4).toFixed(1), pad.left - 6, y + 4);
  }

  // Line
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2.5;
  ctx.beginPath();
  hrs.forEach((hr, i) => {
    const x = pad.left + (i / (hrs.length - 1)) * plotW;
    const y = pad.top + plotH * (1 - cos[i] / maxCO);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Current point
  const curCO = hrData.current * sv / 1000;
  const curIdx = Math.round((hrData.current - 40) / 5);
  if (curIdx >= 0 && curIdx < hrs.length) {
    const x = pad.left + (curIdx / (hrs.length - 1)) * plotW;
    const y = pad.top + plotH * (1 - curCO / maxCO);
    ctx.fillStyle = 'rgba(196,30,58,0.2)'; ctx.beginPath(); ctx.arc(x, y, 10, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#c41e3a'; ctx.beginPath(); ctx.arc(x, y, 5, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(curCO.toFixed(1) + ' L/min', x, y - 14);
  }

  // X-axis labels
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  for (let hr = 40; hr <= 200; hr += 40) {
    const x = pad.left + ((hr - 40) / 160) * plotW;
    ctx.fillText(hr, x, H - pad.bottom + 16);
  }
  ctx.fillText('Heart Rate (bpm)', pad.left + plotW / 2, H - 4);

  // Y-axis label
  ctx.save();
  ctx.translate(12, pad.top + plotH / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('CO (L/min)', 0, 0);
  ctx.restore();
}


// ══════════════════════════════════════════════════════════════════════════
// PART 4: ECG READER
// ══════════════════════════════════════════════════════════════════════════
let ecgAnimId = null;
let ecgBPM = 72;

function ecgUpdate() {
  ecgBPM = parseInt($('ecg-hr').value);
  $('ecg-hr-val').textContent = ecgBPM + ' bpm';
  $('ecg-rate').textContent = ecgBPM;
  $('ecg-rr').textContent = (60 / ecgBPM).toFixed(2);

  if (ecgBPM > 100) $('ecg-pattern').textContent = 'Tachy';
  else if (ecgBPM < 60) $('ecg-pattern').textContent = 'Brady';
  else $('ecg-pattern').textContent = 'NSR';
}

function ecgSetPattern(p) {
  if (p === 'normal') { ecgBPM = 72; }
  else if (p === 'tachy') { ecgBPM = 140; }
  else if (p === 'brady') { ecgBPM = 48; }
  $('ecg-hr').value = ecgBPM;
  ecgUpdate();
}

function generateECGWaveform(t, period) {
  // t is normalized 0..1 within one beat cycle
  // Returns voltage -0.2 to 1.0
  // P wave: t=0.0-0.12
  // PR segment: t=0.12-0.16
  // QRS: t=0.16-0.24
  // ST segment: t=0.24-0.32
  // T wave: t=0.32-0.48
  // baseline: t=0.48-1.0

  if (t < 0.12) {
    // P wave - small positive bump
    const p = t / 0.12;
    return 0.15 * Math.sin(p * Math.PI);
  } else if (t < 0.16) {
    // PR segment - baseline
    return 0;
  } else if (t < 0.18) {
    // Q wave - small negative dip
    const q = (t - 0.16) / 0.02;
    return -0.1 * Math.sin(q * Math.PI);
  } else if (t < 0.21) {
    // R wave - tall positive spike
    const r = (t - 0.18) / 0.03;
    return 1.0 * Math.sin(r * Math.PI);
  } else if (t < 0.24) {
    // S wave - negative dip
    const s = (t - 0.21) / 0.03;
    return -0.2 * Math.sin(s * Math.PI);
  } else if (t < 0.32) {
    // ST segment
    return 0;
  } else if (t < 0.48) {
    // T wave - positive bump
    const tw = (t - 0.32) / 0.16;
    return 0.25 * Math.sin(tw * Math.PI);
  }
  return 0;
}

function drawECG() {
  const ctx = getCtx('ecg-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);

  // ECG paper background
  ctx.fillStyle = '#fefef8';
  ctx.fillRect(0, 0, W, H);

  // Grid lines (small)
  ctx.strokeStyle = '#fce4ec';
  ctx.lineWidth = 0.5;
  const gridSize = 10;
  for (let x = 0; x < W; x += gridSize) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  for (let y = 0; y < H; y += gridSize) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  // Grid lines (large)
  ctx.strokeStyle = '#f8bbd0';
  ctx.lineWidth = 1;
  for (let x = 0; x < W; x += gridSize * 5) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  for (let y = 0; y < H; y += gridSize * 5) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  const pad = { left: 20, right: 20, top: 40, bottom: 40 };
  const plotW = W - pad.left - pad.right;
  const plotH = H - pad.top - pad.bottom;
  const baseline = pad.top + plotH * 0.6;
  const amplitude = plotH * 0.45;

  const period = 60 / ecgBPM; // seconds per beat
  const totalTime = 4; // show 4 seconds
  const numBeats = Math.ceil(totalTime / period);
  const pixelsPerSec = plotW / totalTime;

  // Draw waveform
  ctx.strokeStyle = '#1a1a1a';
  ctx.lineWidth = 2;
  ctx.beginPath();

  const now = Date.now() / 1000;
  const samples = plotW;

  for (let px = 0; px < samples; px++) {
    const time = (px / samples) * totalTime + now;
    const beatTime = time % period;
    const t = beatTime / period;
    const v = generateECGWaveform(t, period);
    const x = pad.left + px;
    const y = baseline - v * amplitude;
    px === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke();

  // Label components on first complete beat
  const firstBeatX = pad.left;
  const beatWidth = period * pixelsPerSec;

  if (beatWidth > 80) {
    const labelY = pad.top + 8;
    ctx.font = 'bold 11px system-ui';
    ctx.textAlign = 'center';

    // P wave
    ctx.fillStyle = '#16a34a';
    const pX = firstBeatX + 0.06 * beatWidth;
    ctx.fillText('P', pX, labelY);
    ctx.font = '9px system-ui';
    ctx.fillText('Atrial depol.', pX, labelY + 12);

    // QRS
    ctx.font = 'bold 11px system-ui';
    ctx.fillStyle = '#c41e3a';
    const qrsX = firstBeatX + 0.20 * beatWidth;
    ctx.fillText('QRS', qrsX, labelY);
    ctx.font = '9px system-ui';
    ctx.fillText('Ventricular depol.', qrsX, labelY + 12);

    // T wave
    ctx.font = 'bold 11px system-ui';
    ctx.fillStyle = '#2563eb';
    const tX = firstBeatX + 0.40 * beatWidth;
    ctx.fillText('T', tX, labelY);
    ctx.font = '9px system-ui';
    ctx.fillText('Ventricular repol.', tX, labelY + 12);
  }

  // Speed/rate info
  ctx.fillStyle = '#374151';
  ctx.font = '12px system-ui';
  ctx.textAlign = 'left';
  ctx.fillText(ecgBPM + ' bpm | R-R: ' + (60/ecgBPM).toFixed(2) + 's | 25mm/s', pad.left, H - 10);
}

// Animate ECG continuously
function ecgAnimate() {
  drawECG();
  ecgAnimId = requestAnimationFrame(ecgAnimate);
}


// ══════════════════════════════════════════════════════════════════════════
// PART 5: BLOOD CELL GALLERY
// ══════════════════════════════════════════════════════════════════════════
const bloodCellData = {
  rbc: { name: 'Erythrocyte (RBC)', type: 'Red Blood Cell', color: '#dc2626', size: 7.5,
    desc: 'Biconcave disc shape, ~7-8 um diameter. No nucleus in mature cells. Contains hemoglobin for O2 transport. ~4.5-5.5 million per uL. Lifespan: ~120 days.' },
  neutrophil: { name: 'Neutrophil', type: 'White Blood Cell (Granulocyte)', color: '#7c3aed', size: 12,
    desc: 'Multi-lobed nucleus (3-5 lobes). Most abundant WBC (40-70%). First responder to bacterial infections. Phagocytic cells. Granules stain neutral purple. Lifespan: hours to days.' },
  lymphocyte: { name: 'Lymphocyte', type: 'White Blood Cell (Agranulocyte)', color: '#2563eb', size: 9,
    desc: 'Large round nucleus, thin rim of cytoplasm. 20-40% of WBCs. T cells (cell-mediated immunity), B cells (antibodies), NK cells (kill infected cells). Key to adaptive immunity.' },
  monocyte: { name: 'Monocyte', type: 'White Blood Cell (Agranulocyte)', color: '#374151', size: 15,
    desc: 'Largest WBC. Kidney/horseshoe-shaped nucleus. 2-8% of WBCs. Become macrophages in tissues. Phagocytize pathogens and debris. Antigen presenting cells. Lifespan: months to years.' },
  eosinophil: { name: 'Eosinophil', type: 'White Blood Cell (Granulocyte)', color: '#ea580c', size: 12,
    desc: 'Bilobed nucleus. 1-4% of WBCs. Combat parasitic infections. Involved in allergic reactions. Granules stain red-orange with eosin dye. Release toxic proteins against parasites.' },
  basophil: { name: 'Basophil', type: 'White Blood Cell (Granulocyte)', color: '#1e3a5f', size: 12,
    desc: 'S-shaped or bilobed nucleus (often obscured by granules). Rarest WBC (<1%). Release histamine and heparin. Involved in allergic and inflammatory responses. Granules stain dark blue-purple.' },
  platelet: { name: 'Thrombocyte (Platelet)', type: 'Cell Fragment', color: '#d97706', size: 3,
    desc: 'Not true cells - fragments of megakaryocytes. 2-3 um diameter. 150,000-400,000 per uL. Essential for blood clotting (hemostasis). Form platelet plug at injury site. Release clotting factors.' },
};

let selectedBloodCell = 'rbc';

function bloodSelectType(type) {
  selectedBloodCell = type;
  document.querySelectorAll('.cell-type-btn').forEach(b => b.classList.remove('active'));
  event.currentTarget.classList.add('active');

  const d = bloodCellData[type];
  $('blood-info').innerHTML = `
    <div class="ip-type">${d.type}</div>
    <div class="ip-title">${d.name}</div>
    <div class="ip-desc">${d.desc}</div>
  `;
  drawBloodSmear();
}

function drawBloodSmear() {
  const ctx = getCtx('blood-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);

  // Microscope field background
  ctx.fillStyle = '#fff8f0';
  ctx.beginPath();
  ctx.arc(W/2, H/2, Math.min(W, H) * 0.45, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = '#1a1a1a';
  ctx.lineWidth = 3;
  ctx.stroke();

  // Dark vignette outside
  ctx.fillStyle = '#2a2a2a';
  ctx.fillRect(0, 0, W, H);
  ctx.save();
  ctx.globalCompositeOperation = 'destination-out';
  ctx.beginPath();
  ctx.arc(W/2, H/2, Math.min(W, H) * 0.45, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  // Re-draw field
  ctx.fillStyle = '#fff8f0';
  ctx.beginPath();
  ctx.arc(W/2, H/2, Math.min(W, H) * 0.45, 0, Math.PI * 2);
  ctx.fill();

  const fieldR = Math.min(W, H) * 0.42;
  const cx = W / 2, cy = H / 2;

  // Seed random positions
  const seed = 42;
  function seededRand(i) {
    const x = Math.sin(seed + i * 127.1) * 43758.5453;
    return x - Math.floor(x);
  }

  // Draw RBCs scattered in background
  for (let i = 0; i < 80; i++) {
    const angle = seededRand(i * 3) * Math.PI * 2;
    const dist = seededRand(i * 3 + 1) * fieldR * 0.9;
    const x = cx + Math.cos(angle) * dist;
    const y = cy + Math.sin(angle) * dist;
    const r = 6 + seededRand(i * 3 + 2) * 3;

    ctx.fillStyle = 'rgba(220, 80, 80, 0.35)';
    ctx.beginPath();
    ctx.ellipse(x, y, r, r * 0.9, seededRand(i) * Math.PI, 0, Math.PI * 2);
    ctx.fill();
    // Biconcave center
    ctx.fillStyle = 'rgba(255, 200, 200, 0.3)';
    ctx.beginPath();
    ctx.ellipse(x, y, r * 0.35, r * 0.3, 0, 0, Math.PI * 2);
    ctx.fill();
  }

  // Draw highlighted cell type
  const d = bloodCellData[selectedBloodCell];
  const hlX = cx, hlY = cy;
  const hlR = d.size * 3;

  if (selectedBloodCell === 'rbc') {
    // RBC - larger highlighted version
    ctx.fillStyle = '#dc2626';
    ctx.beginPath();
    ctx.ellipse(hlX, hlY, hlR, hlR * 0.85, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = '#b91c1c'; ctx.lineWidth = 1.5; ctx.stroke();
    // Biconcave center
    ctx.fillStyle = '#ef9a9a';
    ctx.beginPath();
    ctx.ellipse(hlX, hlY, hlR * 0.35, hlR * 0.3, 0, 0, Math.PI * 2);
    ctx.fill();
  } else if (selectedBloodCell === 'platelet') {
    // Platelets - small cluster
    for (let i = 0; i < 5; i++) {
      const px = hlX + (seededRand(i * 7) - 0.5) * 30;
      const py = hlY + (seededRand(i * 7 + 1) - 0.5) * 25;
      ctx.fillStyle = '#d97706';
      ctx.beginPath();
      ctx.ellipse(px, py, 5 + seededRand(i) * 3, 4 + seededRand(i + 1) * 2, seededRand(i) * Math.PI, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = '#b45309'; ctx.lineWidth = 1; ctx.stroke();
      // Granules
      ctx.fillStyle = '#92400e';
      ctx.beginPath();
      ctx.arc(px, py, 2, 0, Math.PI * 2);
      ctx.fill();
    }
  } else {
    // WBC types
    ctx.fillStyle = d.color + '55';
    ctx.beginPath();
    ctx.arc(hlX, hlY, hlR, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = d.color;
    ctx.lineWidth = 2;
    ctx.stroke();

    // Cytoplasm
    ctx.fillStyle = '#f0f0ff';
    ctx.globalAlpha = 0.4;
    ctx.beginPath();
    ctx.arc(hlX, hlY, hlR, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;

    // Nucleus shape depends on type
    ctx.fillStyle = d.color;
    if (selectedBloodCell === 'neutrophil') {
      // Multi-lobed
      for (let i = 0; i < 4; i++) {
        const lx = hlX + Math.cos(i * 0.8 - 0.5) * hlR * 0.3;
        const ly = hlY + Math.sin(i * 1.2 - 0.3) * hlR * 0.25;
        ctx.beginPath();
        ctx.ellipse(lx, ly, hlR * 0.22, hlR * 0.18, i * 0.5, 0, Math.PI * 2);
        ctx.fill();
      }
      // Granules
      ctx.fillStyle = '#c4b5fd';
      for (let i = 0; i < 15; i++) {
        const gx = hlX + (seededRand(i * 11) - 0.5) * hlR * 1.4;
        const gy = hlY + (seededRand(i * 11 + 1) - 0.5) * hlR * 1.4;
        if (Math.hypot(gx - hlX, gy - hlY) < hlR * 0.9) {
          ctx.beginPath(); ctx.arc(gx, gy, 1.5, 0, Math.PI * 2); ctx.fill();
        }
      }
    } else if (selectedBloodCell === 'lymphocyte') {
      // Large round nucleus
      ctx.beginPath();
      ctx.arc(hlX, hlY, hlR * 0.7, 0, Math.PI * 2);
      ctx.fill();
    } else if (selectedBloodCell === 'monocyte') {
      // Kidney-shaped nucleus
      ctx.beginPath();
      ctx.ellipse(hlX - hlR * 0.1, hlY, hlR * 0.5, hlR * 0.6, -0.3, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#f0f0ff';
      ctx.beginPath();
      ctx.ellipse(hlX + hlR * 0.1, hlY + hlR * 0.1, hlR * 0.2, hlR * 0.35, 0.2, 0, Math.PI * 2);
      ctx.fill();
    } else if (selectedBloodCell === 'eosinophil') {
      // Bilobed nucleus
      ctx.beginPath();
      ctx.ellipse(hlX - hlR * 0.2, hlY, hlR * 0.25, hlR * 0.35, -0.3, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(hlX + hlR * 0.2, hlY, hlR * 0.25, hlR * 0.35, 0.3, 0, Math.PI * 2);
      ctx.fill();
      // Red-orange granules
      ctx.fillStyle = '#fb923c';
      for (let i = 0; i < 20; i++) {
        const gx = hlX + (seededRand(i * 13) - 0.5) * hlR * 1.4;
        const gy = hlY + (seededRand(i * 13 + 1) - 0.5) * hlR * 1.4;
        if (Math.hypot(gx - hlX, gy - hlY) < hlR * 0.9) {
          ctx.beginPath(); ctx.arc(gx, gy, 2, 0, Math.PI * 2); ctx.fill();
        }
      }
    } else if (selectedBloodCell === 'basophil') {
      // S-shaped nucleus (obscured by granules)
      ctx.beginPath();
      ctx.ellipse(hlX, hlY, hlR * 0.3, hlR * 0.5, 0.4, 0, Math.PI * 2);
      ctx.fill();
      // Large dark granules
      ctx.fillStyle = '#1e3a5f';
      for (let i = 0; i < 25; i++) {
        const gx = hlX + (seededRand(i * 17) - 0.5) * hlR * 1.4;
        const gy = hlY + (seededRand(i * 17 + 1) - 0.5) * hlR * 1.4;
        if (Math.hypot(gx - hlX, gy - hlY) < hlR * 0.9) {
          ctx.beginPath(); ctx.arc(gx, gy, 2.5, 0, Math.PI * 2); ctx.fill();
        }
      }
    }
  }

  // Label
  ctx.fillStyle = '#1a1a1a';
  ctx.font = 'bold 14px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText(d.name, cx, cy + hlR + 24);

  // Microscope frame
  ctx.strokeStyle = '#1a1a1a';
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.arc(W/2, H/2, Math.min(W, H) * 0.45, 0, Math.PI * 2);
  ctx.stroke();
}

// Differential count
let diffCounts = { neutrophil: 0, lymphocyte: 0, monocyte: 0, eosinophil: 0, basophil: 0 };

function diffCount(type) {
  const total = Object.values(diffCounts).reduce((a, b) => a + b, 0);
  if (total >= 100) return;
  diffCounts[type]++;
  diffUpdateUI();
}

function diffReset() {
  diffCounts = { neutrophil: 0, lymphocyte: 0, monocyte: 0, eosinophil: 0, basophil: 0 };
  diffUpdateUI();
}

function diffUpdateUI() {
  $('diff-neut').textContent = diffCounts.neutrophil;
  $('diff-lymph').textContent = diffCounts.lymphocyte;
  $('diff-mono').textContent = diffCounts.monocyte;
  $('diff-eos').textContent = diffCounts.eosinophil;
  $('diff-baso').textContent = diffCounts.basophil;
  const total = Object.values(diffCounts).reduce((a, b) => a + b, 0);
  $('diff-total').textContent = total;
  drawDiffChart();
}

function drawDiffChart() {
  const total = Object.values(diffCounts).reduce((a, b) => a + b, 0);
  const ctx = getCtx('diff-chart');
  if (!total) { ctx.clearRect(0, 0, ctx.W, ctx.H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, ctx.W, ctx.H); return; }

  const labels = ['Neutrophils', 'Lymphocytes', 'Monocytes', 'Eosinophils', 'Basophils'];
  const values = [diffCounts.neutrophil, diffCounts.lymphocyte, diffCounts.monocyte, diffCounts.eosinophil, diffCounts.basophil];
  const pcts = values.map(v => (v / total) * 100);
  const normals = [55, 30, 5, 2.5, 0.5]; // midpoint normal %
  const expected = normals.map(n => total * n / 100);

  drawBarChart(ctx, {
    labels: labels.map(l => l.substring(0, 5)),
    values: pcts,
    expected: normals,
    colors: ['#7c3aed', '#2563eb', '#374151', '#ea580c', '#1e3a5f'],
    maxVal: Math.max(...pcts, 70) * 1.2
  });
}


// ══════════════════════════════════════════════════════════════════════════
// PART 6: CARDIOVASCULAR HEALTH DASHBOARD
// ══════════════════════════════════════════════════════════════════════════
let cvMods = { exercise: false, diet: false, smoking: false, weight: false };
let cvBaseScore = 50;
let cvModHistory = [];

function cvAssess() {
  const age = parseInt($('cv-age').value) || 45;
  const hr = parseInt($('cv-hr').value) || 78;
  const sys = parseInt($('cv-sys').value) || 135;
  const dia = parseInt($('cv-dia').value) || 88;
  const tc = parseInt($('cv-tc').value) || 220;
  const ldl = parseInt($('cv-ldl').value) || 140;
  const hdl = parseInt($('cv-hdl').value) || 42;
  const bmi = parseFloat($('cv-bmi').value) || 28;

  // Risk scoring (simplified Framingham-inspired)
  let score = 0;

  // Age
  if (age > 65) score += 25;
  else if (age > 55) score += 18;
  else if (age > 45) score += 12;
  else if (age > 35) score += 5;

  // BP
  if (sys >= 140 || dia >= 90) score += 20;
  else if (sys >= 130 || dia >= 80) score += 12;
  else if (sys >= 120) score += 6;

  // HR
  if (hr > 100) score += 8;
  else if (hr > 85) score += 4;

  // Cholesterol
  if (tc > 240) score += 15;
  else if (tc > 200) score += 8;
  if (ldl > 160) score += 12;
  else if (ldl > 130) score += 6;
  if (hdl < 40) score += 10;
  else if (hdl < 50) score += 5;
  else if (hdl > 60) score -= 5;

  // BMI
  if (bmi > 30) score += 10;
  else if (bmi > 25) score += 5;

  score = clamp(score, 0, 100);
  cvBaseScore = score;

  // Apply modifications
  let modScore = score;
  if (cvMods.exercise) modScore = Math.max(0, modScore - 12);
  if (cvMods.diet) modScore = Math.max(0, modScore - 10);
  if (cvMods.smoking) modScore = Math.max(0, modScore - 8);
  if (cvMods.weight) modScore = Math.max(0, modScore - 7);

  $('cv-score').textContent = modScore;
  $('cv-needle').style.left = modScore + '%';

  let level = 'Low';
  let levelClass = 'ar-pass';
  if (modScore > 60) { level = 'High'; levelClass = 'ar-fail'; }
  else if (modScore > 30) { level = 'Moderate'; levelClass = 'ar-warn'; }
  $('cv-level').textContent = level;

  // Risk factors
  let factors = '';
  if (sys >= 130 || dia >= 80) factors += `<div class="analysis-result ar-fail"><div class="ar-title">Hypertension</div><p>BP ${sys}/${dia} mmHg exceeds normal range (&lt;120/80).</p></div>`;
  if (tc > 200) factors += `<div class="analysis-result ar-warn"><div class="ar-title">Elevated Total Cholesterol</div><p>TC ${tc} mg/dL. Desirable: &lt;200 mg/dL.</p></div>`;
  if (ldl > 130) factors += `<div class="analysis-result ar-warn"><div class="ar-title">Elevated LDL</div><p>LDL ${ldl} mg/dL. Near optimal: &lt;130 mg/dL.</p></div>`;
  if (hdl < 40) factors += `<div class="analysis-result ar-fail"><div class="ar-title">Low HDL</div><p>HDL ${hdl} mg/dL. Low protective cholesterol (&lt;40 is a risk factor).</p></div>`;
  if (bmi > 25) factors += `<div class="analysis-result ar-warn"><div class="ar-title">Elevated BMI</div><p>BMI ${bmi}. Normal range: 18.5-24.9 kg/m&sup2;.</p></div>`;
  if (!factors) factors = '<div class="analysis-result ar-pass"><div class="ar-title">No Major Risk Factors Detected</div><p>All values within acceptable ranges. Continue healthy lifestyle.</p></div>';

  $('cv-factors').innerHTML = factors;

  drawArteryComparison();
  drawModChart();
}

function cvToggleMod(mod) {
  cvMods[mod] = !cvMods[mod];
  const btn = $('mod-' + mod);
  if (cvMods[mod]) {
    btn.classList.remove('btn-outline');
    btn.classList.add('btn-primary');
  } else {
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-outline');
  }
  cvAssess();
}

function cvResetMods() {
  cvMods = { exercise: false, diet: false, smoking: false, weight: false };
  ['exercise', 'diet', 'smoking', 'weight'].forEach(m => {
    const btn = $('mod-' + m);
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-outline');
  });
  cvAssess();
}

function drawArteryComparison() {
  const ctx = getCtx('artery-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const arteryY = H / 2;
  const arteryR = H * 0.32;

  // Healthy artery (left)
  const hx = W * 0.25;
  // Outer wall
  ctx.fillStyle = '#e8b4b4';
  ctx.beginPath(); ctx.arc(hx, arteryY, arteryR, 0, Math.PI * 2); ctx.fill();
  ctx.strokeStyle = '#c62828'; ctx.lineWidth = 3; ctx.stroke();
  // Tunica media
  ctx.fillStyle = '#f8bbd0';
  ctx.beginPath(); ctx.arc(hx, arteryY, arteryR * 0.82, 0, Math.PI * 2); ctx.fill();
  // Tunica intima
  ctx.fillStyle = '#ffcdd2';
  ctx.beginPath(); ctx.arc(hx, arteryY, arteryR * 0.7, 0, Math.PI * 2); ctx.fill();
  // Lumen (open space)
  ctx.fillStyle = '#ef5350';
  ctx.beginPath(); ctx.arc(hx, arteryY, arteryR * 0.55, 0, Math.PI * 2); ctx.fill();
  // Label
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Healthy Artery', hx, H - 12);
  ctx.fillStyle = '#fff'; ctx.font = 'bold 11px system-ui';
  ctx.fillText('Open Lumen', hx, arteryY + 4);

  // Atherosclerotic artery (right)
  const ax = W * 0.75;
  const severity = clamp(cvBaseScore / 100, 0.1, 0.8);

  // Outer wall
  ctx.fillStyle = '#e8b4b4';
  ctx.beginPath(); ctx.arc(ax, arteryY, arteryR, 0, Math.PI * 2); ctx.fill();
  ctx.strokeStyle = '#c62828'; ctx.lineWidth = 3; ctx.stroke();
  // Tunica media
  ctx.fillStyle = '#f8bbd0';
  ctx.beginPath(); ctx.arc(ax, arteryY, arteryR * 0.82, 0, Math.PI * 2); ctx.fill();
  // Tunica intima (thickened)
  ctx.fillStyle = '#ffcdd2';
  ctx.beginPath(); ctx.arc(ax, arteryY, arteryR * 0.7, 0, Math.PI * 2); ctx.fill();

  // Plaque deposits
  ctx.fillStyle = '#fdd835';
  const plaqueR = arteryR * 0.55;
  // Draw irregular plaque
  for (let a = 0; a < Math.PI * 2; a += 0.15) {
    const thickness = severity * arteryR * 0.3 * (0.5 + 0.5 * Math.sin(a * 3 + 1.2));
    const outerR = arteryR * 0.55 + thickness;
    const innerR = arteryR * 0.55;
    ctx.beginPath();
    ctx.arc(ax + Math.cos(a) * (innerR + thickness * 0.5), arteryY + Math.sin(a) * (innerR + thickness * 0.5),
      thickness * 0.6, 0, Math.PI * 2);
    ctx.fill();
  }

  // Narrowed lumen
  const lumenR = arteryR * 0.55 * (1 - severity * 0.7);
  ctx.fillStyle = '#ef5350';
  ctx.beginPath(); ctx.arc(ax, arteryY, lumenR, 0, Math.PI * 2); ctx.fill();

  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Atherosclerotic Artery', ax, H - 12);
  ctx.fillStyle = '#fff'; ctx.font = 'bold 10px system-ui';
  if (lumenR > 10) ctx.fillText('Narrowed', ax, arteryY + 4);
  ctx.fillStyle = '#92400e'; ctx.font = '10px system-ui';
  ctx.fillText('Plaque', ax + arteryR * 0.4, arteryY - arteryR * 0.3);

  // Stenosis %
  const stenosis = Math.round(severity * 70);
  ctx.fillStyle = '#c62828'; ctx.font = 'bold 12px system-ui';
  ctx.fillText('~' + stenosis + '% stenosis', ax, arteryY + arteryR + 16);
}

function drawModChart() {
  const ctx = getCtx('cv-mod-chart');
  const mods = ['Baseline', 'Exercise', 'Diet', 'Quit Smoking', 'Weight Loss', 'All Combined'];
  let s = cvBaseScore;
  const vals = [s];

  const reductions = [12, 10, 8, 7];
  let running = s;
  reductions.forEach(r => {
    running = Math.max(0, running - r);
    vals.push(running);
  });
  // All combined
  vals.push(Math.max(0, s - reductions.reduce((a, b) => a + b, 0)));

  const colors = ['#c41e3a', '#16a34a', '#2563eb', '#d97706', '#7c3aed', '#16a34a'];

  drawBarChart(ctx, {
    labels: mods.map(m => m.length > 8 ? m.substring(0, 7) + '.' : m),
    values: vals,
    colors: colors,
    maxVal: Math.max(...vals, 10) * 1.3
  });
}


// ══════════════════════════════════════════════════════════════════════════
// SIDEBAR NAVIGATION
// ══════════════════════════════════════════════════════════════════════════
document.querySelectorAll('.sidebar-nav a').forEach(link => {
  link.addEventListener('click', function() {
    document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
    this.classList.add('active');
  });
});

// Scroll spy
window.addEventListener('scroll', () => {
  const sections = ['hero', 'part1', 'part2', 'part3', 'part4', 'part5', 'part6'];
  let current = 'hero';
  sections.forEach(id => {
    const el = $(id);
    if (el && el.getBoundingClientRect().top < 200) current = id;
  });
  document.querySelectorAll('.sidebar-nav a').forEach(a => {
    a.classList.toggle('active', a.getAttribute('href') === '#' + current);
  });
});


// ══════════════════════════════════════════════════════════════════════════
// INITIALIZATION
// ══════════════════════════════════════════════════════════════════════════
window.addEventListener('DOMContentLoaded', () => {
  drawHeart();
  drawFlow();
  hrUpdateUI();
  hrSimActivity('rest');
  drawCOChart();
  ecgAnimate();
  drawBloodSmear();
  diffUpdateUI();
  cvAssess();
});

window.addEventListener('resize', () => {
  drawHeart();
  drawFlow();
  drawActivityChart();
  drawCOChart();
  drawBloodSmear();
  drawDiffChart();
  drawArteryComparison();
  drawModChart();
});
</script>
</body>
</html>
