<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 11 Dashboard: Skeletal System | BIOL-8</title>
<style>
/* ═══════════════════════════════════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f0f2f5; --card: #ffffff; --sidebar: #1a1a2e; --sidebar-hover: #252545;
  --accent: #c41e3a; --accent-light: #e8354f; --blue: #2563eb; --blue-light: #3b82f6;
  --green: #16a34a; --amber: #d97706; --purple: #7c3aed;
  --text: #1a1a1a; --text-muted: #6b7280; --border: #e5e7eb;
  --radius: 10px; --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
}
html { scroll-behavior: smooth; }
body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; }

/* ═══════════════════════════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════════════════════════ */
.layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; background: var(--sidebar); color: #e2e8f0; position: fixed;
  top: 0; left: 0; height: 100vh; overflow-y: auto; z-index: 100;
  display: flex; flex-direction: column;
}
.sidebar-header { padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-header h1 { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
.sidebar-header p { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.sidebar-nav { flex: 1; padding: 12px 0; }
.sidebar-nav a {
  display: flex; align-items: center; gap: 10px; padding: 10px 20px;
  color: #94a3b8; text-decoration: none; font-size: 13px; font-weight: 500;
  transition: all 0.15s; border-left: 3px solid transparent;
}
.sidebar-nav a:hover { background: var(--sidebar-hover); color: #e2e8f0; }
.sidebar-nav a.active { color: #fff; background: var(--sidebar-hover); border-left-color: var(--accent); }
.sidebar-nav .nav-num {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 6px; font-size: 11px; font-weight: 700;
  background: rgba(255,255,255,0.08); flex-shrink: 0;
}
.sidebar-nav a.active .nav-num { background: var(--accent); color: #fff; }
.sidebar-footer { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #64748b; }

.main { margin-left: 260px; flex: 1; padding: 32px; max-width: 1200px; }

/* ═══════════════════════════════════════════════════════════════════════
   CARDS & SECTIONS
   ═══════════════════════════════════════════════════════════════════════ */
.section { margin-bottom: 40px; scroll-margin-top: 24px; }
.section-header {
  display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
}
.section-num {
  display: flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: 10px;
  background: var(--accent); color: #fff; font-weight: 800; font-size: 16px; flex-shrink: 0;
}
.section-title { font-size: 22px; font-weight: 700; }
.section-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

.card {
  background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 24px; margin-bottom: 16px; border: 1px solid var(--border);
}
.card-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.card-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
@media (max-width: 900px) { .card-row, .card-row-3 { grid-template-columns: 1fr; } }

/* ═══════════════════════════════════════════════════════════════════════
   BUTTONS & INPUTS
   ═══════════════════════════════════════════════════════════════════════ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
  border: none; cursor: pointer; transition: all 0.15s; font-family: var(--font);
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn-secondary { background: var(--blue); color: #fff; }
.btn-secondary:hover { background: var(--blue-light); }
.btn-outline { background: transparent; color: var(--text); border: 2px solid var(--border); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }

.slider-group { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
.slider-group label { font-size: 13px; font-weight: 600; min-width: 80px; }
.slider-group input[type=range] { flex: 1; accent-color: var(--accent); }
.slider-val { font-family: var(--mono); font-size: 14px; font-weight: 700; min-width: 50px; text-align: right; }

/* ═══════════════════════════════════════════════════════════════════════
   STATS & BADGES
   ═══════════════════════════════════════════════════════════════════════ */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 12px 0; }
.stat-box {
  text-align: center; padding: 14px 8px; border-radius: 8px;
  background: #f8fafc; border: 1px solid var(--border);
}
.stat-box .stat-val { font-size: 28px; font-weight: 800; font-family: var(--mono); }
.stat-box .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-accent .stat-val { color: var(--accent); }
.stat-blue .stat-val { color: var(--blue); }
.stat-green .stat-val { color: var(--green); }
.stat-amber .stat-val { color: var(--amber); }
.stat-purple .stat-val { color: var(--purple); }

.badge {
  display: inline-block; padding: 2px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
}
.badge-red { background: #fef2f2; color: var(--accent); }
.badge-blue { background: #eff6ff; color: var(--blue); }
.badge-green { background: #f0fdf4; color: var(--green); }
.badge-amber { background: #fffbeb; color: var(--amber); }
.badge-purple { background: #f5f3ff; color: var(--purple); }

/* ═══════════════════════════════════════════════════════════════════════
   CHART CONTAINERS
   ═══════════════════════════════════════════════════════════════════════ */
.chart-wrap { position: relative; width: 100%; margin: 8px 0; }
.chart-wrap canvas { width: 100% !important; display: block; border-radius: 6px; }

/* ═══════════════════════════════════════════════════════════════════════
   PROGRESS BAR
   ═══════════════════════════════════════════════════════════════════════ */
.progress-bar { width: 100%; height: 12px; background: #e5e7eb; border-radius: 6px; overflow: hidden; margin: 8px 0; }
.progress-fill { height: 100%; border-radius: 6px; transition: width 0.4s ease; }
.progress-fill-accent { background: linear-gradient(90deg, var(--accent), var(--accent-light)); }
.progress-fill-green { background: linear-gradient(90deg, var(--green), #22c55e); }
.progress-fill-blue { background: linear-gradient(90deg, var(--blue), var(--blue-light)); }

/* ═══════════════════════════════════════════════════════════════════════
   INFO PANEL
   ═══════════════════════════════════════════════════════════════════════ */
.info-panel {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--blue); font-size: 14px;
}
.info-panel .info-title { font-weight: 700; margin-bottom: 6px; }
.info-panel code { font-family: var(--mono); background: #e2e8f0; padding: 1px 6px; border-radius: 4px; font-size: 13px; }
.info-panel.info-green { border-left-color: var(--green); }
.info-panel.info-amber { border-left-color: var(--amber); }
.info-panel.info-accent { border-left-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   TOOLTIP
   ═══════════════════════════════════════════════════════════════════════ */
.tooltip-box {
  position: absolute; background: #1a1a2e; color: #fff; padding: 10px 14px;
  border-radius: 8px; font-size: 13px; max-width: 280px; pointer-events: none;
  box-shadow: var(--shadow-lg); z-index: 50; line-height: 1.5;
  opacity: 0; transition: opacity 0.2s;
}
.tooltip-box.visible { opacity: 1; }
.tooltip-box .tt-title { font-weight: 700; margin-bottom: 4px; font-size: 14px; }
.tooltip-box .tt-desc { color: #cbd5e1; }

/* ═══════════════════════════════════════════════════════════════════════
   HERO BANNER
   ═══════════════════════════════════════════════════════════════════════ */
.hero {
  background: linear-gradient(135deg, #1a1a2e 0%, #2d1b3d 50%, #3b1a2e 100%);
  color: #fff; border-radius: var(--radius); padding: 36px; margin-bottom: 32px;
  position: relative; overflow: hidden;
}
.hero::after {
  content: ''; position: absolute; top: -50%; right: -20%; width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(196,30,58,0.15) 0%, transparent 70%);
  pointer-events: none;
}
.hero h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.hero p { font-size: 15px; color: #cbd5e1; max-width: 600px; line-height: 1.7; }
.hero .bio-tags { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
.hero .bio-tag {
  padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
  background: rgba(255,255,255,0.1); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);
}

/* ═══════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main { margin-left: 0; padding: 16px; }
}
</style>
</head>
<body>
<div class="layout">

<!-- ═══════════════════════════════════════════════════════════════════════
     SIDEBAR
     ═══════════════════════════════════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h1>BIOL-8: Human Biology</h1>
    <p>Lab 11 &mdash; Skeletal System</p>
  </div>
  <nav class="sidebar-nav">
    <a href="#hero" class="active"><span class="nav-num">&bull;</span> Overview</a>
    <a href="#part1"><span class="nav-num">1</span> Skeleton Labeling</a>
    <a href="#part2"><span class="nav-num">2</span> Bone Structure</a>
    <a href="#part3"><span class="nav-num">3</span> Joint Classification</a>
    <a href="#part4"><span class="nav-num">4</span> Growth &amp; Remodeling</a>
    <a href="#part5"><span class="nav-num">5</span> Fracture &amp; Healing</a>
    <a href="#part6"><span class="nav-num">6</span> Skeletal Quiz</a>
  </nav>
  <div class="sidebar-footer">Interactive Lab Dashboard<br>&copy; 2026 BIOL-8</div>
</aside>

<!-- ═══════════════════════════════════════════════════════════════════════
     MAIN CONTENT
     ═══════════════════════════════════════════════════════════════════════ -->
<div class="main">

<!-- HERO -->
<div class="hero" id="hero">
  <h2>Skeletal System</h2>
  <p>Explore the 206 bones of the human skeleton, bone tissue architecture, joint mechanics, growth and remodeling, fracture healing, and test your knowledge with interactive quizzes.</p>
  <div class="bio-tags">
    <span class="bio-tag">Bones</span>
    <span class="bio-tag">Joints</span>
    <span class="bio-tag">Skeletal Anatomy</span>
  </div>
</div>

<!-- ═══════════════════════ PART 1: SKELETON LABELING ════════════════════ -->
<div class="section" id="part1">
  <div class="section-header">
    <div class="section-num">1</div>
    <div><div class="section-title">Skeleton Labeling Tool</div>
    <div class="section-subtitle">Click bones on the anterior skeleton to identify and label them</div></div>
  </div>
  <div class="card">
    <div class="card-title">Mode Selection</div>
    <div class="btn-group">
      <button class="btn btn-primary" id="btn-axial" onclick="setSkeletonMode('axial')">Axial Skeleton</button>
      <button class="btn btn-secondary" id="btn-appendicular" onclick="setSkeletonMode('appendicular')">Appendicular Skeleton</button>
      <button class="btn btn-outline" onclick="setSkeletonMode('all')">Show All</button>
      <button class="btn btn-outline" onclick="resetSkeleton()">Reset</button>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="skel-identified">0</div><div class="stat-label">Identified</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="skel-total">0</div><div class="stat-label">Total Bones</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="skel-pct">0%</div><div class="stat-label">Complete</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="skel-score">0</div><div class="stat-label">Score</div></div>
    </div>
    <div class="progress-bar"><div class="progress-fill progress-fill-accent" id="skel-progress" style="width:0%"></div></div>
  </div>
  <div class="card">
    <div class="card-title">Anterior Skeleton &mdash; Click a bone to identify it</div>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Axial bones are highlighted in <span style="color:var(--accent);font-weight:700;">red</span> and appendicular bones in <span style="color:var(--blue);font-weight:700;">blue</span>.</p>
    <div class="chart-wrap" style="position:relative;">
      <canvas id="skeleton-canvas" height="720" style="cursor:pointer;"></canvas>
      <div class="tooltip-box" id="skel-tooltip"></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Identified Bones</div>
    <div id="skel-identified-list" style="font-size:13px;color:var(--text-muted);min-height:40px;">Click bones on the skeleton above to identify them.</div>
  </div>
</div>

<!-- ═══════════════════════ PART 2: BONE STRUCTURE ════════════════════════ -->
<div class="section" id="part2">
  <div class="section-header">
    <div class="section-num">2</div>
    <div><div class="section-title">Bone Structure Explorer</div>
    <div class="section-subtitle">Zoom into bone from gross anatomy to microscopic structure</div></div>
  </div>
  <div class="card">
    <div class="card-title">Zoom Level</div>
    <div class="btn-group">
      <button class="btn btn-primary" id="btn-gross" onclick="setBoneZoom('gross')">Gross Anatomy</button>
      <button class="btn btn-secondary" id="btn-compact" onclick="setBoneZoom('compact')">Compact Bone</button>
      <button class="btn btn-outline" id="btn-spongy" onclick="setBoneZoom('spongy')">Spongy Bone</button>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="bone-level">Gross</div><div class="stat-label">Zoom Level</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="bone-struct-count">0</div><div class="stat-label">Structures Found</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="bone-struct-total">0</div><div class="stat-label">Total at Level</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Bone Cross-Section &mdash; Click structures for labels and functions</div>
    <div class="chart-wrap" style="position:relative;">
      <canvas id="bone-canvas" height="520" style="cursor:pointer;"></canvas>
      <div class="tooltip-box" id="bone-tooltip"></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Structure Details</div>
    <div id="bone-info" class="info-panel">
      <div class="info-title">Click a structure to learn more</div>
      <div class="tt-desc">Each level reveals different anatomical structures of bone tissue.</div>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 3: JOINT CLASSIFICATION ═════════════════ -->
<div class="section" id="part3">
  <div class="section-header">
    <div class="section-num">3</div>
    <div><div class="section-title">Joint Classification</div>
    <div class="section-subtitle">Explore three main joint types and synovial subtypes</div></div>
  </div>
  <div class="card">
    <div class="card-title">Joint Type</div>
    <div class="btn-group">
      <button class="btn btn-primary" id="btn-fibrous" onclick="setJointType('fibrous')">Fibrous</button>
      <button class="btn btn-secondary" id="btn-cartilaginous" onclick="setJointType('cartilaginous')">Cartilaginous</button>
      <button class="btn btn-outline" id="btn-synovial" onclick="setJointType('synovial')">Synovial</button>
    </div>
    <div id="synovial-subtypes" class="btn-group" style="display:none;">
      <button class="btn btn-sm btn-outline" onclick="setSynovialSub('hinge')">Hinge (Elbow)</button>
      <button class="btn btn-sm btn-outline" onclick="setSynovialSub('ball')">Ball-and-Socket (Hip)</button>
      <button class="btn btn-sm btn-outline" onclick="setSynovialSub('pivot')">Pivot (Atlas/Axis)</button>
      <button class="btn btn-sm btn-outline" onclick="setSynovialSub('gliding')">Gliding</button>
      <button class="btn btn-sm btn-outline" onclick="setSynovialSub('saddle')">Saddle</button>
      <button class="btn btn-sm btn-outline" onclick="setSynovialSub('condyloid')">Condyloid</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title" id="joint-canvas-title">Joint Visualization</div>
    <div class="chart-wrap" style="position:relative;">
      <canvas id="joint-canvas" height="440" style="cursor:pointer;"></canvas>
    </div>
    <div id="joint-info" class="info-panel" style="margin-top:12px;">
      <div class="info-title">Select a joint type to explore</div>
      <div class="tt-desc">Joints connect bones and determine range of motion.</div>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 4: BONE GROWTH & REMODELING ═════════════ -->
<div class="section" id="part4">
  <div class="section-header">
    <div class="section-num">4</div>
    <div><div class="section-title">Bone Growth &amp; Remodeling</div>
    <div class="section-subtitle">Endochondral ossification, growth plates, and Wolff's law</div></div>
  </div>
  <div class="card">
    <div class="card-title">Age Slider &mdash; Bone Density Over the Lifespan</div>
    <div class="slider-group">
      <label>Age (years)</label>
      <input type="range" id="age-slider" min="0" max="90" value="25" oninput="updateAge()">
      <span class="slider-val" id="age-val">25</span>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="growth-phase">Peak</div><div class="stat-label">Life Phase</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="bone-density">100%</div><div class="stat-label">Bone Density</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="ob-activity">Balanced</div><div class="stat-label">Osteoblast Activity</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="oc-activity">Balanced</div><div class="stat-label">Osteoclast Activity</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Bone Density Across the Lifespan</div>
    <div class="chart-wrap"><canvas id="growth-chart" height="300"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Endochondral Ossification &amp; Growth Plate</div>
    <div class="chart-wrap"><canvas id="ossification-canvas" height="380"></canvas></div>
    <div id="growth-info" class="info-panel" style="margin-top:12px;">
      <div class="info-title">Endochondral Ossification</div>
      <div class="tt-desc">Cartilage model is gradually replaced by bone tissue. The epiphyseal plate (growth plate) is the region of active bone elongation in growing individuals.</div>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 5: FRACTURE TYPES & HEALING ════════════ -->
<div class="section" id="part5">
  <div class="section-header">
    <div class="section-num">5</div>
    <div><div class="section-title">Fracture Types &amp; Healing</div>
    <div class="section-subtitle">Six fracture types and the four stages of bone healing</div></div>
  </div>
  <div class="card">
    <div class="card-title">Fracture Types &mdash; Click to explore</div>
    <div class="btn-group">
      <button class="btn btn-sm btn-primary" onclick="setFracture('transverse')">Transverse</button>
      <button class="btn btn-sm btn-secondary" onclick="setFracture('oblique')">Oblique</button>
      <button class="btn btn-sm btn-outline" onclick="setFracture('spiral')">Spiral</button>
      <button class="btn btn-sm btn-outline" onclick="setFracture('comminuted')">Comminuted</button>
      <button class="btn btn-sm btn-outline" onclick="setFracture('greenstick')">Greenstick</button>
      <button class="btn btn-sm btn-outline" onclick="setFracture('compound')">Compound</button>
    </div>
    <div class="chart-wrap"><canvas id="fracture-canvas" height="360"></canvas></div>
    <div id="fracture-info" class="info-panel" style="margin-top:12px;">
      <div class="info-title">Select a fracture type</div>
      <div class="tt-desc">Each fracture type has unique characteristics and healing implications.</div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Healing Stages</div>
    <div class="slider-group">
      <label>Week</label>
      <input type="range" id="heal-slider" min="0" max="12" value="0" oninput="updateHealing()">
      <span class="slider-val" id="heal-week">0</span>
    </div>
    <div class="progress-bar"><div class="progress-fill progress-fill-green" id="heal-progress" style="width:0%"></div></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="heal-stage">Injury</div><div class="stat-label">Stage</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="heal-pct">0%</div><div class="stat-label">Healed</div></div>
    </div>
    <div class="chart-wrap"><canvas id="healing-canvas" height="320"></canvas></div>
    <div id="heal-info" class="info-panel" style="margin-top:12px;">
      <div class="info-title">Fracture Healing Timeline</div>
      <div class="tt-desc">Bone heals through 4 stages: hematoma formation, fibrocartilage callus, bony callus, and bone remodeling (6-12 weeks total).</div>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 6: SKELETAL QUIZ ════════════════════════ -->
<div class="section" id="part6">
  <div class="section-header">
    <div class="section-num">6</div>
    <div><div class="section-title">Skeletal Quiz Challenge</div>
    <div class="section-subtitle">Test your knowledge of bone identification</div></div>
  </div>
  <div class="card">
    <div class="card-title">Quiz Controls</div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="startQuiz()">Start Quiz</button>
      <button class="btn btn-secondary" onclick="nextQuestion()">Next Question</button>
      <button class="btn btn-outline" onclick="resetQuiz()">Reset</button>
    </div>
    <div class="btn-group">
      <button class="btn btn-sm btn-outline" id="btn-diff-easy" onclick="setDifficulty('easy')">Easy (Axial)</button>
      <button class="btn btn-sm btn-outline" id="btn-diff-medium" onclick="setDifficulty('medium')">Medium (Limbs)</button>
      <button class="btn btn-sm btn-outline" id="btn-diff-hard" onclick="setDifficulty('hard')">Hard (Skull)</button>
      <button class="btn btn-sm btn-outline" id="btn-diff-all" onclick="setDifficulty('all')">All Bones</button>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="quiz-q">0</div><div class="stat-label">Question</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="quiz-correct">0</div><div class="stat-label">Correct</div></div>
      <div class="stat-box stat-accent"><div class="stat-val" id="quiz-wrong">0</div><div class="stat-label">Wrong</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="quiz-pct">-</div><div class="stat-label">Accuracy</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="quiz-timer">-</div><div class="stat-label">Time</div></div>
      <div class="stat-box stat-purple"><div class="stat-val" id="quiz-high">0</div><div class="stat-label">High Score</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title" id="quiz-prompt">Select a difficulty and start the quiz</div>
    <div class="chart-wrap"><canvas id="quiz-canvas" height="400" style="cursor:pointer;"></canvas></div>
    <div id="quiz-options" class="btn-group" style="justify-content:center;"></div>
    <div id="quiz-feedback" class="info-panel" style="display:none;">
      <div class="info-title" id="quiz-fb-title">Feedback</div>
      <div class="tt-desc" id="quiz-fb-desc"></div>
    </div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /layout -->

<!-- ═══════════════════════════════════════════════════════════════════════
     JAVASCRIPT ENGINE
     ═══════════════════════════════════════════════════════════════════════ -->
<script>
// ── Utility ──────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

// ── Chart helper ─────────────────────────────────────────────────────────
function getCtx(id) {
  const c = $(id); const dpr = window.devicePixelRatio || 1;
  const w = c.offsetWidth || c.width || 300;
  const h = c.offsetHeight || c.height || 150;
  c.width = w * dpr; c.height = h * dpr;
  const ctx = c.getContext('2d'); ctx.scale(dpr, dpr);
  ctx.W = w; ctx.H = h;
  return ctx;
}

function drawBarChart(ctx, opts = {}) {
  const { labels, values, expected, colors, maxVal, yLabel } = opts;
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const n = values.length, barW = plotW / n * 0.6, gap = plotW / n * 0.4;

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const mv = maxVal || Math.max(...values, ...(expected||[0])) * 1.2 || 10;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui';
    ctx.textAlign = 'right'; ctx.fillText((mv * i/4).toFixed(mv > 10 ? 0 : 2), pad.left - 6, y + 4);
  }

  values.forEach((v, i) => {
    const x = pad.left + (plotW / n) * i + gap/2;
    const h = (v / mv) * plotH;
    ctx.fillStyle = colors ? colors[i] : '#c41e3a';
    ctx.beginPath();
    const r = 4;
    ctx.moveTo(x, pad.top + plotH);
    ctx.lineTo(x, pad.top + plotH - h + r);
    ctx.quadraticCurveTo(x, pad.top + plotH - h, x + r, pad.top + plotH - h);
    ctx.lineTo(x + barW - r, pad.top + plotH - h);
    ctx.quadraticCurveTo(x + barW, pad.top + plotH - h, x + barW, pad.top + plotH - h + r);
    ctx.lineTo(x + barW, pad.top + plotH);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(labels[i], x + barW/2, H - pad.bottom + 16);
    if (v > 0) {
      ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 12px system-ui';
      ctx.fillText(v.toFixed(v % 1 ? 2 : 0), x + barW/2, pad.top + plotH - h - 6);
    }
  });

  if (expected) {
    expected.forEach((ev, i) => {
      const x = pad.left + (plotW / n) * i + gap/2;
      const y = pad.top + plotH - (ev / mv) * plotH;
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.setLineDash([4,3]);
      ctx.beginPath(); ctx.moveTo(x - 4, y); ctx.lineTo(x + barW + 4, y); ctx.stroke();
      ctx.setLineDash([]);
    });
  }
}

function drawLineChart(ctx, series, opts = {}) {
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 30, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const { yMin = 0, yMax = 1, refLine, xLabel } = opts;
  const yRange = yMax - yMin;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((yMin + yRange * i/4).toFixed(2), pad.left - 6, y + 4);
  }
  if (refLine !== undefined) {
    const ry = pad.top + plotH * (1 - (refLine - yMin) / yRange);
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(pad.left, ry); ctx.lineTo(W - pad.right, ry); ctx.stroke();
    ctx.setLineDash([]);
  }

  series.forEach(s => {
    if (!s.data.length) return;
    const xMax = opts.xMax || s.data.length;
    ctx.strokeStyle = s.color; ctx.lineWidth = s.width || 2;
    ctx.beginPath();
    s.data.forEach((v, i) => {
      const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
      const y = pad.top + plotH * (1 - (v - yMin) / yRange);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    if (s.width !== 0) ctx.stroke();
    if (s.dots && s.data.length < 80) {
      s.data.forEach((v, i) => {
        const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
        const y = pad.top + plotH * (1 - (v - yMin) / yRange);
        ctx.fillStyle = s.color; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
      });
    }
  });
}


// ══════════════════════════════════════════════════════════════════════════
// BONE DATABASE
// ══════════════════════════════════════════════════════════════════════════
const BONES = {
  axial: [
    { id:'frontal', name:'Frontal Bone', region:'Skull', x:0.50, y:0.035, w:0.06, h:0.025 },
    { id:'parietal', name:'Parietal Bone', region:'Skull', x:0.50, y:0.015, w:0.07, h:0.02 },
    { id:'temporal', name:'Temporal Bone', region:'Skull', x:0.44, y:0.045, w:0.03, h:0.02 },
    { id:'zygomatic', name:'Zygomatic Bone', region:'Skull', x:0.46, y:0.06, w:0.025, h:0.015 },
    { id:'nasal', name:'Nasal Bone', region:'Skull', x:0.50, y:0.055, w:0.015, h:0.015 },
    { id:'maxilla', name:'Maxilla', region:'Skull', x:0.50, y:0.072, w:0.035, h:0.015 },
    { id:'mandible', name:'Mandible', region:'Skull', x:0.50, y:0.09, w:0.05, h:0.018 },
    { id:'cervical', name:'Cervical Vertebrae (C1-C7)', region:'Vertebral Column', x:0.50, y:0.125, w:0.03, h:0.04 },
    { id:'thoracic', name:'Thoracic Vertebrae (T1-T12)', region:'Vertebral Column', x:0.50, y:0.24, w:0.03, h:0.10 },
    { id:'lumbar', name:'Lumbar Vertebrae (L1-L5)', region:'Vertebral Column', x:0.50, y:0.37, w:0.04, h:0.06 },
    { id:'sacrum', name:'Sacrum', region:'Vertebral Column', x:0.50, y:0.44, w:0.05, h:0.04 },
    { id:'coccyx', name:'Coccyx', region:'Vertebral Column', x:0.50, y:0.48, w:0.02, h:0.02 },
    { id:'sternum', name:'Sternum', region:'Thorax', x:0.50, y:0.20, w:0.025, h:0.08 },
    { id:'ribs', name:'Ribs (12 pairs)', region:'Thorax', x:0.42, y:0.22, w:0.16, h:0.10 },
    { id:'hyoid', name:'Hyoid Bone', region:'Throat', x:0.50, y:0.105, w:0.02, h:0.01 },
  ],
  appendicular: [
    { id:'clavicle_l', name:'Clavicle (Left)', region:'Pectoral Girdle', x:0.40, y:0.145, w:0.08, h:0.012 },
    { id:'clavicle_r', name:'Clavicle (Right)', region:'Pectoral Girdle', x:0.60, y:0.145, w:0.08, h:0.012 },
    { id:'scapula_l', name:'Scapula (Left)', region:'Pectoral Girdle', x:0.37, y:0.17, w:0.05, h:0.06 },
    { id:'scapula_r', name:'Scapula (Right)', region:'Pectoral Girdle', x:0.63, y:0.17, w:0.05, h:0.06 },
    { id:'humerus_l', name:'Humerus (Left)', region:'Upper Limb', x:0.34, y:0.24, w:0.03, h:0.12 },
    { id:'humerus_r', name:'Humerus (Right)', region:'Upper Limb', x:0.66, y:0.24, w:0.03, h:0.12 },
    { id:'radius_l', name:'Radius (Left)', region:'Upper Limb', x:0.32, y:0.37, w:0.02, h:0.10 },
    { id:'radius_r', name:'Radius (Right)', region:'Upper Limb', x:0.68, y:0.37, w:0.02, h:0.10 },
    { id:'ulna_l', name:'Ulna (Left)', region:'Upper Limb', x:0.35, y:0.37, w:0.02, h:0.10 },
    { id:'ulna_r', name:'Ulna (Right)', region:'Upper Limb', x:0.65, y:0.37, w:0.02, h:0.10 },
    { id:'carpals_l', name:'Carpals (Left)', region:'Hand', x:0.30, y:0.47, w:0.03, h:0.02 },
    { id:'carpals_r', name:'Carpals (Right)', region:'Hand', x:0.70, y:0.47, w:0.03, h:0.02 },
    { id:'metacarpals_l', name:'Metacarpals (Left)', region:'Hand', x:0.29, y:0.49, w:0.035, h:0.03 },
    { id:'metacarpals_r', name:'Metacarpals (Right)', region:'Hand', x:0.71, y:0.49, w:0.035, h:0.03 },
    { id:'phalanges_hand_l', name:'Phalanges - Hand (Left)', region:'Hand', x:0.28, y:0.52, w:0.04, h:0.03 },
    { id:'phalanges_hand_r', name:'Phalanges - Hand (Right)', region:'Hand', x:0.72, y:0.52, w:0.04, h:0.03 },
    { id:'os_coxa_l', name:'Os Coxa / Hip Bone (Left)', region:'Pelvic Girdle', x:0.42, y:0.42, w:0.06, h:0.08 },
    { id:'os_coxa_r', name:'Os Coxa / Hip Bone (Right)', region:'Pelvic Girdle', x:0.58, y:0.42, w:0.06, h:0.08 },
    { id:'femur_l', name:'Femur (Left)', region:'Lower Limb', x:0.43, y:0.53, w:0.035, h:0.17 },
    { id:'femur_r', name:'Femur (Right)', region:'Lower Limb', x:0.57, y:0.53, w:0.035, h:0.17 },
    { id:'patella_l', name:'Patella (Left)', region:'Lower Limb', x:0.44, y:0.695, w:0.02, h:0.02 },
    { id:'patella_r', name:'Patella (Right)', region:'Lower Limb', x:0.56, y:0.695, w:0.02, h:0.02 },
    { id:'tibia_l', name:'Tibia (Left)', region:'Lower Limb', x:0.45, y:0.72, w:0.025, h:0.14 },
    { id:'tibia_r', name:'Tibia (Right)', region:'Lower Limb', x:0.55, y:0.72, w:0.025, h:0.14 },
    { id:'fibula_l', name:'Fibula (Left)', region:'Lower Limb', x:0.42, y:0.72, w:0.015, h:0.14 },
    { id:'fibula_r', name:'Fibula (Right)', region:'Lower Limb', x:0.58, y:0.72, w:0.015, h:0.14 },
    { id:'tarsals_l', name:'Tarsals (Left)', region:'Foot', x:0.44, y:0.87, w:0.03, h:0.025 },
    { id:'tarsals_r', name:'Tarsals (Right)', region:'Foot', x:0.56, y:0.87, w:0.03, h:0.025 },
    { id:'metatarsals_l', name:'Metatarsals (Left)', region:'Foot', x:0.44, y:0.90, w:0.035, h:0.025 },
    { id:'metatarsals_r', name:'Metatarsals (Right)', region:'Foot', x:0.56, y:0.90, w:0.035, h:0.025 },
    { id:'phalanges_foot_l', name:'Phalanges - Foot (Left)', region:'Foot', x:0.44, y:0.93, w:0.04, h:0.025 },
    { id:'phalanges_foot_r', name:'Phalanges - Foot (Right)', region:'Foot', x:0.56, y:0.93, w:0.04, h:0.025 },
  ]
};

// ══════════════════════════════════════════════════════════════════════════
// PART 1: SKELETON LABELING
// ══════════════════════════════════════════════════════════════════════════
let skelState = {
  mode: 'all', // 'axial', 'appendicular', 'all'
  identified: new Set(),
  score: 0
};

function getVisibleBones() {
  if (skelState.mode === 'axial') return BONES.axial;
  if (skelState.mode === 'appendicular') return BONES.appendicular;
  return [...BONES.axial, ...BONES.appendicular];
}

function setSkeletonMode(mode) {
  skelState.mode = mode;
  $('btn-axial').className = 'btn ' + (mode === 'axial' ? 'btn-primary' : 'btn-outline');
  $('btn-appendicular').className = 'btn ' + (mode === 'appendicular' ? 'btn-secondary' : 'btn-outline');
  drawSkeleton();
  updateSkelStats();
}

function resetSkeleton() {
  skelState.identified = new Set();
  skelState.score = 0;
  drawSkeleton();
  updateSkelStats();
  $('skel-identified-list').innerHTML = 'Click bones on the skeleton above to identify them.';
}

function updateSkelStats() {
  const visible = getVisibleBones();
  const identified = [...skelState.identified].filter(id => visible.some(b => b.id === id)).length;
  $('skel-identified').textContent = identified;
  $('skel-total').textContent = visible.length;
  const pct = visible.length ? Math.round(identified / visible.length * 100) : 0;
  $('skel-pct').textContent = pct + '%';
  $('skel-score').textContent = skelState.score;
  $('skel-progress').style.width = pct + '%';
}

function drawSkeleton() {
  const ctx = getCtx('skeleton-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Draw body outline
  drawBodyOutline(ctx, W, H);

  // Draw bone regions
  const allBones = [...BONES.axial, ...BONES.appendicular];
  allBones.forEach(bone => {
    const isAxial = BONES.axial.includes(bone);
    const isVisible = skelState.mode === 'all' || (skelState.mode === 'axial' && isAxial) || (skelState.mode === 'appendicular' && !isAxial);
    const isIdentified = skelState.identified.has(bone.id);

    const bx = bone.x * W, by = bone.y * H;
    const bw = bone.w * W, bh = bone.h * H;

    if (!isVisible) {
      ctx.fillStyle = 'rgba(200,200,200,0.2)';
      ctx.strokeStyle = 'rgba(200,200,200,0.3)';
    } else if (isIdentified) {
      ctx.fillStyle = isAxial ? 'rgba(196,30,58,0.25)' : 'rgba(37,99,235,0.25)';
      ctx.strokeStyle = isAxial ? '#c41e3a' : '#2563eb';
    } else {
      ctx.fillStyle = isAxial ? 'rgba(196,30,58,0.08)' : 'rgba(37,99,235,0.08)';
      ctx.strokeStyle = isAxial ? 'rgba(196,30,58,0.4)' : 'rgba(37,99,235,0.4)';
    }

    ctx.lineWidth = isIdentified ? 2.5 : 1.5;
    ctx.beginPath();
    ctx.roundRect(bx - bw/2, by - bh/2, bw, bh, 4);
    ctx.fill(); ctx.stroke();

    // Label for identified bones
    if (isIdentified && isVisible) {
      ctx.fillStyle = isAxial ? '#c41e3a' : '#2563eb';
      ctx.font = 'bold 9px system-ui';
      ctx.textAlign = 'center';
      const label = bone.name.replace(/ \(.*\)/, '').substring(0, 14);
      ctx.fillText(label, bx, by + bh/2 + 11);
    }
  });

  // Title
  ctx.fillStyle = '#374151';
  ctx.font = 'bold 14px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText('Anterior View - Human Skeleton', W/2, H - 10);
}

function drawBodyOutline(ctx, W, H) {
  ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 1.5; ctx.setLineDash([]);

  // Head (oval)
  ctx.beginPath(); ctx.ellipse(W*0.5, H*0.05, W*0.045, H*0.04, 0, 0, Math.PI*2); ctx.stroke();
  // Neck
  ctx.beginPath(); ctx.moveTo(W*0.48, H*0.09); ctx.lineTo(W*0.48, H*0.12); ctx.moveTo(W*0.52, H*0.09); ctx.lineTo(W*0.52, H*0.12); ctx.stroke();
  // Shoulders
  ctx.beginPath(); ctx.moveTo(W*0.35, H*0.14); ctx.quadraticCurveTo(W*0.42, H*0.13, W*0.48, H*0.13);
  ctx.moveTo(W*0.65, H*0.14); ctx.quadraticCurveTo(W*0.58, H*0.13, W*0.52, H*0.13); ctx.stroke();
  // Torso
  ctx.beginPath();
  ctx.moveTo(W*0.35, H*0.14); ctx.lineTo(W*0.37, H*0.34); ctx.lineTo(W*0.40, H*0.45);
  ctx.moveTo(W*0.65, H*0.14); ctx.lineTo(W*0.63, H*0.34); ctx.lineTo(W*0.60, H*0.45); ctx.stroke();
  // Pelvis
  ctx.beginPath();
  ctx.moveTo(W*0.40, H*0.45); ctx.quadraticCurveTo(W*0.50, H*0.50, W*0.60, H*0.45); ctx.stroke();
  // Left arm
  ctx.beginPath();
  ctx.moveTo(W*0.35, H*0.15); ctx.lineTo(W*0.32, H*0.25); ctx.lineTo(W*0.30, H*0.36);
  ctx.lineTo(W*0.28, H*0.46); ctx.lineTo(W*0.26, H*0.56); ctx.stroke();
  // Right arm
  ctx.beginPath();
  ctx.moveTo(W*0.65, H*0.15); ctx.lineTo(W*0.68, H*0.25); ctx.lineTo(W*0.70, H*0.36);
  ctx.lineTo(W*0.72, H*0.46); ctx.lineTo(W*0.74, H*0.56); ctx.stroke();
  // Left leg
  ctx.beginPath();
  ctx.moveTo(W*0.44, H*0.50); ctx.lineTo(W*0.44, H*0.70); ctx.lineTo(W*0.44, H*0.86); ctx.lineTo(W*0.44, H*0.96); ctx.stroke();
  // Right leg
  ctx.beginPath();
  ctx.moveTo(W*0.56, H*0.50); ctx.lineTo(W*0.56, H*0.70); ctx.lineTo(W*0.56, H*0.86); ctx.lineTo(W*0.56, H*0.96); ctx.stroke();

  // Rib cage arcs
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 0.8;
  for (let i = 0; i < 6; i++) {
    const y = H * (0.17 + i * 0.022);
    const spread = W * (0.04 + i * 0.012);
    ctx.beginPath();
    ctx.ellipse(W*0.5, y, spread, H*0.008, 0, 0, Math.PI);
    ctx.stroke();
  }
}

// Click handler for skeleton
$('skeleton-canvas').addEventListener('click', function(e) {
  const rect = this.getBoundingClientRect();
  const scaleX = this.offsetWidth, scaleY = this.offsetHeight;
  const mx = (e.clientX - rect.left) / scaleX;
  const my = (e.clientY - rect.top) / scaleY;

  const visible = getVisibleBones();
  let hit = null;
  for (const bone of visible) {
    const dx = Math.abs(mx - bone.x);
    const dy = Math.abs(my - bone.y);
    if (dx < bone.w/2 + 0.01 && dy < bone.h/2 + 0.01) {
      hit = bone;
      break;
    }
  }

  if (hit) {
    if (!skelState.identified.has(hit.id)) {
      skelState.identified.add(hit.id);
      skelState.score += 10;
    }
    // Show tooltip
    const tip = $('skel-tooltip');
    tip.innerHTML = '<div class="tt-title">' + hit.name + '</div><div class="tt-desc">Region: ' + hit.region + '</div>';
    tip.style.left = (e.clientX - rect.left + 10) + 'px';
    tip.style.top = (e.clientY - rect.top - 40) + 'px';
    tip.classList.add('visible');
    setTimeout(() => tip.classList.remove('visible'), 2000);

    drawSkeleton();
    updateSkelStats();
    updateIdentifiedList();
  }
});

function updateIdentifiedList() {
  const el = $('skel-identified-list');
  if (skelState.identified.size === 0) {
    el.innerHTML = 'Click bones on the skeleton above to identify them.';
    return;
  }
  const allBones = [...BONES.axial, ...BONES.appendicular];
  const groups = {};
  skelState.identified.forEach(id => {
    const bone = allBones.find(b => b.id === id);
    if (bone) {
      if (!groups[bone.region]) groups[bone.region] = [];
      groups[bone.region].push(bone.name);
    }
  });
  let html = '';
  for (const [region, names] of Object.entries(groups)) {
    html += '<strong style="color:var(--text);">' + region + ':</strong> ' + names.join(', ') + '<br>';
  }
  el.innerHTML = html;
}

// ══════════════════════════════════════════════════════════════════════════
// PART 2: BONE STRUCTURE EXPLORER
// ══════════════════════════════════════════════════════════════════════════
let boneZoom = 'gross';
let boneStructFound = { gross: new Set(), compact: new Set(), spongy: new Set() };

const BONE_STRUCTURES = {
  gross: [
    { id:'epiphysis_p', name:'Proximal Epiphysis', desc:'The rounded end of the bone closest to the body. Contains spongy bone filled with red marrow for blood cell production.', x:0.5, y:0.1, w:0.18, h:0.1, color:'#c41e3a' },
    { id:'diaphysis', name:'Diaphysis (Shaft)', desc:'The long cylindrical shaft of the bone. Composed primarily of compact bone surrounding the medullary cavity.', x:0.5, y:0.42, w:0.08, h:0.36, color:'#2563eb' },
    { id:'epiphysis_d', name:'Distal Epiphysis', desc:'The rounded end farthest from the body center. Also contains spongy bone and articular cartilage for joint surfaces.', x:0.5, y:0.85, w:0.18, h:0.1, color:'#c41e3a' },
    { id:'periosteum', name:'Periosteum', desc:'Dense fibrous membrane covering the outer surface of bone. Contains blood vessels, nerves, and osteoblasts for bone growth and repair.', x:0.35, y:0.42, w:0.02, h:0.36, color:'#16a34a' },
    { id:'medullary', name:'Medullary Cavity', desc:'The central hollow region within the diaphysis. Contains yellow marrow (fat storage) in adults and red marrow in children.', x:0.5, y:0.42, w:0.04, h:0.30, color:'#d97706' },
    { id:'articular_p', name:'Articular Cartilage (Proximal)', desc:'Smooth hyaline cartilage covering the joint surface. Reduces friction and absorbs shock during movement.', x:0.5, y:0.04, w:0.16, h:0.03, color:'#7c3aed' },
    { id:'articular_d', name:'Articular Cartilage (Distal)', desc:'Hyaline cartilage at the distal joint surface. Essential for smooth, pain-free joint movement.', x:0.5, y:0.93, w:0.16, h:0.03, color:'#7c3aed' },
    { id:'epiphyseal_line', name:'Epiphyseal Line', desc:'Remnant of the growth plate in adults. In children, this is the active epiphyseal plate where bone elongation occurs.', x:0.5, y:0.19, w:0.15, h:0.015, color:'#ea580c' },
  ],
  compact: [
    { id:'osteon', name:'Osteon (Haversian System)', desc:'The structural unit of compact bone. Concentric rings of bone matrix (lamellae) surrounding a central canal. Each osteon is about 200 micrometers in diameter.', x:0.5, y:0.45, w:0.25, h:0.25, color:'#c41e3a' },
    { id:'haversian_canal', name:'Central (Haversian) Canal', desc:'Runs through the center of each osteon. Contains blood vessels and nerves that supply nutrients and sensation to osteocytes.', x:0.5, y:0.45, w:0.04, h:0.04, color:'#2563eb' },
    { id:'lamellae', name:'Concentric Lamellae', desc:'Rings of bone matrix arranged around the central canal, like tree rings. Each lamella contains collagen fibers oriented in different directions for maximum strength.', x:0.5, y:0.45, w:0.18, h:0.18, color:'#16a34a' },
    { id:'lacunae', name:'Lacunae & Osteocytes', desc:'Small cavities between lamellae that house osteocytes (mature bone cells). Connected by tiny channels called canaliculi for nutrient exchange.', x:0.62, y:0.38, w:0.04, h:0.04, color:'#d97706' },
    { id:'canaliculi', name:'Canaliculi', desc:'Microscopic channels radiating from each lacuna, connecting osteocytes to each other and to the central canal. Allow passage of nutrients and waste.', x:0.56, y:0.52, w:0.06, h:0.03, color:'#7c3aed' },
    { id:'volkmanns', name:"Volkmann's (Perforating) Canals", desc:"Horizontal channels that connect Haversian canals to each other and to the periosteum. Run perpendicular to the long axis of the bone.", x:0.5, y:0.7, w:0.25, h:0.03, color:'#ea580c' },
    { id:'interstitial', name:'Interstitial Lamellae', desc:'Fragments of old osteons that fill the spaces between complete osteons. Remnants of previous bone remodeling cycles.', x:0.30, y:0.30, w:0.08, h:0.08, color:'#64748b' },
  ],
  spongy: [
    { id:'trabeculae', name:'Trabeculae', desc:'Thin, branching plates and rods of bone tissue that form a lattice-like network. Oriented along lines of stress per Wolff\'s law for maximum strength with minimum mass.', x:0.5, y:0.4, w:0.35, h:0.35, color:'#c41e3a' },
    { id:'red_marrow', name:'Red Bone Marrow', desc:'Fills the spaces between trabeculae. Site of hematopoiesis (blood cell production). Produces red blood cells, white blood cells, and platelets.', x:0.35, y:0.5, w:0.10, h:0.10, color:'#dc2626' },
    { id:'marrow_spaces', name:'Marrow Spaces', desc:'Open spaces within the trabecular network that allow blood cell production and nutrient exchange. Much larger than the channels in compact bone.', x:0.65, y:0.4, w:0.10, h:0.10, color:'#2563eb' },
    { id:'endosteum', name:'Endosteum', desc:'Thin membrane lining the internal surfaces of bone, including trabeculae. Contains osteoblasts and osteoclasts for bone remodeling.', x:0.5, y:0.75, w:0.30, h:0.03, color:'#16a34a' },
    { id:'trabecular_osteocyte', name:'Osteocytes in Trabeculae', desc:'Mature bone cells embedded within the trabeculae. Monitor mechanical stress and coordinate bone remodeling through cell signaling.', x:0.55, y:0.55, w:0.06, h:0.06, color:'#d97706' },
  ]
};

function setBoneZoom(level) {
  boneZoom = level;
  $('btn-gross').className = 'btn ' + (level === 'gross' ? 'btn-primary' : 'btn-outline');
  $('btn-compact').className = 'btn ' + (level === 'compact' ? 'btn-secondary' : 'btn-outline');
  $('btn-spongy').className = 'btn ' + (level === 'spongy' ? 'btn-outline' : 'btn-outline');
  if (level === 'spongy') $('btn-spongy').className = 'btn btn-secondary';
  $('bone-level').textContent = level === 'gross' ? 'Gross' : level === 'compact' ? 'Compact' : 'Spongy';
  drawBoneStructure();
  updateBoneStats();
}

function updateBoneStats() {
  const structs = BONE_STRUCTURES[boneZoom];
  $('bone-struct-count').textContent = boneStructFound[boneZoom].size;
  $('bone-struct-total').textContent = structs.length;
}

function drawBoneStructure() {
  const ctx = getCtx('bone-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  if (boneZoom === 'gross') drawGrossAnatomy(ctx, W, H);
  else if (boneZoom === 'compact') drawCompactBone(ctx, W, H);
  else drawSpongyBone(ctx, W, H);

  // Draw structure hotspots
  const structs = BONE_STRUCTURES[boneZoom];
  structs.forEach(s => {
    const sx = s.x * W, sy = s.y * H, sw = s.w * W, sh = s.h * H;
    const found = boneStructFound[boneZoom].has(s.id);
    ctx.strokeStyle = found ? s.color : 'rgba(100,100,100,0.3)';
    ctx.lineWidth = found ? 2.5 : 1;
    ctx.setLineDash(found ? [] : [4,3]);
    ctx.beginPath(); ctx.roundRect(sx - sw/2, sy - sh/2, sw, sh, 6); ctx.stroke();
    ctx.setLineDash([]);
    if (found) {
      ctx.fillStyle = s.color;
      ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
      ctx.fillText(s.name.substring(0, 22), sx, sy - sh/2 - 5);
    }
  });
}

function drawGrossAnatomy(ctx, W, H) {
  // Long bone shape
  const cx = W * 0.5;
  // Proximal epiphysis
  ctx.fillStyle = '#fde8e8';
  ctx.beginPath(); ctx.ellipse(cx, H*0.1, W*0.09, H*0.06, 0, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2; ctx.stroke();
  // Articular cartilage top
  ctx.fillStyle = '#e0d4f5';
  ctx.beginPath(); ctx.ellipse(cx, H*0.04, W*0.08, H*0.015, 0, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#7c3aed'; ctx.lineWidth = 1.5; ctx.stroke();
  // Epiphyseal line
  ctx.strokeStyle = '#ea580c'; ctx.lineWidth = 2.5; ctx.setLineDash([6,3]);
  ctx.beginPath(); ctx.moveTo(cx - W*0.07, H*0.19); ctx.lineTo(cx + W*0.07, H*0.19); ctx.stroke();
  ctx.setLineDash([]);
  // Diaphysis
  ctx.fillStyle = '#e8f0fe';
  ctx.beginPath();
  ctx.moveTo(cx - W*0.04, H*0.17); ctx.lineTo(cx - W*0.035, H*0.75);
  ctx.lineTo(cx + W*0.035, H*0.75); ctx.lineTo(cx + W*0.04, H*0.17);
  ctx.closePath(); ctx.fill();
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.stroke();
  // Periosteum outline (outer edge)
  ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(cx - W*0.042, H*0.17); ctx.lineTo(cx - W*0.037, H*0.75);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(cx + W*0.042, H*0.17); ctx.lineTo(cx + W*0.037, H*0.75);
  ctx.stroke();
  // Medullary cavity
  ctx.fillStyle = '#fef3c7';
  ctx.beginPath();
  ctx.moveTo(cx - W*0.02, H*0.22); ctx.lineTo(cx - W*0.018, H*0.70);
  ctx.lineTo(cx + W*0.018, H*0.70); ctx.lineTo(cx + W*0.02, H*0.22);
  ctx.closePath(); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 1.5; ctx.setLineDash([3,3]); ctx.stroke(); ctx.setLineDash([]);
  // Distal epiphysis
  ctx.fillStyle = '#fde8e8';
  ctx.beginPath(); ctx.ellipse(cx, H*0.85, W*0.09, H*0.06, 0, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2; ctx.stroke();
  // Articular cartilage bottom
  ctx.fillStyle = '#e0d4f5';
  ctx.beginPath(); ctx.ellipse(cx, H*0.93, W*0.08, H*0.015, 0, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#7c3aed'; ctx.lineWidth = 1.5; ctx.stroke();

  // Spongy bone pattern in epiphyses
  ctx.strokeStyle = 'rgba(196,30,58,0.2)'; ctx.lineWidth = 0.8;
  for (let i = 0; i < 15; i++) {
    const angle = Math.random() * Math.PI * 2;
    const r = Math.random() * W * 0.06;
    const ex = cx + Math.cos(angle) * r * 0.6;
    const ey = H * 0.1 + Math.sin(angle) * r * 0.4;
    ctx.beginPath(); ctx.arc(ex, ey, 3 + Math.random() * 5, 0, Math.PI*2); ctx.stroke();
  }
  for (let i = 0; i < 15; i++) {
    const angle = Math.random() * Math.PI * 2;
    const r = Math.random() * W * 0.06;
    const ex = cx + Math.cos(angle) * r * 0.6;
    const ey = H * 0.85 + Math.sin(angle) * r * 0.4;
    ctx.beginPath(); ctx.arc(ex, ey, 3 + Math.random() * 5, 0, Math.PI*2); ctx.stroke();
  }

  // Title
  ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Gross Anatomy of a Long Bone', W/2, H - 8);
}

function drawCompactBone(ctx, W, H) {
  const cx = W * 0.5, cy = H * 0.45;

  // Background: compact bone matrix
  ctx.fillStyle = '#fdf5e6';
  ctx.fillRect(W*0.1, H*0.05, W*0.8, H*0.85);
  ctx.strokeStyle = '#d4a373'; ctx.lineWidth = 2;
  ctx.strokeRect(W*0.1, H*0.05, W*0.8, H*0.85);

  // Draw multiple osteons
  const osteonPositions = [
    { x: 0.5, y: 0.45, r: 0.11 },
    { x: 0.28, y: 0.28, r: 0.08 },
    { x: 0.72, y: 0.28, r: 0.08 },
    { x: 0.28, y: 0.65, r: 0.07 },
    { x: 0.72, y: 0.65, r: 0.07 },
  ];

  osteonPositions.forEach((pos, idx) => {
    const ox = pos.x * W, oy = pos.y * H, or = pos.r * W;
    // Concentric lamellae
    for (let ring = 6; ring >= 1; ring--) {
      const rr = or * (ring / 6);
      const lightness = 85 - ring * 6;
      ctx.fillStyle = `hsl(35, 40%, ${lightness}%)`;
      ctx.beginPath(); ctx.arc(ox, oy, rr, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = 'rgba(180,130,80,0.5)'; ctx.lineWidth = 1;
      ctx.stroke();
    }
    // Central canal
    ctx.fillStyle = '#dbeafe';
    ctx.beginPath(); ctx.arc(ox, oy, or * 0.15, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 1.5; ctx.stroke();
    // Blood vessel dot
    ctx.fillStyle = '#dc2626'; ctx.beginPath(); ctx.arc(ox, oy, 3, 0, Math.PI*2); ctx.fill();

    // Lacunae (small dark ovals between rings)
    for (let ring = 2; ring <= 5; ring++) {
      const rr = or * (ring / 6);
      for (let a = 0; a < 6; a++) {
        const angle = (a / 6) * Math.PI * 2 + idx * 0.5;
        const lx = ox + Math.cos(angle) * rr;
        const ly = oy + Math.sin(angle) * rr;
        ctx.fillStyle = '#92400e';
        ctx.beginPath(); ctx.ellipse(lx, ly, 4, 2.5, angle, 0, Math.PI*2); ctx.fill();
        // Canaliculi (tiny lines)
        ctx.strokeStyle = 'rgba(146,64,14,0.4)'; ctx.lineWidth = 0.5;
        for (let c = 0; c < 4; c++) {
          const ca = angle + (c - 1.5) * 0.8;
          ctx.beginPath();
          ctx.moveTo(lx, ly);
          ctx.lineTo(lx + Math.cos(ca) * 8, ly + Math.sin(ca) * 8);
          ctx.stroke();
        }
      }
    }
  });

  // Volkmann's canal (horizontal connecting line)
  ctx.strokeStyle = '#ea580c'; ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(W*0.15, H*0.7); ctx.lineTo(W*0.85, H*0.7);
  ctx.stroke();
  ctx.fillStyle = '#fde8e8';
  ctx.beginPath(); ctx.arc(W*0.5, H*0.7, 4, 0, Math.PI*2); ctx.fill();

  // Interstitial lamellae (fragments between osteons)
  ctx.fillStyle = 'rgba(100,116,139,0.15)';
  ctx.strokeStyle = 'rgba(100,116,139,0.3)'; ctx.lineWidth = 0.8;
  [[0.30,0.30],[0.70,0.30],[0.30,0.58],[0.70,0.58],[0.50,0.18]].forEach(([px,py]) => {
    ctx.beginPath();
    ctx.arc(px*W, py*H, W*0.03, Math.random()*2, Math.PI + Math.random()*2);
    ctx.fill(); ctx.stroke();
  });

  ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Compact Bone - Osteon (Haversian System) Detail', W/2, H - 8);
}

function drawSpongyBone(ctx, W, H) {
  ctx.fillStyle = '#fff5f5';
  ctx.fillRect(W*0.05, H*0.05, W*0.9, H*0.85);
  ctx.strokeStyle = '#fca5a5'; ctx.lineWidth = 2;
  ctx.strokeRect(W*0.05, H*0.05, W*0.9, H*0.85);

  // Draw trabecular network
  const nodes = [];
  for (let i = 0; i < 30; i++) {
    nodes.push({ x: W*(0.1 + Math.random()*0.8), y: H*(0.1 + Math.random()*0.75) });
  }

  // Trabeculae as connected struts
  ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 4;
  for (let i = 0; i < nodes.length; i++) {
    for (let j = i+1; j < nodes.length; j++) {
      const dist = Math.hypot(nodes[i].x - nodes[j].x, nodes[i].y - nodes[j].y);
      if (dist < W * 0.18) {
        ctx.strokeStyle = `hsl(40, 70%, ${50 + Math.random()*20}%)`;
        ctx.lineWidth = 2 + Math.random() * 4;
        ctx.beginPath();
        ctx.moveTo(nodes[i].x, nodes[i].y);
        ctx.lineTo(nodes[j].x, nodes[j].y);
        ctx.stroke();
      }
    }
  }

  // Osteocytes in trabeculae
  nodes.forEach(n => {
    ctx.fillStyle = '#92400e';
    ctx.beginPath(); ctx.arc(n.x, n.y, 3, 0, Math.PI*2); ctx.fill();
  });

  // Red marrow spaces (pink fill between trabeculae)
  ctx.fillStyle = 'rgba(220,38,38,0.08)';
  ctx.fillRect(W*0.1, H*0.1, W*0.8, H*0.7);

  // Endosteum line at bottom
  ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(W*0.05, H*0.75); ctx.lineTo(W*0.95, H*0.75);
  ctx.stroke();
  ctx.fillStyle = '#16a34a'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Endosteum', W*0.5, H*0.75 - 8);

  ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Spongy (Cancellous) Bone - Trabecular Network', W/2, H - 8);
}

$('bone-canvas').addEventListener('click', function(e) {
  const rect = this.getBoundingClientRect();
  const mx = (e.clientX - rect.left) / this.offsetWidth;
  const my = (e.clientY - rect.top) / this.offsetHeight;

  const structs = BONE_STRUCTURES[boneZoom];
  let hit = null;
  for (const s of structs) {
    if (Math.abs(mx - s.x) < s.w/2 + 0.02 && Math.abs(my - s.y) < s.h/2 + 0.02) {
      hit = s; break;
    }
  }
  if (hit) {
    boneStructFound[boneZoom].add(hit.id);
    $('bone-info').innerHTML = '<div class="info-title" style="color:' + hit.color + ';">' + hit.name + '</div><div class="tt-desc">' + hit.desc + '</div>';
    $('bone-info').className = 'info-panel';

    const tip = $('bone-tooltip');
    tip.innerHTML = '<div class="tt-title">' + hit.name + '</div>';
    tip.style.left = (e.clientX - rect.left + 10) + 'px';
    tip.style.top = (e.clientY - rect.top - 30) + 'px';
    tip.classList.add('visible');
    setTimeout(() => tip.classList.remove('visible'), 1500);

    drawBoneStructure();
    updateBoneStats();
  }
});


// ══════════════════════════════════════════════════════════════════════════
// PART 3: JOINT CLASSIFICATION
// ══════════════════════════════════════════════════════════════════════════
let jointType = 'fibrous';
let synovialSub = 'hinge';
let jointAnimFrame = 0;
let jointAnimId = null;

const JOINT_INFO = {
  fibrous: {
    title: 'Fibrous Joints (Synarthroses)',
    desc: 'Bones joined by dense fibrous connective tissue. Allow little to no movement. Example: Sutures of the skull. The interlocking edges of skull bones are held together by short connective tissue fibers, providing protection for the brain.',
    movement: 'No movement (synarthrosis)'
  },
  cartilaginous: {
    title: 'Cartilaginous Joints (Amphiarthroses)',
    desc: 'Bones joined by cartilage. Allow slight movement. Example: Intervertebral discs between vertebrae. The fibrocartilage discs allow slight flexion and rotation, giving the spine its flexibility while maintaining stability.',
    movement: 'Slight movement (amphiarthrosis)'
  },
  synovial: {
    title: 'Synovial Joints (Diarthroses)',
    desc: 'Freely movable joints with a fluid-filled joint cavity. Include articular cartilage, synovial membrane, and joint capsule. Six subtypes based on shape and movement.',
    movement: 'Free movement (diarthrosis)'
  },
  hinge: { title: 'Hinge Joint (Elbow)', desc: 'Allows movement in one plane only: flexion and extension. Like a door hinge. Found at the elbow (humerus-ulna), knee, and finger joints.', movement: 'Uniaxial: flexion/extension' },
  ball: { title: 'Ball-and-Socket Joint (Hip/Shoulder)', desc: 'Most mobile joint type. The spherical head of one bone fits into the cup-shaped socket of another. Allows movement in all planes: flexion, extension, abduction, adduction, rotation.', movement: 'Multiaxial: all directions' },
  pivot: { title: 'Pivot Joint (Atlas/Axis)', desc: 'A rounded bone process fits into a ring of bone and ligament. Allows rotation around a single axis. The atlas (C1) rotates around the dens of the axis (C2) when you shake your head "no."', movement: 'Uniaxial: rotation' },
  gliding: { title: 'Gliding (Plane) Joint', desc: 'Flat or slightly curved articular surfaces that slide across each other. Found between carpals, tarsals, and between vertebral articular processes. Allow side-to-side and back-and-forth movements.', movement: 'Multiplanar gliding' },
  saddle: { title: 'Saddle Joint (Thumb)', desc: 'Each articular surface has both concave and convex areas, like a saddle. Found at the base of the thumb (trapezium-metacarpal). Allows movement in two planes plus circumduction.', movement: 'Biaxial: two planes' },
  condyloid: { title: 'Condyloid (Ellipsoid) Joint', desc: 'An oval-shaped condyle fits into an elliptical cavity. Found at the wrist (radiocarpal) and knuckles (metacarpophalangeal). Allows flexion, extension, abduction, adduction, and circumduction.', movement: 'Biaxial: two planes' },
};

function setJointType(type) {
  jointType = type;
  $('btn-fibrous').className = 'btn ' + (type === 'fibrous' ? 'btn-primary' : 'btn-outline');
  $('btn-cartilaginous').className = 'btn ' + (type === 'cartilaginous' ? 'btn-secondary' : 'btn-outline');
  $('btn-synovial').className = 'btn ' + (type === 'synovial' ? 'btn-outline' : 'btn-outline');
  if (type === 'synovial') $('btn-synovial').className = 'btn btn-secondary';
  $('synovial-subtypes').style.display = type === 'synovial' ? 'flex' : 'none';

  const info = JOINT_INFO[type];
  $('joint-info').innerHTML = '<div class="info-title">' + info.title + '</div><div class="tt-desc">' + info.desc + '</div><div style="margin-top:8px;"><span class="badge badge-blue">' + info.movement + '</span></div>';
  $('joint-canvas-title').textContent = info.title;

  if (jointAnimId) cancelAnimationFrame(jointAnimId);
  jointAnimFrame = 0;
  drawJoint();
  if (type === 'synovial') animateJoint();
}

function setSynovialSub(sub) {
  synovialSub = sub;
  const info = JOINT_INFO[sub];
  $('joint-info').innerHTML = '<div class="info-title">' + info.title + '</div><div class="tt-desc">' + info.desc + '</div><div style="margin-top:8px;"><span class="badge badge-blue">' + info.movement + '</span></div>';
  $('joint-canvas-title').textContent = info.title;

  if (jointAnimId) cancelAnimationFrame(jointAnimId);
  jointAnimFrame = 0;
  drawJoint();
  animateJoint();
}

function drawJoint() {
  const ctx = getCtx('joint-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  if (jointType === 'fibrous') drawFibrousJoint(ctx, W, H);
  else if (jointType === 'cartilaginous') drawCartilaginousJoint(ctx, W, H);
  else {
    if (synovialSub === 'hinge') drawHingeJoint(ctx, W, H);
    else if (synovialSub === 'ball') drawBallSocketJoint(ctx, W, H);
    else if (synovialSub === 'pivot') drawPivotJoint(ctx, W, H);
    else if (synovialSub === 'gliding') drawGlidingJoint(ctx, W, H);
    else if (synovialSub === 'saddle') drawSaddleJoint(ctx, W, H);
    else drawCondyloidJoint(ctx, W, H);
  }
}

function drawFibrousJoint(ctx, W, H) {
  const cx = W/2, cy = H/2;
  // Two skull plates with interlocking suture
  ctx.fillStyle = '#fef3c7';
  // Left plate
  ctx.beginPath();
  ctx.moveTo(cx - W*0.3, cy - H*0.2);
  ctx.lineTo(cx - W*0.3, cy + H*0.2);
  const steps = 12;
  for (let i = 0; i <= steps; i++) {
    const t = i / steps;
    const y = cy - H*0.2 + t * H*0.4;
    const zigzag = (i % 2 === 0) ? -W*0.015 : W*0.015;
    ctx.lineTo(cx + zigzag, y);
  }
  ctx.lineTo(cx - W*0.3, cy - H*0.2);
  ctx.closePath(); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();

  // Right plate
  ctx.fillStyle = '#dbeafe';
  ctx.beginPath();
  ctx.moveTo(cx + W*0.3, cy - H*0.2);
  ctx.lineTo(cx + W*0.3, cy + H*0.2);
  for (let i = steps; i >= 0; i--) {
    const t = i / steps;
    const y = cy - H*0.2 + t * H*0.4;
    const zigzag = (i % 2 === 0) ? -W*0.015 : W*0.015;
    ctx.lineTo(cx + zigzag, y);
  }
  ctx.closePath(); ctx.fill();
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.stroke();

  // Suture fibers
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 1;
  for (let i = 1; i < steps; i++) {
    const t = i / steps;
    const y = cy - H*0.2 + t * H*0.4;
    const zigzag = (i % 2 === 0) ? -W*0.015 : W*0.015;
    ctx.beginPath();
    ctx.moveTo(cx + zigzag - 8, y); ctx.lineTo(cx + zigzag + 8, y);
    ctx.stroke();
  }

  // Labels
  ctx.fillStyle = '#374151'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('SUTURE (Skull)', cx, cy - H*0.28);
  ctx.font = '12px system-ui';
  ctx.fillText('Fibrous connective tissue', cx, cy + H*0.28);
  ctx.fillStyle = '#c41e3a'; ctx.fillText('No movement allowed', cx, cy + H*0.33);

  // Arrow showing no movement
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(cx - 15, cy + H*0.22); ctx.lineTo(cx + 15, cy + H*0.22); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx - 10, cy + H*0.22 - 4); ctx.lineTo(cx - 15, cy + H*0.22); ctx.lineTo(cx - 10, cy + H*0.22 + 4); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx + 10, cy + H*0.22 - 4); ctx.lineTo(cx + 15, cy + H*0.22); ctx.lineTo(cx + 10, cy + H*0.22 + 4); ctx.stroke();
  ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 18px system-ui';
  ctx.fillText('X', cx, cy + H*0.22 + 6);
}

function drawCartilaginousJoint(ctx, W, H) {
  const cx = W/2, cy = H/2;
  // Two vertebral bodies with disc
  // Upper vertebra
  ctx.fillStyle = '#fef3c7';
  ctx.beginPath(); ctx.roundRect(cx - W*0.12, cy - H*0.22, W*0.24, H*0.12, 8); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
  // Disc
  ctx.fillStyle = '#dbeafe';
  ctx.beginPath(); ctx.roundRect(cx - W*0.13, cy - H*0.08, W*0.26, H*0.06, 6); ctx.fill();
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.stroke();
  // Nucleus pulposus
  ctx.fillStyle = '#bfdbfe';
  ctx.beginPath(); ctx.ellipse(cx, cy - H*0.05, W*0.05, H*0.018, 0, 0, Math.PI*2); ctx.fill();
  // Lower vertebra
  ctx.fillStyle = '#fef3c7';
  ctx.beginPath(); ctx.roundRect(cx - W*0.12, cy + H*0.02, W*0.24, H*0.12, 8); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();

  // Animate slight movement
  const offset = Math.sin(jointAnimFrame * 0.03) * 5;
  ctx.save();
  ctx.translate(offset, 0);
  // Redraw upper vertebra with offset for animation
  ctx.restore();

  // Labels
  ctx.fillStyle = '#374151'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('INTERVERTEBRAL DISC', cx, cy - H*0.30);
  ctx.font = '12px system-ui';
  ctx.fillText('Vertebral body', cx + W*0.2, cy - H*0.16);
  ctx.fillStyle = '#2563eb'; ctx.fillText('Fibrocartilage disc', cx + W*0.22, cy - H*0.05);
  ctx.fillStyle = '#374151'; ctx.fillText('Vertebral body', cx + W*0.2, cy + H*0.08);
  ctx.fillStyle = '#d97706'; ctx.font = 'bold 12px system-ui';
  ctx.fillText('Slight movement allowed', cx, cy + H*0.25);

  // Small movement arrows
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(cx - 20, cy + H*0.20); ctx.lineTo(cx + 20, cy + H*0.20); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx + 15, cy + H*0.20 - 4); ctx.lineTo(cx + 20, cy + H*0.20); ctx.lineTo(cx + 15, cy + H*0.20 + 4); ctx.fill();
  ctx.beginPath(); ctx.moveTo(cx - 15, cy + H*0.20 - 4); ctx.lineTo(cx - 20, cy + H*0.20); ctx.lineTo(cx - 15, cy + H*0.20 + 4); ctx.fill();
}

function drawHingeJoint(ctx, W, H) {
  const cx = W/2, cy = H/2;
  const angle = Math.sin(jointAnimFrame * 0.03) * 0.5;

  // Upper bone (humerus)
  ctx.fillStyle = '#fef3c7';
  ctx.save(); ctx.translate(cx, cy - H*0.05);
  ctx.beginPath(); ctx.roundRect(-W*0.03, -H*0.28, W*0.06, H*0.25, 6); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
  // Trochlea
  ctx.fillStyle = '#fde68a';
  ctx.beginPath(); ctx.arc(0, 0, W*0.04, 0, Math.PI); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.stroke();
  ctx.restore();

  // Lower bone (ulna) - animates
  ctx.save(); ctx.translate(cx, cy - H*0.05);
  ctx.rotate(angle);
  ctx.fillStyle = '#dbeafe';
  ctx.beginPath(); ctx.roundRect(-W*0.025, H*0.02, W*0.05, H*0.28, 6); ctx.fill();
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.stroke();
  // Trochlear notch
  ctx.fillStyle = '#bfdbfe';
  ctx.beginPath(); ctx.arc(0, H*0.02, W*0.035, Math.PI, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#2563eb'; ctx.stroke();
  ctx.restore();

  // Joint capsule outline
  ctx.strokeStyle = 'rgba(124,58,237,0.3)'; ctx.lineWidth = 1.5; ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.ellipse(cx, cy - H*0.03, W*0.06, H*0.06, 0, 0, Math.PI*2); ctx.stroke();
  ctx.setLineDash([]);

  // Movement arrow
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(cx + W*0.12, cy, H*0.08, -0.5, 0.5); ctx.stroke();
  ctx.fillStyle = '#c41e3a'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Flexion/Extension', cx + W*0.15, cy);

  ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Hinge Joint - Elbow', cx, H*0.08);
}

function drawBallSocketJoint(ctx, W, H) {
  const cx = W/2, cy = H/2;
  const angle = Math.sin(jointAnimFrame * 0.02) * 0.4;

  // Socket (acetabulum)
  ctx.fillStyle = '#dbeafe';
  ctx.beginPath(); ctx.arc(cx, cy, W*0.08, 0.3, Math.PI*2 - 0.3); ctx.fill();
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2.5; ctx.stroke();

  // Ball (femoral head) + shaft
  ctx.save(); ctx.translate(cx, cy); ctx.rotate(angle);
  ctx.fillStyle = '#fef3c7';
  ctx.beginPath(); ctx.arc(0, 0, W*0.055, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
  // Shaft
  ctx.fillStyle = '#fef3c7';
  ctx.beginPath(); ctx.roundRect(-W*0.025, W*0.04, W*0.05, H*0.28, 6); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
  ctx.restore();

  // Articular cartilage
  ctx.strokeStyle = '#7c3aed'; ctx.lineWidth = 3; ctx.setLineDash([3,3]);
  ctx.beginPath(); ctx.arc(cx, cy, W*0.065, 0, Math.PI*2); ctx.stroke();
  ctx.setLineDash([]);

  // Rotation arrows (multiple directions)
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 1.5;
  const arrowR = W * 0.14;
  for (let a = 0; a < 4; a++) {
    const theta = a * Math.PI / 2;
    ctx.beginPath();
    ctx.arc(cx, cy, arrowR, theta - 0.3, theta + 0.3);
    ctx.stroke();
    // Arrowhead
    const ax = cx + Math.cos(theta + 0.3) * arrowR;
    const ay = cy + Math.sin(theta + 0.3) * arrowR;
    ctx.beginPath(); ctx.arc(ax, ay, 3, 0, Math.PI*2); ctx.fill();
  }

  ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Ball-and-Socket Joint - Hip/Shoulder', cx, H*0.08);
  ctx.fillStyle = '#c41e3a'; ctx.font = '11px system-ui';
  ctx.fillText('Movement in all directions', cx, H*0.92);
}

function drawPivotJoint(ctx, W, H) {
  const cx = W/2, cy = H/2;
  const angle = Math.sin(jointAnimFrame * 0.04) * 0.6;

  // Atlas (C1) ring
  ctx.save(); ctx.translate(cx, cy); ctx.rotate(angle);
  ctx.fillStyle = '#dbeafe';
  ctx.beginPath(); ctx.ellipse(0, 0, W*0.14, H*0.1, 0, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2.5; ctx.stroke();
  // Hollow center
  ctx.fillStyle = '#f8fafc';
  ctx.beginPath(); ctx.ellipse(0, 0, W*0.05, H*0.04, 0, 0, Math.PI*2); ctx.fill();
  ctx.restore();

  // Dens (axis peg) - stays fixed
  ctx.fillStyle = '#fef3c7';
  ctx.beginPath(); ctx.arc(cx, cy, W*0.035, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
  // Axis body below
  ctx.fillStyle = '#fef3c7';
  ctx.beginPath(); ctx.roundRect(cx - W*0.07, cy + H*0.08, W*0.14, H*0.06, 6); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();

  // Rotation arrow
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(cx, cy, W*0.20, -0.8, 0.8); ctx.stroke();
  ctx.fillStyle = '#c41e3a'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Rotation (head shaking "no")', cx, cy - H*0.2);

  ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui';
  ctx.fillText('Pivot Joint - Atlas (C1) / Axis (C2)', cx, H*0.08);

  // Labels
  ctx.fillStyle = '#2563eb'; ctx.font = '11px system-ui';
  ctx.fillText('Atlas (C1)', cx + W*0.18, cy - H*0.02);
  ctx.fillStyle = '#d97706';
  ctx.fillText('Dens of Axis', cx + W*0.08, cy + H*0.02);
}

function drawGlidingJoint(ctx, W, H) {
  const cx = W/2, cy = H/2;
  const offset = Math.sin(jointAnimFrame * 0.03) * W * 0.04;

  // Upper flat bone
  ctx.save(); ctx.translate(offset, 0);
  ctx.fillStyle = '#fef3c7';
  ctx.beginPath(); ctx.roundRect(cx - W*0.12, cy - H*0.12, W*0.24, H*0.08, 6); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
  ctx.restore();

  // Lower flat bone
  ctx.fillStyle = '#dbeafe';
  ctx.beginPath(); ctx.roundRect(cx - W*0.14, cy + H*0.02, W*0.28, H*0.08, 6); ctx.fill();
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.stroke();

  // Articular surfaces
  ctx.strokeStyle = '#7c3aed'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(cx - W*0.1 + offset, cy - H*0.04); ctx.lineTo(cx + W*0.1 + offset, cy - H*0.04); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx - W*0.12, cy + H*0.02); ctx.lineTo(cx + W*0.12, cy + H*0.02); ctx.stroke();

  // Movement arrows
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(cx - W*0.18, cy - H*0.16); ctx.lineTo(cx + W*0.18, cy - H*0.16); ctx.stroke();

  ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Gliding (Plane) Joint - Carpals/Tarsals', cx, H*0.08);
  ctx.fillStyle = '#c41e3a'; ctx.font = '11px system-ui';
  ctx.fillText('Side-to-side sliding', cx, H*0.92);
}

function drawSaddleJoint(ctx, W, H) {
  const cx = W/2, cy = H/2;
  const angle = Math.sin(jointAnimFrame * 0.03) * 0.3;

  // Draw saddle shape (concave/convex)
  ctx.fillStyle = '#dbeafe';
  ctx.beginPath();
  ctx.moveTo(cx - W*0.15, cy);
  ctx.quadraticCurveTo(cx - W*0.05, cy + H*0.08, cx, cy);
  ctx.quadraticCurveTo(cx + W*0.05, cy - H*0.08, cx + W*0.15, cy);
  ctx.lineTo(cx + W*0.15, cy + H*0.15);
  ctx.lineTo(cx - W*0.15, cy + H*0.15);
  ctx.closePath(); ctx.fill();
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.stroke();

  // Upper saddle bone
  ctx.save(); ctx.translate(cx, cy); ctx.rotate(angle);
  ctx.fillStyle = '#fef3c7';
  ctx.beginPath();
  ctx.moveTo(-W*0.08, 0);
  ctx.quadraticCurveTo(0, -H*0.06, W*0.08, 0);
  ctx.lineTo(W*0.08, -H*0.18);
  ctx.lineTo(-W*0.08, -H*0.18);
  ctx.closePath(); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
  ctx.restore();

  ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Saddle Joint - Thumb (CMC)', cx, H*0.08);
  ctx.fillStyle = '#c41e3a'; ctx.font = '11px system-ui';
  ctx.fillText('Movement in two planes', cx, H*0.92);
}

function drawCondyloidJoint(ctx, W, H) {
  const cx = W/2, cy = H/2;
  const angle = Math.sin(jointAnimFrame * 0.03) * 0.35;

  // Elliptical socket
  ctx.fillStyle = '#dbeafe';
  ctx.beginPath(); ctx.ellipse(cx, cy + H*0.04, W*0.10, H*0.05, 0, Math.PI, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2.5; ctx.stroke();
  // Socket body below
  ctx.fillStyle = '#dbeafe';
  ctx.beginPath(); ctx.roundRect(cx - W*0.12, cy + H*0.06, W*0.24, H*0.16, 6); ctx.fill();
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.stroke();

  // Condyle (oval head)
  ctx.save(); ctx.translate(cx, cy); ctx.rotate(angle);
  ctx.fillStyle = '#fef3c7';
  ctx.beginPath(); ctx.ellipse(0, 0, W*0.07, H*0.04, 0, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
  // Shaft above
  ctx.fillStyle = '#fef3c7';
  ctx.beginPath(); ctx.roundRect(-W*0.025, -H*0.24, W*0.05, H*0.20, 6); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
  ctx.restore();

  ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Condyloid (Ellipsoid) Joint - Wrist', cx, H*0.08);
  ctx.fillStyle = '#c41e3a'; ctx.font = '11px system-ui';
  ctx.fillText('Biaxial movement + circumduction', cx, H*0.92);
}

function animateJoint() {
  jointAnimFrame++;
  drawJoint();
  jointAnimId = requestAnimationFrame(animateJoint);
}


// ══════════════════════════════════════════════════════════════════════════
// PART 4: BONE GROWTH & REMODELING
// ══════════════════════════════════════════════════════════════════════════
function updateAge() {
  const age = parseInt($('age-slider').value);
  $('age-val').textContent = age;

  let phase, density, obAct, ocAct;
  if (age < 2) { phase = 'Infant'; density = 30 + age * 15; obAct = 'Very High'; ocAct = 'Low'; }
  else if (age < 12) { phase = 'Childhood'; density = 45 + (age-2) * 4; obAct = 'High'; ocAct = 'Low'; }
  else if (age < 18) { phase = 'Adolescent'; density = 75 + (age-12) * 4; obAct = 'Very High'; ocAct = 'Moderate'; }
  else if (age < 30) { phase = 'Young Adult'; density = 95 + (age-18) * 0.4; obAct = 'High'; ocAct = 'Balanced'; }
  else if (age < 35) { phase = 'Peak'; density = 100; obAct = 'Balanced'; ocAct = 'Balanced'; }
  else if (age < 50) { phase = 'Early Decline'; density = 100 - (age-35) * 0.5; obAct = 'Moderate'; ocAct = 'Moderate'; }
  else if (age < 65) { phase = 'Menopause/Decline'; density = 92.5 - (age-50) * 1.0; obAct = 'Low'; ocAct = 'High'; }
  else if (age < 80) { phase = 'Elderly'; density = 77.5 - (age-65) * 1.2; obAct = 'Low'; ocAct = 'High'; }
  else { phase = 'Advanced Age'; density = 59.5 - (age-80) * 1.0; obAct = 'Very Low'; ocAct = 'High'; }

  density = clamp(density, 25, 100);
  $('growth-phase').textContent = phase;
  $('bone-density').textContent = Math.round(density) + '%';
  $('ob-activity').textContent = obAct;
  $('oc-activity').textContent = ocAct;

  drawGrowthChart(age);
  drawOssificationCanvas(age);

  // Update info based on conditions
  if (density < 50) {
    $('growth-info').className = 'info-panel info-accent';
    $('growth-info').innerHTML = '<div class="info-title">Osteoporosis Risk</div><div class="tt-desc">At this age, bone density has decreased significantly. Osteoclast activity exceeds osteoblast activity, leading to porous, fragile bones. Weight-bearing exercise and adequate calcium/vitamin D intake can slow bone loss.</div>';
  } else if (age < 18) {
    $('growth-info').className = 'info-panel info-green';
    $('growth-info').innerHTML = '<div class="info-title">Active Growth Phase</div><div class="tt-desc">The epiphyseal plates (growth plates) are actively producing new cartilage that is ossified into bone, increasing bone length. Growth hormone and sex hormones drive this process.</div>';
  } else {
    $('growth-info').className = 'info-panel';
    $('growth-info').innerHTML = '<div class="info-title">Bone Remodeling</div><div class="tt-desc">Bone is constantly remodeled by osteoblasts (build) and osteoclasts (break down). Wolff\'s law: bone adapts to mechanical stress by becoming stronger along stress lines.</div>';
  }
}

function drawGrowthChart(currentAge) {
  const ctx = getCtx('growth-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 30, right: 20, bottom: 40, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Generate density curve
  const points = [];
  for (let age = 0; age <= 90; age++) {
    let d;
    if (age < 2) d = 30 + age * 15;
    else if (age < 12) d = 45 + (age-2) * 4;
    else if (age < 18) d = 75 + (age-12) * 4;
    else if (age < 30) d = 95 + (age-18) * 0.4;
    else if (age < 35) d = 100;
    else if (age < 50) d = 100 - (age-35) * 0.5;
    else if (age < 65) d = 92.5 - (age-50) * 1.0;
    else if (age < 80) d = 77.5 - (age-65) * 1.2;
    else d = 59.5 - (age-80) * 1.0;
    points.push(clamp(d, 25, 100));
  }

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText(Math.round(i * 25) + '%', pad.left - 6, y + 4);
  }

  // Age labels
  for (let age = 0; age <= 90; age += 10) {
    const x = pad.left + (age / 90) * plotW;
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(age, x, H - pad.bottom + 16);
  }
  ctx.fillStyle = '#374151'; ctx.font = '12px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Age (years)', pad.left + plotW/2, H - 4);

  // Density curve
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2.5;
  ctx.beginPath();
  points.forEach((d, age) => {
    const x = pad.left + (age / 90) * plotW;
    const y = pad.top + plotH * (1 - d / 100);
    age === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Osteoporosis threshold
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 1; ctx.setLineDash([6,4]);
  const threshY = pad.top + plotH * (1 - 50/100);
  ctx.beginPath(); ctx.moveTo(pad.left, threshY); ctx.lineTo(W - pad.right, threshY); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#c41e3a'; ctx.font = '10px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Osteoporosis risk threshold', pad.left + 4, threshY - 6);

  // Current age marker
  if (currentAge !== undefined) {
    const cx = pad.left + (currentAge / 90) * plotW;
    const cy = pad.top + plotH * (1 - points[currentAge] / 100);
    ctx.fillStyle = '#c41e3a';
    ctx.beginPath(); ctx.arc(cx, cy, 6, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Age ' + currentAge, cx, cy - 12);
    ctx.fillText(Math.round(points[currentAge]) + '%', cx, cy + 18);
  }

  // Peak bone mass marker
  ctx.fillStyle = '#16a34a'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
  const peakX = pad.left + (30 / 90) * plotW;
  const peakY = pad.top + plotH * (1 - 100/100);
  ctx.fillText('Peak bone mass', peakX, peakY - 8);

  // Phase labels
  ctx.globalAlpha = 0.1;
  ctx.fillStyle = '#16a34a'; ctx.fillRect(pad.left, pad.top, (18/90)*plotW, plotH);
  ctx.fillStyle = '#2563eb'; ctx.fillRect(pad.left + (18/90)*plotW, pad.top, (17/90)*plotW, plotH);
  ctx.fillStyle = '#d97706'; ctx.fillRect(pad.left + (35/90)*plotW, pad.top, (30/90)*plotW, plotH);
  ctx.fillStyle = '#c41e3a'; ctx.fillRect(pad.left + (65/90)*plotW, pad.top, (25/90)*plotW, plotH);
  ctx.globalAlpha = 1;

  ctx.font = '10px system-ui'; ctx.textAlign = 'center';
  ctx.fillStyle = '#16a34a'; ctx.fillText('Growth', pad.left + (9/90)*plotW, pad.top + 14);
  ctx.fillStyle = '#2563eb'; ctx.fillText('Peak', pad.left + (26/90)*plotW, pad.top + 14);
  ctx.fillStyle = '#d97706'; ctx.fillText('Maintenance', pad.left + (50/90)*plotW, pad.top + 14);
  ctx.fillStyle = '#c41e3a'; ctx.fillText('Decline', pad.left + (77/90)*plotW, pad.top + 14);
}

function drawOssificationCanvas(age) {
  const ctx = getCtx('ossification-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Draw 5 stages of endochondral ossification
  const stages = [
    { label: '1. Cartilage Model', desc: 'Hyaline cartilage forms bone shape', ageRange: [0, 8] },
    { label: '2. Collar Formation', desc: 'Bone collar forms around diaphysis', ageRange: [0, 10] },
    { label: '3. Primary Center', desc: 'Blood vessels invade; ossification begins', ageRange: [0, 14] },
    { label: '4. Secondary Centers', desc: 'Ossification spreads to epiphyses', ageRange: [2, 18] },
    { label: '5. Mature Bone', desc: 'Growth plate closes; bone complete', ageRange: [18, 90] },
  ];

  const stageW = W / 5;

  stages.forEach((stage, i) => {
    const sx = stageW * i;
    const isActive = age >= stage.ageRange[0] && age <= stage.ageRange[1];
    const isPast = age > stage.ageRange[1];

    // Stage box
    ctx.fillStyle = isActive ? 'rgba(196,30,58,0.05)' : (isPast ? 'rgba(22,163,74,0.05)' : '#fafafa');
    ctx.fillRect(sx + 4, H*0.06, stageW - 8, H*0.7);
    ctx.strokeStyle = isActive ? '#c41e3a' : (isPast ? '#16a34a' : '#e5e7eb');
    ctx.lineWidth = isActive ? 2 : 1;
    ctx.strokeRect(sx + 4, H*0.06, stageW - 8, H*0.7);

    const cx = sx + stageW/2, cy = H*0.42;

    // Draw bone shape at each stage
    if (i === 0) {
      // Pure cartilage model
      ctx.fillStyle = '#bfdbfe';
      ctx.beginPath(); ctx.ellipse(cx, cy - H*0.12, stageW*0.15, H*0.06, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.roundRect(cx - stageW*0.07, cy - H*0.08, stageW*0.14, H*0.16, 4); ctx.fill();
      ctx.beginPath(); ctx.ellipse(cx, cy + H*0.12, stageW*0.15, H*0.06, 0, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = '#93c5fd'; ctx.lineWidth = 1; ctx.stroke();
    } else if (i === 1) {
      // Bone collar forming
      ctx.fillStyle = '#bfdbfe';
      ctx.beginPath(); ctx.ellipse(cx, cy - H*0.12, stageW*0.15, H*0.06, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.roundRect(cx - stageW*0.07, cy - H*0.08, stageW*0.14, H*0.16, 4); ctx.fill();
      ctx.beginPath(); ctx.ellipse(cx, cy + H*0.12, stageW*0.15, H*0.06, 0, 0, Math.PI*2); ctx.fill();
      // Bone collar
      ctx.fillStyle = '#fef3c7';
      ctx.beginPath(); ctx.roundRect(cx - stageW*0.09, cy - H*0.06, stageW*0.18, H*0.12, 4); ctx.fill();
      ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
    } else if (i === 2) {
      // Primary ossification
      ctx.fillStyle = '#bfdbfe';
      ctx.beginPath(); ctx.ellipse(cx, cy - H*0.12, stageW*0.15, H*0.06, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(cx, cy + H*0.12, stageW*0.15, H*0.06, 0, 0, Math.PI*2); ctx.fill();
      // Bone replacing center
      ctx.fillStyle = '#fef3c7';
      ctx.beginPath(); ctx.roundRect(cx - stageW*0.09, cy - H*0.08, stageW*0.18, H*0.16, 4); ctx.fill();
      ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
      // Blood vessel
      ctx.strokeStyle = '#dc2626'; ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.moveTo(cx, cy - H*0.08); ctx.lineTo(cx, cy + H*0.08); ctx.stroke();
      // Medullary cavity starting
      ctx.fillStyle = '#fde68a';
      ctx.beginPath(); ctx.ellipse(cx, cy, stageW*0.04, H*0.04, 0, 0, Math.PI*2); ctx.fill();
    } else if (i === 3) {
      // Secondary ossification centers
      ctx.fillStyle = '#fef3c7';
      ctx.beginPath(); ctx.roundRect(cx - stageW*0.09, cy - H*0.15, stageW*0.18, H*0.30, 4); ctx.fill();
      ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
      // Remaining cartilage at epiphyses
      ctx.fillStyle = '#bfdbfe';
      ctx.beginPath(); ctx.ellipse(cx, cy - H*0.13, stageW*0.12, H*0.04, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(cx, cy + H*0.13, stageW*0.12, H*0.04, 0, 0, Math.PI*2); ctx.fill();
      // Growth plates
      ctx.strokeStyle = '#ea580c'; ctx.lineWidth = 2.5;
      ctx.beginPath(); ctx.moveTo(cx - stageW*0.1, cy - H*0.08); ctx.lineTo(cx + stageW*0.1, cy - H*0.08); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(cx - stageW*0.1, cy + H*0.08); ctx.lineTo(cx + stageW*0.1, cy + H*0.08); ctx.stroke();
      // Medullary cavity
      ctx.fillStyle = '#fde68a';
      ctx.beginPath(); ctx.roundRect(cx - stageW*0.04, cy - H*0.06, stageW*0.08, H*0.12, 3); ctx.fill();
    } else {
      // Mature bone
      ctx.fillStyle = '#fef3c7';
      ctx.beginPath(); ctx.roundRect(cx - stageW*0.09, cy - H*0.16, stageW*0.18, H*0.32, 4); ctx.fill();
      ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
      // Articular cartilage
      ctx.fillStyle = '#e0d4f5';
      ctx.beginPath(); ctx.ellipse(cx, cy - H*0.15, stageW*0.08, H*0.015, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(cx, cy + H*0.15, stageW*0.08, H*0.015, 0, 0, Math.PI*2); ctx.fill();
      // Epiphyseal line (closed)
      ctx.strokeStyle = '#64748b'; ctx.lineWidth = 1; ctx.setLineDash([3,3]);
      ctx.beginPath(); ctx.moveTo(cx - stageW*0.08, cy - H*0.09); ctx.lineTo(cx + stageW*0.08, cy - H*0.09); ctx.stroke();
      ctx.setLineDash([]);
      // Medullary cavity
      ctx.fillStyle = '#fde68a';
      ctx.beginPath(); ctx.roundRect(cx - stageW*0.04, cy - H*0.06, stageW*0.08, H*0.12, 3); ctx.fill();
    }

    // Stage label
    ctx.fillStyle = isActive ? '#c41e3a' : '#374151';
    ctx.font = (isActive ? 'bold ' : '') + '10px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(stage.label, cx, H*0.82);
    ctx.fillStyle = '#6b7280'; ctx.font = '9px system-ui';
    // Wrap desc
    const words = stage.desc.split(' ');
    let line1 = '', line2 = '';
    words.forEach(w => {
      if (line1.length + w.length < 22) line1 += (line1 ? ' ' : '') + w;
      else line2 += (line2 ? ' ' : '') + w;
    });
    ctx.fillText(line1, cx, H*0.87);
    if (line2) ctx.fillText(line2, cx, H*0.91);
  });

  // Arrow connecting stages
  ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1;
  for (let i = 0; i < 4; i++) {
    const x1 = stageW * (i+1) - 4;
    const x2 = stageW * (i+1) + 4;
    const y = H * 0.42;
    ctx.beginPath(); ctx.moveTo(x1, y); ctx.lineTo(x2, y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x2 - 4, y - 3); ctx.lineTo(x2, y); ctx.lineTo(x2 - 4, y + 3); ctx.fill();
  }
}


// ══════════════════════════════════════════════════════════════════════════
// PART 5: FRACTURE TYPES & HEALING
// ══════════════════════════════════════════════════════════════════════════
let currentFracture = 'transverse';

const FRACTURE_INFO = {
  transverse: { name: 'Transverse Fracture', desc: 'A straight break perpendicular to the long axis of the bone. Usually caused by a direct blow or force applied perpendicular to the bone. Common in the tibia and forearm bones. Healing time: 6-8 weeks.' },
  oblique: { name: 'Oblique Fracture', desc: 'A diagonal break across the bone at an angle. Caused by a force applied at an angle, often from a fall or twisting injury. Common in long bones. Healing time: 6-8 weeks.' },
  spiral: { name: 'Spiral Fracture', desc: 'A twisting break that spirals around the bone shaft. Caused by severe twisting forces, common in sports injuries. The fracture line wraps around the bone like a corkscrew. Healing time: 4-6 weeks for simple cases.' },
  comminuted: { name: 'Comminuted Fracture', desc: 'Bone is shattered into three or more fragments. Usually caused by high-impact trauma (car accidents, falls from height). Most difficult to heal and often requires surgical fixation. Healing time: 12+ weeks.' },
  greenstick: { name: 'Greenstick Fracture', desc: 'An incomplete fracture where the bone bends and partially breaks, like a green twig. Common in children because their bones are more flexible and have thicker periosteum. Healing time: 4-6 weeks.' },
  compound: { name: 'Compound (Open) Fracture', desc: 'The broken bone punctures through the skin surface. High risk of infection. Requires immediate medical attention and often surgical cleaning (debridement) and fixation. Healing time: 8-12+ weeks.' },
};

function setFracture(type) {
  currentFracture = type;
  const info = FRACTURE_INFO[type];
  $('fracture-info').innerHTML = '<div class="info-title">' + info.name + '</div><div class="tt-desc">' + info.desc + '</div>';
  drawFractureCanvas();
}

function drawFractureCanvas() {
  const ctx = getCtx('fracture-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Draw all 6 fracture types in a row
  const types = ['transverse', 'oblique', 'spiral', 'comminuted', 'greenstick', 'compound'];
  const fw = W / 6;

  types.forEach((type, i) => {
    const cx = fw * i + fw/2;
    const isActive = type === currentFracture;

    // Background highlight
    if (isActive) {
      ctx.fillStyle = 'rgba(196,30,58,0.05)';
      ctx.fillRect(fw * i + 2, 30, fw - 4, H - 70);
      ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
      ctx.strokeRect(fw * i + 2, 30, fw - 4, H - 70);
    }

    const boneW = fw * 0.18;
    const top = H * 0.15, bot = H * 0.75;
    const midY = (top + bot) / 2;

    // Draw bone based on fracture type
    ctx.fillStyle = '#fef3c7'; ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2;

    if (type === 'transverse') {
      // Top portion
      ctx.beginPath(); ctx.roundRect(cx - boneW, top, boneW*2, midY - top - 4, 4); ctx.fill(); ctx.stroke();
      // Bottom portion
      ctx.beginPath(); ctx.roundRect(cx - boneW, midY + 4, boneW*2, bot - midY - 4, 4); ctx.fill(); ctx.stroke();
      // Fracture line
      ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2.5;
      ctx.beginPath(); ctx.moveTo(cx - boneW - 4, midY); ctx.lineTo(cx + boneW + 4, midY); ctx.stroke();
    } else if (type === 'oblique') {
      ctx.beginPath(); ctx.roundRect(cx - boneW, top, boneW*2, midY - top - 8, 4); ctx.fill(); ctx.stroke();
      ctx.beginPath(); ctx.roundRect(cx - boneW, midY + 8, boneW*2, bot - midY - 8, 4); ctx.fill(); ctx.stroke();
      ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2.5;
      ctx.beginPath(); ctx.moveTo(cx - boneW - 4, midY - 12); ctx.lineTo(cx + boneW + 4, midY + 12); ctx.stroke();
    } else if (type === 'spiral') {
      ctx.beginPath(); ctx.roundRect(cx - boneW, top, boneW*2, bot - top, 4); ctx.fill(); ctx.stroke();
      ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2.5;
      ctx.beginPath();
      for (let t = 0; t <= 1; t += 0.05) {
        const x = cx + Math.sin(t * Math.PI * 3) * boneW;
        const y = midY - H*0.12 + t * H*0.24;
        t === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.stroke();
    } else if (type === 'comminuted') {
      // Multiple fragments
      const frags = [
        { x: cx-boneW*0.5, y: midY-15, w: boneW, h: 12, r: -0.1 },
        { x: cx+boneW*0.2, y: midY-5, w: boneW*0.8, h: 10, r: 0.2 },
        { x: cx-boneW*0.3, y: midY+5, w: boneW*0.9, h: 11, r: -0.15 },
        { x: cx, y: midY+2, w: boneW*0.5, h: 8, r: 0.3 },
      ];
      // Top and bottom intact portions
      ctx.beginPath(); ctx.roundRect(cx - boneW, top, boneW*2, midY - top - 20, 4); ctx.fill(); ctx.stroke();
      ctx.beginPath(); ctx.roundRect(cx - boneW, midY + 20, boneW*2, bot - midY - 20, 4); ctx.fill(); ctx.stroke();
      // Fragments
      frags.forEach(f => {
        ctx.save(); ctx.translate(f.x, f.y); ctx.rotate(f.r);
        ctx.fillStyle = '#fef3c7';
        ctx.beginPath(); ctx.roundRect(-f.w/2, -f.h/2, f.w, f.h, 2); ctx.fill();
        ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 1.5; ctx.stroke();
        ctx.restore();
      });
    } else if (type === 'greenstick') {
      // Bent bone, partial break
      ctx.beginPath();
      ctx.moveTo(cx - boneW, top); ctx.lineTo(cx + boneW, top);
      ctx.lineTo(cx + boneW, midY - 10);
      ctx.quadraticCurveTo(cx + boneW + 8, midY, cx + boneW, midY + 10);
      ctx.lineTo(cx + boneW, bot); ctx.lineTo(cx - boneW, bot);
      ctx.lineTo(cx - boneW, midY + 10);
      ctx.quadraticCurveTo(cx - boneW - 4, midY, cx - boneW, midY - 10);
      ctx.closePath(); ctx.fill();
      ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
      // Partial fracture on one side
      ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2.5;
      ctx.beginPath(); ctx.moveTo(cx + boneW + 2, midY - 8); ctx.lineTo(cx, midY); ctx.stroke();
    } else if (type === 'compound') {
      // Bone protruding through skin
      ctx.beginPath(); ctx.roundRect(cx - boneW, top, boneW*2, midY - top - 10, 4); ctx.fill(); ctx.stroke();
      ctx.beginPath(); ctx.roundRect(cx - boneW, midY + 15, boneW*2, bot - midY - 15, 4); ctx.fill(); ctx.stroke();
      // Protruding fragment
      ctx.save(); ctx.translate(cx, midY); ctx.rotate(-0.3);
      ctx.fillStyle = '#fef3c7';
      ctx.beginPath();
      ctx.moveTo(-3, 0); ctx.lineTo(-5, -25); ctx.lineTo(5, -30); ctx.lineTo(3, 0);
      ctx.closePath(); ctx.fill();
      ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2; ctx.stroke();
      ctx.restore();
      // Skin tear (wavy line)
      ctx.strokeStyle = '#dc2626'; ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(cx - boneW*2, midY + 2);
      for (let t = 0; t <= 1; t += 0.1) {
        ctx.lineTo(cx - boneW*2 + t * boneW*4, midY + 2 + Math.sin(t*12)*3);
      }
      ctx.stroke();
      // Blood drops
      ctx.fillStyle = '#dc2626';
      for (let d = 0; d < 3; d++) {
        ctx.beginPath(); ctx.arc(cx + (d-1)*8, midY + 20 + d*5, 3, 0, Math.PI*2); ctx.fill();
      }
    }

    // Label
    ctx.fillStyle = isActive ? '#c41e3a' : '#374151';
    ctx.font = (isActive ? 'bold ' : '') + '11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(FRACTURE_INFO[type].name.split(' ')[0], cx, H - 20);
  });
}

function updateHealing() {
  const week = parseInt($('heal-slider').value);
  $('heal-week').textContent = week;
  const pct = Math.round((week / 12) * 100);
  $('heal-pct').textContent = pct + '%';
  $('heal-progress').style.width = pct + '%';

  let stage;
  if (week === 0) stage = 'Injury';
  else if (week <= 1) stage = 'Hematoma';
  else if (week <= 4) stage = 'Fibrocartilage';
  else if (week <= 8) stage = 'Bony Callus';
  else stage = 'Remodeling';
  $('heal-stage').textContent = stage;

  drawHealingCanvas(week);

  const stageInfo = {
    'Injury': 'The bone has just fractured. Blood vessels are torn, forming a hematoma at the fracture site.',
    'Hematoma': 'A blood clot (hematoma) forms at the fracture site. Inflammatory cells arrive to clean up debris. Phagocytes remove dead cells.',
    'Fibrocartilage': 'Fibroblasts and chondroblasts produce a fibrocartilaginous callus. This soft callus bridges the gap and stabilizes the fracture. New blood vessels grow into the area.',
    'Bony Callus': 'Osteoblasts begin converting the fibrocartilage callus to a bony (hard) callus made of spongy bone. The fracture site becomes increasingly rigid.',
    'Remodeling': 'Osteoclasts and osteoblasts reshape the bony callus. Spongy bone is replaced by compact bone. The bone gradually returns to its original shape and strength.'
  };
  $('heal-info').innerHTML = '<div class="info-title">Stage: ' + stage + ' (Week ' + week + ')</div><div class="tt-desc">' + stageInfo[stage] + '</div>';
}

function drawHealingCanvas(week) {
  const ctx = getCtx('healing-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const cx = W/2, cy = H/2;
  const boneW = W * 0.06, boneH = H * 0.35;

  // Draw bone with fracture healing stages
  // Upper bone segment
  ctx.fillStyle = '#fef3c7';
  ctx.beginPath(); ctx.roundRect(cx - boneW, cy - boneH, boneW*2, boneH - 15, 6); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();

  // Lower bone segment
  ctx.beginPath(); ctx.roundRect(cx - boneW, cy + 15, boneW*2, boneH - 15, 6); ctx.fill();
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();

  // Fracture gap / healing region
  if (week === 0) {
    // Fresh fracture
    ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(cx - boneW - 5, cy); ctx.lineTo(cx + boneW + 5, cy); ctx.stroke();
  } else if (week <= 1) {
    // Hematoma (blood clot)
    ctx.fillStyle = 'rgba(220,38,38,0.4)';
    ctx.beginPath(); ctx.ellipse(cx, cy, boneW*1.5, 18, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#dc2626'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Hematoma', cx + boneW*2, cy);
  } else if (week <= 4) {
    // Fibrocartilage callus
    const progress = (week - 1) / 3;
    ctx.fillStyle = 'rgba(59,130,246,0.2)';
    ctx.beginPath(); ctx.ellipse(cx, cy, boneW * (1.5 + progress*0.5), 15 + progress*10, 0, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 1.5; ctx.stroke();
    // Internal fibrocartilage
    ctx.fillStyle = 'rgba(147,197,253,0.4)';
    ctx.beginPath(); ctx.ellipse(cx, cy, boneW * (1 + progress*0.3), 10 + progress*5, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#2563eb'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Soft Callus', cx + boneW*2.5, cy);
    // New blood vessels
    ctx.strokeStyle = '#dc2626'; ctx.lineWidth = 0.8;
    for (let i = 0; i < 4 * progress; i++) {
      const angle = (i / 4) * Math.PI;
      ctx.beginPath();
      ctx.moveTo(cx + Math.cos(angle) * boneW, cy + Math.sin(angle) * 8);
      ctx.lineTo(cx + Math.cos(angle) * boneW * 1.8, cy + Math.sin(angle) * 18);
      ctx.stroke();
    }
  } else if (week <= 8) {
    // Bony callus
    const progress = (week - 4) / 4;
    ctx.fillStyle = 'rgba(234,179,8,0.25)';
    ctx.beginPath(); ctx.ellipse(cx, cy, boneW * (2 - progress*0.3), 25 - progress*5, 0, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
    // Hard callus
    ctx.fillStyle = 'rgba(253,224,71,0.3)';
    ctx.beginPath(); ctx.ellipse(cx, cy, boneW * (1.3 + progress*0.2), 15, 0, 0, Math.PI*2); ctx.fill();
    // Spongy bone forming
    ctx.strokeStyle = 'rgba(180,130,60,0.4)'; ctx.lineWidth = 0.8;
    for (let i = 0; i < 8; i++) {
      const rx = cx + (Math.random() - 0.5) * boneW * 2.5;
      const ry = cy + (Math.random() - 0.5) * 30;
      ctx.beginPath(); ctx.arc(rx, ry, 3 + Math.random()*4, 0, Math.PI*2); ctx.stroke();
    }
    ctx.fillStyle = '#d97706'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Bony Callus', cx + boneW*2.5, cy);
  } else {
    // Remodeling
    const progress = (week - 8) / 4;
    // Callus shrinking
    const callSize = 1.5 - progress * 0.5;
    ctx.fillStyle = 'rgba(234,179,8,0.15)';
    ctx.beginPath(); ctx.ellipse(cx, cy, boneW * callSize, 20 - progress*8, 0, 0, Math.PI*2); ctx.fill();
    // Compact bone replacing
    ctx.fillStyle = '#fef3c7';
    ctx.beginPath(); ctx.roundRect(cx - boneW, cy - 12, boneW*2, 24, 4); ctx.fill();
    ctx.strokeStyle = '#d97706'; ctx.lineWidth = 1.5; ctx.stroke();
    ctx.fillStyle = '#16a34a'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Remodeling', cx + boneW*2.5, cy);
  }

  // Timeline bar at bottom
  const tlY = H * 0.88, tlW = W * 0.8, tlX = W * 0.1;
  ctx.fillStyle = '#e5e7eb';
  ctx.beginPath(); ctx.roundRect(tlX, tlY, tlW, 12, 6); ctx.fill();

  // Stage sections
  const stageColors = ['#dc2626', '#3b82f6', '#d97706', '#16a34a'];
  const stageWidths = [1/12, 3/12, 4/12, 4/12];
  let cumW = 0;
  stageColors.forEach((c, i) => {
    ctx.fillStyle = c + '40';
    const sw = stageWidths[i] * tlW;
    ctx.fillRect(tlX + cumW, tlY, sw, 12);
    cumW += sw;
  });

  // Progress marker
  const markerX = tlX + (week / 12) * tlW;
  ctx.fillStyle = '#c41e3a';
  ctx.beginPath(); ctx.arc(markerX, tlY + 6, 8, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.font = 'bold 9px system-ui'; ctx.textAlign = 'center';
  ctx.fillText(week, markerX, tlY + 9);

  // Stage labels
  ctx.font = '9px system-ui'; ctx.textAlign = 'center';
  ctx.fillStyle = '#dc2626'; ctx.fillText('Hematoma', tlX + (0.5/12)*tlW, tlY + 24);
  ctx.fillStyle = '#3b82f6'; ctx.fillText('Soft Callus', tlX + (2.5/12)*tlW, tlY + 24);
  ctx.fillStyle = '#d97706'; ctx.fillText('Bony Callus', tlX + (6/12)*tlW, tlY + 24);
  ctx.fillStyle = '#16a34a'; ctx.fillText('Remodeling', tlX + (10/12)*tlW, tlY + 24);
}


// ══════════════════════════════════════════════════════════════════════════
// PART 6: SKELETAL QUIZ
// ══════════════════════════════════════════════════════════════════════════
let quizState = {
  active: false,
  difficulty: 'all',
  questionNum: 0,
  correct: 0,
  wrong: 0,
  currentBone: null,
  options: [],
  answered: false,
  timerStart: 0,
  timerInterval: null,
  highScore: 0,
};

const QUIZ_POOLS = {
  easy: [
    { name: 'Sternum', region: 'Thorax', hint: 'The breastbone at the center of the chest' },
    { name: 'Ribs', region: 'Thorax', hint: '12 pairs protecting the thoracic organs' },
    { name: 'Sacrum', region: 'Vertebral Column', hint: 'Triangular bone at the base of the spine' },
    { name: 'Coccyx', region: 'Vertebral Column', hint: 'The tailbone, fused vertebrae at bottom of spine' },
    { name: 'Cervical Vertebrae', region: 'Vertebral Column', hint: '7 vertebrae of the neck (C1-C7)' },
    { name: 'Thoracic Vertebrae', region: 'Vertebral Column', hint: '12 vertebrae of the mid-back' },
    { name: 'Lumbar Vertebrae', region: 'Vertebral Column', hint: '5 large vertebrae of the lower back' },
    { name: 'Hyoid Bone', region: 'Throat', hint: 'U-shaped bone in the neck, supports the tongue' },
  ],
  medium: [
    { name: 'Humerus', region: 'Upper Limb', hint: 'The upper arm bone' },
    { name: 'Radius', region: 'Upper Limb', hint: 'Lateral forearm bone (thumb side)' },
    { name: 'Ulna', region: 'Upper Limb', hint: 'Medial forearm bone (pinky side)' },
    { name: 'Femur', region: 'Lower Limb', hint: 'The thigh bone, longest bone in the body' },
    { name: 'Tibia', region: 'Lower Limb', hint: 'The shinbone, medial leg bone' },
    { name: 'Fibula', region: 'Lower Limb', hint: 'Lateral leg bone, thinner than tibia' },
    { name: 'Patella', region: 'Lower Limb', hint: 'The kneecap' },
    { name: 'Clavicle', region: 'Pectoral Girdle', hint: 'The collarbone' },
    { name: 'Scapula', region: 'Pectoral Girdle', hint: 'The shoulder blade' },
    { name: 'Os Coxa', region: 'Pelvic Girdle', hint: 'Hip bone (ilium + ischium + pubis)' },
    { name: 'Carpals', region: 'Hand', hint: '8 small bones of the wrist' },
    { name: 'Metacarpals', region: 'Hand', hint: '5 bones forming the palm' },
    { name: 'Tarsals', region: 'Foot', hint: '7 bones of the ankle/heel' },
    { name: 'Metatarsals', region: 'Foot', hint: '5 bones of the midfoot' },
    { name: 'Phalanges', region: 'Hand/Foot', hint: 'Finger and toe bones' },
  ],
  hard: [
    { name: 'Frontal Bone', region: 'Skull', hint: 'Forehead bone' },
    { name: 'Parietal Bone', region: 'Skull', hint: 'Top/sides of cranium (paired)' },
    { name: 'Temporal Bone', region: 'Skull', hint: 'Side of skull near temples and ears' },
    { name: 'Occipital Bone', region: 'Skull', hint: 'Back of the skull' },
    { name: 'Sphenoid Bone', region: 'Skull', hint: 'Butterfly-shaped bone at skull base' },
    { name: 'Ethmoid Bone', region: 'Skull', hint: 'Between eye orbits, forms nasal cavity roof' },
    { name: 'Zygomatic Bone', region: 'Skull', hint: 'Cheekbone' },
    { name: 'Maxilla', region: 'Skull', hint: 'Upper jaw bone' },
    { name: 'Mandible', region: 'Skull', hint: 'Lower jaw, only movable skull bone' },
    { name: 'Nasal Bone', region: 'Skull', hint: 'Bridge of the nose (paired)' },
    { name: 'Lacrimal Bone', region: 'Skull', hint: 'Smallest facial bone, near tear duct' },
    { name: 'Palatine Bone', region: 'Skull', hint: 'Forms part of the hard palate' },
    { name: 'Vomer', region: 'Skull', hint: 'Forms inferior part of nasal septum' },
    { name: 'Inferior Nasal Concha', region: 'Skull', hint: 'Scroll-shaped bone in nasal cavity' },
  ],
};

function setDifficulty(diff) {
  quizState.difficulty = diff;
  ['easy','medium','hard','all'].forEach(d => {
    $('btn-diff-' + d).className = 'btn btn-sm ' + (d === diff ? 'btn-primary' : 'btn-outline');
  });
}

function getQuizPool() {
  if (quizState.difficulty === 'all') return [...QUIZ_POOLS.easy, ...QUIZ_POOLS.medium, ...QUIZ_POOLS.hard];
  return QUIZ_POOLS[quizState.difficulty];
}

function startQuiz() {
  quizState.active = true;
  quizState.questionNum = 0;
  quizState.correct = 0;
  quizState.wrong = 0;
  quizState.answered = false;
  quizState.timerStart = Date.now();
  if (quizState.timerInterval) clearInterval(quizState.timerInterval);
  quizState.timerInterval = setInterval(updateTimer, 1000);
  $('quiz-feedback').style.display = 'none';
  nextQuestion();
}

function updateTimer() {
  if (!quizState.active) return;
  const elapsed = Math.floor((Date.now() - quizState.timerStart) / 1000);
  const min = Math.floor(elapsed / 60);
  const sec = elapsed % 60;
  $('quiz-timer').textContent = min + ':' + (sec < 10 ? '0' : '') + sec;
}

function nextQuestion() {
  if (!quizState.active) { startQuiz(); return; }

  quizState.questionNum++;
  quizState.answered = false;
  $('quiz-feedback').style.display = 'none';

  const pool = getQuizPool();
  const correctBone = pool[rand(0, pool.length - 1)];
  quizState.currentBone = correctBone;

  // Generate 3 wrong options
  const allBones = [...QUIZ_POOLS.easy, ...QUIZ_POOLS.medium, ...QUIZ_POOLS.hard];
  const wrongOptions = [];
  while (wrongOptions.length < 3) {
    const wb = allBones[rand(0, allBones.length - 1)];
    if (wb.name !== correctBone.name && !wrongOptions.find(w => w.name === wb.name)) {
      wrongOptions.push(wb);
    }
  }

  // Shuffle options
  const options = [correctBone, ...wrongOptions];
  for (let i = options.length - 1; i > 0; i--) {
    const j = rand(0, i);
    [options[i], options[j]] = [options[j], options[i]];
  }
  quizState.options = options;

  updateQuizUI();
  drawQuizCanvas();
}

function updateQuizUI() {
  $('quiz-q').textContent = quizState.questionNum;
  $('quiz-correct').textContent = quizState.correct;
  $('quiz-wrong').textContent = quizState.wrong;
  const total = quizState.correct + quizState.wrong;
  $('quiz-pct').textContent = total > 0 ? Math.round(quizState.correct / total * 100) + '%' : '-';
  $('quiz-high').textContent = quizState.highScore;

  $('quiz-prompt').textContent = 'Question ' + quizState.questionNum + ': Identify this bone';

  // Render option buttons
  const optDiv = $('quiz-options');
  optDiv.innerHTML = '';
  quizState.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline';
    btn.textContent = opt.name;
    btn.onclick = () => answerQuiz(i);
    btn.id = 'quiz-opt-' + i;
    optDiv.appendChild(btn);
  });
}

function answerQuiz(idx) {
  if (quizState.answered) return;
  quizState.answered = true;

  const selected = quizState.options[idx];
  const correct = selected.name === quizState.currentBone.name;

  if (correct) {
    quizState.correct++;
    $('quiz-opt-' + idx).className = 'btn btn-primary';
    $('quiz-opt-' + idx).style.background = '#16a34a';
    $('quiz-fb-title').textContent = 'Correct!';
    $('quiz-fb-desc').textContent = quizState.currentBone.name + ' - ' + quizState.currentBone.hint;
    $('quiz-feedback').className = 'info-panel info-green';
  } else {
    quizState.wrong++;
    $('quiz-opt-' + idx).className = 'btn btn-primary';
    $('quiz-opt-' + idx).style.background = '#c41e3a';
    // Highlight correct answer
    quizState.options.forEach((opt, i) => {
      if (opt.name === quizState.currentBone.name) {
        $('quiz-opt-' + i).style.background = '#16a34a';
        $('quiz-opt-' + i).style.color = '#fff';
      }
    });
    $('quiz-fb-title').textContent = 'Incorrect! The answer was: ' + quizState.currentBone.name;
    $('quiz-fb-desc').textContent = quizState.currentBone.hint;
    $('quiz-feedback').className = 'info-panel info-accent';
  }
  $('quiz-feedback').style.display = 'block';

  // Update high score
  if (quizState.correct > quizState.highScore) {
    quizState.highScore = quizState.correct;
  }
  updateQuizUI();
}

function resetQuiz() {
  quizState.active = false;
  quizState.questionNum = 0;
  quizState.correct = 0;
  quizState.wrong = 0;
  if (quizState.timerInterval) clearInterval(quizState.timerInterval);
  $('quiz-timer').textContent = '-';
  $('quiz-prompt').textContent = 'Select a difficulty and start the quiz';
  $('quiz-options').innerHTML = '';
  $('quiz-feedback').style.display = 'none';
  updateQuizUI();
  drawQuizCanvas();
}

function drawQuizCanvas() {
  const ctx = getCtx('quiz-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  if (!quizState.active || !quizState.currentBone) {
    ctx.fillStyle = '#9ca3af'; ctx.font = '16px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Start the quiz to begin identifying bones', W/2, H/2);
    return;
  }

  const bone = quizState.currentBone;

  // Draw region of skeleton highlighting the target
  drawBodyOutline(ctx, W, H);

  // Highlight the region
  const regionPositions = {
    'Skull': { x: 0.5, y: 0.06, r: 0.06 },
    'Vertebral Column': { x: 0.5, y: 0.30, r: 0.12 },
    'Thorax': { x: 0.5, y: 0.22, r: 0.10 },
    'Throat': { x: 0.5, y: 0.11, r: 0.03 },
    'Upper Limb': { x: 0.35, y: 0.32, r: 0.10 },
    'Lower Limb': { x: 0.46, y: 0.72, r: 0.14 },
    'Pectoral Girdle': { x: 0.40, y: 0.16, r: 0.06 },
    'Pelvic Girdle': { x: 0.50, y: 0.44, r: 0.08 },
    'Hand': { x: 0.28, y: 0.50, r: 0.05 },
    'Hand/Foot': { x: 0.28, y: 0.50, r: 0.05 },
    'Foot': { x: 0.46, y: 0.92, r: 0.04 },
  };

  const pos = regionPositions[bone.region] || { x: 0.5, y: 0.5, r: 0.08 };

  // Pulsing highlight circle
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 3;
  ctx.setLineDash([6, 3]);
  ctx.beginPath(); ctx.arc(pos.x * W, pos.y * H, pos.r * W, 0, Math.PI*2); ctx.stroke();
  ctx.setLineDash([]);

  // Fill highlight
  ctx.fillStyle = 'rgba(196,30,58,0.08)';
  ctx.beginPath(); ctx.arc(pos.x * W, pos.y * H, pos.r * W, 0, Math.PI*2); ctx.fill();

  // Arrow pointing to region
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
  const arrowStartX = pos.x * W + pos.r * W + 15;
  const arrowStartY = pos.y * H;
  ctx.beginPath();
  ctx.moveTo(arrowStartX + 60, arrowStartY - 15);
  ctx.lineTo(arrowStartX, arrowStartY);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(arrowStartX + 6, arrowStartY - 5);
  ctx.lineTo(arrowStartX, arrowStartY);
  ctx.lineTo(arrowStartX + 6, arrowStartY + 5);
  ctx.stroke();

  // Question box
  ctx.fillStyle = '#1a1a2e';
  ctx.beginPath(); ctx.roundRect(arrowStartX + 65, arrowStartY - 45, 200, 60, 8); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Region: ' + bone.region, arrowStartX + 80, arrowStartY - 22);
  ctx.fillStyle = '#cbd5e1'; ctx.font = '12px system-ui';
  ctx.fillText('Which bone is this?', arrowStartX + 80, arrowStartY - 2);

  // Difficulty badge
  const diffColors = { easy: '#16a34a', medium: '#d97706', hard: '#c41e3a' };
  let diff = 'easy';
  if (QUIZ_POOLS.medium.find(b => b.name === bone.name)) diff = 'medium';
  if (QUIZ_POOLS.hard.find(b => b.name === bone.name)) diff = 'hard';
  ctx.fillStyle = diffColors[diff];
  ctx.beginPath(); ctx.roundRect(arrowStartX + 80, arrowStartY + 4, 50, 16, 8); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.font = 'bold 9px system-ui'; ctx.textAlign = 'center';
  ctx.fillText(diff.toUpperCase(), arrowStartX + 105, arrowStartY + 15);
}


// ══════════════════════════════════════════════════════════════════════════
// SIDEBAR SCROLL HIGHLIGHT
// ══════════════════════════════════════════════════════════════════════════
function updateSidebar() {
  const sections = document.querySelectorAll('.section, .hero');
  const links = document.querySelectorAll('.sidebar-nav a');
  let current = '';
  sections.forEach(s => {
    if (window.scrollY >= s.offsetTop - 100) current = s.id;
  });
  links.forEach(a => {
    a.classList.toggle('active', a.getAttribute('href') === '#' + current);
  });
}
window.addEventListener('scroll', updateSidebar);


// ══════════════════════════════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════════════════════════════
window.addEventListener('DOMContentLoaded', () => {
  drawSkeleton();
  updateSkelStats();
  setBoneZoom('gross');
  setJointType('fibrous');
  updateAge();
  setFracture('transverse');
  updateHealing();
  drawQuizCanvas();
});

window.addEventListener('resize', () => {
  drawSkeleton();
  drawBoneStructure();
  drawJoint();
  drawGrowthChart(parseInt($('age-slider').value));
  drawOssificationCanvas(parseInt($('age-slider').value));
  drawFractureCanvas();
  drawHealingCanvas(parseInt($('heal-slider').value));
  drawQuizCanvas();
});
</script>
</body>
</html>
