<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 12 Dashboard: Muscular System | BIOL-8</title>
<style>
/* ═══════════════════════════════════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f0f2f5; --card: #ffffff; --sidebar: #1a1a2e; --sidebar-hover: #252545;
  --accent: #c41e3a; --accent-light: #e8354f; --blue: #2563eb; --blue-light: #3b82f6;
  --green: #16a34a; --amber: #d97706; --purple: #7c3aed;
  --text: #1a1a1a; --text-muted: #6b7280; --border: #e5e7eb;
  --radius: 10px; --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
}
html { scroll-behavior: smooth; }
body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; }

/* ═══════════════════════════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════════════════════════ */
.layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; background: var(--sidebar); color: #e2e8f0; position: fixed;
  top: 0; left: 0; height: 100vh; overflow-y: auto; z-index: 100;
  display: flex; flex-direction: column;
}
.sidebar-header { padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-header h1 { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
.sidebar-header p { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.sidebar-nav { flex: 1; padding: 12px 0; }
.sidebar-nav a {
  display: flex; align-items: center; gap: 10px; padding: 10px 20px;
  color: #94a3b8; text-decoration: none; font-size: 13px; font-weight: 500;
  transition: all 0.15s; border-left: 3px solid transparent;
}
.sidebar-nav a:hover { background: var(--sidebar-hover); color: #e2e8f0; }
.sidebar-nav a.active { color: #fff; background: var(--sidebar-hover); border-left-color: var(--accent); }
.sidebar-nav .nav-num {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 6px; font-size: 11px; font-weight: 700;
  background: rgba(255,255,255,0.08); flex-shrink: 0;
}
.sidebar-nav a.active .nav-num { background: var(--accent); color: #fff; }
.sidebar-footer { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #64748b; }

.main { margin-left: 260px; flex: 1; padding: 32px; max-width: 1200px; }

/* ═══════════════════════════════════════════════════════════════════════
   CARDS & SECTIONS
   ═══════════════════════════════════════════════════════════════════════ */
.section { margin-bottom: 40px; scroll-margin-top: 24px; }
.section-header {
  display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
}
.section-num {
  display: flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: 10px;
  background: var(--accent); color: #fff; font-weight: 800; font-size: 16px; flex-shrink: 0;
}
.section-title { font-size: 22px; font-weight: 700; }
.section-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

.card {
  background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 24px; margin-bottom: 16px; border: 1px solid var(--border);
}
.card-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.card-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
@media (max-width: 900px) { .card-row, .card-row-3 { grid-template-columns: 1fr; } }

/* ═══════════════════════════════════════════════════════════════════════
   BUTTONS & INPUTS
   ═══════════════════════════════════════════════════════════════════════ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
  border: none; cursor: pointer; transition: all 0.15s; font-family: var(--font);
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn-secondary { background: var(--blue); color: #fff; }
.btn-secondary:hover { background: var(--blue-light); }
.btn-outline { background: transparent; color: var(--text); border: 2px solid var(--border); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }

.slider-group { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
.slider-group label { font-size: 13px; font-weight: 600; min-width: 80px; }
.slider-group input[type=range] { flex: 1; accent-color: var(--accent); }
.slider-val { font-family: var(--mono); font-size: 14px; font-weight: 700; min-width: 50px; text-align: right; }

/* ═══════════════════════════════════════════════════════════════════════
   STATS & BADGES
   ═══════════════════════════════════════════════════════════════════════ */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 12px 0; }
.stat-box {
  text-align: center; padding: 14px 8px; border-radius: 8px;
  background: #f8fafc; border: 1px solid var(--border);
}
.stat-box .stat-val { font-size: 28px; font-weight: 800; font-family: var(--mono); }
.stat-box .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-accent .stat-val { color: var(--accent); }
.stat-blue .stat-val { color: var(--blue); }
.stat-green .stat-val { color: var(--green); }
.stat-amber .stat-val { color: var(--amber); }
.stat-purple .stat-val { color: var(--purple); }

.badge {
  display: inline-block; padding: 2px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
}
.badge-red { background: #fef2f2; color: var(--accent); }
.badge-blue { background: #eff6ff; color: var(--blue); }
.badge-green { background: #f0fdf4; color: var(--green); }
.badge-amber { background: #fffbeb; color: var(--amber); }
.badge-purple { background: #f5f3ff; color: var(--purple); }

/* ═══════════════════════════════════════════════════════════════════════
   CHART CONTAINERS
   ═══════════════════════════════════════════════════════════════════════ */
.chart-wrap { position: relative; width: 100%; margin: 8px 0; }
.chart-wrap canvas { width: 100% !important; display: block; border-radius: 6px; }

/* ═══════════════════════════════════════════════════════════════════════
   CONVERGENCE LINE
   ═══════════════════════════════════════════════════════════════════════ */
.convergence-info { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin: 10px 0; font-size: 13px; }
.convergence-info .ci-dot { width: 12px; height: 3px; border-radius: 2px; display: inline-block; }

/* ═══════════════════════════════════════════════════════════════════════
   ANALYSIS PANEL
   ═══════════════════════════════════════════════════════════════════════ */
.analysis-result {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--blue); font-size: 14px;
}
.analysis-result .ar-title { font-weight: 700; margin-bottom: 6px; }
.analysis-result code { font-family: var(--mono); background: #e2e8f0; padding: 1px 6px; border-radius: 4px; font-size: 13px; }
.analysis-result.ar-pass { border-left-color: var(--green); }
.analysis-result.ar-fail { border-left-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   HERO BANNER
   ═══════════════════════════════════════════════════════════════════════ */
.hero {
  background: linear-gradient(135deg, #1a1a2e 0%, #2d1b3d 50%, #3b1a2e 100%);
  color: #fff; border-radius: var(--radius); padding: 36px; margin-bottom: 32px;
  position: relative; overflow: hidden;
}
.hero::after {
  content: ''; position: absolute; top: -50%; right: -20%; width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(196,30,58,0.15) 0%, transparent 70%);
  pointer-events: none;
}
.hero h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.hero p { font-size: 15px; color: #cbd5e1; max-width: 600px; line-height: 1.7; }
.hero .bio-tags { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
.hero .bio-tag {
  padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
  background: rgba(255,255,255,0.1); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);
}

/* ═══════════════════════════════════════════════════════════════════════
   MUSCLE-SPECIFIC STYLES
   ═══════════════════════════════════════════════════════════════════════ */
.progress-bar-wrap { background: #e5e7eb; border-radius: 8px; height: 8px; margin: 8px 0; overflow: hidden; }
.progress-bar-fill { height: 100%; border-radius: 8px; background: var(--green); transition: width 0.3s; }
.muscle-label-list { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
.muscle-label {
  padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;
  background: #f1f5f9; border: 1px solid var(--border); color: var(--text-muted);
  transition: all 0.2s; cursor: default;
}
.muscle-label.identified { background: #f0fdf4; border-color: #86efac; color: var(--green); }

.zoom-level-indicator {
  display: flex; gap: 4px; margin: 8px 0;
}
.zoom-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: #e5e7eb; transition: all 0.2s;
}
.zoom-dot.active { background: var(--accent); transform: scale(1.3); }

.fiber-legend { display: flex; gap: 16px; flex-wrap: wrap; margin: 8px 0; font-size: 13px; }
.fiber-legend-item { display: flex; align-items: center; gap: 6px; }
.fiber-swatch { width: 14px; height: 14px; border-radius: 3px; }

.grip-btn {
  width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent);
  background: linear-gradient(135deg, #fef2f2, #fff); cursor: pointer;
  font-size: 14px; font-weight: 800; color: var(--accent); font-family: var(--font);
  transition: all 0.1s; display: flex; align-items: center; justify-content: center;
  user-select: none;
}
.grip-btn:active { transform: scale(0.92); background: linear-gradient(135deg, #fecaca, #fef2f2); }

.joint-select {
  padding: 8px 16px; border-radius: 8px; border: 2px solid var(--border);
  font-size: 14px; font-weight: 600; font-family: var(--font);
  background: #fff; cursor: pointer;
}

/* ═══════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main { margin-left: 0; padding: 16px; }
}
</style>
</head>
<body>
<div class="layout">

<!-- ═══════════════════════════════════════════════════════════════════════
     SIDEBAR
     ═══════════════════════════════════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h1>BIOL-8: Human Biology</h1>
    <p>Lab 12 &mdash; Muscular System</p>
  </div>
  <nav class="sidebar-nav">
    <a href="#hero" class="active"><span class="nav-num">&bull;</span> Overview</a>
    <a href="#part1"><span class="nav-num">1</span> Muscle Identification</a>
    <a href="#part2"><span class="nav-num">2</span> Contraction Mechanism</a>
    <a href="#part3"><span class="nav-num">3</span> Fiber Types</a>
    <a href="#part4"><span class="nav-num">4</span> Fatigue &amp; Recovery</a>
    <a href="#part5"><span class="nav-num">5</span> Action Simulator</a>
    <a href="#part6"><span class="nav-num">6</span> Exercise Physiology</a>
  </nav>
  <div class="sidebar-footer">Interactive Lab Dashboard<br>&copy; 2026 BIOL-8</div>
</aside>

<!-- ═══════════════════════════════════════════════════════════════════════
     MAIN CONTENT
     ═══════════════════════════════════════════════════════════════════════ -->
<div class="main">

<!-- HERO -->
<div class="hero" id="hero">
  <h2>Muscular System</h2>
  <p>Explore the muscles of the human body through interactive anatomy, contraction animations, fiber type comparisons, fatigue experiments, and exercise physiology simulations.</p>
  <div class="bio-tags">
    <span class="bio-tag">Muscles</span>
    <span class="bio-tag">Contraction</span>
    <span class="bio-tag">Exercise</span>
  </div>
</div>

<!-- ═══════════════════════ PART 1: MUSCLE IDENTIFICATION ════════════════ -->
<div class="section" id="part1">
  <div class="section-header">
    <div class="section-num">1</div>
    <div><div class="section-title">Major Muscle Identification</div>
    <div class="section-subtitle">Click muscles on the body to identify and learn their names and functions</div></div>
  </div>
  <div class="card">
    <div class="card-title">Interactive Body Map</div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="toggleBodyView('anterior')">Anterior View</button>
      <button class="btn btn-secondary" onclick="toggleBodyView('posterior')">Posterior View</button>
      <button class="btn btn-outline" onclick="resetIdentification()">Reset Progress</button>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-green"><div class="stat-val" id="id-count">0</div><div class="stat-label">Identified</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="id-total">20</div><div class="stat-label">Total Muscles</div></div>
      <div class="stat-box stat-accent"><div class="stat-val" id="id-pct">0%</div><div class="stat-label">Progress</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="id-view">ANT</div><div class="stat-label">Current View</div></div>
    </div>
    <div class="progress-bar-wrap"><div class="progress-bar-fill" id="id-progress" style="width:0%"></div></div>
    <div class="chart-wrap"><canvas id="body-canvas" height="520"></canvas></div>
    <div id="muscle-info" class="analysis-result" style="display:none;">
      <div class="ar-title" id="muscle-info-name"></div>
      <p id="muscle-info-detail"></p>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Identification Progress</div>
    <div class="muscle-label-list" id="muscle-labels"></div>
  </div>
</div>

<!-- ═══════════════════════ PART 2: CONTRACTION MECHANISM ════════════════ -->
<div class="section" id="part2">
  <div class="section-header">
    <div class="section-num">2</div>
    <div><div class="section-title">Muscle Contraction Mechanism</div>
    <div class="section-subtitle">Sliding filament model from whole muscle to sarcomere level</div></div>
  </div>
  <div class="card">
    <div class="card-title">Zoom Levels</div>
    <div class="btn-group">
      <button class="btn btn-sm btn-outline" onclick="setZoom(0)">Whole Muscle</button>
      <button class="btn btn-sm btn-outline" onclick="setZoom(1)">Fascicle</button>
      <button class="btn btn-sm btn-outline" onclick="setZoom(2)">Fiber</button>
      <button class="btn btn-sm btn-outline" onclick="setZoom(3)">Myofibril</button>
      <button class="btn btn-sm btn-primary" onclick="setZoom(4)">Sarcomere</button>
    </div>
    <div class="zoom-level-indicator" id="zoom-dots"></div>
    <div class="chart-wrap"><canvas id="zoom-canvas" height="340"></canvas></div>
    <p style="font-size:13px;color:var(--text-muted);margin-top:8px;" id="zoom-desc">Click a zoom level above to explore muscle structure from macro to molecular scale.</p>
  </div>
  <div class="card">
    <div class="card-title">Sarcomere Contraction Animation</div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="toggleContraction()"><span id="contract-btn-text">Play Contraction</span></button>
      <button class="btn btn-secondary" onclick="stepContraction()">Step Forward</button>
      <button class="btn btn-outline" onclick="resetContraction()">Reset</button>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="contract-step">0</div><div class="stat-label">Step</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="contract-phase">Rest</div><div class="stat-label">Phase</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="contract-atp">3</div><div class="stat-label">ATP Used</div></div>
      <div class="stat-box stat-purple"><div class="stat-val" id="contract-ca">Low</div><div class="stat-label">Ca2+ Level</div></div>
    </div>
    <div class="chart-wrap"><canvas id="sarcomere-canvas" height="300"></canvas></div>
    <div class="analysis-result" id="contract-info">
      <div class="ar-title">Resting State</div>
      <p>The sarcomere is at resting length. Tropomyosin blocks active binding sites on actin. Press Play or Step to begin the contraction cycle.</p>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 3: FIBER TYPES ═════════════════════════ -->
<div class="section" id="part3">
  <div class="section-header">
    <div class="section-num">3</div>
    <div><div class="section-title">Muscle Fiber Type Comparison</div>
    <div class="section-subtitle">Compare slow oxidative, fast oxidative, and fast glycolytic fibers</div></div>
  </div>
  <div class="card">
    <div class="card-title">Fiber Type Overview</div>
    <div class="fiber-legend">
      <div class="fiber-legend-item"><div class="fiber-swatch" style="background:#dc2626;"></div> Type I (Slow Oxidative)</div>
      <div class="fiber-legend-item"><div class="fiber-swatch" style="background:#ea580c;"></div> Type IIa (Fast Oxidative)</div>
      <div class="fiber-legend-item"><div class="fiber-swatch" style="background:#f5f5dc; border:1px solid #ccc;"></div> Type IIx (Fast Glycolytic)</div>
    </div>
    <div class="chart-wrap"><canvas id="fiber-cross-canvas" height="220"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Property Comparison Charts</div>
    <div class="btn-group">
      <button class="btn btn-sm btn-primary" onclick="setFiberChart('speed')">Contraction Speed</button>
      <button class="btn btn-sm btn-secondary" onclick="setFiberChart('fatigue')">Fatigue Resistance</button>
      <button class="btn btn-sm btn-outline" onclick="setFiberChart('mito')">Mitochondria</button>
      <button class="btn btn-sm btn-outline" onclick="setFiberChart('myoglobin')">Myoglobin</button>
      <button class="btn btn-sm btn-outline" onclick="setFiberChart('all')">All Properties</button>
    </div>
    <div class="chart-wrap"><canvas id="fiber-chart" height="280"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Body Distribution Examples</div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val">Soleus</div><div class="stat-label">Type I Rich</div></div>
      <div class="stat-box stat-amber"><div class="stat-val">Biceps</div><div class="stat-label">Mixed I/IIa</div></div>
      <div class="stat-box stat-blue"><div class="stat-val">Orbicularis</div><div class="stat-label">Type IIx Rich</div></div>
    </div>
    <div class="chart-wrap"><canvas id="fiber-dist-chart" height="220"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════ PART 4: FATIGUE & RECOVERY ══════════════════ -->
<div class="section" id="part4">
  <div class="section-header">
    <div class="section-num">4</div>
    <div><div class="section-title">Fatigue &amp; Recovery Experiment</div>
    <div class="section-subtitle">Virtual grip strength test measuring muscle fatigue and recovery</div></div>
  </div>
  <div class="card">
    <div class="card-title">Virtual Grip Strength Test</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Click the SQUEEZE button as rapidly as possible for 30 seconds. Watch your force output decline as muscles fatigue. Rest between trials to observe recovery.</p>
    <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap;">
      <button class="grip-btn" id="grip-btn" onclick="gripSqueeze()">SQUEEZE</button>
      <div>
        <div class="btn-group" style="margin:0;">
          <button class="btn btn-primary" onclick="startGripTrial()">Start Trial</button>
          <button class="btn btn-secondary" onclick="startRestPeriod()">Rest 15s</button>
          <button class="btn btn-outline" onclick="resetGrip()">Reset All</button>
        </div>
      </div>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="grip-force">0</div><div class="stat-label">Current Force</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="grip-peak">0</div><div class="stat-label">Peak Force</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="grip-clicks">0</div><div class="stat-label">Total Clicks</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="grip-time">30s</div><div class="stat-label">Time Left</div></div>
      <div class="stat-box stat-purple"><div class="stat-val" id="grip-trial">0</div><div class="stat-label">Trial #</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Force Output Over Time (Current Trial)</div>
    <div class="chart-wrap"><canvas id="fatigue-chart" height="260"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Peak Force Across Trials</div>
    <div class="convergence-info">
      <span><span class="ci-dot" style="background:var(--accent);"></span> Peak force per trial</span>
      <span><span class="ci-dot" style="background:var(--blue);"></span> Recovery trend</span>
    </div>
    <div class="chart-wrap"><canvas id="trials-chart" height="220"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Lactic Acid Accumulation</div>
    <div class="chart-wrap"><canvas id="lactate-chart" height="180"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════ PART 5: ACTION SIMULATOR ════════════════════ -->
<div class="section" id="part5">
  <div class="section-header">
    <div class="section-num">5</div>
    <div><div class="section-title">Muscle Action Simulator</div>
    <div class="section-subtitle">Explore agonist, antagonist, and synergist roles in joint movements</div></div>
  </div>
  <div class="card">
    <div class="card-title">Select Joint Movement</div>
    <div class="btn-group">
      <select class="joint-select" id="joint-select" onchange="selectJoint()">
        <option value="elbow-flexion">Elbow Flexion</option>
        <option value="elbow-extension">Elbow Extension</option>
        <option value="knee-extension">Knee Extension</option>
        <option value="knee-flexion">Knee Flexion</option>
        <option value="shoulder-abduction">Shoulder Abduction</option>
        <option value="hip-extension">Hip Extension</option>
      </select>
      <button class="btn btn-primary" onclick="playJointAction()"><span id="joint-btn-text">Play Movement</span></button>
      <button class="btn btn-outline" onclick="resetJointAction()">Reset</button>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="joint-agonist">-</div><div class="stat-label">Agonist</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="joint-antagonist">-</div><div class="stat-label">Antagonist</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="joint-synergist">-</div><div class="stat-label">Synergist</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="joint-lever">-</div><div class="stat-label">Lever Class</div></div>
    </div>
    <div class="chart-wrap"><canvas id="joint-canvas" height="400"></canvas></div>
    <div class="analysis-result" id="joint-info">
      <div class="ar-title">Select a movement above</div>
      <p>Choose a joint movement to see the agonist (prime mover), antagonist, and synergist muscles in action. Origin and insertion points will be marked.</p>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 6: EXERCISE PHYSIOLOGY ═════════════════ -->
<div class="section" id="part6">
  <div class="section-header">
    <div class="section-num">6</div>
    <div><div class="section-title">Exercise Physiology Dashboard</div>
    <div class="section-subtitle">Explore how different exercises recruit muscles and energy systems</div></div>
  </div>
  <div class="card">
    <div class="card-title">Select Exercise Type</div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="selectExercise('sprint')">Sprinting</button>
      <button class="btn btn-secondary" onclick="selectExercise('marathon')">Marathon</button>
      <button class="btn btn-outline" onclick="selectExercise('weightlift')">Weightlifting</button>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="ex-type">-</div><div class="stat-label">Exercise</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="ex-energy">-</div><div class="stat-label">Energy System</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="ex-duration">-</div><div class="stat-label">Duration</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="ex-fiber">-</div><div class="stat-label">Primary Fiber</div></div>
      <div class="stat-box stat-purple"><div class="stat-val" id="ex-vo2">-</div><div class="stat-label">VO2 Demand</div></div>
    </div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Primary Muscles Used</div>
      <div class="chart-wrap"><canvas id="ex-body-canvas" height="380"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">Fiber Type Recruitment</div>
      <div class="chart-wrap"><canvas id="ex-fiber-chart" height="180"></canvas></div>
      <div class="card-title" style="margin-top:16px;">Energy System Contribution</div>
      <div class="chart-wrap"><canvas id="ex-energy-chart" height="180"></canvas></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Training Adaptation Over 12 Weeks</div>
    <div class="convergence-info">
      <span><span class="ci-dot" style="background:var(--accent);"></span> Strength gain</span>
      <span><span class="ci-dot" style="background:var(--blue);"></span> Endurance gain</span>
      <span><span class="ci-dot" style="background:var(--green);"></span> Muscle mass</span>
    </div>
    <div class="chart-wrap"><canvas id="adaptation-chart" height="280"></canvas></div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /layout -->

<!-- ═══════════════════════════════════════════════════════════════════════
     JAVASCRIPT ENGINE
     ═══════════════════════════════════════════════════════════════════════ -->
<script>
// == Utility ==
const $ = id => document.getElementById(id);
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
const lerp = (a, b, t) => a + (b - a) * t;

// == Chart helpers (from reference) ==
function getCtx(id) {
  const c = $(id); const dpr = window.devicePixelRatio || 1;
  const w = c.offsetWidth || c.width || 300;
  const h = c.offsetHeight || c.height || 150;
  c.width = w * dpr; c.height = h * dpr;
  const ctx = c.getContext('2d'); ctx.scale(dpr, dpr);
  ctx.W = w; ctx.H = h;
  return ctx;
}

function drawBarChart(ctx, opts = {}) {
  const { labels, values, expected, colors, maxVal, yLabel } = opts;
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const n = values.length, barW = plotW / n * 0.6, gap = plotW / n * 0.4;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);
  const mv = maxVal || Math.max(...values, ...(expected||[0])) * 1.2 || 10;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui';
    ctx.textAlign = 'right'; ctx.fillText((mv * i/4).toFixed(mv > 10 ? 0 : 2), pad.left - 6, y + 4);
  }
  values.forEach((v, i) => {
    const x = pad.left + (plotW / n) * i + gap/2;
    const h = (v / mv) * plotH;
    ctx.fillStyle = colors ? colors[i] : '#c41e3a';
    ctx.beginPath();
    const r = 4;
    ctx.moveTo(x, pad.top + plotH);
    ctx.lineTo(x, pad.top + plotH - h + r);
    ctx.quadraticCurveTo(x, pad.top + plotH - h, x + r, pad.top + plotH - h);
    ctx.lineTo(x + barW - r, pad.top + plotH - h);
    ctx.quadraticCurveTo(x + barW, pad.top + plotH - h, x + barW, pad.top + plotH - h + r);
    ctx.lineTo(x + barW, pad.top + plotH);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(labels[i], x + barW/2, H - pad.bottom + 16);
    if (v > 0) {
      ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 12px system-ui';
      ctx.fillText(v.toFixed(v % 1 ? 2 : 0), x + barW/2, pad.top + plotH - h - 6);
    }
  });
  if (expected) {
    expected.forEach((ev, i) => {
      const x = pad.left + (plotW / n) * i + gap/2;
      const y = pad.top + plotH - (ev / mv) * plotH;
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.setLineDash([4,3]);
      ctx.beginPath(); ctx.moveTo(x - 4, y); ctx.lineTo(x + barW + 4, y); ctx.stroke();
      ctx.setLineDash([]);
    });
  }
}

function drawLineChart(ctx, series, opts = {}) {
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 30, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);
  const { yMin = 0, yMax = 1, refLine, xLabel } = opts;
  const yRange = yMax - yMin;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((yMin + yRange * i/4).toFixed(yRange > 10 ? 0 : 2), pad.left - 6, y + 4);
  }
  if (refLine !== undefined) {
    const ry = pad.top + plotH * (1 - (refLine - yMin) / yRange);
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(pad.left, ry); ctx.lineTo(W - pad.right, ry); ctx.stroke();
    ctx.setLineDash([]);
  }
  series.forEach(s => {
    if (!s.data.length) return;
    const xMax = opts.xMax || s.data.length;
    ctx.strokeStyle = s.color; ctx.lineWidth = s.width || 2;
    ctx.beginPath();
    s.data.forEach((v, i) => {
      const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
      const y = pad.top + plotH * (1 - (v - yMin) / yRange);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    if (s.width !== 0) ctx.stroke();
    if (s.dots && s.data.length < 80) {
      s.data.forEach((v, i) => {
        const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
        const y = pad.top + plotH * (1 - (v - yMin) / yRange);
        ctx.fillStyle = s.color; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
      });
    }
  });
}

// ══════════════════════════════════════════════════════════════════════════
// PART 1: MUSCLE IDENTIFICATION
// ══════════════════════════════════════════════════════════════════════════

const muscleData = {
  anterior: [
    { name: 'Deltoid (L)', x: 0.30, y: 0.18, w: 0.06, h: 0.05, desc: 'Abducts, flexes, and extends the arm. Caps the shoulder joint.' },
    { name: 'Deltoid (R)', x: 0.64, y: 0.18, w: 0.06, h: 0.05, desc: 'Abducts, flexes, and extends the arm. Caps the shoulder joint.' },
    { name: 'Pectoralis Major (L)', x: 0.36, y: 0.20, w: 0.10, h: 0.08, desc: 'Large fan-shaped chest muscle. Flexes, adducts, and medially rotates the arm.' },
    { name: 'Pectoralis Major (R)', x: 0.54, y: 0.20, w: 0.10, h: 0.08, desc: 'Large fan-shaped chest muscle. Flexes, adducts, and medially rotates the arm.' },
    { name: 'Biceps Brachii (L)', x: 0.27, y: 0.27, w: 0.04, h: 0.09, desc: 'Flexes the elbow and supinates the forearm. Two-headed muscle of the upper arm.' },
    { name: 'Biceps Brachii (R)', x: 0.69, y: 0.27, w: 0.04, h: 0.09, desc: 'Flexes the elbow and supinates the forearm. Two-headed muscle of the upper arm.' },
    { name: 'Rectus Abdominis', x: 0.44, y: 0.32, w: 0.12, h: 0.12, desc: 'Flexes the vertebral column ("six-pack"). Runs vertically along the front of the abdomen.' },
    { name: 'External Oblique (L)', x: 0.37, y: 0.33, w: 0.07, h: 0.08, desc: 'Lateral flexion and rotation of the trunk. Forms the waistline.' },
    { name: 'External Oblique (R)', x: 0.56, y: 0.33, w: 0.07, h: 0.08, desc: 'Lateral flexion and rotation of the trunk. Forms the waistline.' },
    { name: 'Quadriceps (L)', x: 0.38, y: 0.50, w: 0.08, h: 0.16, desc: 'Four-muscle group (rectus femoris, vastus lateralis, medialis, intermedius). Extends the knee.' },
    { name: 'Quadriceps (R)', x: 0.54, y: 0.50, w: 0.08, h: 0.16, desc: 'Four-muscle group (rectus femoris, vastus lateralis, medialis, intermedius). Extends the knee.' },
    { name: 'Tibialis Anterior (L)', x: 0.40, y: 0.70, w: 0.04, h: 0.12, desc: 'Dorsiflexes and inverts the foot. Located on the shin.' },
    { name: 'Tibialis Anterior (R)', x: 0.56, y: 0.70, w: 0.04, h: 0.12, desc: 'Dorsiflexes and inverts the foot. Located on the shin.' },
    { name: 'Sternocleidomastoid', x: 0.46, y: 0.10, w: 0.08, h: 0.05, desc: 'Flexes and laterally rotates the head. Prominent neck muscle.' },
  ],
  posterior: [
    { name: 'Trapezius', x: 0.40, y: 0.13, w: 0.20, h: 0.10, desc: 'Elevates, depresses, and retracts the scapula. Diamond-shaped upper back muscle.' },
    { name: 'Latissimus Dorsi (L)', x: 0.35, y: 0.25, w: 0.09, h: 0.12, desc: 'Extends, adducts, and medially rotates the arm. Broadest muscle of the back.' },
    { name: 'Latissimus Dorsi (R)', x: 0.56, y: 0.25, w: 0.09, h: 0.12, desc: 'Extends, adducts, and medially rotates the arm. Broadest muscle of the back.' },
    { name: 'Triceps Brachii (L)', x: 0.27, y: 0.26, w: 0.05, h: 0.10, desc: 'Extends the elbow. Three-headed muscle on the back of the upper arm.' },
    { name: 'Triceps Brachii (R)', x: 0.68, y: 0.26, w: 0.05, h: 0.10, desc: 'Extends the elbow. Three-headed muscle on the back of the upper arm.' },
    { name: 'Gluteus Maximus (L)', x: 0.38, y: 0.40, w: 0.09, h: 0.08, desc: 'Extends and laterally rotates the hip. Largest and most superficial gluteal muscle.' },
    { name: 'Gluteus Maximus (R)', x: 0.53, y: 0.40, w: 0.09, h: 0.08, desc: 'Extends and laterally rotates the hip. Largest and most superficial gluteal muscle.' },
    { name: 'Hamstrings (L)', x: 0.38, y: 0.50, w: 0.07, h: 0.16, desc: 'Three muscles (biceps femoris, semitendinosus, semimembranosus). Flex the knee, extend the hip.' },
    { name: 'Hamstrings (R)', x: 0.55, y: 0.50, w: 0.07, h: 0.16, desc: 'Three muscles (biceps femoris, semitendinosus, semimembranosus). Flex the knee, extend the hip.' },
    { name: 'Gastrocnemius (L)', x: 0.39, y: 0.68, w: 0.06, h: 0.12, desc: 'Plantarflexes the foot and flexes the knee. The large calf muscle.' },
    { name: 'Gastrocnemius (R)', x: 0.55, y: 0.68, w: 0.06, h: 0.12, desc: 'Plantarflexes the foot and flexes the knee. The large calf muscle.' },
    { name: 'Erector Spinae', x: 0.44, y: 0.28, w: 0.12, h: 0.10, desc: 'Group of muscles running along the spine. Extends and laterally flexes the vertebral column.' },
  ],
};

let currentView = 'anterior';
let identifiedMuscles = new Set();
let hoveredMuscle = null;

function getAllMuscleNames() {
  const names = new Set();
  muscleData.anterior.forEach(m => names.add(m.name));
  muscleData.posterior.forEach(m => names.add(m.name));
  return [...names];
}

function toggleBodyView(view) {
  currentView = view;
  $('id-view').textContent = view === 'anterior' ? 'ANT' : 'POST';
  drawBody();
}

function resetIdentification() {
  identifiedMuscles.clear();
  hoveredMuscle = null;
  updateIdUI();
  drawBody();
}

function updateIdUI() {
  const all = getAllMuscleNames();
  $('id-count').textContent = identifiedMuscles.size;
  $('id-total').textContent = all.length;
  const pct = all.length ? Math.round(identifiedMuscles.size / all.length * 100) : 0;
  $('id-pct').textContent = pct + '%';
  $('id-progress').style.width = pct + '%';

  const labelContainer = $('muscle-labels');
  labelContainer.innerHTML = '';
  all.sort().forEach(name => {
    const span = document.createElement('span');
    span.className = 'muscle-label' + (identifiedMuscles.has(name) ? ' identified' : '');
    span.textContent = name.replace(/ \((L|R)\)/, '');
    if (identifiedMuscles.has(name)) {
      // Avoid duplicate visual labels for L/R
    }
    labelContainer.appendChild(span);
  });
  // Deduplicate display labels
  const seen = new Set();
  labelContainer.innerHTML = '';
  all.sort().forEach(name => {
    const display = name.replace(/ \((L|R)\)/, '');
    if (seen.has(display)) return;
    seen.add(display);
    const isId = identifiedMuscles.has(name) || identifiedMuscles.has(name.replace('(L)', '(R)')) || identifiedMuscles.has(name.replace('(R)', '(L)'));
    const span = document.createElement('span');
    span.className = 'muscle-label' + (isId ? ' identified' : '');
    span.textContent = display;
    labelContainer.appendChild(span);
  });
}

function drawBody() {
  const ctx = getCtx('body-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Draw body outline
  const cx = W * 0.5, headY = H * 0.06;
  ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 2; ctx.fillStyle = '#f1f5f9';

  // Head
  ctx.beginPath(); ctx.ellipse(cx, headY + 22, 22, 26, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  // Neck
  ctx.fillRect(cx - 8, headY + 48, 16, 14);
  ctx.strokeRect(cx - 8, headY + 48, 16, 14);
  // Torso
  ctx.beginPath();
  ctx.moveTo(cx - 60, H * 0.12); ctx.lineTo(cx - 70, H * 0.14);
  ctx.lineTo(cx - 55, H * 0.44); ctx.lineTo(cx - 30, H * 0.48);
  ctx.lineTo(cx + 30, H * 0.48); ctx.lineTo(cx + 55, H * 0.44);
  ctx.lineTo(cx + 70, H * 0.14); ctx.lineTo(cx + 60, H * 0.12);
  ctx.closePath(); ctx.fill(); ctx.stroke();
  // Arms
  [-1, 1].forEach(side => {
    ctx.beginPath();
    ctx.moveTo(cx + side * 68, H * 0.15);
    ctx.lineTo(cx + side * 90, H * 0.25);
    ctx.lineTo(cx + side * 85, H * 0.38);
    ctx.lineTo(cx + side * 75, H * 0.38);
    ctx.lineTo(cx + side * 78, H * 0.25);
    ctx.lineTo(cx + side * 58, H * 0.16);
    ctx.closePath(); ctx.fill(); ctx.stroke();
  });
  // Legs
  [-1, 1].forEach(side => {
    ctx.beginPath();
    ctx.moveTo(cx + side * 28, H * 0.48);
    ctx.lineTo(cx + side * 38, H * 0.65);
    ctx.lineTo(cx + side * 34, H * 0.84);
    ctx.lineTo(cx + side * 22, H * 0.84);
    ctx.lineTo(cx + side * 20, H * 0.65);
    ctx.lineTo(cx + side * 12, H * 0.48);
    ctx.closePath(); ctx.fill(); ctx.stroke();
  });
  // Feet
  [-1, 1].forEach(side => {
    ctx.beginPath();
    ctx.ellipse(cx + side * 28, H * 0.86, 14, 6, 0, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();
  });

  // Label: view indicator
  ctx.fillStyle = '#374151'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText(currentView === 'anterior' ? 'ANTERIOR VIEW' : 'POSTERIOR VIEW', cx, H * 0.95);

  // Draw muscle regions
  const muscles = muscleData[currentView];
  muscles.forEach(m => {
    const mx = W * m.x, my = H * m.y, mw = W * m.w, mh = H * m.h;
    const isId = identifiedMuscles.has(m.name);
    const isHov = hoveredMuscle === m.name;

    ctx.fillStyle = isId ? 'rgba(22,163,74,0.35)' : isHov ? 'rgba(196,30,58,0.25)' : 'rgba(37,99,235,0.12)';
    ctx.strokeStyle = isId ? '#16a34a' : isHov ? '#c41e3a' : 'rgba(37,99,235,0.3)';
    ctx.lineWidth = isHov ? 2.5 : 1.5;

    // Draw rounded rect for muscle region
    const r = 6;
    ctx.beginPath();
    ctx.moveTo(mx + r, my); ctx.lineTo(mx + mw - r, my);
    ctx.quadraticCurveTo(mx + mw, my, mx + mw, my + r);
    ctx.lineTo(mx + mw, my + mh - r);
    ctx.quadraticCurveTo(mx + mw, my + mh, mx + mw - r, my + mh);
    ctx.lineTo(mx + r, my + mh);
    ctx.quadraticCurveTo(mx, my + mh, mx, my + mh - r);
    ctx.lineTo(mx, my + r);
    ctx.quadraticCurveTo(mx, my, mx + r, my);
    ctx.closePath(); ctx.fill(); ctx.stroke();

    // Label
    if (isId || isHov) {
      ctx.fillStyle = isId ? '#16a34a' : '#c41e3a';
      ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
      const label = m.name.replace(/ \((L|R)\)/, '');
      ctx.fillText(label, mx + mw/2, my - 4);
    }
  });
}

// Click handler for body canvas
function setupBodyClick() {
  const canvas = $('body-canvas');
  canvas.addEventListener('click', function(e) {
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const px = (e.clientX - rect.left);
    const py = (e.clientY - rect.top);
    const W = canvas.offsetWidth, H = canvas.offsetHeight;

    const muscles = muscleData[currentView];
    for (let m of muscles) {
      const mx = W * m.x, my = H * m.y, mw = W * m.w, mh = H * m.h;
      if (px >= mx && px <= mx + mw && py >= my && py <= my + mh) {
        identifiedMuscles.add(m.name);
        // Also identify paired muscle
        if (m.name.includes('(L)')) identifiedMuscles.add(m.name.replace('(L)', '(R)'));
        if (m.name.includes('(R)')) identifiedMuscles.add(m.name.replace('(R)', '(L)'));

        $('muscle-info').style.display = 'block';
        $('muscle-info-name').textContent = m.name.replace(/ \((L|R)\)/, '');
        $('muscle-info-detail').textContent = m.desc;
        updateIdUI();
        drawBody();
        return;
      }
    }
  });

  canvas.addEventListener('mousemove', function(e) {
    const rect = canvas.getBoundingClientRect();
    const px = e.clientX - rect.left;
    const py = e.clientY - rect.top;
    const W = canvas.offsetWidth, H = canvas.offsetHeight;
    let found = null;
    const muscles = muscleData[currentView];
    for (let m of muscles) {
      const mx = W * m.x, my = H * m.y, mw = W * m.w, mh = H * m.h;
      if (px >= mx && px <= mx + mw && py >= my && py <= my + mh) {
        found = m.name; break;
      }
    }
    if (found !== hoveredMuscle) {
      hoveredMuscle = found;
      canvas.style.cursor = found ? 'pointer' : 'default';
      drawBody();
    }
  });
}

// ══════════════════════════════════════════════════════════════════════════
// PART 2: CONTRACTION MECHANISM
// ══════════════════════════════════════════════════════════════════════════

let zoomLevel = 4;
const zoomLabels = ['Whole Muscle', 'Fascicle', 'Muscle Fiber', 'Myofibril', 'Sarcomere'];
const zoomDescs = [
  'A whole skeletal muscle (e.g., biceps brachii) is composed of hundreds of fascicles wrapped in epimysium connective tissue.',
  'Each fascicle is a bundle of muscle fibers (cells) wrapped in perimysium. A fascicle may contain 10-100 individual fibers.',
  'A single muscle fiber is a multinucleated cell packed with myofibrils. Each fiber is wrapped in endomysium.',
  'Myofibrils are cylindrical organelles that run the length of the fiber, composed of repeating sarcomere units.',
  'The sarcomere is the functional unit of contraction. Thick (myosin) and thin (actin) filaments overlap and slide past each other.',
];

function setZoom(level) {
  zoomLevel = level;
  drawZoomCanvas();
  $('zoom-desc').textContent = zoomDescs[level];
  // Update dots
  const dots = $('zoom-dots');
  dots.innerHTML = '';
  for (let i = 0; i < 5; i++) {
    const d = document.createElement('div');
    d.className = 'zoom-dot' + (i === level ? ' active' : '');
    dots.appendChild(d);
  }
}

function drawZoomCanvas() {
  const ctx = getCtx('zoom-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const cx = W/2, cy = H/2;

  if (zoomLevel === 0) {
    // Whole muscle shape - spindle
    ctx.fillStyle = '#dc2626';
    ctx.beginPath();
    ctx.moveTo(cx - 140, cy);
    ctx.bezierCurveTo(cx - 100, cy - 50, cx - 40, cy - 55, cx, cy - 55);
    ctx.bezierCurveTo(cx + 40, cy - 55, cx + 100, cy - 50, cx + 140, cy);
    ctx.bezierCurveTo(cx + 100, cy + 50, cx + 40, cy + 55, cx, cy + 55);
    ctx.bezierCurveTo(cx - 40, cy + 55, cx - 100, cy + 50, cx - 140, cy);
    ctx.fill();
    // Tendons
    ctx.fillStyle = '#f5f5dc'; ctx.strokeStyle = '#d4a574'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(cx - 140, cy - 8); ctx.lineTo(cx - 200, cy - 4);
    ctx.lineTo(cx - 200, cy + 4); ctx.lineTo(cx - 140, cy + 8);
    ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(cx + 140, cy - 8); ctx.lineTo(cx + 200, cy - 4);
    ctx.lineTo(cx + 200, cy + 4); ctx.lineTo(cx + 140, cy + 8);
    ctx.closePath(); ctx.fill(); ctx.stroke();
    // Labels
    ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Epimysium', cx, cy - 70);
    ctx.fillText('Tendon', cx - 175, cy - 18);
    ctx.fillText('Tendon', cx + 175, cy - 18);
    ctx.fillText('Muscle belly', cx, cy + 80);
    // Fascicle lines
    ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 1;
    for (let i = -3; i <= 3; i++) {
      ctx.beginPath();
      ctx.moveTo(cx - 120, cy + i * 12);
      ctx.lineTo(cx + 120, cy + i * 12);
      ctx.stroke();
    }
  } else if (zoomLevel === 1) {
    // Fascicle - bundle of fibers
    ctx.fillStyle = '#eee'; ctx.strokeStyle = '#999'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.ellipse(cx, cy, 100, 100, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    // Perimysium label
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Perimysium', cx, cy - 115);
    // Individual fibers
    const fiberPositions = [
      [0, 0], [-30, -30], [30, -30], [-30, 30], [30, 30],
      [-55, 0], [55, 0], [0, -55], [0, 55],
      [-40, -60], [40, -60], [-40, 60], [40, 60],
      [-65, -35], [65, -35], [-65, 35], [65, 35],
    ];
    fiberPositions.forEach(([dx, dy]) => {
      if (Math.sqrt(dx*dx + dy*dy) < 90) {
        ctx.fillStyle = '#dc2626'; ctx.strokeStyle = '#b91c1c'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.ellipse(cx + dx, cy + dy, 14, 14, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        // Nuclei dots
        ctx.fillStyle = '#1a1a2e';
        ctx.beginPath(); ctx.arc(cx + dx - 4, cy + dy - 4, 2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(cx + dx + 4, cy + dy + 2, 2, 0, Math.PI*2); ctx.fill();
      }
    });
    ctx.fillStyle = '#374151'; ctx.font = '11px system-ui';
    ctx.fillText('Muscle fibers (cells)', cx, cy + 120);
  } else if (zoomLevel === 2) {
    // Single fiber with myofibrils
    ctx.fillStyle = '#fecaca'; ctx.strokeStyle = '#dc2626'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.roundRect(cx - 160, cy - 60, 320, 120, 12);
    ctx.fill(); ctx.stroke();
    // Myofibrils as stripes
    for (let i = 0; i < 8; i++) {
      const y = cy - 48 + i * 14;
      ctx.fillStyle = i % 2 === 0 ? '#ef4444' : '#f87171';
      ctx.fillRect(cx - 148, y, 296, 10);
      // Striations
      ctx.strokeStyle = 'rgba(0,0,0,0.15)'; ctx.lineWidth = 0.5;
      for (let j = 0; j < 20; j++) {
        const x = cx - 148 + j * 15.5;
        ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x, y + 10); ctx.stroke();
      }
    }
    // Nuclei at edge
    ctx.fillStyle = '#1a1a2e';
    [-35, 15, 55].forEach(dy => {
      ctx.beginPath(); ctx.ellipse(cx - 145, cy + dy, 8, 4, 0, 0, Math.PI*2); ctx.fill();
    });
    // Labels
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Endomysium', cx, cy - 75);
    ctx.fillText('Myofibrils', cx, cy + 85);
    ctx.font = '11px system-ui';
    ctx.fillText('Nuclei (peripheral)', cx - 110, cy + 85);
    ctx.fillText('Striations (sarcomere banding)', cx + 60, cy + 100);
  } else if (zoomLevel === 3) {
    // Myofibril with sarcomere units
    const startX = cx - 180, sarW = 72;
    for (let s = 0; s < 5; s++) {
      const sx = startX + s * sarW;
      // I band (light)
      ctx.fillStyle = '#fde68a'; ctx.fillRect(sx, cy - 40, sarW * 0.25, 80);
      // A band (dark)
      ctx.fillStyle = '#991b1b'; ctx.fillRect(sx + sarW * 0.25, cy - 40, sarW * 0.5, 80);
      // H zone
      ctx.fillStyle = '#b91c1c'; ctx.fillRect(sx + sarW * 0.35, cy - 30, sarW * 0.3, 60);
      // I band (light)
      ctx.fillStyle = '#fde68a'; ctx.fillRect(sx + sarW * 0.75, cy - 40, sarW * 0.25, 80);
      // Z lines
      ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(sx, cy - 45); ctx.lineTo(sx, cy + 45); ctx.stroke();
      // M line
      ctx.strokeStyle = '#374151'; ctx.lineWidth = 1; ctx.setLineDash([3, 3]);
      ctx.beginPath(); ctx.moveTo(sx + sarW/2, cy - 35); ctx.lineTo(sx + sarW/2, cy + 35); ctx.stroke();
      ctx.setLineDash([]);
    }
    // Final Z line
    ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(startX + 5 * sarW, cy - 45); ctx.lineTo(startX + 5 * sarW, cy + 45); ctx.stroke();
    // Labels
    ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Z-line', startX, cy - 55);
    ctx.fillText('I-band', startX + sarW * 0.12, cy + 60);
    ctx.fillText('A-band', startX + sarW * 0.5, cy + 60);
    ctx.fillText('H-zone', startX + sarW * 0.5, cy + 75);
    ctx.fillText('M-line', startX + sarW * 0.5, cy - 55);
    ctx.font = 'bold 13px system-ui';
    ctx.fillText('One Sarcomere', startX + sarW * 0.5, cy - 70);
    // Bracket
    ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(startX, cy - 62); ctx.lineTo(startX, cy - 66);
    ctx.lineTo(startX + sarW, cy - 66); ctx.lineTo(startX + sarW, cy - 62);
    ctx.stroke();
  } else if (zoomLevel === 4) {
    drawSarcomereDetail(ctx, W, H, 0);
  }
}

function drawSarcomereDetail(ctx, W, H, contractPct) {
  const cx = W/2, cy = H/2;
  const sarW = 260 - contractPct * 80;
  const left = cx - sarW/2, right = cx + sarW/2;

  // Background
  ctx.fillStyle = '#fef9ef';
  ctx.fillRect(left - 10, cy - 80, sarW + 20, 160);

  // Z-lines
  ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 3;
  ctx.beginPath(); ctx.moveTo(left, cy - 70); ctx.lineTo(left, cy + 70); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(right, cy - 70); ctx.lineTo(right, cy + 70); ctx.stroke();

  // Thin filaments (actin) from left Z-line
  const actinLen = sarW * 0.42;
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 3;
  for (let i = -2; i <= 2; i++) {
    const y = cy + i * 20;
    ctx.beginPath(); ctx.moveTo(left, y); ctx.lineTo(left + actinLen, y); ctx.stroke();
    // Troponin/tropomyosin dots
    for (let j = 1; j < 6; j++) {
      ctx.fillStyle = '#93c5fd';
      ctx.beginPath(); ctx.arc(left + j * actinLen/6, y, 2.5, 0, Math.PI*2); ctx.fill();
    }
  }
  // Thin filaments from right Z-line
  for (let i = -2; i <= 2; i++) {
    const y = cy + i * 20;
    ctx.beginPath(); ctx.moveTo(right, y); ctx.lineTo(right - actinLen, y); ctx.stroke();
    for (let j = 1; j < 6; j++) {
      ctx.fillStyle = '#93c5fd';
      ctx.beginPath(); ctx.arc(right - j * actinLen/6, y, 2.5, 0, Math.PI*2); ctx.fill();
    }
  }

  // Thick filaments (myosin) centered
  const myosinLen = sarW * 0.45;
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 5;
  for (let i = -2; i <= 2; i++) {
    const y = cy + i * 20;
    ctx.beginPath(); ctx.moveTo(cx - myosinLen/2, y); ctx.lineTo(cx + myosinLen/2, y); ctx.stroke();
    // Cross-bridge heads
    ctx.fillStyle = '#c41e3a';
    for (let j = 0; j < 8; j++) {
      const hx = cx - myosinLen/2 + (j + 0.5) * myosinLen/8;
      const side = j % 2 === 0 ? -1 : 1;
      ctx.beginPath(); ctx.arc(hx, y + side * 7, 3, 0, Math.PI*2); ctx.fill();
    }
  }

  // M-line
  ctx.strokeStyle = '#6b7280'; ctx.lineWidth = 1.5; ctx.setLineDash([4, 3]);
  ctx.beginPath(); ctx.moveTo(cx, cy - 65); ctx.lineTo(cx, cy + 65); ctx.stroke();
  ctx.setLineDash([]);

  // Labels
  ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Z-line', left, cy - 78);
  ctx.fillText('Z-line', right, cy - 78);
  ctx.fillText('M-line', cx, cy - 78);
  ctx.fillStyle = '#2563eb'; ctx.fillText('Actin (thin)', left + actinLen * 0.5, cy + 85);
  ctx.fillStyle = '#c41e3a'; ctx.fillText('Myosin (thick)', cx, cy + 100);

  // Sarcomere length indicator
  ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui';
  const state = contractPct < 0.1 ? 'RELAXED' : contractPct < 0.5 ? 'CONTRACTING' : 'CONTRACTED';
  ctx.fillText(state, cx, cy - 100);
}

// Contraction animation
let contractState = { step: 0, phase: 'rest', atp: 0, playing: false, animId: null, progress: 0 };

const contractPhases = [
  { name: 'Resting State', desc: 'The sarcomere is at resting length. Tropomyosin blocks active binding sites on actin. Ca2+ is sequestered in the sarcoplasmic reticulum (SR).', ca: 'Low', atp: 0 },
  { name: 'Nerve Signal', desc: 'Action potential arrives at the neuromuscular junction. Acetylcholine is released, depolarizing the muscle fiber membrane (sarcolemma).', ca: 'Low', atp: 0 },
  { name: 'Ca2+ Release', desc: 'Depolarization spreads along T-tubules to the SR. Ca2+ ions flood into the sarcoplasm from the SR, binding to troponin.', ca: 'HIGH', atp: 0 },
  { name: 'Binding Sites Exposed', desc: 'Ca2+-troponin complex shifts tropomyosin away from active sites on actin. Myosin heads can now bind to actin.', ca: 'HIGH', atp: 0 },
  { name: 'Cross-Bridge Formed', desc: 'Myosin heads (energized by ATP hydrolysis) bind to exposed active sites on actin, forming cross-bridges.', ca: 'HIGH', atp: 1 },
  { name: 'Power Stroke', desc: 'Myosin heads pivot, pulling actin filaments toward the M-line. ADP and Pi are released. The sarcomere shortens.', ca: 'HIGH', atp: 1 },
  { name: 'Detachment', desc: 'A new ATP molecule binds to myosin, causing it to release from actin. ATP is hydrolyzed, re-energizing the myosin head.', ca: 'HIGH', atp: 2 },
  { name: 'Ca2+ Reuptake', desc: 'When nerve stimulation stops, Ca2+ is pumped back into the SR by ATP-powered Ca2+ pumps. Tropomyosin re-covers binding sites.', ca: 'Low', atp: 3 },
  { name: 'Relaxation', desc: 'Without Ca2+, cross-bridges cannot form. The sarcomere returns to resting length passively. The muscle relaxes.', ca: 'Low', atp: 3 },
];

function toggleContraction() {
  if (contractState.playing) {
    contractState.playing = false;
    if (contractState.animId) cancelAnimationFrame(contractState.animId);
    $('contract-btn-text').textContent = 'Play Contraction';
  } else {
    contractState.playing = true;
    contractState.step = 0;
    contractState.progress = 0;
    $('contract-btn-text').textContent = 'Pause';
    animateContraction();
  }
}

function animateContraction() {
  if (!contractState.playing) return;
  contractState.progress += 0.008;
  if (contractState.progress >= 1) {
    contractState.step++;
    contractState.progress = 0;
    if (contractState.step >= contractPhases.length) {
      contractState.step = contractPhases.length - 1;
      contractState.playing = false;
      $('contract-btn-text').textContent = 'Play Contraction';
      updateContractionUI();
      return;
    }
  }
  updateContractionUI();
  contractState.animId = requestAnimationFrame(animateContraction);
}

function stepContraction() {
  contractState.playing = false;
  if (contractState.animId) cancelAnimationFrame(contractState.animId);
  $('contract-btn-text').textContent = 'Play Contraction';
  contractState.step = Math.min(contractState.step + 1, contractPhases.length - 1);
  contractState.progress = 0;
  updateContractionUI();
}

function resetContraction() {
  contractState.playing = false;
  if (contractState.animId) cancelAnimationFrame(contractState.animId);
  $('contract-btn-text').textContent = 'Play Contraction';
  contractState = { step: 0, phase: 'rest', atp: 0, playing: false, animId: null, progress: 0 };
  updateContractionUI();
}

function updateContractionUI() {
  const phase = contractPhases[contractState.step];
  $('contract-step').textContent = contractState.step;
  $('contract-phase').textContent = phase.name.split(' ')[0];
  $('contract-atp').textContent = phase.atp;
  $('contract-ca').textContent = phase.ca;
  $('contract-info').innerHTML = `<div class="ar-title">${phase.name} (Step ${contractState.step}/${contractPhases.length - 1})</div><p>${phase.desc}</p>`;

  // Draw sarcomere at appropriate contraction level
  const ctx = getCtx('sarcomere-canvas');
  ctx.clearRect(0, 0, ctx.W, ctx.H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, ctx.W, ctx.H);
  let contractPct = 0;
  if (contractState.step >= 5 && contractState.step <= 6) contractPct = 0.6 + contractState.progress * 0.2;
  else if (contractState.step === 4) contractPct = 0.3 + contractState.progress * 0.3;
  else if (contractState.step === 3) contractPct = contractState.progress * 0.3;
  else if (contractState.step >= 7) contractPct = Math.max(0, 0.8 - (contractState.step - 7 + contractState.progress) * 0.8);
  drawSarcomereDetail(ctx, ctx.W, ctx.H, contractPct);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 3: FIBER TYPES
// ══════════════════════════════════════════════════════════════════════════

const fiberTypes = {
  speed:     { label: 'Contraction Speed', values: [1, 5, 10],   unit: 'relative' },
  fatigue:   { label: 'Fatigue Resistance', values: [10, 7, 2],  unit: 'relative' },
  mito:      { label: 'Mitochondria Density', values: [10, 8, 3], unit: 'relative' },
  myoglobin: { label: 'Myoglobin Content', values: [10, 6, 1],   unit: 'relative' },
};

let currentFiberChart = 'all';

function setFiberChart(prop) {
  currentFiberChart = prop;
  drawFiberChart();
}

function drawFiberChart() {
  const ctx = getCtx('fiber-chart');
  const fiberColors = ['#dc2626', '#ea580c', '#d4b896'];
  const fiberLabels = ['Type I', 'Type IIa', 'Type IIx'];

  if (currentFiberChart === 'all') {
    // Grouped bar chart
    const W = ctx.W, H = ctx.H;
    const pad = { top: 30, right: 20, bottom: 50, left: 50 };
    const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
    ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

    const props = Object.keys(fiberTypes);
    const nGroups = props.length, nBars = 3;
    const groupW = plotW / nGroups;
    const barW = groupW * 0.22;
    const maxVal = 12;

    // Grid
    ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
      const y = pad.top + plotH * (1 - i/4);
      ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
      ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
      ctx.fillText((maxVal * i/4).toFixed(0), pad.left - 6, y + 4);
    }

    props.forEach((prop, gi) => {
      const ft = fiberTypes[prop];
      ft.values.forEach((v, bi) => {
        const x = pad.left + gi * groupW + (bi + 0.5) * barW + groupW * 0.12;
        const h = (v / maxVal) * plotH;
        ctx.fillStyle = fiberColors[bi];
        ctx.fillRect(x, pad.top + plotH - h, barW - 2, h);
        if (v > 0) {
          ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
          ctx.fillText(v, x + (barW - 2)/2, pad.top + plotH - h - 4);
        }
      });
      ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
      ctx.fillText(ft.label.split(' ')[0], pad.left + gi * groupW + groupW/2, H - pad.bottom + 14);
      ctx.font = '10px system-ui';
      ctx.fillText(ft.label.split(' ').slice(1).join(' '), pad.left + gi * groupW + groupW/2, H - pad.bottom + 28);
    });

    // Legend
    fiberLabels.forEach((label, i) => {
      const lx = pad.left + i * 100;
      ctx.fillStyle = fiberColors[i]; ctx.fillRect(lx, 8, 12, 12);
      ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
      ctx.fillText(label, lx + 16, 18);
    });
  } else {
    const ft = fiberTypes[currentFiberChart];
    drawBarChart(ctx, {
      labels: fiberLabels,
      values: ft.values,
      colors: fiberColors,
      maxVal: 12
    });
  }
}

function drawFiberCross() {
  const ctx = getCtx('fiber-cross-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Draw cross-section of muscle bundle with mixed fiber types
  const cx = W/2, cy = H/2;
  ctx.fillStyle = '#f1f5f9'; ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.ellipse(cx, cy, 90, 85, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();

  const fibers = [];
  // Generate random fiber positions
  for (let i = 0; i < 45; i++) {
    const angle = Math.random() * Math.PI * 2;
    const dist = Math.random() * 70;
    const fx = cx + Math.cos(angle) * dist;
    const fy = cy + Math.sin(angle) * dist;
    // Check overlap
    let ok = true;
    for (let f of fibers) {
      if (Math.sqrt((f.x - fx)**2 + (f.y - fy)**2) < 15) { ok = false; break; }
    }
    if (ok && Math.sqrt((fx - cx)**2 + (fy - cy)**2) < 78) {
      const r = Math.random();
      let type = r < 0.45 ? 0 : r < 0.75 ? 1 : 2;
      fibers.push({ x: fx, y: fy, type });
    }
  }

  const fColors = ['#dc2626', '#ea580c', '#f5e6c8'];
  const fStrokes = ['#b91c1c', '#c2410c', '#d4a574'];
  fibers.forEach(f => {
    ctx.fillStyle = fColors[f.type]; ctx.strokeStyle = fStrokes[f.type]; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.arc(f.x, f.y, 7, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    // Myofibril dots
    ctx.fillStyle = 'rgba(0,0,0,0.15)';
    for (let d = 0; d < 3; d++) {
      ctx.beginPath(); ctx.arc(f.x + (d-1)*3, f.y, 1, 0, Math.PI*2); ctx.fill();
    }
  });

  // Labels
  ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Cross-Section of Mixed Fiber Bundle', cx, H - 10);
}

function drawFiberDistChart() {
  const ctx = getCtx('fiber-dist-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 30, right: 20, bottom: 40, left: 90 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const muscles = [
    { name: 'Soleus', t1: 80, t2a: 15, t2x: 5 },
    { name: 'Vastus Lat.', t1: 45, t2a: 30, t2x: 25 },
    { name: 'Biceps', t1: 42, t2a: 38, t2x: 20 },
    { name: 'Gastrocnemius', t1: 50, t2a: 25, t2x: 25 },
    { name: 'Triceps', t1: 33, t2a: 35, t2x: 32 },
    { name: 'Orbicularis Oc.', t1: 15, t2a: 25, t2x: 60 },
  ];

  const barH = plotH / muscles.length * 0.7;
  const gap = plotH / muscles.length * 0.3;

  // Legend
  ctx.fillStyle = '#dc2626'; ctx.fillRect(pad.left, 6, 12, 12);
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Type I', pad.left + 16, 16);
  ctx.fillStyle = '#ea580c'; ctx.fillRect(pad.left + 70, 6, 12, 12);
  ctx.fillText('Type IIa', pad.left + 86, 16);
  ctx.fillStyle = '#d4b896'; ctx.fillRect(pad.left + 150, 6, 12, 12);
  ctx.fillText('Type IIx', pad.left + 166, 16);

  muscles.forEach((m, i) => {
    const y = pad.top + i * (barH + gap);
    const t1W = (m.t1 / 100) * plotW;
    const t2aW = (m.t2a / 100) * plotW;
    const t2xW = (m.t2x / 100) * plotW;

    ctx.fillStyle = '#dc2626'; ctx.fillRect(pad.left, y, t1W, barH);
    ctx.fillStyle = '#ea580c'; ctx.fillRect(pad.left + t1W, y, t2aW, barH);
    ctx.fillStyle = '#d4b896'; ctx.fillRect(pad.left + t1W + t2aW, y, t2xW, barH);

    ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText(m.name, pad.left - 6, y + barH/2 + 4);

    // Percentage labels
    ctx.font = '10px system-ui'; ctx.textAlign = 'center'; ctx.fillStyle = '#fff';
    if (t1W > 30) ctx.fillText(m.t1 + '%', pad.left + t1W/2, y + barH/2 + 4);
    if (t2aW > 30) ctx.fillText(m.t2a + '%', pad.left + t1W + t2aW/2, y + barH/2 + 4);
    if (t2xW > 30) ctx.fillText(m.t2x + '%', pad.left + t1W + t2aW + t2xW/2, y + barH/2 + 4);
  });
}

// ══════════════════════════════════════════════════════════════════════════
// PART 4: FATIGUE & RECOVERY
// ══════════════════════════════════════════════════════════════════════════

let gripState = {
  active: false,
  timeLeft: 30,
  clicks: 0,
  forceHistory: [],
  currentForce: 0,
  peakForce: 0,
  trialNum: 0,
  trialPeaks: [],
  lactate: 0,
  lactateHistory: [],
  fatigueFactor: 1.0,
  lastClickTime: 0,
  intervalId: null,
  resting: false,
  restTime: 0,
};

function startGripTrial() {
  if (gripState.active || gripState.resting) return;
  gripState.active = true;
  gripState.timeLeft = 30;
  gripState.clicks = 0;
  gripState.forceHistory = [];
  gripState.currentForce = 0;
  gripState.peakForce = 0;
  gripState.trialNum++;
  gripState.fatigueFactor = Math.max(0.3, 1.0 - gripState.trialNum * 0.08 + gripState.lactate * -0.02);
  gripState.lastClickTime = Date.now();

  $('grip-btn').style.borderColor = '#16a34a';
  $('grip-btn').textContent = 'SQUEEZE!';

  gripState.intervalId = setInterval(() => {
    gripState.timeLeft--;
    // Decay force
    gripState.currentForce = Math.max(0, gripState.currentForce * 0.85);
    // Increase lactate during effort
    if (gripState.currentForce > 0) gripState.lactate = Math.min(20, gripState.lactate + 0.15);
    // Record
    gripState.forceHistory.push(gripState.currentForce);

    updateGripUI();

    if (gripState.timeLeft <= 0) {
      endGripTrial();
    }
  }, 1000);

  updateGripUI();
}

function gripSqueeze() {
  if (!gripState.active) return;
  const now = Date.now();
  const dt = now - gripState.lastClickTime;
  gripState.lastClickTime = now;

  gripState.clicks++;
  // Force depends on click speed and fatigue
  const clickRate = Math.min(1, 200 / Math.max(dt, 50)); // faster = more force
  const fatigue = Math.max(0.1, gripState.fatigueFactor - gripState.clicks * 0.003 - gripState.lactate * 0.02);
  const force = clickRate * fatigue * 100;
  gripState.currentForce = Math.min(100, gripState.currentForce + force * 0.4);
  gripState.peakForce = Math.max(gripState.peakForce, gripState.currentForce);
  gripState.lactate = Math.min(20, gripState.lactate + 0.05);

  updateGripUI();
}

function endGripTrial() {
  gripState.active = false;
  clearInterval(gripState.intervalId);
  gripState.trialPeaks.push(gripState.peakForce);
  $('grip-btn').style.borderColor = 'var(--accent)';
  $('grip-btn').textContent = 'SQUEEZE';
  gripState.lactateHistory.push(gripState.lactate);
  drawTrialsChart();
  drawLactateChart();
  updateGripUI();
}

function startRestPeriod() {
  if (gripState.active || gripState.resting) return;
  gripState.resting = true;
  gripState.restTime = 15;
  $('grip-btn').textContent = 'RESTING...';
  $('grip-btn').style.borderColor = '#2563eb';

  const restId = setInterval(() => {
    gripState.restTime--;
    gripState.lactate = Math.max(0, gripState.lactate - 0.8);
    gripState.fatigueFactor = Math.min(1.0, gripState.fatigueFactor + 0.04);
    $('grip-time').textContent = gripState.restTime + 's';

    if (gripState.restTime <= 0) {
      clearInterval(restId);
      gripState.resting = false;
      $('grip-btn').textContent = 'SQUEEZE';
      $('grip-btn').style.borderColor = 'var(--accent)';
      $('grip-time').textContent = '30s';
      drawLactateChart();
    }
  }, 1000);
}

function resetGrip() {
  gripState.active = false;
  gripState.resting = false;
  clearInterval(gripState.intervalId);
  gripState = {
    active: false, timeLeft: 30, clicks: 0, forceHistory: [], currentForce: 0,
    peakForce: 0, trialNum: 0, trialPeaks: [], lactate: 0, lactateHistory: [],
    fatigueFactor: 1.0, lastClickTime: 0, intervalId: null, resting: false, restTime: 0,
  };
  $('grip-btn').textContent = 'SQUEEZE';
  $('grip-btn').style.borderColor = 'var(--accent)';
  updateGripUI();
  drawFatigueChart();
  drawTrialsChart();
  drawLactateChart();
}

function updateGripUI() {
  $('grip-force').textContent = gripState.currentForce.toFixed(0);
  $('grip-peak').textContent = gripState.peakForce.toFixed(0);
  $('grip-clicks').textContent = gripState.clicks;
  $('grip-time').textContent = gripState.timeLeft + 's';
  $('grip-trial').textContent = gripState.trialNum;
  drawFatigueChart();
}

function drawFatigueChart() {
  if (!gripState.forceHistory.length) {
    const ctx = getCtx('fatigue-chart');
    ctx.clearRect(0, 0, ctx.W, ctx.H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, ctx.W, ctx.H);
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Start a trial and squeeze to see force output', ctx.W/2, ctx.H/2);
    return;
  }
  const ctx = getCtx('fatigue-chart');
  drawLineChart(ctx, [
    { data: gripState.forceHistory, color: '#c41e3a', width: 2.5, dots: gripState.forceHistory.length < 40 }
  ], { yMin: 0, yMax: 100 });
}

function drawTrialsChart() {
  const ctx = getCtx('trials-chart');
  if (!gripState.trialPeaks.length) {
    ctx.clearRect(0, 0, ctx.W, ctx.H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, ctx.W, ctx.H);
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Complete trials to see peak force comparison', ctx.W/2, ctx.H/2);
    return;
  }
  drawBarChart(ctx, {
    labels: gripState.trialPeaks.map((_, i) => 'T' + (i + 1)),
    values: gripState.trialPeaks,
    colors: gripState.trialPeaks.map((v, i) => i === 0 ? '#16a34a' : v < gripState.trialPeaks[0] * 0.7 ? '#c41e3a' : '#d97706'),
    maxVal: 110,
  });
}

function drawLactateChart() {
  const ctx = getCtx('lactate-chart');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const pad = { top: 20, right: 30, bottom: 30, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;

  // Current lactate as gauge
  const maxLactate = 20;
  const pct = gripState.lactate / maxLactate;
  const gaugeW = plotW * 0.6;
  const gaugeH = 24;
  const gx = pad.left + (plotW - gaugeW) / 2;
  const gy = pad.top + plotH / 2 - gaugeH / 2;

  // Background
  const grad = ctx.createLinearGradient(gx, 0, gx + gaugeW, 0);
  grad.addColorStop(0, '#16a34a'); grad.addColorStop(0.4, '#d97706'); grad.addColorStop(0.8, '#c41e3a');
  ctx.fillStyle = '#e5e7eb';
  ctx.beginPath(); ctx.roundRect(gx, gy, gaugeW, gaugeH, 8); ctx.fill();
  ctx.fillStyle = grad;
  ctx.beginPath(); ctx.roundRect(gx, gy, gaugeW * pct, gaugeH, 8); ctx.fill();

  ctx.fillStyle = '#374151'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Lactic Acid: ' + gripState.lactate.toFixed(1) + ' mmol/L', W/2, gy - 12);

  // Zone labels
  ctx.font = '11px system-ui';
  ctx.fillStyle = '#16a34a'; ctx.fillText('Normal', gx + gaugeW * 0.15, gy + gaugeH + 18);
  ctx.fillStyle = '#d97706'; ctx.fillText('Threshold', gx + gaugeW * 0.5, gy + gaugeH + 18);
  ctx.fillStyle = '#c41e3a'; ctx.fillText('Fatigue Zone', gx + gaugeW * 0.85, gy + gaugeH + 18);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 5: MUSCLE ACTION SIMULATOR
// ══════════════════════════════════════════════════════════════════════════

const jointActions = {
  'elbow-flexion': {
    title: 'Elbow Flexion',
    agonist: 'Biceps Brachii', antagonist: 'Triceps Brachii', synergist: 'Brachialis',
    lever: '3rd Class',
    desc: 'The biceps brachii contracts to flex the elbow (bend the arm). The triceps relaxes as antagonist. The brachialis assists as synergist. This is a 3rd class lever: effort (muscle insertion) is between the fulcrum (elbow joint) and the load (forearm/hand).',
    origin: 'Scapula (coracoid process, supraglenoid tubercle)',
    insertion: 'Radial tuberosity',
  },
  'elbow-extension': {
    title: 'Elbow Extension',
    agonist: 'Triceps Brachii', antagonist: 'Biceps Brachii', synergist: 'Anconeus',
    lever: '1st Class',
    desc: 'The triceps brachii contracts to extend the elbow (straighten the arm). The biceps relaxes. The anconeus assists. This acts as a 1st class lever at the olecranon.',
    origin: 'Scapula (infraglenoid tubercle) and posterior humerus',
    insertion: 'Olecranon process of ulna',
  },
  'knee-extension': {
    title: 'Knee Extension',
    agonist: 'Quadriceps', antagonist: 'Hamstrings', synergist: 'Tensor Fasciae Latae',
    lever: '3rd Class',
    desc: 'The quadriceps group contracts to extend the knee (straighten the leg). The hamstrings relax as antagonist. 3rd class lever with effort between fulcrum (knee joint) and load (lower leg).',
    origin: 'Anterior inferior iliac spine and femur',
    insertion: 'Tibial tuberosity (via patellar ligament)',
  },
  'knee-flexion': {
    title: 'Knee Flexion',
    agonist: 'Hamstrings', antagonist: 'Quadriceps', synergist: 'Gastrocnemius',
    lever: '3rd Class',
    desc: 'The hamstrings contract to flex the knee (bend the leg). The quadriceps relax. The gastrocnemius assists at the knee. 3rd class lever system.',
    origin: 'Ischial tuberosity',
    insertion: 'Tibia and fibula (medial and lateral)',
  },
  'shoulder-abduction': {
    title: 'Shoulder Abduction',
    agonist: 'Deltoid', antagonist: 'Pectoralis Major', synergist: 'Supraspinatus',
    lever: '3rd Class',
    desc: 'The deltoid contracts to abduct the arm (raise it sideways). The pectoralis major acts as antagonist (adduction). The supraspinatus assists in initiating abduction. 3rd class lever.',
    origin: 'Clavicle, acromion, and spine of scapula',
    insertion: 'Deltoid tuberosity of humerus',
  },
  'hip-extension': {
    title: 'Hip Extension',
    agonist: 'Gluteus Maximus', antagonist: 'Iliopsoas', synergist: 'Hamstrings',
    lever: '3rd Class',
    desc: 'The gluteus maximus contracts to extend the hip (move thigh backward). The iliopsoas relaxes as antagonist. Hamstrings assist as synergists. 3rd class lever system.',
    origin: 'Ilium, sacrum, and coccyx',
    insertion: 'Gluteal tuberosity of femur and iliotibial tract',
  },
};

let jointAnimState = { playing: false, progress: 0, animId: null };

function selectJoint() {
  const key = $('joint-select').value;
  const action = jointActions[key];
  $('joint-agonist').textContent = action.agonist.split(' ')[0];
  $('joint-antagonist').textContent = action.antagonist.split(' ')[0];
  $('joint-synergist').textContent = action.synergist.split(' ')[0];
  $('joint-lever').textContent = action.lever;
  $('joint-info').innerHTML = `
    <div class="ar-title">${action.title}</div>
    <p>${action.desc}</p>
    <p style="margin-top:8px;"><strong>Origin:</strong> ${action.origin}<br><strong>Insertion:</strong> ${action.insertion}</p>
  `;
  jointAnimState.progress = 0;
  drawJointCanvas();
}

function playJointAction() {
  if (jointAnimState.playing) {
    jointAnimState.playing = false;
    if (jointAnimState.animId) cancelAnimationFrame(jointAnimState.animId);
    $('joint-btn-text').textContent = 'Play Movement';
    return;
  }
  jointAnimState.playing = true;
  jointAnimState.progress = 0;
  $('joint-btn-text').textContent = 'Stop';
  animateJoint();
}

function resetJointAction() {
  jointAnimState.playing = false;
  if (jointAnimState.animId) cancelAnimationFrame(jointAnimState.animId);
  $('joint-btn-text').textContent = 'Play Movement';
  jointAnimState.progress = 0;
  drawJointCanvas();
}

function animateJoint() {
  if (!jointAnimState.playing) return;
  jointAnimState.progress += 0.015;
  if (jointAnimState.progress > 2) jointAnimState.progress = 0;
  drawJointCanvas();
  jointAnimState.animId = requestAnimationFrame(animateJoint);
}

function drawJointCanvas() {
  const ctx = getCtx('joint-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const key = $('joint-select').value;
  const action = jointActions[key];
  const p = jointAnimState.progress;
  // Animation oscillates: 0->1 is flexion, 1->2 is return
  const t = p <= 1 ? p : 2 - p;
  const cx = W/2, cy = H/2;

  if (key.startsWith('elbow')) {
    const isFlexion = key === 'elbow-flexion';
    const angle = isFlexion ? lerp(Math.PI * 0.05, Math.PI * 0.55, t) : lerp(Math.PI * 0.55, Math.PI * 0.05, t);

    // Upper arm (fixed)
    const shoulderX = cx - 40, shoulderY = cy - 100;
    const elbowX = shoulderX, elbowY = shoulderY + 130;

    ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 22; ctx.lineCap = 'round';
    ctx.beginPath(); ctx.moveTo(shoulderX, shoulderY); ctx.lineTo(elbowX, elbowY); ctx.stroke();

    // Forearm (rotates)
    const forearmLen = 120;
    const handX = elbowX + Math.cos(-angle + Math.PI/2) * forearmLen;
    const handY = elbowY - Math.sin(-angle + Math.PI/2) * forearmLen;

    ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 18;
    ctx.beginPath(); ctx.moveTo(elbowX, elbowY); ctx.lineTo(handX, handY); ctx.stroke();

    // Agonist muscle (thickens when contracting)
    const agonistThick = lerp(8, 18, t);
    const agonistMidX = shoulderX + 20;
    const agonistMidY = (shoulderY + elbowY) / 2;
    ctx.fillStyle = 'rgba(196,30,58,0.6)'; ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.ellipse(agonistMidX, agonistMidY, agonistThick, 55, 0, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();

    // Antagonist muscle (thins when agonist contracts)
    const antagThick = lerp(14, 6, t);
    const antagMidX = shoulderX - 18;
    ctx.fillStyle = 'rgba(37,99,235,0.4)'; ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.ellipse(antagMidX, agonistMidY, antagThick, 50, 0, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();

    // Joint circle
    ctx.fillStyle = '#f59e0b'; ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(elbowX, elbowY, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Shoulder joint
    ctx.beginPath(); ctx.arc(shoulderX, shoulderY, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Origin/Insertion markers
    ctx.fillStyle = '#16a34a'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'left';
    ctx.beginPath(); ctx.arc(agonistMidX + 5, shoulderY + 20, 5, 0, Math.PI*2); ctx.fill();
    ctx.fillText('Origin', agonistMidX + 14, shoulderY + 24);

    ctx.fillStyle = '#7c3aed';
    ctx.beginPath(); ctx.arc(elbowX + 18, elbowY + 15, 5, 0, Math.PI*2); ctx.fill();
    ctx.fillText('Insertion', elbowX + 26, elbowY + 19);

    // Labels
    ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
    ctx.fillStyle = '#c41e3a'; ctx.fillText(action.agonist + ' (Agonist)', agonistMidX + 80, agonistMidY - 10);
    ctx.fillStyle = '#2563eb'; ctx.fillText(action.antagonist + ' (Antagonist)', antagMidX - 80, agonistMidY + 10);
    ctx.fillStyle = '#d97706'; ctx.fillText('Fulcrum (Elbow)', elbowX, elbowY + 30);

    // Load
    ctx.fillStyle = '#374151'; ctx.font = '12px system-ui';
    ctx.fillText('Load', handX + 10, handY);

    // Lever class label
    ctx.fillStyle = '#7c3aed'; ctx.font = 'bold 14px system-ui';
    ctx.fillText(action.lever + ' Lever', cx + 100, cy - 120);

  } else if (key.startsWith('knee')) {
    const isExtension = key === 'knee-extension';
    const angle = isExtension ? lerp(Math.PI * 0.6, Math.PI * 0.05, t) : lerp(Math.PI * 0.05, Math.PI * 0.6, t);

    const hipX = cx, hipY = cy - 110;
    const kneeX = hipX, kneeY = hipY + 140;
    const footLen = 130;
    const footX = kneeX + Math.cos(-angle + Math.PI/2) * footLen;
    const footY = kneeY - Math.sin(-angle + Math.PI/2) * footLen;

    // Thigh
    ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 26; ctx.lineCap = 'round';
    ctx.beginPath(); ctx.moveTo(hipX, hipY); ctx.lineTo(kneeX, kneeY); ctx.stroke();

    // Lower leg
    ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 20;
    ctx.beginPath(); ctx.moveTo(kneeX, kneeY); ctx.lineTo(footX, footY); ctx.stroke();

    // Quadriceps (anterior thigh)
    const quadThick = isExtension ? lerp(10, 20, t) : lerp(20, 10, t);
    ctx.fillStyle = 'rgba(196,30,58,0.5)'; ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.ellipse(hipX + 22, (hipY + kneeY)/2, quadThick, 60, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Hamstrings (posterior thigh)
    const hamThick = isExtension ? lerp(16, 8, t) : lerp(8, 16, t);
    ctx.fillStyle = 'rgba(37,99,235,0.4)'; ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.ellipse(hipX - 20, (hipY + kneeY)/2, hamThick, 55, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Joints
    ctx.fillStyle = '#f59e0b'; ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(kneeX, kneeY, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(hipX, hipY, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Labels
    ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
    ctx.fillStyle = '#c41e3a'; ctx.fillText(action.agonist + ' (Agonist)', hipX + 100, (hipY + kneeY)/2);
    ctx.fillStyle = '#2563eb'; ctx.fillText(action.antagonist + ' (Antag.)', hipX - 100, (hipY + kneeY)/2);
    ctx.fillStyle = '#d97706'; ctx.fillText('Fulcrum (Knee)', kneeX + 60, kneeY + 5);
    ctx.fillStyle = '#7c3aed'; ctx.font = 'bold 14px system-ui';
    ctx.fillText(action.lever + ' Lever', cx + 120, cy - 120);

  } else if (key === 'shoulder-abduction') {
    const angle = lerp(0, Math.PI * 0.45, t);

    const shoulderX = cx, shoulderY = cy - 40;
    const armLen = 150;
    const handX = shoulderX + Math.cos(Math.PI/2 - angle) * armLen;
    const handY = shoulderY + Math.sin(Math.PI/2 - angle) * armLen;

    // Torso
    ctx.fillStyle = '#e5e7eb'; ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 2;
    ctx.fillRect(cx - 50, cy - 80, 100, 160);
    ctx.strokeRect(cx - 50, cy - 80, 100, 160);

    // Arm
    ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 18; ctx.lineCap = 'round';
    ctx.beginPath(); ctx.moveTo(shoulderX + 50, shoulderY + 20); ctx.lineTo(handX + 50, handY + 20); ctx.stroke();

    // Deltoid
    const deltThick = lerp(10, 22, t);
    ctx.fillStyle = 'rgba(196,30,58,0.5)'; ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.ellipse(shoulderX + 55, shoulderY + 10, deltThick, 30, -angle/2, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();

    // Pec (antagonist)
    const pecThick = lerp(18, 8, t);
    ctx.fillStyle = 'rgba(37,99,235,0.4)'; ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.ellipse(shoulderX + 20, shoulderY + 30, pecThick, 35, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Joint
    ctx.fillStyle = '#f59e0b'; ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(shoulderX + 50, shoulderY + 20, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Labels
    ctx.font = 'bold 13px system-ui';
    ctx.fillStyle = '#c41e3a'; ctx.textAlign = 'left';
    ctx.fillText('Deltoid (Agonist)', shoulderX + 85, shoulderY);
    ctx.fillStyle = '#2563eb';
    ctx.fillText('Pec. Major (Antag.)', shoulderX - 90, shoulderY + 50);
    ctx.fillStyle = '#7c3aed'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(action.lever + ' Lever', cx, cy + 120);

  } else if (key === 'hip-extension') {
    const angle = lerp(0, Math.PI * 0.35, t);

    const hipX = cx, hipY = cy - 20;
    const legLen = 160;
    const footX = hipX - Math.sin(angle) * legLen;
    const footY = hipY + Math.cos(angle) * legLen;

    // Pelvis
    ctx.fillStyle = '#e5e7eb'; ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.ellipse(hipX, hipY - 30, 60, 40, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Leg
    ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 22; ctx.lineCap = 'round';
    ctx.beginPath(); ctx.moveTo(hipX, hipY); ctx.lineTo(footX, footY); ctx.stroke();

    // Glute (agonist)
    const gluteThick = lerp(12, 24, t);
    ctx.fillStyle = 'rgba(196,30,58,0.5)'; ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.ellipse(hipX - 30, hipY - 10, gluteThick, 35, 0.3, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Iliopsoas (antagonist)
    const ilioThick = lerp(14, 6, t);
    ctx.fillStyle = 'rgba(37,99,235,0.4)'; ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.ellipse(hipX + 25, hipY + 10, ilioThick, 30, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Hip joint
    ctx.fillStyle = '#f59e0b'; ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(hipX, hipY, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    // Labels
    ctx.font = 'bold 13px system-ui';
    ctx.fillStyle = '#c41e3a'; ctx.textAlign = 'right';
    ctx.fillText('Glut. Max. (Agonist)', hipX - 60, hipY - 10);
    ctx.fillStyle = '#2563eb'; ctx.textAlign = 'left';
    ctx.fillText('Iliopsoas (Antag.)', hipX + 50, hipY + 20);
    ctx.fillStyle = '#7c3aed'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(action.lever + ' Lever', cx + 120, cy - 100);
  }
}

// ══════════════════════════════════════════════════════════════════════════
// PART 6: EXERCISE PHYSIOLOGY
// ══════════════════════════════════════════════════════════════════════════

const exerciseData = {
  sprint: {
    name: 'Sprinting', energy: 'ATP-CP', duration: '10-30s', fiber: 'Type IIx',
    vo2: 'Very High',
    muscles: ['Quadriceps', 'Hamstrings', 'Gluteus Maximus', 'Gastrocnemius', 'Hip Flexors'],
    fiberRecruitment: [20, 30, 50], // Type I, IIa, IIx
    energySystems: [60, 35, 5], // ATP-CP, Glycolytic, Oxidative
    adaptation: {
      strength: [100, 108, 115, 120, 125, 130, 134, 137, 139, 141, 143, 144, 145],
      endurance: [100, 102, 104, 106, 108, 110, 111, 112, 113, 114, 115, 115, 116],
      mass: [100, 101, 103, 105, 107, 109, 111, 112, 113, 114, 115, 116, 117],
    }
  },
  marathon: {
    name: 'Marathon', energy: 'Oxidative', duration: '2-5 hrs', fiber: 'Type I',
    vo2: 'Moderate',
    muscles: ['Quadriceps', 'Hamstrings', 'Gastrocnemius', 'Soleus', 'Hip Flexors', 'Core'],
    fiberRecruitment: [70, 25, 5],
    energySystems: [2, 8, 90],
    adaptation: {
      strength: [100, 102, 103, 104, 105, 106, 107, 107, 108, 108, 109, 109, 110],
      endurance: [100, 108, 116, 123, 129, 134, 138, 142, 145, 148, 150, 152, 155],
      mass: [100, 100, 99, 99, 98, 98, 98, 97, 97, 97, 97, 97, 97],
    }
  },
  weightlift: {
    name: 'Weightlifting', energy: 'ATP-CP', duration: '1-10s', fiber: 'Type IIa/IIx',
    vo2: 'Low',
    muscles: ['Pectoralis Major', 'Deltoid', 'Quadriceps', 'Latissimus Dorsi', 'Biceps', 'Triceps'],
    fiberRecruitment: [15, 40, 45],
    energySystems: [80, 18, 2],
    adaptation: {
      strength: [100, 112, 122, 130, 137, 143, 148, 152, 155, 158, 160, 162, 164],
      endurance: [100, 101, 102, 103, 104, 105, 106, 107, 108, 108, 109, 109, 110],
      mass: [100, 103, 106, 109, 112, 114, 116, 118, 120, 121, 122, 123, 124],
    }
  },
};

let currentExercise = null;

function selectExercise(type) {
  currentExercise = type;
  const ex = exerciseData[type];
  $('ex-type').textContent = ex.name;
  $('ex-energy').textContent = ex.energy;
  $('ex-duration').textContent = ex.duration;
  $('ex-fiber').textContent = ex.fiber;
  $('ex-vo2').textContent = ex.vo2;
  drawExBody();
  drawExFiberChart();
  drawExEnergyChart();
  drawAdaptationChart();
}

function drawExBody() {
  const ctx = getCtx('ex-body-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  if (!currentExercise) {
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Select an exercise to see primary muscles', W/2, H/2);
    return;
  }

  const ex = exerciseData[currentExercise];
  const cx = W/2, headY = H * 0.04;

  // Draw simplified body
  ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 1.5; ctx.fillStyle = '#f1f5f9';
  // Head
  ctx.beginPath(); ctx.ellipse(cx, headY + 18, 16, 20, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  // Torso
  ctx.beginPath();
  ctx.moveTo(cx - 45, H * 0.12); ctx.lineTo(cx - 40, H * 0.42);
  ctx.lineTo(cx - 22, H * 0.46); ctx.lineTo(cx + 22, H * 0.46);
  ctx.lineTo(cx + 40, H * 0.42); ctx.lineTo(cx + 45, H * 0.12);
  ctx.closePath(); ctx.fill(); ctx.stroke();
  // Arms
  [-1, 1].forEach(side => {
    ctx.beginPath();
    ctx.moveTo(cx + side * 45, H * 0.13);
    ctx.lineTo(cx + side * 62, H * 0.24);
    ctx.lineTo(cx + side * 58, H * 0.36);
    ctx.lineTo(cx + side * 50, H * 0.36);
    ctx.lineTo(cx + side * 52, H * 0.24);
    ctx.lineTo(cx + side * 38, H * 0.14);
    ctx.closePath(); ctx.fill(); ctx.stroke();
  });
  // Legs
  [-1, 1].forEach(side => {
    ctx.beginPath();
    ctx.moveTo(cx + side * 20, H * 0.46);
    ctx.lineTo(cx + side * 28, H * 0.64);
    ctx.lineTo(cx + side * 24, H * 0.82);
    ctx.lineTo(cx + side * 14, H * 0.82);
    ctx.lineTo(cx + side * 14, H * 0.64);
    ctx.lineTo(cx + side * 8, H * 0.46);
    ctx.closePath(); ctx.fill(); ctx.stroke();
  });

  // Highlight active muscles
  const highlights = {
    'Quadriceps': [{ x: 0.44, y: 0.50, w: 0.12, h: 0.14 }],
    'Hamstrings': [{ x: 0.44, y: 0.50, w: 0.12, h: 0.14 }],
    'Gluteus Maximus': [{ x: 0.42, y: 0.40, w: 0.16, h: 0.08 }],
    'Gastrocnemius': [{ x: 0.44, y: 0.66, w: 0.12, h: 0.10 }],
    'Soleus': [{ x: 0.44, y: 0.72, w: 0.12, h: 0.08 }],
    'Hip Flexors': [{ x: 0.42, y: 0.42, w: 0.16, h: 0.06 }],
    'Core': [{ x: 0.40, y: 0.28, w: 0.20, h: 0.12 }],
    'Pectoralis Major': [{ x: 0.38, y: 0.16, w: 0.24, h: 0.10 }],
    'Deltoid': [{ x: 0.30, y: 0.12, w: 0.08, h: 0.06 }, { x: 0.62, y: 0.12, w: 0.08, h: 0.06 }],
    'Latissimus Dorsi': [{ x: 0.36, y: 0.22, w: 0.28, h: 0.12 }],
    'Biceps': [{ x: 0.28, y: 0.22, w: 0.06, h: 0.10 }, { x: 0.66, y: 0.22, w: 0.06, h: 0.10 }],
    'Triceps': [{ x: 0.28, y: 0.22, w: 0.06, h: 0.10 }, { x: 0.66, y: 0.22, w: 0.06, h: 0.10 }],
  };

  ctx.globalAlpha = 0.5;
  ex.muscles.forEach(muscle => {
    const regions = highlights[muscle] || [];
    regions.forEach(r => {
      ctx.fillStyle = '#c41e3a';
      ctx.beginPath();
      ctx.roundRect(W * r.x, H * r.y, W * r.w, H * r.h, 6);
      ctx.fill();
    });
  });
  ctx.globalAlpha = 1;

  // List muscles
  ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Primary Muscles:', 10, H * 0.88);
  ctx.font = '11px system-ui'; ctx.fillStyle = '#c41e3a';
  ex.muscles.forEach((m, i) => {
    ctx.fillText('- ' + m, 10, H * 0.88 + (i + 1) * 16);
  });
}

function drawExFiberChart() {
  if (!currentExercise) return;
  const ctx = getCtx('ex-fiber-chart');
  const ex = exerciseData[currentExercise];
  drawBarChart(ctx, {
    labels: ['Type I', 'Type IIa', 'Type IIx'],
    values: ex.fiberRecruitment,
    colors: ['#dc2626', '#ea580c', '#d4b896'],
    maxVal: 100,
  });
}

function drawExEnergyChart() {
  if (!currentExercise) return;
  const ctx = getCtx('ex-energy-chart');
  const ex = exerciseData[currentExercise];
  drawBarChart(ctx, {
    labels: ['ATP-CP', 'Glycolytic', 'Oxidative'],
    values: ex.energySystems,
    colors: ['#7c3aed', '#d97706', '#16a34a'],
    maxVal: 100,
  });
}

function drawAdaptationChart() {
  if (!currentExercise) {
    const ctx = getCtx('adaptation-chart');
    ctx.clearRect(0, 0, ctx.W, ctx.H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, ctx.W, ctx.H);
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Select an exercise to see training adaptations', ctx.W/2, ctx.H/2);
    return;
  }
  const ctx = getCtx('adaptation-chart');
  const ex = exerciseData[currentExercise];
  drawLineChart(ctx, [
    { data: ex.adaptation.strength, color: '#c41e3a', width: 2.5, dots: true },
    { data: ex.adaptation.endurance, color: '#2563eb', width: 2.5, dots: true },
    { data: ex.adaptation.mass, color: '#16a34a', width: 2.5, dots: true },
  ], { yMin: 90, yMax: 170, refLine: 100 });

  // X-axis labels
  const W = ctx.W, H = ctx.H;
  const pad = { left: 50, bottom: 30, right: 20 };
  const plotW = W - pad.left - pad.right;
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  for (let w = 0; w <= 12; w += 2) {
    const x = pad.left + (w / 12) * plotW;
    ctx.fillText('Wk ' + w, x, H - 4);
  }
}

// ══════════════════════════════════════════════════════════════════════════
// SIDEBAR SCROLL HIGHLIGHT
// ══════════════════════════════════════════════════════════════════════════
function updateSidebar() {
  const sections = document.querySelectorAll('.section, .hero');
  const links = document.querySelectorAll('.sidebar-nav a');
  let current = '';
  sections.forEach(s => {
    if (window.scrollY >= s.offsetTop - 100) current = s.id;
  });
  links.forEach(a => {
    a.classList.toggle('active', a.getAttribute('href') === '#' + current);
  });
}
window.addEventListener('scroll', updateSidebar);

// ══════════════════════════════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════════════════════════════
window.addEventListener('DOMContentLoaded', () => {
  setupBodyClick();
  drawBody();
  updateIdUI();
  setZoom(4);
  updateContractionUI();
  drawFiberCross();
  drawFiberChart();
  drawFiberDistChart();
  drawFatigueChart();
  drawTrialsChart();
  drawLactateChart();
  selectJoint();
  drawExBody();
  drawAdaptationChart();
});

window.addEventListener('resize', () => {
  drawBody();
  drawZoomCanvas();
  updateContractionUI();
  drawFiberCross();
  drawFiberChart();
  drawFiberDistChart();
  drawFatigueChart();
  drawTrialsChart();
  drawLactateChart();
  drawJointCanvas();
  if (currentExercise) {
    drawExBody();
    drawExFiberChart();
    drawExEnergyChart();
    drawAdaptationChart();
  }
});
</script>
</body>
</html>
