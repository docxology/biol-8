<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 6 Dashboard: Metabolism | BIOL-8</title>
<style>
/* ═══════════════════════════════════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f0f2f5; --card: #ffffff; --sidebar: #1a1a2e; --sidebar-hover: #252545;
  --accent: #c41e3a; --accent-light: #e8354f; --blue: #2563eb; --blue-light: #3b82f6;
  --green: #16a34a; --amber: #d97706; --purple: #7c3aed;
  --text: #1a1a1a; --text-muted: #6b7280; --border: #e5e7eb;
  --radius: 10px; --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
}
html { scroll-behavior: smooth; }
body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; }

/* ═══════════════════════════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════════════════════════ */
.layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; background: var(--sidebar); color: #e2e8f0; position: fixed;
  top: 0; left: 0; height: 100vh; overflow-y: auto; z-index: 100;
  display: flex; flex-direction: column;
}
.sidebar-header { padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-header h1 { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
.sidebar-header p { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.sidebar-nav { flex: 1; padding: 12px 0; }
.sidebar-nav a {
  display: flex; align-items: center; gap: 10px; padding: 10px 20px;
  color: #94a3b8; text-decoration: none; font-size: 13px; font-weight: 500;
  transition: all 0.15s; border-left: 3px solid transparent;
}
.sidebar-nav a:hover { background: var(--sidebar-hover); color: #e2e8f0; }
.sidebar-nav a.active { color: #fff; background: var(--sidebar-hover); border-left-color: var(--accent); }
.sidebar-nav .nav-num {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 6px; font-size: 11px; font-weight: 700;
  background: rgba(255,255,255,0.08); flex-shrink: 0;
}
.sidebar-nav a.active .nav-num { background: var(--accent); color: #fff; }
.sidebar-footer { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #64748b; }

.main { margin-left: 260px; flex: 1; padding: 32px; max-width: 1200px; }

/* ═══════════════════════════════════════════════════════════════════════
   CARDS & SECTIONS
   ═══════════════════════════════════════════════════════════════════════ */
.section { margin-bottom: 40px; scroll-margin-top: 24px; }
.section-header {
  display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
}
.section-num {
  display: flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: 10px;
  background: var(--accent); color: #fff; font-weight: 800; font-size: 16px; flex-shrink: 0;
}
.section-title { font-size: 22px; font-weight: 700; }
.section-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

.card {
  background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 24px; margin-bottom: 16px; border: 1px solid var(--border);
}
.card-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.card-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
@media (max-width: 900px) { .card-row, .card-row-3 { grid-template-columns: 1fr; } }

/* ═══════════════════════════════════════════════════════════════════════
   BUTTONS & INPUTS
   ═══════════════════════════════════════════════════════════════════════ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
  border: none; cursor: pointer; transition: all 0.15s; font-family: var(--font);
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn-secondary { background: var(--blue); color: #fff; }
.btn-secondary:hover { background: var(--blue-light); }
.btn-outline { background: transparent; color: var(--text); border: 2px solid var(--border); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }

.slider-group { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
.slider-group label { font-size: 13px; font-weight: 600; min-width: 80px; }
.slider-group input[type=range] { flex: 1; accent-color: var(--accent); }
.slider-val { font-family: var(--mono); font-size: 14px; font-weight: 700; min-width: 50px; text-align: right; }

select.input-select {
  padding: 8px 12px; border-radius: 8px; border: 2px solid var(--border);
  font-family: var(--font); font-size: 13px; font-weight: 600; background: #fff; cursor: pointer;
}
select.input-select:focus { border-color: var(--accent); outline: none; }

input.input-field {
  padding: 8px 12px; border-radius: 8px; border: 2px solid var(--border);
  font-family: var(--mono); font-size: 14px; font-weight: 600; width: 90px; text-align: center;
}
input.input-field:focus { border-color: var(--accent); outline: none; }

/* ═══════════════════════════════════════════════════════════════════════
   STATS & BADGES
   ═══════════════════════════════════════════════════════════════════════ */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 12px 0; }
.stat-box {
  text-align: center; padding: 14px 8px; border-radius: 8px;
  background: #f8fafc; border: 1px solid var(--border);
}
.stat-box .stat-val { font-size: 28px; font-weight: 800; font-family: var(--mono); }
.stat-box .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-accent .stat-val { color: var(--accent); }
.stat-blue .stat-val { color: var(--blue); }
.stat-green .stat-val { color: var(--green); }
.stat-amber .stat-val { color: var(--amber); }
.stat-purple .stat-val { color: var(--purple); }

.badge {
  display: inline-block; padding: 2px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
}
.badge-red { background: #fef2f2; color: var(--accent); }
.badge-blue { background: #eff6ff; color: var(--blue); }
.badge-green { background: #f0fdf4; color: var(--green); }
.badge-amber { background: #fffbeb; color: var(--amber); }
.badge-purple { background: #f5f3ff; color: var(--purple); }

/* ═══════════════════════════════════════════════════════════════════════
   CHART CONTAINERS
   ═══════════════════════════════════════════════════════════════════════ */
.chart-wrap { position: relative; width: 100%; margin: 8px 0; }
.chart-wrap canvas { width: 100% !important; display: block; border-radius: 6px; }

/* ═══════════════════════════════════════════════════════════════════════
   CONVERGENCE LINE
   ═══════════════════════════════════════════════════════════════════════ */
.convergence-info { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin: 10px 0; font-size: 13px; }
.convergence-info .ci-dot { width: 12px; height: 3px; border-radius: 2px; display: inline-block; }

/* ═══════════════════════════════════════════════════════════════════════
   ANALYSIS PANEL
   ═══════════════════════════════════════════════════════════════════════ */
.analysis-result {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--blue); font-size: 14px;
}
.analysis-result .ar-title { font-weight: 700; margin-bottom: 6px; }
.analysis-result code { font-family: var(--mono); background: #e2e8f0; padding: 1px 6px; border-radius: 4px; font-size: 13px; }
.analysis-result.ar-pass { border-left-color: var(--green); }
.analysis-result.ar-fail { border-left-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   HERO BANNER
   ═══════════════════════════════════════════════════════════════════════ */
.hero {
  background: linear-gradient(135deg, #1a1a2e 0%, #2d1b3d 50%, #3b1a2e 100%);
  color: #fff; border-radius: var(--radius); padding: 36px; margin-bottom: 32px;
  position: relative; overflow: hidden;
}
.hero::after {
  content: ''; position: absolute; top: -50%; right: -20%; width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(196,30,58,0.15) 0%, transparent 70%);
  pointer-events: none;
}
.hero h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.hero p { font-size: 15px; color: #cbd5e1; max-width: 600px; line-height: 1.7; }
.hero .bio-tags { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
.hero .bio-tag {
  padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
  background: rgba(255,255,255,0.1); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);
}

/* ═══════════════════════════════════════════════════════════════════════
   FORM GRID
   ═══════════════════════════════════════════════════════════════════════ */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0; }
.form-grid .form-item { display: flex; flex-direction: column; gap: 4px; }
.form-grid .form-item label { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
@media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }

/* ═══════════════════════════════════════════════════════════════════════
   PATHWAY STAGE BUTTONS
   ═══════════════════════════════════════════════════════════════════════ */
.pathway-stages { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
.pathway-stage {
  padding: 8px 16px; border-radius: 8px; border: 2px solid var(--border);
  background: #fff; cursor: pointer; font-size: 12px; font-weight: 700;
  transition: all 0.15s; font-family: var(--font); text-align: center;
}
.pathway-stage:hover { border-color: var(--accent); color: var(--accent); }
.pathway-stage.active { background: var(--accent); color: #fff; border-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main { margin-left: 0; padding: 16px; }
}
</style>
</head>
<body>
<div class="layout">

<!-- ═══════════════════════════════════════════════════════════════════════
     SIDEBAR
     ═══════════════════════════════════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h1>BIOL-8: Human Biology</h1>
    <p>Lab 6 &mdash; Metabolism</p>
  </div>
  <nav class="sidebar-nav">
    <a href="#hero" class="active"><span class="nav-num">&bull;</span> Overview</a>
    <a href="#part1"><span class="nav-num">1</span> Catalase Enzyme Lab</a>
    <a href="#part2"><span class="nav-num">2</span> BMR Calculator</a>
    <a href="#part3"><span class="nav-num">3</span> Aerobic vs Anaerobic</a>
    <a href="#part4"><span class="nav-num">4</span> ATP Energy Budget</a>
    <a href="#part5"><span class="nav-num">5</span> Enzyme Kinetics</a>
    <a href="#part6"><span class="nav-num">6</span> Metabolic Pathway Map</a>
  </nav>
  <div class="sidebar-footer">Interactive Lab Dashboard<br>&copy; 2026 BIOL-8</div>
</aside>

<!-- ═══════════════════════════════════════════════════════════════════════
     MAIN CONTENT
     ═══════════════════════════════════════════════════════════════════════ -->
<div class="main">

<!-- HERO -->
<div class="hero" id="hero">
  <h2>Metabolism</h2>
  <p>Explore the biochemistry of life: enzyme activity, cellular respiration, ATP production, and how your body converts food into energy. Interactive simulations for every section of Lab 6.</p>
  <div class="bio-tags">
    <span class="bio-tag">Enzymes</span>
    <span class="bio-tag">ATP</span>
    <span class="bio-tag">Exercise Physiology</span>
  </div>
</div>

<!-- ═══════════════════════ PART 1: CATALASE ENZYME LAB ════════════════════════ -->
<div class="section" id="part1">
  <div class="section-header">
    <div class="section-num">1</div>
    <div><div class="section-title">Catalase Enzyme Lab</div>
    <div class="section-subtitle">Investigate how temperature, pH, and substrate concentration affect enzyme activity</div></div>
  </div>

  <div class="card">
    <div class="card-title">Virtual Experiment: H&#8322;O&#8322; + Liver Tissue (Catalase)</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Catalase in liver tissue breaks down hydrogen peroxide into water and oxygen gas. Adjust conditions and observe bubble production.</p>
    <div class="slider-group">
      <label>Temperature</label>
      <input type="range" id="cat-temp" min="0" max="80" value="37" oninput="catUpdate()">
      <span class="slider-val" id="cat-temp-val">37&deg;C</span>
    </div>
    <div class="slider-group">
      <label>pH</label>
      <input type="range" id="cat-ph" min="1" max="14" value="7" step="0.5" oninput="catUpdate()">
      <span class="slider-val" id="cat-ph-val">7.0</span>
    </div>
    <div class="slider-group">
      <label>Substrate [H&#8322;O&#8322;]</label>
      <input type="range" id="cat-sub" min="1" max="100" value="50" oninput="catUpdate()">
      <span class="slider-val" id="cat-sub-val">50%</span>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="catStart()">Add H&#8322;O&#8322; to Tissue</button>
      <button class="btn btn-outline" onclick="catReset()">Reset</button>
    </div>
    <div class="chart-wrap"><canvas id="cat-canvas" height="260"></canvas></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="cat-rate">0</div><div class="stat-label">Bubbles/min</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="cat-o2">0</div><div class="stat-label">O&#8322; (mL)</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="cat-status">Ready</div><div class="stat-label">Status</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="cat-denat">No</div><div class="stat-label">Denatured?</div></div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Effect of Temperature on Reaction Rate</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">Click "Run Temperature Sweep" to test all temperatures automatically.</p>
    <div class="btn-group">
      <button class="btn btn-secondary" onclick="catTempSweep()">Run Temperature Sweep</button>
    </div>
    <div class="chart-wrap"><canvas id="cat-temp-chart" height="240"></canvas></div>
  </div>

  <div class="card-row">
    <div class="card">
      <div class="card-title">Effect of pH on Reaction Rate</div>
      <div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="catPhSweep()">Run pH Sweep</button></div>
      <div class="chart-wrap"><canvas id="cat-ph-chart" height="220"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">Effect of Substrate Concentration</div>
      <div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="catSubSweep()">Run Substrate Sweep</button></div>
      <div class="chart-wrap"><canvas id="cat-sub-chart" height="220"></canvas></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 2: BMR CALCULATOR ════════════════════════ -->
<div class="section" id="part2">
  <div class="section-header">
    <div class="section-num">2</div>
    <div><div class="section-title">Basal Metabolic Rate Calculator</div>
    <div class="section-subtitle">Calculate your daily energy needs using the Harris-Benedict equation</div></div>
  </div>

  <div class="card">
    <div class="card-title">Your Metrics</div>
    <div class="form-grid">
      <div class="form-item">
        <label>Age (years)</label>
        <input class="input-field" type="number" id="bmr-age" value="25" min="1" max="120" onchange="bmrCalc()">
      </div>
      <div class="form-item">
        <label>Sex</label>
        <select class="input-select" id="bmr-sex" onchange="bmrCalc()">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>
      <div class="form-item">
        <label>Height (cm)</label>
        <input class="input-field" type="number" id="bmr-height" value="175" min="50" max="250" onchange="bmrCalc()">
      </div>
      <div class="form-item">
        <label>Weight (kg)</label>
        <input class="input-field" type="number" id="bmr-weight" value="70" min="20" max="300" onchange="bmrCalc()">
      </div>
    </div>
    <div class="slider-group">
      <label>Activity Level</label>
      <select class="input-select" id="bmr-activity" onchange="bmrCalc()" style="flex:1;">
        <option value="1.2">Sedentary (little/no exercise)</option>
        <option value="1.375">Lightly Active (1-3 days/week)</option>
        <option value="1.55" selected>Moderately Active (3-5 days/week)</option>
        <option value="1.725">Very Active (6-7 days/week)</option>
        <option value="1.9">Extra Active (athlete/physical job)</option>
      </select>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="bmr-val">-</div><div class="stat-label">BMR (kcal/day)</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="bmr-tdee">-</div><div class="stat-label">TDEE (kcal/day)</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="bmr-per-hr">-</div><div class="stat-label">kcal/hour</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="bmr-kj">-</div><div class="stat-label">kJ/day</div></div>
    </div>
  </div>

  <div class="card-row">
    <div class="card">
      <div class="card-title">Daily Calorie Needs by Activity Level</div>
      <div class="chart-wrap"><canvas id="bmr-activity-chart" height="260"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">Where Your Energy Goes</div>
      <div class="chart-wrap"><canvas id="bmr-pie-chart" height="260"></canvas></div>
      <div style="text-align:center;margin-top:8px;">
        <span class="badge badge-red">Brain 20%</span>
        <span class="badge badge-blue">Organs 29%</span>
        <span class="badge badge-green">Muscles 25%</span>
        <span class="badge badge-amber">Heat 26%</span>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 3: AEROBIC VS ANAEROBIC ════════════════════════ -->
<div class="section" id="part3">
  <div class="section-header">
    <div class="section-num">3</div>
    <div><div class="section-title">Aerobic vs. Anaerobic in Exercise</div>
    <div class="section-subtitle">See how your body switches energy systems during exercise</div></div>
  </div>

  <div class="card">
    <div class="card-title">Exercise Intensity Simulator</div>
    <div class="slider-group">
      <label>Intensity</label>
      <input type="range" id="ex-intensity" min="0" max="100" value="30" oninput="exUpdate()">
      <span class="slider-val" id="ex-intensity-val">30%</span>
    </div>
    <div class="chart-wrap"><canvas id="ex-canvas" height="300"></canvas></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="ex-hr">72</div><div class="stat-label">Heart Rate (bpm)</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="ex-br">14</div><div class="stat-label">Breaths/min</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="ex-atp">36</div><div class="stat-label">ATP/glucose</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="ex-lactate">0.8</div><div class="stat-label">Lactate (mmol/L)</div></div>
      <div class="stat-box stat-purple"><div class="stat-val" id="ex-mode">Aerobic</div><div class="stat-label">Energy System</div></div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Oxygen Debt &amp; Recovery</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">After intense exercise, your body needs extra oxygen to clear lactate and replenish ATP (EPOC: Excess Post-Exercise Oxygen Consumption).</p>
    <div class="convergence-info">
      <span><span class="ci-dot" style="background:var(--blue);"></span> O&#8322; Consumption</span>
      <span><span class="ci-dot" style="background:var(--accent);"></span> O&#8322; Demand</span>
      <span><span class="ci-dot" style="background:rgba(196,30,58,0.2);"></span> Oxygen Debt</span>
    </div>
    <div class="chart-wrap"><canvas id="ex-debt-chart" height="240"></canvas></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="exSimulateWorkout()">Simulate 30-min Workout</button>
      <button class="btn btn-outline" onclick="exResetDebt()">Reset</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 4: ATP ENERGY BUDGET ════════════════════════ -->
<div class="section" id="part4">
  <div class="section-header">
    <div class="section-num">4</div>
    <div><div class="section-title">ATP Energy Budget</div>
    <div class="section-subtitle">Your body produces and recycles ~40 kg of ATP every day</div></div>
  </div>

  <div class="card">
    <div class="card-title">Daily ATP Production &amp; Consumption</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">ATP is the universal energy currency. At any moment you have only ~250g, but you produce and consume your body weight in ATP daily.</p>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val">~40 kg</div><div class="stat-label">ATP made/day</div></div>
      <div class="stat-box stat-blue"><div class="stat-val">250 g</div><div class="stat-label">ATP on hand</div></div>
      <div class="stat-box stat-green"><div class="stat-val">~500</div><div class="stat-label">Recycles/day</div></div>
      <div class="stat-box stat-amber"><div class="stat-val">40%</div><div class="stat-label">Efficiency</div></div>
    </div>
    <div class="chart-wrap"><canvas id="atp-sankey" height="340"></canvas></div>
  </div>

  <div class="card">
    <div class="card-title">Energy Budget Calculator</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">See how your daily activities consume ATP. Adjust hours spent on each activity.</p>
    <div class="slider-group">
      <label>Sleep (hrs)</label>
      <input type="range" id="atp-sleep" min="0" max="12" value="8" oninput="atpBudgetUpdate()">
      <span class="slider-val" id="atp-sleep-val">8</span>
    </div>
    <div class="slider-group">
      <label>Sitting (hrs)</label>
      <input type="range" id="atp-sit" min="0" max="16" value="8" oninput="atpBudgetUpdate()">
      <span class="slider-val" id="atp-sit-val">8</span>
    </div>
    <div class="slider-group">
      <label>Walking (hrs)</label>
      <input type="range" id="atp-walk" min="0" max="10" value="4" oninput="atpBudgetUpdate()">
      <span class="slider-val" id="atp-walk-val">4</span>
    </div>
    <div class="slider-group">
      <label>Exercise (hrs)</label>
      <input type="range" id="atp-exer" min="0" max="6" value="1" oninput="atpBudgetUpdate()">
      <span class="slider-val" id="atp-exer-val">1</span>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="atp-total-kg">-</div><div class="stat-label">Total ATP (kg)</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="atp-total-cal">-</div><div class="stat-label">Total kcal</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="atp-useful">-</div><div class="stat-label">Useful Energy</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="atp-heat">-</div><div class="stat-label">Heat Lost</div></div>
    </div>
    <div class="chart-wrap"><canvas id="atp-budget-chart" height="240"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════ PART 5: ENZYME KINETICS ════════════════════════ -->
<div class="section" id="part5">
  <div class="section-header">
    <div class="section-num">5</div>
    <div><div class="section-title">Enzyme Kinetics Curves</div>
    <div class="section-subtitle">Explore Michaelis-Menten kinetics and inhibitor effects</div></div>
  </div>

  <div class="card">
    <div class="card-title">Michaelis-Menten Plot</div>
    <div class="slider-group">
      <label>Vmax</label>
      <input type="range" id="ek-vmax" min="10" max="200" value="100" oninput="ekUpdate()">
      <span class="slider-val" id="ek-vmax-val">100</span>
    </div>
    <div class="slider-group">
      <label>Km</label>
      <input type="range" id="ek-km" min="1" max="100" value="25" oninput="ekUpdate()">
      <span class="slider-val" id="ek-km-val">25</span>
    </div>
    <div class="slider-group">
      <label>[Substrate]</label>
      <input type="range" id="ek-sub" min="0" max="200" value="50" oninput="ekUpdate()">
      <span class="slider-val" id="ek-sub-val">50</span>
    </div>
    <div class="btn-group">
      <button class="btn btn-outline btn-sm" id="ek-btn-none" onclick="ekSetInhibitor('none')" style="border-color:var(--accent);color:var(--accent);">No Inhibitor</button>
      <button class="btn btn-outline btn-sm" id="ek-btn-comp" onclick="ekSetInhibitor('competitive')">Competitive</button>
      <button class="btn btn-outline btn-sm" id="ek-btn-noncomp" onclick="ekSetInhibitor('noncompetitive')">Noncompetitive</button>
    </div>
    <div class="chart-wrap"><canvas id="ek-mm-chart" height="280"></canvas></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="ek-v">-</div><div class="stat-label">Reaction Rate (V)</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="ek-vmax-disp">100</div><div class="stat-label">Vmax</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="ek-km-disp">25</div><div class="stat-label">Km</div></div>
      <div class="stat-box stat-purple"><div class="stat-val" id="ek-inhib-disp">None</div><div class="stat-label">Inhibitor</div></div>
    </div>
  </div>

  <div class="card-row">
    <div class="card">
      <div class="card-title">Lineweaver-Burk (Double Reciprocal)</div>
      <div class="chart-wrap"><canvas id="ek-lb-chart" height="260"></canvas></div>
      <p style="font-size:12px;color:var(--text-muted);margin-top:8px;">1/V vs 1/[S]. Y-intercept = 1/Vmax. X-intercept = -1/Km. Competitive inhibitors change the slope but same Y-intercept. Noncompetitive inhibitors change the Y-intercept.</p>
    </div>
    <div class="card">
      <div class="card-title">Medical Applications</div>
      <div class="analysis-result ar-pass">
        <div class="ar-title">Aspirin (Competitive Inhibitor)</div>
        <p>Irreversibly inhibits <code>COX-1</code> and <code>COX-2</code> enzymes, reducing prostaglandin production. Relieves pain and inflammation.</p>
      </div>
      <div class="analysis-result">
        <div class="ar-title">Statins (Competitive Inhibitor)</div>
        <p>Competitively inhibit <code>HMG-CoA reductase</code>, the rate-limiting enzyme in cholesterol synthesis. Lowers LDL cholesterol.</p>
      </div>
      <div class="analysis-result ar-fail">
        <div class="ar-title">Cyanide (Noncompetitive Inhibitor)</div>
        <p>Binds <code>cytochrome c oxidase</code> in the ETC, blocking all aerobic ATP production. Rapidly lethal.</p>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 6: METABOLIC PATHWAY MAP ════════════════════════ -->
<div class="section" id="part6">
  <div class="section-header">
    <div class="section-num">6</div>
    <div><div class="section-title">Metabolic Pathway Map</div>
    <div class="section-subtitle">Trace glucose from food through every step of cellular respiration</div></div>
  </div>

  <div class="card">
    <div class="card-title">Cellular Respiration Overview</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Click each stage to see details. Toggle between aerobic and anaerobic pathways.</p>
    <div class="btn-group">
      <button class="btn btn-primary" id="pw-btn-aerobic" onclick="pwSetMode('aerobic')">Aerobic Pathway</button>
      <button class="btn btn-outline" id="pw-btn-anaerobic" onclick="pwSetMode('anaerobic')">Anaerobic (Fermentation)</button>
      <button class="btn btn-secondary btn-sm" onclick="pwAnimate()">Animate</button>
    </div>
    <div class="chart-wrap"><canvas id="pw-canvas" height="400"></canvas></div>
    <div class="pathway-stages">
      <button class="pathway-stage active" onclick="pwSelectStage(0)">Glucose</button>
      <button class="pathway-stage" onclick="pwSelectStage(1)">Glycolysis</button>
      <button class="pathway-stage" onclick="pwSelectStage(2)">Pyruvate</button>
      <button class="pathway-stage" onclick="pwSelectStage(3)">Krebs Cycle</button>
      <button class="pathway-stage" onclick="pwSelectStage(4)">ETC</button>
      <button class="pathway-stage" onclick="pwSelectStage(5)">Fermentation</button>
    </div>
  </div>

  <div class="card-row">
    <div class="card">
      <div class="card-title">Stage Details</div>
      <div id="pw-details" class="analysis-result">
        <div class="ar-title" id="pw-detail-title">Glucose</div>
        <p id="pw-detail-text">C&#8326;H&#8321;&#8322;O&#8326; &mdash; a 6-carbon sugar. The starting fuel for cellular respiration. Obtained from food digestion. Contains chemical energy in its carbon-hydrogen bonds.</p>
      </div>
      <div class="stat-grid">
        <div class="stat-box stat-accent"><div class="stat-val" id="pw-atp-stage">0</div><div class="stat-label">ATP This Stage</div></div>
        <div class="stat-box stat-blue"><div class="stat-val" id="pw-atp-total">0</div><div class="stat-label">Running Total</div></div>
        <div class="stat-box stat-green"><div class="stat-val" id="pw-co2">0</div><div class="stat-label">CO&#8322; Released</div></div>
        <div class="stat-box stat-amber"><div class="stat-val" id="pw-nadh">0</div><div class="stat-label">NADH Made</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ATP Comparison: Aerobic vs. Anaerobic</div>
      <div class="chart-wrap"><canvas id="pw-comparison-chart" height="220"></canvas></div>
      <div style="text-align:center;margin-top:8px;">
        <span class="badge badge-green">Aerobic: 36-38 ATP</span>
        <span class="badge badge-red">Anaerobic: 2 ATP</span>
      </div>
      <p style="font-size:13px;color:var(--text-muted);margin-top:8px;">Aerobic respiration is 18-19x more efficient. Your muscles switch to anaerobic when oxygen supply cannot meet demand during intense exercise.</p>
    </div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /layout -->

<!-- ═══════════════════════════════════════════════════════════════════════
     JAVASCRIPT ENGINE
     ═══════════════════════════════════════════════════════════════════════ -->
<script>
// == Utility ==================================================================
const $ = id => document.getElementById(id);
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
const lerp = (a, b, t) => a + (b - a) * t;

// == Chart helpers ============================================================
function getCtx(id) {
  const c = $(id); const dpr = window.devicePixelRatio || 1;
  const w = c.offsetWidth || c.width || 300;
  const h = c.offsetHeight || c.height || 150;
  c.width = w * dpr; c.height = h * dpr;
  const ctx = c.getContext('2d'); ctx.scale(dpr, dpr);
  ctx.W = w; ctx.H = h;
  return ctx;
}

function drawBarChart(ctx, opts = {}) {
  const { labels, values, expected, colors, maxVal, yLabel } = opts;
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const n = values.length, barW = plotW / n * 0.6, gap = plotW / n * 0.4;

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const mv = maxVal || Math.max(...values, ...(expected||[0])) * 1.2 || 10;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui';
    ctx.textAlign = 'right'; ctx.fillText((mv * i/4).toFixed(mv > 10 ? 0 : 2), pad.left - 6, y + 4);
  }

  values.forEach((v, i) => {
    const x = pad.left + (plotW / n) * i + gap/2;
    const h = (v / mv) * plotH;
    ctx.fillStyle = colors ? colors[i] : '#c41e3a';
    ctx.beginPath();
    const r = 4;
    ctx.moveTo(x, pad.top + plotH);
    ctx.lineTo(x, pad.top + plotH - h + r);
    ctx.quadraticCurveTo(x, pad.top + plotH - h, x + r, pad.top + plotH - h);
    ctx.lineTo(x + barW - r, pad.top + plotH - h);
    ctx.quadraticCurveTo(x + barW, pad.top + plotH - h, x + barW, pad.top + plotH - h + r);
    ctx.lineTo(x + barW, pad.top + plotH);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(labels[i], x + barW/2, H - pad.bottom + 16);
    if (v > 0) {
      ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 12px system-ui';
      ctx.fillText(v.toFixed(v % 1 ? 1 : 0), x + barW/2, pad.top + plotH - h - 6);
    }
  });

  if (expected) {
    expected.forEach((ev, i) => {
      const x = pad.left + (plotW / n) * i + gap/2;
      const y = pad.top + plotH - (ev / mv) * plotH;
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.setLineDash([4,3]);
      ctx.beginPath(); ctx.moveTo(x - 4, y); ctx.lineTo(x + barW + 4, y); ctx.stroke();
      ctx.setLineDash([]);
    });
  }
}

function drawLineChart(ctx, series, opts = {}) {
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 30, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const { yMin = 0, yMax = 1, refLine, xLabels } = opts;
  const yRange = yMax - yMin;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((yMin + yRange * i/4).toFixed(yMax > 10 ? 0 : 2), pad.left - 6, y + 4);
  }
  if (refLine !== undefined) {
    const ry = pad.top + plotH * (1 - (refLine - yMin) / yRange);
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(pad.left, ry); ctx.lineTo(W - pad.right, ry); ctx.stroke();
    ctx.setLineDash([]);
  }

  series.forEach(s => {
    if (!s.data.length) return;
    const xMax = opts.xMax || s.data.length;
    ctx.strokeStyle = s.color; ctx.lineWidth = s.width || 2;
    if (s.dash) ctx.setLineDash(s.dash);
    ctx.beginPath();
    s.data.forEach((v, i) => {
      const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
      const y = pad.top + plotH * (1 - (v - yMin) / yRange);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    if (s.width !== 0) ctx.stroke();
    ctx.setLineDash([]);
    if (s.dots && s.data.length < 80) {
      s.data.forEach((v, i) => {
        const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
        const y = pad.top + plotH * (1 - (v - yMin) / yRange);
        ctx.fillStyle = s.color; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
      });
    }
  });

  if (xLabels) {
    ctx.fillStyle = '#9ca3af'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
    xLabels.forEach((lbl, i) => {
      const x = pad.left + (i / Math.max(xLabels.length - 1, 1)) * plotW;
      ctx.fillText(lbl, x, H - 4);
    });
  }
}

// ══════════════════════════════════════════════════════════════════════════
// PART 1: CATALASE ENZYME LAB
// ══════════════════════════════════════════════════════════════════════════
let catBubbles = [];
let catAnimId = null;
let catRunning = false;

function catGetRate(temp, ph, sub) {
  // Temperature: bell curve centered at 37C, denaturation >60C
  let tFactor;
  if (temp <= 0) tFactor = 0;
  else if (temp < 37) tFactor = Math.exp(-Math.pow(temp - 37, 2) / 200);
  else if (temp <= 55) tFactor = Math.exp(-Math.pow(temp - 37, 2) / 250);
  else tFactor = Math.max(0, 1 - (temp - 55) / 10); // denaturation

  // pH: bell curve centered at 7 for catalase
  const phFactor = Math.exp(-Math.pow(ph - 7, 2) / 4);

  // Substrate: Michaelis-Menten
  const subFactor = sub / (sub + 20);

  return Math.max(0, tFactor * phFactor * subFactor * 120);
}

function catUpdate() {
  const temp = parseInt($('cat-temp').value);
  const ph = parseFloat($('cat-ph').value);
  const sub = parseInt($('cat-sub').value);
  $('cat-temp-val').innerHTML = temp + '&deg;C';
  $('cat-ph-val').textContent = ph.toFixed(1);
  $('cat-sub-val').textContent = sub + '%';

  const rate = catGetRate(temp, ph, sub);
  $('cat-rate').textContent = rate.toFixed(1);
  $('cat-o2').textContent = (rate * 0.04).toFixed(1);
  $('cat-denat').textContent = temp > 55 ? 'Yes!' : 'No';
  $('cat-denat').style.color = temp > 55 ? 'var(--accent)' : '';
}

function catStart() {
  catRunning = true;
  $('cat-status').textContent = 'Active';
  catBubbles = [];
  if (catAnimId) cancelAnimationFrame(catAnimId);
  catAnimLoop();
}

function catReset() {
  catRunning = false;
  $('cat-status').textContent = 'Ready';
  catBubbles = [];
  if (catAnimId) cancelAnimationFrame(catAnimId);
  const ctx = getCtx('cat-canvas');
  ctx.clearRect(0, 0, ctx.W, ctx.H);
  catDrawBeaker(ctx, 0);
}

function catAnimLoop() {
  if (!catRunning) return;
  const ctx = getCtx('cat-canvas');
  const W = ctx.W, H = ctx.H;
  const temp = parseInt($('cat-temp').value);
  const ph = parseFloat($('cat-ph').value);
  const sub = parseInt($('cat-sub').value);
  const rate = catGetRate(temp, ph, sub);

  // Spawn bubbles based on rate
  if (Math.random() < rate / 60) {
    catBubbles.push({
      x: 100 + Math.random() * 120,
      y: H - 60,
      r: 2 + Math.random() * 4,
      speed: 0.5 + Math.random() * 1.5,
      wobble: Math.random() * Math.PI * 2
    });
  }

  catDrawBeaker(ctx, rate);
  catAnimId = requestAnimationFrame(catAnimLoop);
}

function catDrawBeaker(ctx, rate) {
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Beaker
  const bx = 60, by = 40, bw = 200, bh = H - 80;
  ctx.strokeStyle = '#374151'; ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(bx, by); ctx.lineTo(bx, by + bh); ctx.lineTo(bx + bw, by + bh); ctx.lineTo(bx + bw, by);
  ctx.stroke();

  // Liquid (H2O2 solution)
  const liquidH = bh * 0.7;
  const liquidY = by + bh - liquidH;
  ctx.fillStyle = 'rgba(200,220,255,0.4)';
  ctx.fillRect(bx + 2, liquidY, bw - 4, liquidH - 2);

  // Liver tissue at bottom
  ctx.fillStyle = '#8B4513';
  ctx.beginPath();
  ctx.ellipse(bx + bw/2, by + bh - 15, 40, 12, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#A0522D';
  ctx.beginPath();
  ctx.ellipse(bx + bw/2 - 10, by + bh - 18, 20, 8, -0.3, 0, Math.PI * 2);
  ctx.fill();

  // Bubbles
  catBubbles.forEach(b => {
    b.y -= b.speed;
    b.x += Math.sin(b.wobble + b.y * 0.05) * 0.3;
    ctx.fillStyle = 'rgba(150,200,255,0.6)';
    ctx.strokeStyle = 'rgba(100,150,220,0.8)';
    ctx.lineWidth = 0.5;
    ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
    ctx.fill(); ctx.stroke();
    // highlight
    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.beginPath(); ctx.arc(b.x - b.r * 0.3, b.y - b.r * 0.3, b.r * 0.3, 0, Math.PI * 2);
    ctx.fill();
  });
  catBubbles = catBubbles.filter(b => b.y > by);

  // Rate meter on right side
  const mx = 310, my = 60, mw = 30, mh = H - 120;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  ctx.strokeRect(mx, my, mw, mh);
  const fillH = (rate / 120) * mh;
  const gradient = ctx.createLinearGradient(mx, my + mh, mx, my + mh - fillH);
  gradient.addColorStop(0, '#16a34a');
  gradient.addColorStop(0.5, '#d97706');
  gradient.addColorStop(1, '#c41e3a');
  ctx.fillStyle = gradient;
  ctx.fillRect(mx + 2, my + mh - fillH, mw - 4, fillH);

  ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Rate', mx + mw/2, my - 6);
  ctx.fillText(rate.toFixed(0), mx + mw/2, my + mh + 16);

  // Info text area
  const ix = 370;
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Catalase Reaction', ix, 70);
  ctx.font = '13px system-ui'; ctx.fillStyle = '#6b7280';
  ctx.fillText('2 H\u2082O\u2082  \u2192  2 H\u2082O + O\u2082\u2191', ix, 95);

  const temp = parseInt($('cat-temp').value);
  if (temp > 55) {
    ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 13px system-ui';
    ctx.fillText('ENZYME DENATURED!', ix, 130);
    ctx.font = '12px system-ui';
    ctx.fillText('Protein structure unfolded', ix, 148);
    ctx.fillText('at high temperature.', ix, 164);
  } else if (rate > 80) {
    ctx.fillStyle = '#16a34a'; ctx.font = 'bold 13px system-ui';
    ctx.fillText('Optimal conditions!', ix, 130);
  } else if (rate > 30) {
    ctx.fillStyle = '#d97706'; ctx.font = 'bold 13px system-ui';
    ctx.fillText('Moderate activity', ix, 130);
  } else {
    ctx.fillStyle = '#6b7280'; ctx.font = 'bold 13px system-ui';
    ctx.fillText('Low activity', ix, 130);
  }
}

function catTempSweep() {
  const ph = parseFloat($('cat-ph').value);
  const sub = parseInt($('cat-sub').value);
  const data = [];
  for (let t = 0; t <= 80; t += 2) data.push(catGetRate(t, ph, sub));
  const ctx = getCtx('cat-temp-chart');
  drawLineChart(ctx, [
    { data: data, color: '#c41e3a', width: 2.5, dots: false }
  ], {
    yMin: 0, yMax: Math.max(...data) * 1.15 || 120,
    xLabels: ['0\u00B0C','10\u00B0C','20\u00B0C','30\u00B0C','40\u00B0C','50\u00B0C','60\u00B0C','70\u00B0C','80\u00B0C']
  });
  // Add optimal zone highlight
  const W = ctx.W, H = ctx.H;
  const padL = 50, padT = 20, padR = 20, padB = 30;
  const plotW = W - padL - padR, plotH = H - padT - padB;
  const optX1 = padL + (32/80) * plotW;
  const optX2 = padL + (42/80) * plotW;
  ctx.fillStyle = 'rgba(22,163,74,0.1)';
  ctx.fillRect(optX1, padT, optX2 - optX1, plotH);
  ctx.fillStyle = '#16a34a'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Optimal', (optX1 + optX2) / 2, padT + 14);
  // Denaturation zone
  const denX = padL + (55/80) * plotW;
  ctx.fillStyle = 'rgba(196,30,58,0.08)';
  ctx.fillRect(denX, padT, W - padR - denX, plotH);
  ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 10px system-ui';
  ctx.fillText('Denaturation', (denX + W - padR) / 2, padT + 14);
}

function catPhSweep() {
  const temp = parseInt($('cat-temp').value);
  const sub = parseInt($('cat-sub').value);
  const data = [];
  for (let ph = 1; ph <= 14; ph += 0.5) data.push(catGetRate(temp, ph, sub));
  const ctx = getCtx('cat-ph-chart');
  drawLineChart(ctx, [
    { data: data, color: '#2563eb', width: 2.5, dots: false }
  ], { yMin: 0, yMax: Math.max(...data) * 1.15 || 120,
    xLabels: ['pH 1','pH 4','pH 7','pH 10','pH 14'] });
}

function catSubSweep() {
  const temp = parseInt($('cat-temp').value);
  const ph = parseFloat($('cat-ph').value);
  const data = [];
  for (let s = 0; s <= 100; s += 2) data.push(catGetRate(temp, ph, s));
  const ctx = getCtx('cat-sub-chart');
  drawLineChart(ctx, [
    { data: data, color: '#7c3aed', width: 2.5, dots: false }
  ], { yMin: 0, yMax: Math.max(...data) * 1.15 || 120,
    xLabels: ['0%','25%','50%','75%','100%'] });
  // Show Vmax asymptote
  const W = ctx.W, H = ctx.H;
  const padT = 20, padB = 30, padL = 50, padR = 20;
  const plotH = H - padT - padB;
  const maxRate = catGetRate(temp, ph, 100);
  const asymY = padT + plotH * (1 - maxRate / (Math.max(...data) * 1.15));
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(padL, asymY); ctx.lineTo(W - padR, asymY); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#d97706'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'right';
  ctx.fillText('Vmax', W - padR - 4, asymY - 4);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 2: BMR CALCULATOR
// ══════════════════════════════════════════════════════════════════════════
function bmrCalc() {
  const age = parseInt($('bmr-age').value) || 25;
  const sex = $('bmr-sex').value;
  const h = parseFloat($('bmr-height').value) || 175;
  const w = parseFloat($('bmr-weight').value) || 70;
  const activity = parseFloat($('bmr-activity').value);

  // Harris-Benedict
  let bmr;
  if (sex === 'male') {
    bmr = 88.362 + (13.397 * w) + (4.799 * h) - (5.677 * age);
  } else {
    bmr = 447.593 + (9.247 * w) + (3.098 * h) - (4.330 * age);
  }

  const tdee = bmr * activity;
  $('bmr-val').textContent = Math.round(bmr);
  $('bmr-tdee').textContent = Math.round(tdee);
  $('bmr-per-hr').textContent = (bmr / 24).toFixed(1);
  $('bmr-kj').textContent = Math.round(bmr * 4.184);

  // Activity chart
  const levels = [1.2, 1.375, 1.55, 1.725, 1.9];
  const labels = ['Sedentary', 'Light', 'Moderate', 'Very Active', 'Extra Active'];
  const values = levels.map(l => Math.round(bmr * l));
  const actColors = ['#6b7280','#2563eb','#16a34a','#d97706','#c41e3a'];
  const ctx = getCtx('bmr-activity-chart');
  drawBarChart(ctx, { labels, values, colors: actColors, maxVal: Math.max(...values) * 1.15 });

  // Pie chart
  drawBmrPie();
}

function drawBmrPie() {
  const ctx = getCtx('bmr-pie-chart');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const data = [
    { label: 'Brain', pct: 0.20, color: '#c41e3a' },
    { label: 'Organs', pct: 0.29, color: '#2563eb' },
    { label: 'Muscles', pct: 0.25, color: '#16a34a' },
    { label: 'Heat', pct: 0.26, color: '#d97706' }
  ];

  const cx = W / 2, cy = H / 2 - 5;
  const r = Math.min(W, H) / 2 - 40;
  let startAngle = -Math.PI / 2;

  data.forEach(d => {
    const endAngle = startAngle + d.pct * Math.PI * 2;
    ctx.fillStyle = d.color;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, startAngle, endAngle);
    ctx.closePath();
    ctx.fill();

    // Label
    const midAngle = (startAngle + endAngle) / 2;
    const lx = cx + Math.cos(midAngle) * (r * 0.65);
    const ly = cy + Math.sin(midAngle) * (r * 0.65);
    ctx.fillStyle = '#fff'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(d.label, lx, ly - 2);
    ctx.font = '11px system-ui';
    ctx.fillText(Math.round(d.pct * 100) + '%', lx, ly + 13);

    startAngle = endAngle;
  });

  // Inner circle for donut
  ctx.fillStyle = '#f8fafc';
  ctx.beginPath(); ctx.arc(cx, cy, r * 0.35, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Energy', cx, cy - 4);
  ctx.fillText('Use', cx, cy + 14);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 3: AEROBIC VS ANAEROBIC
// ══════════════════════════════════════════════════════════════════════════
let exAnimId = null;
let exRunnerPhase = 0;

function exUpdate() {
  const intensity = parseInt($('ex-intensity').value);
  $('ex-intensity-val').textContent = intensity + '%';

  // Heart rate: rest 72, max ~200
  const hr = Math.round(72 + (200 - 72) * Math.pow(intensity / 100, 1.2));
  $('ex-hr').textContent = hr;

  // Breathing rate: rest 14, max ~45
  const br = Math.round(14 + 31 * Math.pow(intensity / 100, 1.1));
  $('ex-br').textContent = br;

  // ATP per glucose: transitions around 70% intensity
  const anaerobicPct = Math.max(0, Math.min(1, (intensity - 50) / 40));
  const atpPerGlucose = Math.round(36 - 34 * anaerobicPct);
  $('ex-atp').textContent = atpPerGlucose;

  // Lactate: exponential rise above ~60% intensity
  const lactate = 0.8 + Math.max(0, 12 * Math.pow(Math.max(0, intensity - 50) / 50, 2.5));
  $('ex-lactate').textContent = lactate.toFixed(1);

  // Mode
  if (intensity < 50) $('ex-mode').textContent = 'Aerobic';
  else if (intensity < 75) $('ex-mode').textContent = 'Mixed';
  else $('ex-mode').textContent = 'Anaerobic';

  drawExCanvas(intensity);
}

function drawExCanvas(intensity) {
  const ctx = getCtx('ex-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);

  // Background gradient based on intensity
  const gradient = ctx.createLinearGradient(0, 0, W, 0);
  if (intensity < 50) {
    gradient.addColorStop(0, '#f0fdf4');
    gradient.addColorStop(1, '#ecfdf5');
  } else if (intensity < 75) {
    gradient.addColorStop(0, '#fffbeb');
    gradient.addColorStop(1, '#fef3c7');
  } else {
    gradient.addColorStop(0, '#fef2f2');
    gradient.addColorStop(1, '#fee2e2');
  }
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, W, H);

  // Ground
  ctx.fillStyle = '#d1d5db';
  ctx.fillRect(0, H - 40, W, 40);

  // Runner (stick figure)
  exRunnerPhase += (0.01 + intensity * 0.002);
  const rx = 120, ry = H - 90;
  const legSwing = Math.sin(exRunnerPhase) * (10 + intensity * 0.3);
  const armSwing = Math.sin(exRunnerPhase + Math.PI) * (8 + intensity * 0.2);
  const bobY = Math.abs(Math.sin(exRunnerPhase)) * (2 + intensity * 0.05);

  ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 3; ctx.lineCap = 'round';
  // Body
  ctx.beginPath(); ctx.moveTo(rx, ry - bobY); ctx.lineTo(rx, ry - 40 - bobY); ctx.stroke();
  // Head
  ctx.beginPath(); ctx.arc(rx, ry - 52 - bobY, 12, 0, Math.PI * 2); ctx.stroke();
  // Arms
  ctx.beginPath(); ctx.moveTo(rx, ry - 35 - bobY); ctx.lineTo(rx - 15 + armSwing, ry - 20 - bobY); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(rx, ry - 35 - bobY); ctx.lineTo(rx + 15 - armSwing, ry - 20 - bobY); ctx.stroke();
  // Legs
  ctx.beginPath(); ctx.moveTo(rx, ry - bobY); ctx.lineTo(rx - 12 + legSwing, ry + 25); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(rx, ry - bobY); ctx.lineTo(rx + 12 - legSwing, ry + 25); ctx.stroke();

  // Speed lines
  if (intensity > 30) {
    ctx.strokeStyle = 'rgba(100,100,100,0.3)'; ctx.lineWidth = 1;
    for (let i = 0; i < Math.min(intensity / 10, 8); i++) {
      const ly = ry - 50 + i * 10 - bobY;
      const lx = rx - 30 - Math.random() * 20 * (intensity / 50);
      ctx.beginPath(); ctx.moveTo(lx, ly); ctx.lineTo(lx - 10 - intensity / 5, ly); ctx.stroke();
    }
  }

  // Energy system info panel (right side)
  const px = 260, py = 30;
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 16px system-ui'; ctx.textAlign = 'left';

  const anaerobicPct = Math.max(0, Math.min(100, ((intensity - 50) / 40) * 100));
  const aerobicPct = 100 - anaerobicPct;

  // Aerobic bar
  ctx.fillStyle = '#16a34a'; ctx.font = 'bold 13px system-ui';
  ctx.fillText('Aerobic: ' + aerobicPct.toFixed(0) + '%', px, py + 20);
  ctx.fillStyle = '#e5e7eb';
  ctx.fillRect(px, py + 28, 200, 16);
  ctx.fillStyle = '#16a34a';
  ctx.fillRect(px, py + 28, 200 * aerobicPct / 100, 16);

  // Anaerobic bar
  ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 13px system-ui';
  ctx.fillText('Anaerobic: ' + anaerobicPct.toFixed(0) + '%', px, py + 65);
  ctx.fillStyle = '#e5e7eb';
  ctx.fillRect(px, py + 73, 200, 16);
  ctx.fillStyle = '#c41e3a';
  ctx.fillRect(px, py + 73, 200 * anaerobicPct / 100, 16);

  // ATP equation
  ctx.fillStyle = '#374151'; ctx.font = '12px system-ui';
  if (intensity < 50) {
    ctx.fillText('Glucose + O\u2082 \u2192 CO\u2082 + H\u2082O + 36 ATP', px, py + 120);
  } else if (intensity < 75) {
    ctx.fillText('Mixed: Aerobic + Anaerobic', px, py + 120);
    ctx.fillText('ATP yield declining...', px, py + 138);
  } else {
    ctx.fillText('Glucose \u2192 Lactic Acid + 2 ATP', px, py + 120);
    ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 12px system-ui';
    ctx.fillText('Lactic acid building up!', px, py + 138);
  }

  // Lactate meter
  const lactate = 0.8 + Math.max(0, 12 * Math.pow(Math.max(0, intensity - 50) / 50, 2.5));
  ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui';
  ctx.fillText('Blood Lactate', px, py + 175);
  ctx.fillStyle = '#e5e7eb';
  ctx.fillRect(px, py + 182, 200, 12);
  const lactPct = Math.min(1, lactate / 13);
  ctx.fillStyle = lactate > 4 ? '#c41e3a' : lactate > 2 ? '#d97706' : '#16a34a';
  ctx.fillRect(px, py + 182, 200 * lactPct, 12);
  ctx.fillStyle = '#6b7280'; ctx.font = '10px system-ui';
  ctx.fillText(lactate.toFixed(1) + ' mmol/L', px + 205, py + 192);

  if (catAnimId === null && catRunning === false) {
    requestAnimationFrame(() => drawExCanvas(intensity));
  }
}

// Oxygen debt chart
let exDebtData = null;

function exSimulateWorkout() {
  const phases = [];
  // Warmup (0-5 min): intensity 20-50%
  for (let t = 0; t <= 5; t++) {
    const i = 20 + t * 6;
    phases.push({ time: t, demand: 0.5 + i * 0.025, supply: Math.min(0.5 + i * 0.02, 0.5 + i * 0.025 - 0.1) });
  }
  // High intensity (5-20 min): intensity 70-90%
  for (let t = 6; t <= 20; t++) {
    const i = 70 + Math.sin((t - 5) * 0.5) * 10;
    phases.push({ time: t, demand: 2.0 + (i - 70) * 0.03, supply: 1.6 + (t - 5) * 0.02 });
  }
  // Cooldown (20-25 min)
  for (let t = 21; t <= 25; t++) {
    const decay = (t - 20) / 5;
    phases.push({ time: t, demand: 2.0 * (1 - decay) + 0.5 * decay, supply: 1.7 * (1 - decay * 0.5) });
  }
  // Recovery (25-35 min)
  for (let t = 26; t <= 35; t++) {
    const decay = (t - 25) / 10;
    phases.push({ time: t, demand: 0.4, supply: 0.5 + 0.7 * Math.exp(-decay * 2) });
  }

  exDebtData = phases;
  drawExDebtChart();
}

function exResetDebt() {
  exDebtData = null;
  const ctx = getCtx('ex-debt-chart');
  ctx.clearRect(0, 0, ctx.W, ctx.H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, ctx.W, ctx.H);
  ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Click "Simulate 30-min Workout" to see oxygen debt', ctx.W / 2, ctx.H / 2);
}

function drawExDebtChart() {
  if (!exDebtData) return;
  const ctx = getCtx('ex-debt-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 35, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const maxY = 2.8;
  const n = exDebtData.length;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((maxY * i/4).toFixed(1) + ' L', pad.left - 6, y + 4);
  }

  // Shade debt area
  ctx.fillStyle = 'rgba(196,30,58,0.1)';
  ctx.beginPath();
  exDebtData.forEach((d, i) => {
    const x = pad.left + (i / (n - 1)) * plotW;
    const yD = pad.top + plotH * (1 - d.demand / maxY);
    const yS = pad.top + plotH * (1 - Math.min(d.supply, d.demand) / maxY);
    if (d.demand > d.supply) {
      if (i === 0) ctx.moveTo(x, yS);
      else ctx.lineTo(x, yS);
    }
  });
  for (let i = n - 1; i >= 0; i--) {
    const d = exDebtData[i];
    if (d.demand > d.supply) {
      const x = pad.left + (i / (n - 1)) * plotW;
      const yD = pad.top + plotH * (1 - d.demand / maxY);
      ctx.lineTo(x, yD);
    }
  }
  ctx.closePath(); ctx.fill();

  // EPOC shading (recovery)
  ctx.fillStyle = 'rgba(37,99,235,0.1)';
  ctx.beginPath();
  let startedEpoc = false;
  exDebtData.forEach((d, i) => {
    if (d.supply > d.demand && d.time > 20) {
      const x = pad.left + (i / (n - 1)) * plotW;
      const yD = pad.top + plotH * (1 - d.demand / maxY);
      const yS = pad.top + plotH * (1 - d.supply / maxY);
      if (!startedEpoc) { ctx.moveTo(x, yD); startedEpoc = true; }
      else ctx.lineTo(x, yD);
    }
  });
  for (let i = n - 1; i >= 0; i--) {
    const d = exDebtData[i];
    if (d.supply > d.demand && d.time > 20) {
      const x = pad.left + (i / (n - 1)) * plotW;
      const yS = pad.top + plotH * (1 - d.supply / maxY);
      ctx.lineTo(x, yS);
    }
  }
  ctx.closePath(); ctx.fill();

  // Demand line
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
  ctx.beginPath();
  exDebtData.forEach((d, i) => {
    const x = pad.left + (i / (n - 1)) * plotW;
    const y = pad.top + plotH * (1 - d.demand / maxY);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Supply line
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2;
  ctx.beginPath();
  exDebtData.forEach((d, i) => {
    const x = pad.left + (i / (n - 1)) * plotW;
    const y = pad.top + plotH * (1 - d.supply / maxY);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Phase labels
  ctx.fillStyle = '#6b7280'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Warmup', pad.left + plotW * 2.5 / 35, H - 5);
  ctx.fillText('High Intensity', pad.left + plotW * 12.5 / 35, H - 5);
  ctx.fillText('Cooldown', pad.left + plotW * 22.5 / 35, H - 5);
  ctx.fillText('Recovery (EPOC)', pad.left + plotW * 30 / 35, H - 5);

  // Time axis
  for (let t = 0; t <= 35; t += 5) {
    const x = pad.left + (t / 35) * plotW;
    ctx.fillStyle = '#9ca3af'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(t + 'min', x, H - pad.bottom + 14);
  }

  // Debt label
  ctx.fillStyle = 'rgba(196,30,58,0.7)'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('O\u2082 DEBT', pad.left + plotW * 10 / 35, pad.top + plotH * 0.3);
  ctx.fillStyle = 'rgba(37,99,235,0.7)';
  ctx.fillText('EPOC', pad.left + plotW * 28 / 35, pad.top + plotH * 0.5);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 4: ATP ENERGY BUDGET
// ══════════════════════════════════════════════════════════════════════════
function drawAtpSankey() {
  const ctx = getCtx('atp-sankey');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const stages = [
    { label: 'Food\nIntake', x: 20, color: '#d97706', width: 80 },
    { label: 'Digestion', x: 140, color: '#ea580c', width: 70 },
    { label: 'Cellular\nRespiration', x: 260, color: '#c41e3a', width: 60 },
    { label: 'ATP', x: 380, color: '#7c3aed', width: 50 }
  ];

  const cy = H / 2;
  const boxH = 80;

  // Draw flow connections
  for (let i = 0; i < stages.length - 1; i++) {
    const s = stages[i], e = stages[i + 1];
    const sx = s.x + 60, ex = e.x;
    ctx.fillStyle = 'rgba(196,30,58,0.08)';
    ctx.beginPath();
    ctx.moveTo(sx, cy - boxH/2 * (1 - i * 0.1));
    ctx.bezierCurveTo(sx + 40, cy - boxH/2, ex - 40, cy - boxH/2, ex, cy - boxH/2 * (1 - (i+1) * 0.1));
    ctx.lineTo(ex, cy + boxH/2 * (1 - (i+1) * 0.1));
    ctx.bezierCurveTo(ex - 40, cy + boxH/2, sx + 40, cy + boxH/2, sx, cy + boxH/2 * (1 - i * 0.1));
    ctx.closePath(); ctx.fill();
  }

  // Draw boxes
  stages.forEach(s => {
    ctx.fillStyle = s.color;
    const bx = s.x, by = cy - boxH / 2;
    ctx.beginPath();
    ctx.roundRect(bx, by, 60, boxH, 8);
    ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    const lines = s.label.split('\n');
    lines.forEach((line, li) => {
      ctx.fillText(line, bx + 30, cy + (li - (lines.length - 1) / 2) * 14 + 4);
    });
  });

  // Outputs from ATP
  const outputs = [
    { label: 'Muscle\nContraction', y: cy - 90, pct: '25%', color: '#16a34a' },
    { label: 'Brain\nActivity', y: cy - 30, pct: '20%', color: '#2563eb' },
    { label: 'Active\nTransport', y: cy + 30, pct: '15%', color: '#7c3aed' },
    { label: 'Heat\nLoss', y: cy + 90, pct: '40%', color: '#d97706' }
  ];

  const atpRight = 440;
  outputs.forEach(o => {
    // Flow line
    ctx.strokeStyle = o.color; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(atpRight, cy);
    ctx.bezierCurveTo(atpRight + 30, cy, atpRight + 30, o.y, atpRight + 60, o.y);
    ctx.stroke();
    // Arrow
    ctx.fillStyle = o.color;
    ctx.beginPath();
    ctx.moveTo(atpRight + 60, o.y - 5);
    ctx.lineTo(atpRight + 68, o.y);
    ctx.lineTo(atpRight + 60, o.y + 5);
    ctx.closePath(); ctx.fill();
    // Box
    ctx.fillStyle = o.color + '15';
    ctx.strokeStyle = o.color;
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.roundRect(atpRight + 72, o.y - 22, 80, 44, 6);
    ctx.fill(); ctx.stroke();
    ctx.fillStyle = o.color; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
    const lines = o.label.split('\n');
    lines.forEach((line, li) => {
      ctx.fillText(line, atpRight + 112, o.y + (li - (lines.length - 1) / 2) * 12 - 2);
    });
    ctx.font = 'bold 12px system-ui';
    ctx.fillText(o.pct, atpRight + 112, o.y + 16);
  });

  // Efficiency label
  ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Energy conversion efficiency: ~40%', 20, H - 20);
  ctx.fillStyle = '#6b7280'; ctx.font = '12px system-ui';
  ctx.fillText('60% released as heat (maintains body temperature at 37\u00B0C)', 20, H - 4);
}

function atpBudgetUpdate() {
  const sleep = parseInt($('atp-sleep').value);
  const sit = parseInt($('atp-sit').value);
  const walk = parseInt($('atp-walk').value);
  const exer = parseInt($('atp-exer').value);
  $('atp-sleep-val').textContent = sleep;
  $('atp-sit-val').textContent = sit;
  $('atp-walk-val').textContent = walk;
  $('atp-exer-val').textContent = exer;

  // ATP rates (kg/hr) - approximate
  const rates = { sleep: 1.0, sit: 1.5, walk: 3.0, exer: 8.0 };
  const totalKg = sleep * rates.sleep + sit * rates.sit + walk * rates.walk + exer * rates.exer;
  const totalCal = totalKg * 50; // ~50 kcal per kg ATP
  const useful = totalCal * 0.4;
  const heat = totalCal * 0.6;

  $('atp-total-kg').textContent = totalKg.toFixed(0) + ' kg';
  $('atp-total-cal').textContent = totalCal.toFixed(0);
  $('atp-useful').textContent = useful.toFixed(0) + ' kcal';
  $('atp-heat').textContent = heat.toFixed(0) + ' kcal';

  // Budget chart
  const labels = ['Sleep', 'Sitting', 'Walking', 'Exercise'];
  const values = [sleep * rates.sleep, sit * rates.sit, walk * rates.walk, exer * rates.exer];
  const budgetColors = ['#7c3aed', '#2563eb', '#16a34a', '#c41e3a'];
  const ctx = getCtx('atp-budget-chart');
  drawBarChart(ctx, {
    labels, values, colors: budgetColors,
    maxVal: Math.max(...values, 10) * 1.2
  });
}

// ══════════════════════════════════════════════════════════════════════════
// PART 5: ENZYME KINETICS
// ══════════════════════════════════════════════════════════════════════════
let ekInhibitor = 'none';

function ekSetInhibitor(type) {
  ekInhibitor = type;
  document.querySelectorAll('[id^="ek-btn-"]').forEach(btn => {
    btn.style.borderColor = 'var(--border)';
    btn.style.color = 'var(--text)';
  });
  $('ek-btn-' + (type === 'noncompetitive' ? 'noncomp' : type)).style.borderColor = 'var(--accent)';
  $('ek-btn-' + (type === 'noncompetitive' ? 'noncomp' : type)).style.color = 'var(--accent)';

  const labels = { none: 'None', competitive: 'Competitive', noncompetitive: 'Noncompetitive' };
  $('ek-inhib-disp').textContent = labels[type];
  ekUpdate();
}

function ekMM(S, Vmax, Km, inhibitor) {
  if (inhibitor === 'competitive') {
    // Competitive: increases apparent Km by factor of 2
    return (Vmax * S) / (Km * 2 + S);
  } else if (inhibitor === 'noncompetitive') {
    // Noncompetitive: decreases apparent Vmax by factor of 2
    return ((Vmax / 2) * S) / (Km + S);
  }
  return (Vmax * S) / (Km + S);
}

function ekUpdate() {
  const Vmax = parseInt($('ek-vmax').value);
  const Km = parseInt($('ek-km').value);
  const S = parseInt($('ek-sub').value);
  $('ek-vmax-val').textContent = Vmax;
  $('ek-km-val').textContent = Km;
  $('ek-sub-val').textContent = S;

  const V = ekMM(S, Vmax, Km, ekInhibitor);
  $('ek-v').textContent = V.toFixed(1);

  const effVmax = ekInhibitor === 'noncompetitive' ? Vmax / 2 : Vmax;
  const effKm = ekInhibitor === 'competitive' ? Km * 2 : Km;
  $('ek-vmax-disp').textContent = effVmax;
  $('ek-km-disp').textContent = effKm;

  drawEkMM(Vmax, Km, S);
  drawEkLB(Vmax, Km);
}

function drawEkMM(Vmax, Km, currentS) {
  const ctx = getCtx('ek-mm-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 25, right: 20, bottom: 40, left: 55 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const maxS = 200;
  const maxV = Vmax * 1.15;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i / 4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText(Math.round(maxV * i / 4), pad.left - 6, y + 4);
  }

  // X axis labels
  for (let i = 0; i <= 4; i++) {
    const x = pad.left + plotW * i / 4;
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(Math.round(maxS * i / 4), x, H - pad.bottom + 16);
  }
  ctx.fillStyle = '#374151'; ctx.font = '12px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('[Substrate]', pad.left + plotW / 2, H - 4);
  ctx.save(); ctx.translate(12, pad.top + plotH / 2);
  ctx.rotate(-Math.PI / 2); ctx.fillText('Reaction Rate (V)', 0, 0); ctx.restore();

  // Uninhibited curve (always shown as reference)
  const nPoints = 100;
  ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 2;
  if (ekInhibitor !== 'none') {
    ctx.setLineDash([4, 4]); ctx.globalAlpha = 0.5;
  }
  ctx.beginPath();
  for (let i = 0; i <= nPoints; i++) {
    const S = (i / nPoints) * maxS;
    const V = ekMM(S, Vmax, Km, 'none');
    const x = pad.left + (S / maxS) * plotW;
    const y = pad.top + plotH * (1 - V / maxV);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke();
  ctx.setLineDash([]); ctx.globalAlpha = 1;

  // Inhibited curve
  if (ekInhibitor !== 'none') {
    ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2.5;
    ctx.beginPath();
    for (let i = 0; i <= nPoints; i++) {
      const S = (i / nPoints) * maxS;
      const V = ekMM(S, Vmax, Km, ekInhibitor);
      const x = pad.left + (S / maxS) * plotW;
      const y = pad.top + plotH * (1 - V / maxV);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();
  } else {
    // If no inhibitor, redraw solid
    ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 2.5;
    ctx.beginPath();
    for (let i = 0; i <= nPoints; i++) {
      const S = (i / nPoints) * maxS;
      const V = ekMM(S, Vmax, Km, 'none');
      const x = pad.left + (S / maxS) * plotW;
      const y = pad.top + plotH * (1 - V / maxV);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();
  }

  // Vmax line
  const effVmax = ekInhibitor === 'noncompetitive' ? Vmax / 2 : Vmax;
  const vmaxY = pad.top + plotH * (1 - effVmax / maxV);
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 1; ctx.setLineDash([6, 3]);
  ctx.beginPath(); ctx.moveTo(pad.left, vmaxY); ctx.lineTo(W - pad.right, vmaxY); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#d97706'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Vmax = ' + effVmax, W - pad.right - 80, vmaxY - 4);

  // Vmax/2 and Km lines
  const halfV = effVmax / 2;
  const effKm = ekInhibitor === 'competitive' ? Km * 2 : Km;
  const halfVY = pad.top + plotH * (1 - halfV / maxV);
  const kmX = pad.left + (effKm / maxS) * plotW;

  ctx.strokeStyle = '#7c3aed'; ctx.lineWidth = 1; ctx.setLineDash([3, 3]);
  // Horizontal at Vmax/2
  ctx.beginPath(); ctx.moveTo(pad.left, halfVY); ctx.lineTo(kmX, halfVY); ctx.stroke();
  // Vertical at Km
  ctx.beginPath(); ctx.moveTo(kmX, halfVY); ctx.lineTo(kmX, pad.top + plotH); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#7c3aed'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Km = ' + effKm, kmX, pad.top + plotH + 14);
  ctx.textAlign = 'right';
  ctx.fillText('Vmax/2', pad.left - 4, halfVY + 4);

  // Current substrate dot
  const curV = ekMM(currentS, Vmax, Km, ekInhibitor);
  const dotX = pad.left + (currentS / maxS) * plotW;
  const dotY = pad.top + plotH * (1 - curV / maxV);
  ctx.fillStyle = '#c41e3a'; ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(dotX, dotY, 6, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('V=' + curV.toFixed(1), dotX + 10, dotY - 2);

  // Legend
  ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  if (ekInhibitor !== 'none') {
    ctx.fillStyle = '#16a34a'; ctx.fillRect(pad.left + 5, 6, 20, 3);
    ctx.fillStyle = '#374151'; ctx.fillText('Uninhibited', pad.left + 30, 12);
    ctx.fillStyle = '#c41e3a'; ctx.fillRect(pad.left + 110, 6, 20, 3);
    ctx.fillStyle = '#374151';
    ctx.fillText(ekInhibitor === 'competitive' ? 'Competitive Inhibitor' : 'Noncompetitive Inhibitor', pad.left + 135, 12);
  }
}

function drawEkLB(Vmax, Km) {
  const ctx = getCtx('ek-lb-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 25, right: 20, bottom: 35, left: 55 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Lineweaver-Burk: 1/V vs 1/[S]
  // 1/V = (Km/Vmax) * (1/[S]) + 1/Vmax
  const maxInvS = 0.5; // 1/[S] range: -0.1 to 0.5
  const minInvS = -0.15;

  // Calculate y range
  function lbY(invS, vmax, km) { return (km / vmax) * invS + 1 / vmax; }

  const maxInvV = Math.max(
    lbY(maxInvS, Vmax, Km),
    ekInhibitor === 'competitive' ? lbY(maxInvS, Vmax, Km * 2) : 0,
    ekInhibitor === 'noncompetitive' ? lbY(maxInvS, Vmax / 2, Km) : 0
  ) * 1.15;
  const minInvV = -maxInvV * 0.15;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i / 4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
  }

  // Axes
  const zeroX = pad.left + (-minInvS / (maxInvS - minInvS)) * plotW;
  const zeroY = pad.top + plotH * (1 - (-minInvV) / (maxInvV - minInvV));

  ctx.strokeStyle = '#374151'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(pad.left, zeroY); ctx.lineTo(W - pad.right, zeroY); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(zeroX, pad.top); ctx.lineTo(zeroX, pad.top + plotH); ctx.stroke();

  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('1/[S]', pad.left + plotW / 2, H - 4);
  ctx.save(); ctx.translate(12, pad.top + plotH / 2); ctx.rotate(-Math.PI / 2);
  ctx.fillText('1/V', 0, 0); ctx.restore();

  function plotLB(vmax, km, color, dash) {
    ctx.strokeStyle = color; ctx.lineWidth = 2;
    if (dash) ctx.setLineDash(dash);
    ctx.beginPath();
    const steps = 50;
    for (let i = 0; i <= steps; i++) {
      const invS = minInvS + (maxInvS - minInvS) * i / steps;
      const invV = lbY(invS, vmax, km);
      const x = pad.left + ((invS - minInvS) / (maxInvS - minInvS)) * plotW;
      const y = pad.top + plotH * (1 - (invV - minInvV) / (maxInvV - minInvV));
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();
    ctx.setLineDash([]);

    // Mark intercepts
    const yIntercept = 1 / vmax;
    const xIntercept = -1 / km;
    // Y-intercept
    const yiX = zeroX;
    const yiY = pad.top + plotH * (1 - (yIntercept - minInvV) / (maxInvV - minInvV));
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(yiX, yiY, 4, 0, Math.PI * 2); ctx.fill();
    // X-intercept
    const xiX = pad.left + ((xIntercept - minInvS) / (maxInvS - minInvS)) * plotW;
    ctx.beginPath(); ctx.arc(xiX, zeroY, 4, 0, Math.PI * 2); ctx.fill();
  }

  // Uninhibited
  plotLB(Vmax, Km, '#16a34a', ekInhibitor !== 'none' ? [4, 4] : null);

  // Inhibited
  if (ekInhibitor === 'competitive') {
    plotLB(Vmax, Km * 2, '#c41e3a', null);
  } else if (ekInhibitor === 'noncompetitive') {
    plotLB(Vmax / 2, Km, '#c41e3a', null);
  }

  // Labels
  ctx.fillStyle = '#374151'; ctx.font = '10px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Y-int = 1/Vmax', zeroX + 4, pad.top + 12);
  ctx.fillText('X-int = -1/Km', pad.left + 4, zeroY - 6);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 6: METABOLIC PATHWAY MAP
// ══════════════════════════════════════════════════════════════════════════
let pwMode = 'aerobic';
let pwSelectedStage = 0;
let pwAnimating = false;
let pwAnimStep = 0;

const pwStageInfo = [
  {
    title: 'Glucose',
    text: 'C\u2086H\u2081\u2082O\u2086 \u2014 a 6-carbon sugar. The starting fuel for cellular respiration. Obtained from food digestion. Contains chemical energy in its carbon-hydrogen bonds.',
    atp: 0, atpTotal: 0, co2: 0, nadh: 0
  },
  {
    title: 'Glycolysis',
    text: 'Occurs in the cytoplasm. Glucose (6C) is split into 2 pyruvate (3C each). Requires 2 ATP investment, produces 4 ATP and 2 NADH. Net gain: 2 ATP. Does NOT require oxygen.',
    atp: 2, atpTotal: 2, co2: 0, nadh: 2
  },
  {
    title: 'Pyruvate',
    text: 'A 3-carbon molecule. At this crossroads: with oxygen available, pyruvate enters mitochondria for the Krebs cycle. Without oxygen, pyruvate undergoes fermentation in the cytoplasm.',
    atp: 0, atpTotal: 2, co2: 2, nadh: 2
  },
  {
    title: 'Krebs Cycle (Citric Acid Cycle)',
    text: 'Occurs in the mitochondrial matrix. Pyruvate is converted to Acetyl-CoA, then processed through the cycle. Produces 2 ATP, 6 NADH, 2 FADH\u2082, and 4 CO\u2082 (per glucose). Requires oxygen indirectly.',
    atp: 2, atpTotal: 4, co2: 4, nadh: 8
  },
  {
    title: 'Electron Transport Chain (ETC)',
    text: 'Located in the inner mitochondrial membrane. NADH and FADH\u2082 donate electrons. Creates a proton gradient that drives ATP synthase. Produces 32-34 ATP. Oxygen is the final electron acceptor, forming water.',
    atp: 34, atpTotal: 38, co2: 0, nadh: 0
  },
  {
    title: 'Fermentation (Anaerobic)',
    text: 'When oxygen is unavailable, pyruvate is converted to lactic acid (in humans) or ethanol + CO\u2082 (in yeast). No additional ATP is produced. Total yield: only 2 ATP from glycolysis. Lactic acid causes muscle fatigue.',
    atp: 0, atpTotal: 2, co2: 0, nadh: -2
  }
];

function pwSetMode(mode) {
  pwMode = mode;
  if (mode === 'aerobic') {
    $('pw-btn-aerobic').className = 'btn btn-primary';
    $('pw-btn-anaerobic').className = 'btn btn-outline';
  } else {
    $('pw-btn-aerobic').className = 'btn btn-outline';
    $('pw-btn-anaerobic').className = 'btn btn-primary';
  }
  pwDraw();
}

function pwSelectStage(idx) {
  pwSelectedStage = idx;
  document.querySelectorAll('.pathway-stage').forEach((el, i) => {
    el.classList.toggle('active', i === idx);
  });
  const info = pwStageInfo[idx];
  $('pw-detail-title').textContent = info.title;
  $('pw-detail-text').innerHTML = info.text;
  $('pw-atp-stage').textContent = info.atp;
  $('pw-atp-total').textContent = info.atpTotal;
  $('pw-co2').textContent = info.co2;
  $('pw-nadh').textContent = info.nadh >= 0 ? info.nadh : info.nadh + ' (consumed)';
  pwDraw();
}

function pwAnimate() {
  if (pwAnimating) return;
  pwAnimating = true;
  pwAnimStep = 0;
  pwAnimLoop();
}

function pwAnimLoop() {
  if (!pwAnimating) return;
  pwAnimStep += 0.02;
  pwDraw();
  if (pwAnimStep < 1) {
    requestAnimationFrame(pwAnimLoop);
  } else {
    pwAnimating = false;
  }
}

function pwDraw() {
  const ctx = getCtx('pw-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const stages = [
    { label: 'Glucose', sub: 'C\u2086H\u2081\u2082O\u2086', x: 60, y: 50, color: '#d97706', idx: 0 },
    { label: 'Glycolysis', sub: 'Cytoplasm', x: 60, y: 140, color: '#ea580c', idx: 1 },
    { label: 'Pyruvate', sub: '2 x 3C', x: 60, y: 230, color: '#dc2626', idx: 2 }
  ];

  const aerobicStages = [
    { label: 'Krebs Cycle', sub: 'Mito. Matrix', x: 280, y: 230, color: '#16a34a', idx: 3 },
    { label: 'ETC', sub: 'Inner Membrane', x: 280, y: 320, color: '#2563eb', idx: 4 }
  ];

  const anaerobicStage = { label: 'Fermentation', sub: 'Cytoplasm', x: 440, y: 140, color: '#7c3aed', idx: 5 };

  const boxW = 140, boxH = 55;

  function drawBox(s, highlight) {
    const bx = s.x, by = s.y;
    ctx.fillStyle = highlight ? s.color : s.color + '15';
    ctx.strokeStyle = s.color;
    ctx.lineWidth = highlight ? 3 : 1.5;
    ctx.beginPath(); ctx.roundRect(bx, by, boxW, boxH, 8); ctx.fill(); ctx.stroke();

    ctx.fillStyle = highlight ? '#fff' : '#1a1a1a';
    ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(s.label, bx + boxW / 2, by + 22);
    ctx.font = '11px system-ui';
    ctx.fillStyle = highlight ? 'rgba(255,255,255,0.8)' : '#6b7280';
    ctx.fillText(s.sub, bx + boxW / 2, by + 40);
  }

  function drawArrow(x1, y1, x2, y2, color, label, atpLabel) {
    ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
    // arrowhead
    const angle = Math.atan2(y2 - y1, x2 - x1);
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - 8 * Math.cos(angle - 0.4), y2 - 8 * Math.sin(angle - 0.4));
    ctx.lineTo(x2 - 8 * Math.cos(angle + 0.4), y2 - 8 * Math.sin(angle + 0.4));
    ctx.closePath(); ctx.fill();
    // label
    if (label) {
      const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
      ctx.fillStyle = '#374151'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
      ctx.fillText(label, mx + 10, my - 4);
    }
    // ATP badge
    if (atpLabel) {
      const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
      ctx.fillStyle = '#7c3aed'; ctx.font = 'bold 10px system-ui';
      ctx.fillText(atpLabel, mx + 10, my + 10);
    }
  }

  function drawCurvedArrow(x1, y1, x2, y2, color, cp1x, cp1y) {
    ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.quadraticCurveTo(cp1x, cp1y, x2, y2);
    ctx.stroke();
    const angle = Math.atan2(y2 - cp1y, x2 - cp1x);
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - 8 * Math.cos(angle - 0.4), y2 - 8 * Math.sin(angle - 0.4));
    ctx.lineTo(x2 - 8 * Math.cos(angle + 0.4), y2 - 8 * Math.sin(angle + 0.4));
    ctx.closePath(); ctx.fill();
  }

  // Draw common stages (Glucose -> Glycolysis -> Pyruvate)
  stages.forEach(s => drawBox(s, s.idx === pwSelectedStage));

  // Arrows between common stages
  drawArrow(130, 105, 130, 140, '#ea580c', '-2 ATP invested', '+4 ATP, +2 NADH');

  drawArrow(130, 195, 130, 230, '#dc2626', '', '');

  // Branch point at pyruvate
  if (pwMode === 'aerobic') {
    // Draw aerobic path
    drawCurvedArrow(200, 257, 280, 257, '#16a34a', 240, 257);

    aerobicStages.forEach(s => drawBox(s, s.idx === pwSelectedStage));

    drawArrow(350, 285, 350, 320, '#2563eb', '+2 FADH\u2082', '+2 ATP, +6 NADH');

    // CO2 output
    ctx.fillStyle = '#9ca3af'; ctx.font = '10px system-ui'; ctx.textAlign = 'left';
    ctx.fillText('6 CO\u2082 \u2191', 425, 250);

    // O2 input
    ctx.fillStyle = '#2563eb'; ctx.font = 'bold 10px system-ui';
    ctx.fillText('6 O\u2082 \u2192', 425, 340);

    // Water output
    ctx.fillStyle = '#3b82f6'; ctx.font = '10px system-ui';
    ctx.fillText('6 H\u2082O', 425, 360);

    // ATP total box
    ctx.fillStyle = '#16a34a';
    ctx.beginPath(); ctx.roundRect(260, H - 60, 180, 44, 8); ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 16px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Total: 36-38 ATP', 350, H - 32);

    // Draw animated glucose molecules if animating
    if (pwAnimating) {
      const progress = pwAnimStep;
      ctx.fillStyle = '#d97706';
      for (let i = 0; i < 3; i++) {
        const t = (progress + i * 0.3) % 1;
        let px, py;
        if (t < 0.33) {
          py = lerp(105, 230, t / 0.33);
          px = 130;
        } else if (t < 0.66) {
          px = lerp(200, 350, (t - 0.33) / 0.33);
          py = 257;
        } else {
          px = 350;
          py = lerp(285, 375, (t - 0.66) / 0.33);
        }
        ctx.beginPath(); ctx.arc(px, py, 4 + i, 0, Math.PI * 2); ctx.fill();
      }
    }
  } else {
    // Anaerobic path
    drawCurvedArrow(200, 240, 440, 168, '#7c3aed', 320, 180);

    drawBox(anaerobicStage, anaerobicStage.idx === pwSelectedStage);

    // Lactic acid output
    ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'left';
    ctx.fillText('Lactic Acid', 440, 210);
    ctx.font = '10px system-ui'; ctx.fillStyle = '#6b7280';
    ctx.fillText('(causes fatigue)', 440, 224);
    ctx.fillText('NAD+ recycled', 440, 240);

    // Also show aerobic path grayed out
    aerobicStages.forEach(s => {
      ctx.globalAlpha = 0.15;
      drawBox(s, false);
      ctx.globalAlpha = 1;
    });
    ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('NO O\u2082', 350, 210);
    ctx.fillText('BLOCKED', 350, 226);

    // ATP total box
    ctx.fillStyle = '#c41e3a';
    ctx.beginPath(); ctx.roundRect(260, H - 60, 180, 44, 8); ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 16px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Total: Only 2 ATP', 350, H - 32);

    if (pwAnimating) {
      const progress = pwAnimStep;
      ctx.fillStyle = '#7c3aed';
      for (let i = 0; i < 3; i++) {
        const t = (progress + i * 0.3) % 1;
        let px, py;
        if (t < 0.5) {
          py = lerp(105, 230, t / 0.5);
          px = 130;
        } else {
          px = lerp(200, 510, (t - 0.5) / 0.5);
          py = lerp(240, 168, (t - 0.5) / 0.5);
        }
        ctx.beginPath(); ctx.arc(px, py, 4 + i, 0, Math.PI * 2); ctx.fill();
      }
    }
  }

  // Net equation box at top right
  ctx.fillStyle = '#f1f5f9';
  ctx.strokeStyle = '#e5e7eb';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.roundRect(W - 260, 10, 250, 50, 6); ctx.fill(); ctx.stroke();
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
  if (pwMode === 'aerobic') {
    ctx.fillText('C\u2086H\u2081\u2082O\u2086 + 6O\u2082 \u2192 6CO\u2082 + 6H\u2082O', W - 135, 30);
    ctx.fillStyle = '#16a34a'; ctx.font = 'bold 13px system-ui';
    ctx.fillText('+ 36-38 ATP', W - 135, 50);
  } else {
    ctx.fillText('C\u2086H\u2081\u2082O\u2086 \u2192 2 Lactic Acid', W - 135, 30);
    ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 13px system-ui';
    ctx.fillText('+ 2 ATP', W - 135, 50);
  }
}

function drawPwComparison() {
  const ctx = getCtx('pw-comparison-chart');
  const labels = ['Glycolysis', 'Krebs', 'ETC', 'Total'];
  const aerobic = [2, 2, 34, 38];
  const anaerobic = [2, 0, 0, 2];

  const W = ctx.W, H = ctx.H;
  const pad = { top: 25, right: 20, bottom: 40, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const n = labels.length;
  const groupW = plotW / n;
  const barW = groupW * 0.3;
  const maxV = 42;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i / 4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText(Math.round(maxV * i / 4), pad.left - 6, y + 4);
  }

  labels.forEach((label, i) => {
    const cx = pad.left + groupW * i + groupW / 2;
    // Aerobic bar
    const ah = (aerobic[i] / maxV) * plotH;
    ctx.fillStyle = '#16a34a';
    ctx.fillRect(cx - barW - 2, pad.top + plotH - ah, barW, ah);
    if (aerobic[i] > 0) {
      ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
      ctx.fillText(aerobic[i], cx - barW / 2 - 2, pad.top + plotH - ah - 4);
    }
    // Anaerobic bar
    const anh = (anaerobic[i] / maxV) * plotH;
    ctx.fillStyle = '#c41e3a';
    ctx.fillRect(cx + 2, pad.top + plotH - anh, barW, anh);
    if (anaerobic[i] > 0) {
      ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
      ctx.fillText(anaerobic[i], cx + 2 + barW / 2, pad.top + plotH - anh - 4);
    }
    // Label
    ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(label, cx, H - pad.bottom + 16);
  });

  // Legend
  ctx.fillStyle = '#16a34a'; ctx.fillRect(pad.left, 6, 12, 12);
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Aerobic', pad.left + 18, 16);
  ctx.fillStyle = '#c41e3a'; ctx.fillRect(pad.left + 80, 6, 12, 12);
  ctx.fillStyle = '#374151'; ctx.fillText('Anaerobic', pad.left + 98, 16);
}

// ══════════════════════════════════════════════════════════════════════════
// SIDEBAR ACTIVE STATE
// ══════════════════════════════════════════════════════════════════════════
const navLinks = document.querySelectorAll('.sidebar-nav a');
const sections = document.querySelectorAll('.section, .hero');

function updateActiveNav() {
  let current = '';
  sections.forEach(section => {
    const rect = section.getBoundingClientRect();
    if (rect.top <= 120) current = section.id;
  });
  navLinks.forEach(link => {
    link.classList.toggle('active', link.getAttribute('href') === '#' + current);
  });
}
window.addEventListener('scroll', updateActiveNav);

// ══════════════════════════════════════════════════════════════════════════
// INITIALIZATION
// ══════════════════════════════════════════════════════════════════════════
function init() {
  // Part 1: Initial catalase display
  catUpdate();
  catReset();

  // Part 2: Calculate initial BMR
  bmrCalc();

  // Part 3: Initial exercise display
  exUpdate();
  exResetDebt();

  // Part 4: ATP Sankey + budget
  drawAtpSankey();
  atpBudgetUpdate();

  // Part 5: Enzyme kinetics
  ekSetInhibitor('none');
  ekUpdate();

  // Part 6: Pathway map + comparison
  pwDraw();
  pwSelectStage(0);
  drawPwComparison();
}

window.addEventListener('load', init);
window.addEventListener('resize', () => {
  // Redraw all charts on resize
  catUpdate();
  bmrCalc();
  drawExCanvas(parseInt($('ex-intensity').value));
  if (exDebtData) drawExDebtChart();
  drawAtpSankey();
  atpBudgetUpdate();
  ekUpdate();
  pwDraw();
  drawPwComparison();
});
</script>
</body>
</html>
